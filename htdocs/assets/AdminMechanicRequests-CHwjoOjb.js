var f=(a,N,r)=>new Promise((x,h)=>{var v=t=>{try{d(r.next(t))}catch(b){h(b)}},F=t=>{try{d(r.throw(t))}catch(b){h(b)}},d=t=>t.done?x(t.value):Promise.resolve(t.value).then(v,F);d((r=r.apply(a,N)).next())});import{j as e}from"./ui-vendor-DMUr7mTx.js";import{r as j}from"./react-vendor-BvqlMsL5.js";import{u as re,s as z,C as l,d as c,I as le,S as ce,q as de,r as me,t as oe,v as u,h as xe,i as he,j as D,k as M,D as je,m as ue,n as pe,o as ge,p as Ne,T as ve,G as be,B as p,y as O,e as g}from"./index-ZwIgorfy.js";import{a as ye,u as fe,b as B}from"./query-vendor-B2F_wWlc.js";import{Y as we,j as k,J as w,ao as R,aF as L,a2 as Re,aP as Y,aE as W,f as _e}from"./icons-vendor-b0I7fGSL.js";import"./supabase-vendor-B984m0TI.js";import"./utils-vendor-B2FlkASS.js";import"./router-vendor-CEyBJ8vK.js";import"./ui-components-7w1-MJre.js";const Le=()=>{var K,U;const{profile:a}=re(),N=ye(),[r,x]=j.useState(null),[h,v]=j.useState(""),[F,d]=j.useState(!1),[t,b]=j.useState(""),[I,Z]=j.useState("all"),[$,ee]=j.useState("pending"),{data:se=[],isLoading:ae}=fe({queryKey:["admin-all-requests",a==null?void 0:a.organization_id],queryFn:()=>f(void 0,null,function*(){if(!(a!=null&&a.organization_id))return[];const{data:s,error:i}=yield z.from("mechanic_organization_requests").select(`
          *,
          mechanic:profiles!mechanic_id(id, first_name, last_name, email, phone),
          organization:organizations(id, name),
          approver:profiles!approved_by(id, first_name, last_name)
        `).eq("organization_id",a.organization_id).order("created_at",{ascending:!1});return i?(console.error("Error fetching requests:",i),[]):s||[]}),enabled:!!(a!=null&&a.organization_id)&&a.role==="admin"}),_=se.filter(s=>{var n,y,V,X,G,H,J;const i=t===""||((y=(n=s.mechanic)==null?void 0:n.first_name)==null?void 0:y.toLowerCase().includes(t.toLowerCase()))||((X=(V=s.mechanic)==null?void 0:V.last_name)==null?void 0:X.toLowerCase().includes(t.toLowerCase()))||((H=(G=s.mechanic)==null?void 0:G.email)==null?void 0:H.toLowerCase().includes(t.toLowerCase()))||((J=s.message)==null?void 0:J.toLowerCase().includes(t.toLowerCase())),P=I==="all"||s.status===I;return i&&P}),C=_.filter(s=>s.status==="pending"),S=_.filter(s=>s.status==="active"||s.status==="approved"),T=_.filter(s=>s.status==="rejected"),q=_.filter(s=>s.status==="terminated"),m=B({mutationFn:P=>f(void 0,[P],function*({requestId:s,responseMessage:i}){const{error:n}=yield z.from("mechanic_organization_requests").update({status:"approved",approved_by:a==null?void 0:a.id,approved_at:new Date().toISOString(),response_message:i.trim()||null}).eq("id",s);if(n)throw n}),onSuccess:()=>{O({title:"Request Approved",description:"The mechanic has been approved to work with your organization."}),d(!1),x(null),v(""),N.invalidateQueries({queryKey:["admin-all-requests"]})}}),o=B({mutationFn:P=>f(void 0,[P],function*({requestId:s,responseMessage:i}){const{error:n}=yield z.from("mechanic_organization_requests").update({status:"rejected",approved_by:a==null?void 0:a.id,approved_at:new Date().toISOString(),response_message:i.trim()||null}).eq("id",s);if(n)throw n}),onSuccess:()=>{O({title:"Request Rejected",description:"The request has been rejected."}),d(!1),x(null),v(""),N.invalidateQueries({queryKey:["admin-all-requests"]})}}),Q=B({mutationFn:P=>f(void 0,[P],function*({requestId:s,reason:i}){const{error:n}=yield z.from("mechanic_organization_requests").update({status:"terminated",terminated_by:a==null?void 0:a.id,terminated_at:new Date().toISOString(),termination_reason:i.trim()||"Terminated by admin"}).eq("id",s);if(n)throw n}),onSuccess:()=>{O({title:"Relationship Terminated",description:"The mechanic relationship has been terminated."}),N.invalidateQueries({queryKey:["admin-all-requests"]})}}),te=s=>{x(s),d(!0)},ne=s=>{x(s),d(!0)},E=s=>{r&&(s==="approve"?m.mutate({requestId:r.id,responseMessage:h}):o.mutate({requestId:r.id,responseMessage:h}))},ie=s=>{switch(s){case"pending":return e.jsxs(g,{variant:"outline",className:"bg-yellow-50 text-yellow-700 border-yellow-200",children:[e.jsx(k,{className:"h-3 w-3 mr-1"}),"Pending"]});case"approved":return e.jsxs(g,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200",children:[e.jsx(w,{className:"h-3 w-3 mr-1"}),"Approved"]});case"active":return e.jsxs(g,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:[e.jsx(w,{className:"h-3 w-3 mr-1"}),"Active"]});case"rejected":return e.jsxs(g,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200",children:[e.jsx(R,{className:"h-3 w-3 mr-1"}),"Rejected"]});case"terminated":return e.jsxs(g,{variant:"outline",className:"bg-gray-50 text-gray-700 border-gray-200",children:[e.jsx(R,{className:"h-3 w-3 mr-1"}),"Terminated"]});default:return e.jsx(g,{variant:"outline",children:s})}},A=({request:s})=>{var i,P,n,y;return e.jsx(l,{className:"hover:shadow-md transition-shadow",children:e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-full",children:e.jsx(_e,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsxs("h3",{className:"font-medium",children:[(i=s.mechanic)==null?void 0:i.first_name," ",(P=s.mechanic)==null?void 0:P.last_name]}),ie(s.status)]}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:(n=s.mechanic)==null?void 0:n.email}),((y=s.mechanic)==null?void 0:y.phone)&&e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:s.mechanic.phone}),e.jsxs("p",{className:"text-xs text-gray-500 mb-2",children:["Requested ",new Date(s.created_at).toLocaleDateString()," at ",new Date(s.created_at).toLocaleTimeString()]}),s.message&&e.jsx("div",{className:"bg-gray-50 p-2 rounded text-sm mb-2",children:e.jsxs("p",{className:"text-gray-700",children:['"',s.message,'"']})}),s.response_message&&e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-sm",children:[e.jsx("p",{className:"text-blue-700 font-medium",children:"Response:"}),e.jsxs("p",{className:"text-blue-600",children:['"',s.response_message,'"']})]})]})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs(p,{size:"sm",onClick:()=>te(s),disabled:m.isPending||o.isPending,children:[e.jsx(W,{className:"h-4 w-4 mr-1"}),"Approve"]}),e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>ne(s),disabled:m.isPending||o.isPending,children:[e.jsx(Y,{className:"h-4 w-4 mr-1"}),"Reject"]})]}),(s.status==="active"||s.status==="approved")&&e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>{confirm("Are you sure you want to terminate this relationship?")&&Q.mutate({requestId:s.id,reason:"Terminated by admin"})},disabled:Q.isPending,children:[e.jsx(L,{className:"h-4 w-4 mr-1"}),"Terminate"]})]})]})})})};return(a==null?void 0:a.role)!=="admin"?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(l,{children:e.jsxs(c,{className:"p-8 text-center",children:[e.jsx(we,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"Only administrators can access this page."})]})})}):e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Mechanic Request Management"}),e.jsx("p",{className:"text-gray-600",children:"Manage mechanic requests and working relationships"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8",children:[e.jsx(l,{children:e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(k,{className:"h-5 w-5 text-yellow-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:C.length}),e.jsx("p",{className:"text-sm text-gray-600",children:"Pending Requests"})]})]})})}),e.jsx(l,{children:e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"h-5 w-5 text-green-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:S.length}),e.jsx("p",{className:"text-sm text-gray-600",children:"Active Mechanics"})]})]})})}),e.jsx(l,{children:e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{className:"h-5 w-5 text-red-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:T.length}),e.jsx("p",{className:"text-sm text-gray-600",children:"Rejected Requests"})]})]})})}),e.jsx(l,{children:e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{className:"h-5 w-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:q.length}),e.jsx("p",{className:"text-sm text-gray-600",children:"Terminated"})]})]})})})]}),e.jsx(l,{className:"mb-6",children:e.jsx(c,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(Re,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(le,{placeholder:"Search by mechanic name, email, or message...",value:t,onChange:s=>b(s.target.value),className:"pl-10"})]})}),e.jsx("div",{className:"w-full md:w-48",children:e.jsxs(ce,{value:I,onValueChange:Z,children:[e.jsx(de,{children:e.jsx(me,{placeholder:"Filter by status"})}),e.jsxs(oe,{children:[e.jsx(u,{value:"all",children:"All Status"}),e.jsx(u,{value:"pending",children:"Pending"}),e.jsx(u,{value:"approved",children:"Approved"}),e.jsx(u,{value:"active",children:"Active"}),e.jsx(u,{value:"rejected",children:"Rejected"}),e.jsx(u,{value:"terminated",children:"Terminated"})]})]})})]})})}),e.jsxs(xe,{value:$,onValueChange:ee,className:"space-y-6",children:[e.jsxs(he,{className:"grid w-full grid-cols-4",children:[e.jsxs(D,{value:"pending",className:"flex items-center space-x-2",children:[e.jsx(k,{className:"h-4 w-4"}),e.jsxs("span",{children:["Pending (",C.length,")"]})]}),e.jsxs(D,{value:"active",className:"flex items-center space-x-2",children:[e.jsx(w,{className:"h-4 w-4"}),e.jsxs("span",{children:["Active (",S.length,")"]})]}),e.jsxs(D,{value:"rejected",className:"flex items-center space-x-2",children:[e.jsx(R,{className:"h-4 w-4"}),e.jsxs("span",{children:["Rejected (",T.length,")"]})]}),e.jsxs(D,{value:"terminated",className:"flex items-center space-x-2",children:[e.jsx(L,{className:"h-4 w-4"}),e.jsxs("span",{children:["Terminated (",q.length,")"]})]})]}),e.jsx(M,{value:"pending",className:"space-y-4",children:ae?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{children:"Loading requests..."})]}):C.length===0?e.jsx(l,{children:e.jsxs(c,{className:"p-8 text-center",children:[e.jsx(k,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Pending Requests"}),e.jsx("p",{className:"text-gray-600",children:"All mechanic requests have been reviewed."})]})}):e.jsx("div",{className:"grid gap-4",children:C.map(s=>e.jsx(A,{request:s},s.id))})}),e.jsx(M,{value:"active",className:"space-y-4",children:S.length===0?e.jsx(l,{children:e.jsxs(c,{className:"p-8 text-center",children:[e.jsx(w,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Active Mechanics"}),e.jsx("p",{className:"text-gray-600",children:"No mechanics are currently working with your organization."})]})}):e.jsx("div",{className:"grid gap-4",children:S.map(s=>e.jsx(A,{request:s},s.id))})}),e.jsx(M,{value:"rejected",className:"space-y-4",children:T.length===0?e.jsx(l,{children:e.jsxs(c,{className:"p-8 text-center",children:[e.jsx(R,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Rejected Requests"}),e.jsx("p",{className:"text-gray-600",children:"No requests have been rejected."})]})}):e.jsx("div",{className:"grid gap-4",children:T.map(s=>e.jsx(A,{request:s},s.id))})}),e.jsx(M,{value:"terminated",className:"space-y-4",children:q.length===0?e.jsx(l,{children:e.jsxs(c,{className:"p-8 text-center",children:[e.jsx(L,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Terminated Relationships"}),e.jsx("p",{className:"text-gray-600",children:"No mechanic relationships have been terminated."})]})}):e.jsx("div",{className:"grid gap-4",children:q.map(s=>e.jsx(A,{request:s},s.id))})})]}),e.jsx(je,{open:F,onOpenChange:d,children:e.jsxs(ue,{children:[e.jsxs(pe,{children:[e.jsx(ge,{children:r&&e.jsx(e.Fragment,{children:m.isPending||o.isPending?"Processing...":"Respond to Request"})}),e.jsx(Ne,{children:r&&e.jsxs(e.Fragment,{children:["Respond to ",(K=r.mechanic)==null?void 0:K.first_name," ",(U=r.mechanic)==null?void 0:U.last_name,"'s request to join your organization."]})})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Response Message (Optional)"}),e.jsx(ve,{placeholder:"Add a personal message...",value:h,onChange:s=>v(s.target.value),rows:3})]})}),e.jsxs(be,{children:[e.jsx(p,{variant:"outline",onClick:()=>d(!1),disabled:m.isPending||o.isPending,children:"Cancel"}),e.jsxs(p,{variant:"outline",onClick:()=>E("reject"),disabled:m.isPending||o.isPending,children:[e.jsx(Y,{className:"h-4 w-4 mr-1"}),"Reject"]}),e.jsxs(p,{onClick:()=>E("approve"),disabled:m.isPending||o.isPending,children:[e.jsx(W,{className:"h-4 w-4 mr-1"}),"Approve"]})]})]})})]})};export{Le as default};
