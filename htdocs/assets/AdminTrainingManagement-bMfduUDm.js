var $=(j,t,n)=>new Promise((r,o)=>{var g=i=>{try{f(n.next(i))}catch(x){o(x)}},p=i=>{try{f(n.throw(i))}catch(x){o(x)}},f=i=>i.done?r(i.value):Promise.resolve(i.value).then(g,p);f((n=n.apply(j,t)).next())});import{j as e}from"./ui-vendor-DMUr7mTx.js";import{r as d}from"./react-vendor-BvqlMsL5.js";import{u as V,s as H,J as N,D as X,F as Y,B as D,m as ee,n as se,o as ae,L as S,S as O,q as k,r as M,t as R,v as A,I as te,a2 as ne,a3 as re,a4 as ie,T as le,f as ce,C as b,d as w,a as de,b as oe,P as me,e as T}from"./index-ZwIgorfy.js";import{C as xe}from"./calendar-C0tEixyh.js";import{E as ge,g as J,V as ue,az as F,Z as he,J as je,j as I,T as pe,U as L,f as fe,aa as ve}from"./icons-vendor-b0I7fGSL.js";import{f as Z}from"./utils-vendor-B2FlkASS.js";import{N as q}from"./router-vendor-CEyBJ8vK.js";import"./supabase-vendor-B984m0TI.js";import"./query-vendor-B2F_wWlc.js";import"./ui-components-7w1-MJre.js";const B=[{value:"driver-safety-fundamentals",label:"Driver Safety Fundamentals"},{value:"vehicle-inspection-training",label:"Daily Vehicle Inspection Procedures"},{value:"emergency-procedures",label:"Emergency Response Procedures"},{value:"legal-compliance",label:"Legal Compliance and Documentation"},{value:"passenger-assistance",label:"Passenger Assistance Training"},{value:"defensive-driving",label:"Defensive Driving Techniques"},{value:"first-aid",label:"First Aid Training"},{value:"customer-service",label:"Customer Service Excellence"},{value:"hazardous-materials",label:"Hazardous Materials Handling"},{value:"route-optimization",label:"Route Optimization Training"}],U=({onTrainingAssigned:j})=>{const{user:t,profile:n}=V(),[r,o]=d.useState(!1),[g,p]=d.useState(!1),[f,i]=d.useState([]),[x,v]=d.useState(""),[u,C]=d.useState(""),[P,z]=d.useState(""),[h,s]=d.useState(void 0),[l,m]=d.useState("");d.useEffect(()=>{r&&(n!=null&&n.organization_id)&&c()},[r,n==null?void 0:n.organization_id]);const c=()=>$(void 0,null,function*(){try{const{data:a,error:_}=yield H.from("profiles").select("id, email, first_name, last_name").eq("role","driver").eq("organization_id",n==null?void 0:n.organization_id).order("first_name",{ascending:!0});if(_){console.error("Error fetching drivers:",_),N.error("Failed to load drivers");return}i(a||[])}catch(a){console.error("Error fetching drivers:",a),N.error("Failed to load drivers")}}),E=a=>$(void 0,null,function*(){var _;if(a.preventDefault(),!x||!u||!h){N.error("Please fill in all required fields");return}p(!0);try{const y=yield fetch("https://dznbihypzmvcmradijqn.supabase.co/functions/v1/assign-driver-training",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t==null?void 0:t.access_token}`},body:JSON.stringify({driver_id:x,training_type:u,training_name:P||((_=B.find(W=>W.value===u))==null?void 0:_.label)||u,due_date:h.toISOString(),notes:l||null})}),Q=yield y.json();if(!y.ok)throw new Error(Q.error||"Failed to assign training");N.success("Training assigned successfully!"),o(!1),G(),j==null||j()}catch(y){console.error("Error assigning training:",y),N.error(y instanceof Error?y.message:"Failed to assign training")}finally{p(!1)}}),G=()=>{v(""),C(""),z(""),s(void 0),m("")},K=a=>a.first_name&&a.last_name?`${a.first_name} ${a.last_name}`:a.email;return e.jsxs(X,{open:r,onOpenChange:o,children:[e.jsx(Y,{asChild:!0,children:e.jsxs(D,{className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"Assign Training"]})}),e.jsxs(ee,{className:"sm:max-w-[500px]",children:[e.jsx(se,{children:e.jsx(ae,{children:"Assign Training to Driver"})}),e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"driver",children:"Driver *"}),e.jsxs(O,{value:x,onValueChange:v,children:[e.jsx(k,{children:e.jsx(M,{placeholder:"Select a driver"})}),e.jsx(R,{children:f.map(a=>e.jsx(A,{value:a.id,children:K(a)},a.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"training-type",children:"Training Type *"}),e.jsxs(O,{value:u,onValueChange:C,children:[e.jsx(k,{children:e.jsx(M,{placeholder:"Select training type"})}),e.jsxs(R,{children:[B.map(a=>e.jsx(A,{value:a.value,children:a.label},a.value)),e.jsx(A,{value:"custom",children:"Custom Training"})]})]})]}),u==="custom"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"custom-name",children:"Custom Training Name *"}),e.jsx(te,{id:"custom-name",value:P,onChange:a=>z(a.target.value),placeholder:"Enter custom training name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{children:"Due Date *"}),e.jsxs(ne,{children:[e.jsx(re,{asChild:!0,children:e.jsxs(D,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),h?Z(h,"PPP"):"Pick a date"]})}),e.jsx(ie,{className:"w-auto p-0",children:e.jsx(xe,{mode:"single",selected:h,onSelect:s,initialFocus:!0,disabled:a=>a<new Date})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"notes",children:"Notes (Optional)"}),e.jsx(le,{id:"notes",value:l,onChange:a=>m(a.target.value),placeholder:"Add any additional notes or instructions...",rows:3})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx(D,{type:"button",variant:"outline",onClick:()=>o(!1),disabled:g,children:"Cancel"}),e.jsxs(D,{type:"submit",disabled:g,children:[g&&e.jsx(ue,{className:"w-4 h-4 mr-2 animate-spin"}),"Assign Training"]})]})]})]})]})},Ee=()=>{const{user:j,profile:t,loading:n}=V(),r=ce(),[o,g]=d.useState(!0),[p,f]=d.useState([]),[i,x]=d.useState({total:0,completed:0,inProgress:0,overdue:0,notStarted:0});d.useEffect(()=>{t!=null&&t.organization_id&&v()},[t==null?void 0:t.organization_id]);const v=()=>$(void 0,null,function*(){g(!0);try{const{data:s,error:l}=yield H.from("training_completions").select(`
          *,
          driver:profiles!training_completions_driver_id_fkey(
            email,
            first_name,
            last_name
          )
        `).eq("organization_id",t==null?void 0:t.organization_id).order("created_at",{ascending:!1});if(l){console.error("Error fetching training records:",l),N.error("Failed to load training records");return}f(s||[]),u(s||[])}catch(s){console.error("Error fetching training records:",s),N.error("Failed to load training records")}finally{g(!1)}}),u=s=>{const l=new Date,m={total:s.length,completed:s.filter(c=>c.status==="completed").length,inProgress:s.filter(c=>c.status==="in_progress").length,overdue:s.filter(c=>new Date(c.due_date)<l&&c.status!=="completed").length,notStarted:s.filter(c=>c.status==="not_started").length};x(m)},C=(s,l)=>{const m=new Date;if(new Date(l)<m&&s!=="completed")return e.jsx(T,{className:"bg-red-100 text-red-800",children:"Overdue"});switch(s){case"completed":return e.jsx(T,{className:"bg-green-100 text-green-800",children:"Completed"});case"in_progress":return e.jsx(T,{className:"bg-blue-100 text-blue-800",children:"In Progress"});case"not_started":return e.jsx(T,{className:"bg-gray-100 text-gray-800",children:"Not Started"});default:return e.jsx(T,{variant:"secondary",children:s})}},P=s=>s.first_name&&s.last_name?`${s.first_name} ${s.last_name}`:s.email,z=s=>{const l=new Date,c=new Date(s).getTime()-l.getTime();return Math.ceil(c/(1e3*60*60*24))};if(n||o)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading training management..."})]})});if(!j||!t)return e.jsx(q,{to:"/auth",replace:!0});if(!["admin","council"].includes(t.role))return e.jsx(q,{to:"/dashboard",replace:!0});const h=e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:`${r?"space-y-3":"flex justify-between items-center"}`,children:[e.jsxs("div",{children:[e.jsxs("h1",{className:`${r?"text-2xl":"text-3xl"} font-bold text-gray-900 flex items-center gap-2 sm:gap-3`,children:[e.jsx(F,{className:`${r?"w-6 h-6":"w-8 h-8"} text-blue-600`}),"Training Management"]}),e.jsx("p",{className:"text-gray-600 mt-1 text-sm sm:text-base",children:"Manage driver training assignments and track progress"})]}),e.jsxs("div",{className:`flex items-center gap-2 ${r?"w-full":"space-x-2"}`,children:[e.jsxs(D,{onClick:v,variant:"outline",disabled:o,size:r?"sm":"default",className:r?"flex-1":"",children:[e.jsx(he,{className:`w-4 h-4 ${r?"mr-1":"mr-2"} ${o?"animate-spin":""}`}),r?"Refresh":"Refresh Data"]}),e.jsx(U,{onTrainingAssigned:v})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx(b,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Total Assignments"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:i.total})]}),e.jsx(F,{className:"w-8 h-8 text-blue-600"})]})})}),e.jsx(b,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Completed"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:i.completed})]}),e.jsx(je,{className:"w-8 h-8 text-green-600"})]})})}),e.jsx(b,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"In Progress"}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:i.inProgress})]}),e.jsx(I,{className:"w-8 h-8 text-blue-600"})]})})}),e.jsx(b,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Overdue"}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:i.overdue})]}),e.jsx(pe,{className:"w-8 h-8 text-red-600"})]})})}),e.jsx(b,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Not Started"}),e.jsx("p",{className:"text-2xl font-bold text-gray-600",children:i.notStarted})]}),e.jsx(L,{className:"w-8 h-8 text-gray-600"})]})})})]}),e.jsxs(b,{children:[e.jsx(de,{children:e.jsxs(oe,{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5"}),"Training Assignments"]})}),e.jsx(w,{children:p.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(F,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Training Assignments"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Start by assigning training to your drivers"}),e.jsx(U,{onTrainingAssigned:v})]}):e.jsx("div",{className:"space-y-4",children:p.map(s=>{const l=z(s.due_date),m=l<0&&s.status!=="completed";return e.jsxs("div",{className:"border rounded-lg p-4 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(L,{className:"w-8 h-8 text-gray-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:P(s.driver)}),e.jsx("p",{className:"text-sm text-gray-600",children:s.training_name})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[C(s.status,s.due_date),e.jsx(D,{variant:"outline",size:"sm",children:e.jsx(ve,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-4 h-4 text-gray-500"}),e.jsxs("span",{className:"text-sm text-gray-600",children:["Due: ",Z(new Date(s.due_date),"MMM dd, yyyy")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:`text-sm ${m?"text-red-600":"text-gray-600"}`,children:m?`${Math.abs(l)} days overdue`:`${l} days remaining`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-4 h-4 text-gray-500"}),e.jsxs("span",{className:"text-sm text-gray-600",children:["Progress: ",s.progress,"%"]})]})]}),e.jsx(me,{value:s.progress,className:"mb-2"}),s.notes&&e.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:[e.jsx("strong",{children:"Notes:"})," ",s.notes]})]},s.id)})})})]})]});return r?e.jsx("div",{className:"container mx-auto px-4 py-6",children:h}):e.jsx("div",{className:"container mx-auto px-6 py-8",children:h})};export{Ee as default};
