var Ue=Object.defineProperty,Ee=Object.defineProperties;var Fe=Object.getOwnPropertyDescriptors;var me=Object.getOwnPropertySymbols;var De=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable;var xe=(o,l,d)=>l in o?Ue(o,l,{enumerable:!0,configurable:!0,writable:!0,value:d}):o[l]=d,u=(o,l)=>{for(var d in l||(l={}))De.call(l,d)&&xe(o,d,l[d]);if(me)for(var d of me(l))ke.call(l,d)&&xe(o,d,l[d]);return o},j=(o,l)=>Ee(o,Fe(l));var N=(o,l,d)=>new Promise((k,F)=>{var I=E=>{try{D(d.next(E))}catch(h){F(h)}},L=E=>{try{D(d.throw(E))}catch(h){F(h)}},D=E=>E.done?k(E.value):Promise.resolve(E.value).then(I,L);D((d=d.apply(o,l)).next())});import{j as e}from"./ui-vendor-DMUr7mTx.js";import{r as U,a as Le}from"./react-vendor-BvqlMsL5.js";import{u as ge,l as oe,s as f,at as ve,B as v,h as _e,i as ye,j as V,k as B,C as b,a as S,b as C,d as T,e as A,A as Ne,g as we,D as Y,m as Z,n as ee,o as se,L as g,I as O,S as G,q as J,r as W,t as X,v as K,T as le,w as he}from"./index-ZwIgorfy.js";import{a as qe,u as re,b as ue}from"./query-vendor-B2F_wWlc.js";import{E as je}from"./emailService-CYvLt_Xb.js";import{E as be,G as Re,ak as Se,J as te,ao as fe,j as pe,f as Ce,T as ce,Z as $e,h as de,ab as Ie,aF as Pe}from"./icons-vendor-b0I7fGSL.js";import"./supabase-vendor-B984m0TI.js";import"./utils-vendor-B2FlkASS.js";import"./router-vendor-CEyBJ8vK.js";import"./ui-components-7w1-MJre.js";const Me=()=>{const{user:o}=ge(),{toast:l}=oe(),d=qe(),{data:k,isLoading:F,error:I}=re({queryKey:["notification-templates"],queryFn:()=>N(void 0,null,function*(){const{data:a,error:r}=yield f.from("notification_templates").select("*").eq("is_active",!0).order("created_at",{ascending:!1});if(r)throw r;return a||[]})}),{data:L,isLoading:D,error:E}=re({queryKey:["notification-logs"],queryFn:()=>N(void 0,null,function*(){const{data:a,error:r}=yield f.from("notification_logs").select(`
          *,
          user_agreements!inner(title),
          profiles!inner(email)
        `).order("sent_at",{ascending:!1}).limit(50);if(r)throw r;return a||[]})}),h=ue({mutationFn:a=>N(void 0,null,function*(){if(!(o!=null&&o.id))throw new Error("User not authenticated");const{data:r,error:_}=yield f.from("user_agreements").select("*").eq("id",a.agreement_id).single();if(_||!r)throw new Error("Agreement not found");let n=[];if(a.send_to_all){const{data:i}=yield f.from("profiles").select("id, email, first_name, last_name").or(`terms_version.neq.${r.version},privacy_policy_version.neq.${r.version}`);n=i||[]}else if(a.user_ids&&a.user_ids.length>0){const{data:i}=yield f.from("profiles").select("id, email, first_name, last_name").in("id",a.user_ids);n=i||[]}let m=null;if(a.template_id){const{data:i}=yield f.from("notification_templates").select("*").eq("id",a.template_id).single();m=i}a.custom_subject||m!=null&&m.subject||`${r.title}`,a.custom_body||m!=null&&m.body||`${r.title}`;const c=n.map(i=>N(void 0,null,function*(){try{const{error:w}=yield f.from("notification_logs").insert({user_id:i.id,agreement_id:a.agreement_id,notification_type:a.notification_type,status:"pending",user_email:i.email,agreement_title:r.title});if(w)throw w;let M=!1;return a.notification_type==="agreement_update"?M=yield je.sendAgreementNotification({to:i.email,firstName:i.first_name||"User",lastName:i.last_name,email:i.email,agreementTitle:r.title,agreementType:r.agreement_type.replace("_"," "),loginUrl:`${window.location.origin}/auth`}):a.notification_type==="reminder"&&(M=yield je.sendReminderEmail({to:i.email,firstName:i.first_name||"User",lastName:i.last_name,email:i.email,agreementTitle:r.title,agreementType:r.agreement_type.replace("_"," "),loginUrl:`${window.location.origin}/auth`})),yield f.from("notification_logs").update({status:M?"sent":"failed",sent_at:new Date().toISOString(),error_message:M?null:"Email delivery failed"}).eq("user_id",i.id).eq("agreement_id",a.agreement_id),{success:M,user:i.email}}catch(w){return yield f.from("notification_logs").update({status:"failed",error_message:w instanceof Error?w.message:"Unknown error",sent_at:new Date().toISOString()}).eq("user_id",i.id).eq("agreement_id",a.agreement_id),{success:!1,user:i.email,error:w}}})),q=yield Promise.all(c),y=q.filter(i=>i.success).length,R=q.filter(i=>!i.success).length;return{total:q.length,successful:y,failed:R,results:q}}),onSuccess:a=>{l({title:"Notifications Sent",description:`Successfully sent ${a.successful} notifications. ${a.failed} failed.`}),d.invalidateQueries({queryKey:["notification-logs"]})},onError:a=>{l({title:"Error",description:a.message||"Failed to send notifications",variant:"destructive"})}}),P=ue({mutationFn:a=>N(void 0,null,function*(){const{data:r,error:_}=yield f.from("notification_templates").insert(j(u({},a),{created_by:o==null?void 0:o.id})).select().single();if(_)throw _;return r}),onSuccess:()=>{l({title:"Template Created",description:"Notification template created successfully"}),d.invalidateQueries({queryKey:["notification-templates"]})},onError:a=>{l({title:"Error",description:a.message||"Failed to create template",variant:"destructive"})}}),{data:x,isLoading:Q}=re({queryKey:["users-needing-acceptance"],queryFn:()=>N(void 0,null,function*(){const{data:a,error:r}=yield f.from("profiles").select(`
          id,
          email,
          first_name,
          last_name,
          terms_accepted,
          terms_version,
          privacy_policy_accepted,
          privacy_policy_version
        `);if(r)throw r;const{data:_}=yield f.rpc("get_latest_agreement_version",{agreement_type_param:"terms_of_service"}),{data:n}=yield f.rpc("get_latest_agreement_version",{agreement_type_param:"privacy_policy"});return(a==null?void 0:a.filter(m=>!m.terms_accepted||m.terms_version!==_||!m.privacy_policy_accepted||m.privacy_policy_version!==n))||[]})}),H=a=>N(void 0,null,function*(){const r=a||(x==null?void 0:x.map(n=>n.id))||[];if(r.length===0){l({title:"No Users",description:"No users need to accept agreements"});return}const{data:_}=yield f.from("user_agreements").select("*").eq("is_active",!0).order("effective_date",{ascending:!1}).limit(2);if(!_||_.length===0){l({title:"No Agreements",description:"No active agreements found",variant:"destructive"});return}for(const n of _)yield h.mutateAsync({agreement_id:n.id,notification_type:"reminder",user_ids:r,custom_subject:`Reminder: Please Accept ${n.title}`,custom_body:`This is a friendly reminder to please review and accept the updated ${n.title}. You can do this by logging into your account.`})});return{templates:k,notificationLogs:L,usersNeedingAcceptance:x,isLoadingTemplates:F,isLoadingLogs:D,isLoadingUsers:Q,isSending:h.isPending,isCreatingTemplate:P.isPending,templatesError:I,logsError:E,sendNotification:h.mutate,sendNotificationAsync:h.mutateAsync,createTemplate:P.mutate,sendReminderNotifications:H,getTemplateById:a=>k==null?void 0:k.find(r=>r.id===a),getLogsByStatus:a=>(L==null?void 0:L.filter(r=>r.status===a))||[]}},Oe=()=>{const{toast:o}=oe(),[l,d]=U.useState(!1),[k,F]=U.useState(!1),[I,L]=U.useState(null),[D,E]=U.useState("templates"),{templates:h,notificationLogs:P,usersNeedingAcceptance:x,isLoadingTemplates:Q,isLoadingLogs:H,isLoadingUsers:a,isSending:r,sendNotification:_,createTemplate:n,sendReminderNotifications:m,getLogsByStatus:c}=Me(),{agreements:q}=ve(),[y,R]=U.useState({name:"",subject:"",body:"",type:"agreement_update"}),[i,w]=U.useState({agreement_id:"",template_id:"",custom_subject:"",custom_body:"",send_to_all:!1,selected_users:[]}),M=()=>N(void 0,null,function*(){if(!y.name||!y.subject||!y.body){o({title:"Validation Error",description:"Please fill in all required fields",variant:"destructive"});return}n(y),d(!1),R({name:"",subject:"",body:"",type:"agreement_update"})}),ae=()=>N(void 0,null,function*(){if(!i.agreement_id){o({title:"Validation Error",description:"Please select an agreement",variant:"destructive"});return}_({agreement_id:i.agreement_id,notification_type:"agreement_update",template_id:i.template_id||void 0,custom_subject:i.custom_subject||void 0,custom_body:i.custom_body||void 0,user_ids:i.send_to_all?void 0:i.selected_users,send_to_all:i.send_to_all}),F(!1),w({agreement_id:"",template_id:"",custom_subject:"",custom_body:"",send_to_all:!1,selected_users:[]})}),s=()=>N(void 0,null,function*(){yield m()}),p=t=>{switch(t){case"sent":return e.jsx(te,{className:"h-4 w-4 text-green-600"});case"failed":return e.jsx(fe,{className:"h-4 w-4 text-red-600"});case"pending":return e.jsx(pe,{className:"h-4 w-4 text-yellow-600"});default:return e.jsx(ce,{className:"h-4 w-4 text-gray-600"})}},z=t=>{switch(t){case"sent":return e.jsx(A,{variant:"default",className:"bg-green-100 text-green-800",children:"Sent"});case"failed":return e.jsx(A,{variant:"destructive",children:"Failed"});case"pending":return e.jsx(A,{variant:"secondary",children:"Pending"});default:return e.jsx(A,{variant:"outline",children:"Unknown"})}},$=c("sent"),ie=c("failed"),ne=c("pending");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Notification Management"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage email templates and send notifications"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{onClick:()=>d(!0),variant:"outline",children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),"Create Template"]}),e.jsxs(v,{onClick:()=>F(!0),children:[e.jsx(Re,{className:"h-4 w-4 mr-2"}),"Send Notification"]})]})]}),e.jsxs(_e,{value:D,onValueChange:E,children:[e.jsxs(ye,{className:"grid w-full grid-cols-4",children:[e.jsx(V,{value:"templates",children:"Templates"}),e.jsx(V,{value:"logs",children:"Notification Logs"}),e.jsx(V,{value:"users",children:"Users Needing Acceptance"}),e.jsx(V,{value:"reminders",children:"Reminders"})]}),e.jsx(B,{value:"templates",className:"space-y-4",children:e.jsxs(b,{children:[e.jsx(S,{children:e.jsx(C,{children:"Email Templates"})}),e.jsx(T,{children:Q?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsx("div",{className:"space-y-4",children:h==null?void 0:h.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("h3",{className:"font-semibold",children:t.name}),e.jsx(A,{variant:"outline",children:t.type.replace("_"," ")}),e.jsx(A,{variant:t.is_active?"default":"secondary",children:t.is_active?"Active":"Inactive"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-1",children:[e.jsx("strong",{children:"Subject:"})," ",t.subject]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx("strong",{children:"Body:"})," ",t.body.substring(0,100),"..."]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(v,{variant:"outline",size:"sm",onClick:()=>{L(t),R({name:t.name,subject:t.subject,body:t.body,type:t.type}),d(!0)},children:e.jsx(Se,{className:"h-4 w-4"})})})]},t.id))})})]})}),e.jsxs(B,{value:"logs",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(b,{children:[e.jsxs(S,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Sent"}),e.jsx(te,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:$.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Successfully delivered"})]})]}),e.jsxs(b,{children:[e.jsxs(S,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Failed"}),e.jsx(fe,{className:"h-4 w-4 text-red-600"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:ie.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Delivery failed"})]})]}),e.jsxs(b,{children:[e.jsxs(S,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Pending"}),e.jsx(pe,{className:"h-4 w-4 text-yellow-600"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:ne.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Awaiting delivery"})]})]})]}),e.jsxs(b,{children:[e.jsx(S,{children:e.jsx(C,{children:"Recent Notifications"})}),e.jsx(T,{children:H?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsx("div",{className:"space-y-4",children:P==null?void 0:P.slice(0,10).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[p(t.status),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.user_email}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.agreement_title})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[z(t.status),e.jsx(A,{variant:"outline",children:t.notification_type})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.sent_at?new Date(t.sent_at).toLocaleString():"Pending"})]})]},t.id))})})]})]}),e.jsx(B,{value:"users",className:"space-y-4",children:e.jsxs(b,{children:[e.jsx(S,{children:e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5"}),"Users Needing Agreement Acceptance",e.jsx(A,{variant:"outline",children:(x==null?void 0:x.length)||0})]})}),e.jsx(T,{children:a?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsx("div",{className:"space-y-4",children:x==null?void 0:x.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[t.first_name," ",t.last_name]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.email})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[t.needs_terms&&e.jsx(A,{variant:"destructive",children:"Needs Terms"}),t.needs_privacy&&e.jsx(A,{variant:"destructive",children:"Needs Privacy"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Last login: ",t.last_login?new Date(t.last_login).toLocaleDateString():"Never"]})]})]},t.user_id))})})]})}),e.jsx(B,{value:"reminders",className:"space-y-4",children:e.jsxs(b,{children:[e.jsx(S,{children:e.jsx(C,{children:"Send Reminder Notifications"})}),e.jsxs(T,{children:[e.jsxs(Ne,{children:[e.jsx(ce,{className:"h-4 w-4"}),e.jsx(we,{children:"Send reminder notifications to users who haven't accepted the latest agreements. This will send emails to all users who need to accept agreements."})]}),e.jsx("div",{className:"mt-4",children:e.jsx(v,{onClick:s,disabled:r||((x==null?void 0:x.length)||0)===0,className:"w-full",children:r?e.jsxs(e.Fragment,{children:[e.jsx($e,{className:"h-4 w-4 mr-2 animate-spin"}),"Sending Reminders..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Send Reminders to ",(x==null?void 0:x.length)||0," Users"]})})})]})]})})]}),e.jsx(Y,{open:l,onOpenChange:d,children:e.jsxs(Z,{className:"max-w-2xl",children:[e.jsx(ee,{children:e.jsx(se,{children:I?"Edit Template":"Create Template"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"template_name",children:"Template Name"}),e.jsx(O,{id:"template_name",value:y.name,onChange:t=>R(j(u({},y),{name:t.target.value})),placeholder:"e.g., Agreement Update Notification"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"template_type",children:"Type"}),e.jsxs(G,{value:y.type,onValueChange:t=>R(j(u({},y),{type:t})),children:[e.jsx(J,{children:e.jsx(W,{})}),e.jsxs(X,{children:[e.jsx(K,{value:"agreement_update",children:"Agreement Update"}),e.jsx(K,{value:"reminder",children:"Reminder"}),e.jsx(K,{value:"welcome",children:"Welcome"})]})]})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"template_subject",children:"Subject"}),e.jsx(O,{id:"template_subject",value:y.subject,onChange:t=>R(j(u({},y),{subject:t.target.value})),placeholder:"Email subject line"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"template_body",children:"Body"}),e.jsx(le,{id:"template_body",value:y.body,onChange:t=>R(j(u({},y),{body:t.target.value})),placeholder:"Email body content...",className:"min-h-[200px]"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(v,{variant:"outline",onClick:()=>d(!1),children:"Cancel"}),e.jsx(v,{onClick:M,children:I?"Update Template":"Create Template"})]})]})]})}),e.jsx(Y,{open:k,onOpenChange:F,children:e.jsxs(Z,{className:"max-w-2xl",children:[e.jsx(ee,{children:e.jsx(se,{children:"Send Notification"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"notification_agreement",children:"Agreement"}),e.jsxs(G,{value:i.agreement_id,onValueChange:t=>w(j(u({},i),{agreement_id:t})),children:[e.jsx(J,{children:e.jsx(W,{placeholder:"Select an agreement"})}),e.jsx(X,{children:q==null?void 0:q.map(t=>e.jsxs(K,{value:t.id,children:[t.title," v",t.version]},t.id))})]})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"notification_template",children:"Template (Optional)"}),e.jsxs(G,{value:i.template_id,onValueChange:t=>w(j(u({},i),{template_id:t})),children:[e.jsx(J,{children:e.jsx(W,{placeholder:"Select a template (optional)"})}),e.jsx(X,{children:h==null?void 0:h.map(t=>e.jsx(K,{value:t.id,children:t.name},t.id))})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(he,{id:"send_to_all",checked:i.send_to_all,onCheckedChange:t=>w(j(u({},i),{send_to_all:t}))}),e.jsx(g,{htmlFor:"send_to_all",children:"Send to all users needing acceptance"})]}),!i.send_to_all&&e.jsxs("div",{children:[e.jsx(g,{children:"Select Users"}),e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded-md p-2",children:x==null?void 0:x.map(t=>e.jsxs("div",{className:"flex items-center space-x-2 py-1",children:[e.jsx(he,{id:`user-${t.user_id}`,checked:i.selected_users.includes(t.user_id),onCheckedChange:Te=>{w(Te?j(u({},i),{selected_users:[...i.selected_users,t.user_id]}):j(u({},i),{selected_users:i.selected_users.filter(Ae=>Ae!==t.user_id)}))}}),e.jsxs(g,{htmlFor:`user-${t.user_id}`,className:"text-sm",children:[t.first_name," ",t.last_name," (",t.email,")"]})]},t.user_id))})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(v,{variant:"outline",onClick:()=>F(!1),children:"Cancel"}),e.jsx(v,{onClick:ae,disabled:r,children:r?"Sending...":"Send Notification"})]})]})]})})]})},Ze=()=>{const{user:o}=ge(),{toast:l}=oe(),[d,k]=U.useState(!1),[F,I]=U.useState(!1),[L,D]=U.useState(!1),[E,h]=U.useState(!1),[P,x]=U.useState(null),[Q,H]=U.useState("overview"),{agreements:a,isLoadingAgreements:r,refetchStatus:_}=ve(),[n,m]=U.useState({agreement_type:"terms_of_service",version:"",title:"",content:"",effective_date:new Date().toISOString().split("T")[0]}),[c,q]=U.useState({totalUsers:0,acceptedTerms:0,acceptedPrivacy:0,pendingAcceptance:0,recentAcceptances:[]});Le.useEffect(()=>{y()},[]);const y=()=>N(void 0,null,function*(){try{const{count:s}=yield f.from("profiles").select("*",{count:"exact",head:!0}),{data:p}=yield f.from("profiles").select("terms_accepted, privacy_policy_accepted"),z=(p==null?void 0:p.filter(t=>t.terms_accepted).length)||0,$=(p==null?void 0:p.filter(t=>t.privacy_policy_accepted).length)||0,ie=(s||0)-Math.min(z,$),{data:ne}=yield f.from("user_agreement_acceptances").select(`
          accepted_at,
          user_agreements!inner(agreement_type, version, title),
          profiles!inner(first_name, last_name, email)
        `).order("accepted_at",{ascending:!1}).limit(10);q({totalUsers:s||0,acceptedTerms:z,acceptedPrivacy:$,pendingAcceptance:ie,recentAcceptances:ne||[]})}catch(s){console.error("Error loading analytics:",s)}}),R=()=>N(void 0,null,function*(){if(!n.version||!n.title||!n.content){l({title:"Validation Error",description:"Please fill in all required fields",variant:"destructive"});return}k(!0);try{const{error:s}=yield f.from("user_agreements").insert(j(u({},n),{created_by:o==null?void 0:o.id,effective_date:new Date(n.effective_date).toISOString()}));if(s)throw s;l({title:"Success",description:"Agreement created successfully"}),D(!1),m({agreement_type:"terms_of_service",version:"",title:"",content:"",effective_date:new Date().toISOString().split("T")[0]}),_()}catch(s){l({title:"Error",description:s.message||"Failed to create agreement",variant:"destructive"})}finally{k(!1)}}),i=()=>N(void 0,null,function*(){if(P){I(!0);try{const{error:s}=yield f.from("user_agreements").update({title:n.title,content:n.content,effective_date:new Date(n.effective_date).toISOString()}).eq("id",P.id);if(s)throw s;l({title:"Success",description:"Agreement updated successfully"}),h(!1),x(null),_()}catch(s){l({title:"Error",description:s.message||"Failed to update agreement",variant:"destructive"})}finally{I(!1)}}}),w=s=>N(void 0,null,function*(){try{const{error:p}=yield f.from("user_agreements").update({is_active:!1}).eq("id",s);if(p)throw p;l({title:"Success",description:"Agreement deactivated successfully"}),_()}catch(p){l({title:"Error",description:p.message||"Failed to deactivate agreement",variant:"destructive"})}}),M=(s,p)=>N(void 0,null,function*(){try{l({title:"Notification Sent",description:`Email notification sent to users about ${s} v${p} update`})}catch(z){l({title:"Error",description:"Failed to send notification",variant:"destructive"})}}),ae=s=>{const p=new Blob([s.content],{type:"text/plain"}),z=URL.createObjectURL(p),$=document.createElement("a");$.href=z,$.download=`${s.agreement_type}_v${s.version}.txt`,document.body.appendChild($),$.click(),document.body.removeChild($),URL.revokeObjectURL(z)};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Agreement Management"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage user agreements, track acceptance, and send notifications"})]}),e.jsxs(v,{onClick:()=>D(!0),className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),"Create Agreement"]})]}),e.jsxs(_e,{value:Q,onValueChange:H,children:[e.jsxs(ye,{className:"grid w-full grid-cols-5",children:[e.jsx(V,{value:"overview",children:"Overview"}),e.jsx(V,{value:"agreements",children:"Agreements"}),e.jsx(V,{value:"analytics",children:"Analytics"}),e.jsx(V,{value:"notifications",children:"Notifications"}),e.jsx(V,{value:"notification-manager",children:"Notification Manager"})]}),e.jsxs(B,{value:"overview",className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(b,{children:[e.jsxs(S,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Total Users"}),e.jsx(Ce,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:c.totalUsers}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Registered users"})]})]}),e.jsxs(b,{children:[e.jsxs(S,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Terms Accepted"}),e.jsx(te,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:c.acceptedTerms}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[c.totalUsers>0?Math.round(c.acceptedTerms/c.totalUsers*100):0,"% acceptance rate"]})]})]}),e.jsxs(b,{children:[e.jsxs(S,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Privacy Accepted"}),e.jsx(te,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:c.acceptedPrivacy}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[c.totalUsers>0?Math.round(c.acceptedPrivacy/c.totalUsers*100):0,"% acceptance rate"]})]})]}),e.jsxs(b,{children:[e.jsxs(S,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Pending Acceptance"}),e.jsx(ce,{className:"h-4 w-4 text-orange-600"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:c.pendingAcceptance}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Need to accept agreements"})]})]})]}),e.jsxs(b,{children:[e.jsx(S,{children:e.jsx(C,{children:"Recent Agreement Acceptances"})}),e.jsx(T,{children:e.jsx("div",{className:"space-y-4",children:c.recentAcceptances.length>0?c.recentAcceptances.map((s,p)=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[s.profiles.first_name," ",s.profiles.last_name]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.user_agreements.title," v",s.user_agreements.version]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-medium",children:new Date(s.accepted_at).toLocaleDateString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(s.accepted_at).toLocaleTimeString()})]})]},p)):e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"No recent acceptances"})})})]})]}),e.jsx(B,{value:"agreements",className:"space-y-6",children:e.jsxs(b,{children:[e.jsx(S,{children:e.jsx(C,{children:"Active Agreements"})}),e.jsx(T,{children:r?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsx("div",{className:"space-y-4",children:a==null?void 0:a.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("h3",{className:"font-semibold",children:s.title}),e.jsxs(A,{variant:"outline",children:["v",s.version]}),e.jsx(A,{variant:s.is_active?"default":"secondary",children:s.is_active?"Active":"Inactive"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Effective: ",new Date(s.effective_date).toLocaleDateString()]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Type: ",s.agreement_type.replace("_"," ")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{variant:"outline",size:"sm",onClick:()=>ae(s),children:e.jsx(Ie,{className:"h-4 w-4"})}),e.jsx(v,{variant:"outline",size:"sm",onClick:()=>{x(s),m({agreement_type:s.agreement_type,version:s.version,title:s.title,content:s.content,effective_date:s.effective_date.split("T")[0]}),h(!0)},children:e.jsx(Se,{className:"h-4 w-4"})}),s.is_active&&e.jsx(v,{variant:"outline",size:"sm",onClick:()=>w(s.id),children:e.jsx(Pe,{className:"h-4 w-4"})})]})]},s.id))})})]})}),e.jsx(B,{value:"analytics",className:"space-y-6",children:e.jsxs(b,{children:[e.jsx(S,{children:e.jsx(C,{children:"Agreement Analytics"})}),e.jsx(T,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Acceptance Trends"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Terms of Service"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-32 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full",style:{width:`${c.totalUsers>0?c.acceptedTerms/c.totalUsers*100:0}%`}})}),e.jsxs("span",{className:"text-sm font-medium",children:[c.acceptedTerms,"/",c.totalUsers]})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Privacy Policy"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-32 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-green-600 h-2 rounded-full",style:{width:`${c.totalUsers>0?c.acceptedPrivacy/c.totalUsers*100:0}%`}})}),e.jsxs("span",{className:"text-sm font-medium",children:[c.acceptedPrivacy,"/",c.totalUsers]})]})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Version Distribution"}),e.jsx("div",{className:"space-y-2",children:a==null?void 0:a.map(s=>e.jsxs("div",{className:"flex justify-between items-center p-2 bg-muted rounded",children:[e.jsxs("span",{className:"text-sm",children:[s.title," v",s.version]}),e.jsx(A,{variant:"outline",children:s.agreement_type})]},s.id))})]})]})})]})}),e.jsx(B,{value:"notifications",className:"space-y-6",children:e.jsxs(b,{children:[e.jsx(S,{children:e.jsx(C,{children:"Send Agreement Update Notifications"})}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(Ne,{children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx(we,{children:"Send email notifications to users when agreements are updated. Users will be prompted to accept the new version on their next login."})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:a==null?void 0:a.filter(s=>s.is_active).map(s=>e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium",children:s.title}),e.jsxs(A,{variant:"outline",children:["v",s.version]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:s.agreement_type.replace("_"," ")}),e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>M(s.agreement_type,s.version),className:"w-full",children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Send Notification"]})]},s.id))})]})})]})}),e.jsx(B,{value:"notification-manager",className:"space-y-6",children:e.jsx(Oe,{})})]}),e.jsx(Y,{open:L,onOpenChange:D,children:e.jsxs(Z,{className:"max-w-4xl max-h-[90vh]",children:[e.jsx(ee,{children:e.jsx(se,{children:"Create New Agreement"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"agreement_type",children:"Agreement Type"}),e.jsxs(G,{value:n.agreement_type,onValueChange:s=>m(j(u({},n),{agreement_type:s})),children:[e.jsx(J,{children:e.jsx(W,{})}),e.jsxs(X,{children:[e.jsx(K,{value:"terms_of_service",children:"Terms of Service"}),e.jsx(K,{value:"privacy_policy",children:"Privacy Policy"})]})]})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"version",children:"Version"}),e.jsx(O,{id:"version",value:n.version,onChange:s=>m(j(u({},n),{version:s.target.value})),placeholder:"e.g., 1.1.0"})]})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"title",children:"Title"}),e.jsx(O,{id:"title",value:n.title,onChange:s=>m(j(u({},n),{title:s.target.value})),placeholder:"Agreement title"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"effective_date",children:"Effective Date"}),e.jsx(O,{id:"effective_date",type:"date",value:n.effective_date,onChange:s=>m(j(u({},n),{effective_date:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"content",children:"Content"}),e.jsx(le,{id:"content",value:n.content,onChange:s=>m(j(u({},n),{content:s.target.value})),placeholder:"Enter agreement content...",className:"min-h-[400px]"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(v,{variant:"outline",onClick:()=>D(!1),children:"Cancel"}),e.jsx(v,{onClick:R,disabled:d,children:d?"Creating...":"Create Agreement"})]})]})]})}),e.jsx(Y,{open:E,onOpenChange:h,children:e.jsxs(Z,{className:"max-w-4xl max-h-[90vh]",children:[e.jsx(ee,{children:e.jsx(se,{children:"Edit Agreement"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{children:"Agreement Type"}),e.jsx(O,{value:n.agreement_type.replace("_"," "),disabled:!0})]}),e.jsxs("div",{children:[e.jsx(g,{children:"Version"}),e.jsx(O,{value:n.version,disabled:!0})]})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"edit_title",children:"Title"}),e.jsx(O,{id:"edit_title",value:n.title,onChange:s=>m(j(u({},n),{title:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"edit_effective_date",children:"Effective Date"}),e.jsx(O,{id:"edit_effective_date",type:"date",value:n.effective_date,onChange:s=>m(j(u({},n),{effective_date:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"edit_content",children:"Content"}),e.jsx(le,{id:"edit_content",value:n.content,onChange:s=>m(j(u({},n),{content:s.target.value})),className:"min-h-[400px]"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(v,{variant:"outline",onClick:()=>h(!1),children:"Cancel"}),e.jsx(v,{onClick:i,disabled:F,children:F?"Updating...":"Update Agreement"})]})]})]})})]})};export{Ze as default};
