var we=Object.defineProperty,ye=Object.defineProperties;var Ne=Object.getOwnPropertyDescriptors;var te=Object.getOwnPropertySymbols;var ve=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var re=(t,i,s)=>i in t?we(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s,ne=(t,i)=>{for(var s in i||(i={}))ve.call(i,s)&&re(t,s,i[s]);if(te)for(var s of te(i))be.call(i,s)&&re(t,s,i[s]);return t},ie=(t,i)=>ye(t,Ne(i));var A=(t,i,s)=>new Promise((n,l)=>{var r=d=>{try{o(s.next(d))}catch(g){l(g)}},y=d=>{try{o(s.throw(d))}catch(g){l(g)}},o=d=>d.done?n(d.value):Promise.resolve(d.value).then(r,y);o((s=s.apply(t,i)).next())});import{j as e}from"./ui-vendor-DMUr7mTx.js";import{r as v,a as le}from"./react-vendor-BvqlMsL5.js";import{K as _e,N as Ce,O as Pe,Q as Ee,e as Se,u as ee,P as Te,B as f,C as I,a as L,b as R,c as De,d as $,l as he,D as me,m as xe,n as Y,o as K,p as W,L as p,I as j,A as J,g as H,s as U,G as oe}from"./index-ZwIgorfy.js";import{u as ze}from"./useDrivers-BY9VTvBN.js";import{T as Fe,a as ke,b as Q,c as F,d as Ae,e as P}from"./table-6WL4qh3Z.js";import{E as Oe,O as Ie}from"./DriverStatusBadges-COsAPelL.js";import{J as ue,ao as $e,aO as Ue,aA as Me,k as Be,$ as Le,F as Re,D as qe,y as Je,g as He,aa as G,am as Z,aP as ge,aE as pe,h as Ve,aQ as Qe,T as je,aR as ce,an as de,E as Xe,f as Ye,j as Ke}from"./icons-vendor-b0I7fGSL.js";import{f as We}from"./utils-vendor-B2FlkASS.js";import{a as Ge}from"./router-vendor-CEyBJ8vK.js";import{a as Ze,b as es}from"./query-vendor-B2F_wWlc.js";import"./supabase-vendor-B984m0TI.js";import"./ui-components-7w1-MJre.js";const ss=({missingDocuments:t=[],completedDocuments:i=[]})=>{const s={driver_license:{icon:Ue,label:"Driver License"},medical_certificate:{icon:Me,label:"Medical Certificate"},insurance:{icon:Be,label:"Insurance Documents"},emergency_contact:{icon:Le,label:"Emergency Contact"},tax_forms:{icon:Re,label:"Tax Forms (W-4)"},direct_deposit:{icon:qe,label:"Direct Deposit Form"},photo_id:{icon:Je,label:"Photo ID Badge"}},n=Object.keys(s);return e.jsx(_e,{children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[n.map(l=>{const r=s[l],y=r.icon,o=i.includes(l),d=t.includes(l);return e.jsxs(Ce,{children:[e.jsx(Pe,{asChild:!0,children:e.jsxs("div",{className:"relative",children:[e.jsx(y,{className:`w-4 h-4 ${o?"text-green-600":d?"text-red-500":"text-gray-400"}`}),o&&e.jsx(ue,{className:"w-2 h-2 text-green-600 absolute -top-1 -right-1 bg-white rounded-full"}),d&&e.jsx($e,{className:"w-2 h-2 text-red-500 absolute -top-1 -right-1 bg-white rounded-full"})]})}),e.jsx(Ee,{children:e.jsxs("p",{children:[r.label,": ",o?"Completed":d?"Missing":"Not Required"]})})]},l)}),t.length>0&&e.jsxs(Se,{variant:"destructive",className:"ml-2 text-xs",children:[t.length," missing"]})]})})},fe=()=>{const{profile:t}=ee(),i=(t==null?void 0:t.role)==="admin",s=(t==null?void 0:t.role)==="council",n=(t==null?void 0:t.role)==="super_admin",l=i||s||n,r=t==null?void 0:t.organization_id;return{isAdmin:i,isCouncil:s,isSuperAdmin:n,canManagePasswords:l,organizationId:r,profile:t}},as=({drivers:t,onViewDriver:i,onPasswordChange:s})=>{const{canManagePasswords:n,organizationId:l}=fe();return e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Fe,{children:[e.jsx(ke,{children:e.jsxs(Q,{children:[e.jsx(F,{children:"Name"}),e.jsx(F,{children:"Email"}),e.jsx(F,{children:"Employment Status"}),e.jsx(F,{children:"Onboarding Status"}),e.jsx(F,{children:"Progress"}),e.jsx(F,{children:"Documents"}),e.jsx(F,{children:"Hire Date"}),e.jsx(F,{children:"Actions"})]})}),e.jsxs(Ae,{children:[t==null?void 0:t.map(r=>e.jsxs(Q,{children:[e.jsxs(P,{className:"font-medium",children:[r.first_name," ",r.last_name]}),e.jsx(P,{children:r.email}),e.jsx(P,{children:e.jsx(Oe,{status:r.employment_status||"applicant"})}),e.jsx(P,{children:e.jsx(Ie,{status:r.onboarding_status||"pending"})}),e.jsx(P,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Te,{value:r.onboarding_progress||0,className:"w-20"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[r.completed_tasks||0,"/",r.total_tasks||0]})]})}),e.jsx(P,{children:e.jsx(ss,{missingDocuments:r.missing_documents,completedDocuments:r.completed_documents})}),e.jsx(P,{children:r.hire_date?e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(He,{className:"w-4 h-4"}),e.jsx("span",{children:We(new Date(r.hire_date),"MMM dd, yyyy")})]}):e.jsx("span",{className:"text-gray-400",children:"Not hired"})}),e.jsx(P,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>i(r.id),className:"flex items-center space-x-1",children:[e.jsx(G,{className:"w-4 h-4"}),e.jsx("span",{children:"View"})]}),s&&n&&(r.organization_id===l?e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>s({id:r.id,email:r.email,first_name:r.first_name,last_name:r.last_name,organization_id:r.organization_id}),className:"flex items-center space-x-1",children:[e.jsx(Z,{className:"w-4 h-4"}),e.jsx("span",{children:"Password"})]}):e.jsxs(f,{variant:"outline",size:"sm",disabled:!0,className:"flex items-center space-x-1 opacity-50 cursor-not-allowed",title:"Can only change passwords for drivers in your organization",children:[e.jsx(Z,{className:"w-4 h-4"}),e.jsx("span",{children:"Password"})]}))]})})]},r.id)),(!t||t.length===0)&&e.jsx(Q,{children:e.jsx(P,{colSpan:8,className:"text-center py-8",children:e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx(ge,{className:"w-8 h-8 text-gray-400"}),e.jsx("span",{className:"text-gray-500",children:"No drivers found"})]})})})]})]})})},ts=({drivers:t,isLoading:i,onPasswordChange:s})=>{const n=Ge(),l=r=>{n(`/drivers/${r}`)};return i?e.jsx("div",{className:"flex items-center justify-center p-8",children:"Loading drivers..."}):e.jsx(e.Fragment,{children:e.jsxs(I,{children:[e.jsxs(L,{children:[e.jsxs(R,{className:"flex items-center space-x-2",children:[e.jsx(pe,{className:"w-5 h-5"}),e.jsx("span",{children:"Drivers Overview"})]}),e.jsx(De,{children:"Manage driver onboarding and employment status"})]}),e.jsx($,{children:e.jsx(as,{drivers:t,onViewDriver:l,onPasswordChange:s})})]})})},rs="https://dznbihypzmvcmradijqn.supabase.co",ns=({open:t,onOpenChange:i,onDriverAdded:s})=>{const[n,l]=v.useState({first_name:"",last_name:"",email:"",phone:"",address:"",city:"",state:"",zip_code:"",hire_date:"",termination_date:"",cdl_number:"",medical_card_expiry:""}),[r,y]=v.useState(null),{toast:o}=he(),d=Ze(),g=es({mutationFn:a=>A(void 0,null,function*(){console.log("Creating driver with data:",a);const{data:{session:h},error:w}=yield U.auth.getSession();if(w||!h)throw new Error("You must be logged in to create drivers. Please log in and try again.");console.log("Session found, calling create-driver function...");const{data:u,error:_}=yield U.functions.invoke("create-driver",{body:{email:a.email,firstName:a.first_name,lastName:a.last_name,phone:a.phone||null,address:a.address||null,city:a.city||null,state:a.state||null,zipCode:a.zip_code||null,hireDate:a.hire_date||null,cdlNumber:a.cdl_number||null,medicalCardExpiry:a.medical_card_expiry||null}});if(console.log("Edge Function response:",{data:u,error:_}),_)if(console.error("Error creating driver:",_),_.message&&_.message.includes("non-2xx status code")){console.log("Attempting direct fetch to get detailed error...");try{const N=yield fetch(`${rs}/functions/v1/create-driver`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h.access_token}`},body:JSON.stringify({email:a.email,firstName:a.first_name,lastName:a.last_name,phone:a.phone||null,address:a.address||null,city:a.city||null,state:a.state||null,zipCode:a.zip_code||null,hireDate:a.hire_date||null,cdlNumber:a.cdl_number||null,medicalCardExpiry:a.medical_card_expiry||null})}),m=yield N.text();if(console.log("Direct fetch response:",{status:N.status,statusText:N.statusText,body:m}),!N.ok)throw new Error(`Driver creation failed: ${N.status} ${N.statusText} - ${m}`)}catch(N){throw console.error("Direct fetch also failed:",N),new Error("Driver creation failed. Please check the Edge Function logs for details.")}}else throw _;if(u!=null&&u.error)throw console.error("Edge Function returned error:",u.error),new Error(u.error);return u}),onSuccess:a=>{d.invalidateQueries({queryKey:["drivers"]}),y({email:n.email,temporaryPassword:a.temporaryPassword||"Contact admin for password",emailSent:a.emailSent});const h=a.emailSent?"Driver created successfully and welcome email sent!":"Driver created successfully. Email failed - please share credentials manually.";o({title:"Success",description:h}),s==null||s()},onError:a=>{var w;console.error("Driver creation error:",a);let h="Failed to create driver. Please try again.";if(a.message)h=a.message;else if((w=a.context)!=null&&w.body)try{h=(typeof a.context.body=="string"?JSON.parse(a.context.body):a.context.body).error||h}catch(u){console.error("Error parsing error body:",u)}else a.details&&(h=a.details);o({title:"Error",description:h,variant:"destructive"})}}),x=a=>{const{name:h,value:w}=a.target;l(u=>ie(ne({},u),{[h]:w}))},b=a=>A(void 0,null,function*(){if(a.preventDefault(),!n.first_name||!n.last_name||!n.email){o({title:"Validation Error",description:"Please fill in all required fields (First Name, Last Name, Email).",variant:"destructive"});return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n.email)){o({title:"Validation Error",description:"Please enter a valid email address.",variant:"destructive"});return}g.mutate(n)}),C=a=>A(void 0,null,function*(){try{yield navigator.clipboard.writeText(a),o({title:"Copied",description:"Copied to clipboard"})}catch(h){console.error("Failed to copy: ",h)}}),E=()=>{y(null),l({first_name:"",last_name:"",email:"",phone:"",address:"",city:"",state:"",zip_code:"",hire_date:"",termination_date:"",cdl_number:"",medical_card_expiry:""}),i(!1)};return e.jsx(me,{open:t,onOpenChange:E,children:e.jsx(xe,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:r?e.jsxs(e.Fragment,{children:[e.jsxs(Y,{children:[e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-5 h-5 text-green-600"}),"Driver Created Successfully"]}),e.jsx(W,{children:"The driver account has been created. Please share these login credentials with the new driver."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(J,{className:r.emailSent?"border-green-200 bg-green-50":"border-yellow-200 bg-yellow-50",children:[r.emailSent?e.jsx(Ve,{className:"h-4 w-4 text-green-600"}):e.jsx(Qe,{className:"h-4 w-4 text-yellow-600"}),e.jsx(H,{children:r.emailSent?e.jsxs("span",{className:"text-green-800",children:[e.jsx("strong",{children:"Email Sent:"})," Welcome email with login credentials has been sent to the driver."]}):e.jsxs("span",{className:"text-yellow-800",children:[e.jsx("strong",{children:"Email Failed:"})," Please share the credentials manually with the driver."]})})]}),e.jsxs(J,{children:[e.jsx(je,{className:"h-4 w-4"}),e.jsxs(H,{children:[e.jsx("strong",{children:"Important:"})," The driver will be required to change their password on first login for security."]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg space-y-3",children:[e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-700",children:"Email"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(j,{value:r.email,readOnly:!0,className:"bg-white"}),e.jsx(f,{variant:"outline",size:"sm",onClick:()=>C(r.email),children:e.jsx(ce,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-700",children:"Temporary Password"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(j,{value:r.temporaryPassword,readOnly:!0,className:"bg-white font-mono"}),e.jsx(f,{variant:"outline",size:"sm",onClick:()=>C(r.temporaryPassword),children:e.jsx(ce,{className:"w-4 h-4"})})]})]})]}),e.jsxs("div",{className:"text-sm text-gray-600 space-y-2",children:[e.jsx("p",{children:e.jsx("strong",{children:"Next Steps:"})}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e.jsx("li",{children:"Share these credentials with the new driver"}),e.jsx("li",{children:"The driver must log in and change their password immediately"}),e.jsx("li",{children:"The temporary password will only work for the first login"})]})]}),e.jsx(f,{onClick:E,className:"w-full",children:"Close"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(K,{children:"Add New Driver"}),e.jsx(W,{children:"Fill out the form below to add a new driver to the system. Required fields are marked with *."})]}),e.jsxs("form",{onSubmit:b,className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(p,{htmlFor:"first_name",children:"First Name *"}),e.jsx(j,{type:"text",id:"first_name",name:"first_name",value:n.first_name,onChange:x,required:!0,placeholder:"Enter first name"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"last_name",children:"Last Name *"}),e.jsx(j,{type:"text",id:"last_name",name:"last_name",value:n.last_name,onChange:x,required:!0,placeholder:"Enter last name"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(p,{htmlFor:"email",children:"Email *"}),e.jsx(j,{type:"email",id:"email",name:"email",value:n.email,onChange:x,required:!0,placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"phone",children:"Phone Number"}),e.jsx(j,{type:"tel",id:"phone",name:"phone",value:n.phone,onChange:x,placeholder:"Enter phone number"})]})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"address",children:"Address"}),e.jsx(j,{type:"text",id:"address",name:"address",value:n.address,onChange:x,placeholder:"Enter street address"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(p,{htmlFor:"city",children:"City"}),e.jsx(j,{type:"text",id:"city",name:"city",value:n.city,onChange:x,placeholder:"Enter city"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"state",children:"State"}),e.jsx(j,{type:"text",id:"state",name:"state",value:n.state,onChange:x,placeholder:"Enter state"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"zip_code",children:"Zip Code"}),e.jsx(j,{type:"text",id:"zip_code",name:"zip_code",value:n.zip_code,onChange:x,placeholder:"Enter zip code"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(p,{htmlFor:"hire_date",children:"Hire Date"}),e.jsx(j,{type:"date",id:"hire_date",name:"hire_date",value:n.hire_date,onChange:x})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"termination_date",children:"Termination Date (Optional)"}),e.jsx(j,{type:"date",id:"termination_date",name:"termination_date",value:n.termination_date,onChange:x})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(p,{htmlFor:"cdl_number",children:"CDL Number"}),e.jsx(j,{type:"text",id:"cdl_number",name:"cdl_number",value:n.cdl_number,onChange:x,placeholder:"Enter CDL number"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"medical_card_expiry",children:"Medical Card Expiry"}),e.jsx(j,{type:"date",id:"medical_card_expiry",name:"medical_card_expiry",value:n.medical_card_expiry,onChange:x})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx(f,{type:"button",variant:"outline",onClick:E,disabled:g.isPending,children:"Cancel"}),e.jsx(f,{type:"submit",disabled:g.isPending,children:g.isPending?"Creating...":"Create Driver"})]})]})]})})})},X="https://dznbihypzmvcmradijqn.supabase.co",is=({isOpen:t,onClose:i,driver:s})=>{const[n,l]=v.useState(""),[r,y]=v.useState(""),[o,d]=v.useState(!1),[g,x]=v.useState(!1),[b,C]=v.useState(!1),[E,a]=v.useState(""),[h,w]=v.useState(!1),{toast:u}=he(),{canManagePasswords:_,organizationId:N}=fe(),{user:m}=ee(),S=()=>A(void 0,null,function*(){if(!(!s||!_)){if(s.organization_id&&s.organization_id!==N){a("You can only change passwords for drivers in your organization.");return}if(!n||!r){a("Please fill in all fields");return}if(n.length<6){a("Password must be at least 6 characters long");return}if(n!==r){a("Passwords do not match");return}w(!0)}}),T=()=>A(void 0,null,function*(){if(!(!s||!m)){C(!0),a("");try{if(!s.id)throw new Error("Invalid driver selected. Please refresh the page and try again.");if(s.organization_id&&s.organization_id!==N)throw new Error("Access denied: You can only change passwords for drivers in your organization.");console.log("Calling Edge Function with parameters:",{targetUserId:s.id,adminUserId:m.id,hasNewPassword:!!n});const{data:{session:c}}=yield U.auth.getSession();if(!c)throw new Error("No active session found. Please log in again.");const{data:D,error:O}=yield U.functions.invoke("change-user-password",{body:{targetUserId:s.id,newPassword:n,adminUserId:m.id}});if(console.log("Edge Function response:",{data:D,error:O}),O)if(console.error("Edge Function error:",O),O.message&&O.message.includes("non-2xx status code")){console.log("Attempting direct fetch to get detailed error...");try{const z=yield fetch(`${X}/functions/v1/change-user-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c.access_token}`},body:JSON.stringify({targetUserId:s.id,newPassword:n,adminUserId:m.id})}),V=yield z.text();if(console.log("Direct fetch response:",{status:z.status,statusText:z.statusText,body:V}),!z.ok){const q=JSON.parse(V);if(q.error&&q.error.includes("Target user not found"))throw new Error("The selected driver no longer exists. Please refresh the page and try again.");if(q.error&&q.error.includes("User not found in authentication system")){console.log("User not found in Auth, attempting to create Auth user...");const M=yield fetch(`${X}/functions/v1/create-missing-auth-user`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c.access_token}`},body:JSON.stringify({profileId:s.id,adminUserId:m.id})}),se=yield M.text();if(console.log("Create Auth user response:",{status:M.status,body:se}),M.ok){console.log("Auth user created successfully, now trying password change again...");const B=yield fetch(`${X}/functions/v1/change-user-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c.access_token}`},body:JSON.stringify({targetUserId:s.id,newPassword:n,adminUserId:m.id})}),ae=yield B.text();if(console.log("Retry password change response:",{status:B.status,body:ae}),!B.ok)throw new Error(`Password change failed after creating Auth user: ${B.status} ${B.statusText} - ${ae}`);u({title:"Password Updated",description:`Password for ${s.email} has been successfully updated.`}),l(""),y(""),w(!1),i();return}else throw new Error(`Failed to create Auth user: ${M.status} ${M.statusText} - ${se}`)}else throw new Error(`Password change failed: ${z.status} ${z.statusText} - ${V}`)}}catch(z){throw console.error("Direct fetch also failed:",z),new Error("Password change failed. Please check the Edge Function logs for details.")}}else throw O;if(D!=null&&D.error)throw console.error("Edge Function data error:",D.error),new Error(D.error);u({title:"Password Updated",description:`Password for ${s.email} has been successfully updated.`}),l(""),y(""),w(!1),i()}catch(c){console.error("Error updating password:",c),console.error("Error details:",{message:c.message,status:c.status,statusText:c.statusText,data:c.data}),c.message&&(c.message.includes("no longer exists")||c.message.includes("Invalid driver selected")||c.message.includes("Target user not found"))?a(`${c.message} The driver list may be outdated. Please refresh the page.`):a(c.message||"Failed to update password. Please try again.")}finally{C(!1)}}}),k=()=>{l(""),y(""),a(""),d(!1),x(!1),w(!1),i()};return!s||!_?null:e.jsx(me,{open:t,onOpenChange:k,children:e.jsxs(xe,{className:"sm:max-w-md",children:[e.jsxs(Y,{children:[e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5"}),"Change Driver Password"]}),e.jsxs(W,{children:["Update the password for"," ",e.jsxs("span",{className:"font-medium",children:[s.first_name," ",s.last_name]})," ","(",s.email,")"]})]}),h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-4",children:e.jsxs(J,{children:[e.jsx(je,{className:"h-4 w-4"}),e.jsxs(H,{children:["Are you sure you want to change the password for"," ",e.jsxs("span",{className:"font-medium",children:[s.first_name," ",s.last_name]}),"?",e.jsx("br",{}),e.jsx("br",{}),"This action will immediately update their login credentials. They will need to use the new password to access their account."]})]})}),e.jsxs(oe,{className:"flex gap-2",children:[e.jsx(f,{variant:"outline",onClick:()=>w(!1),disabled:b,children:"Back"}),e.jsx(f,{onClick:T,disabled:b,variant:"destructive",children:b?"Updating...":"Confirm Password Change"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4",children:[E&&e.jsx(J,{variant:"destructive",children:e.jsx(H,{children:E})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"newPassword",children:"New Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(j,{id:"newPassword",type:o?"text":"password",value:n,onChange:c=>l(c.target.value),placeholder:"Enter new password",className:"pr-10"}),e.jsx(f,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>d(!o),children:o?e.jsx(de,{className:"h-4 w-4"}):e.jsx(G,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"confirmPassword",children:"Confirm Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(j,{id:"confirmPassword",type:g?"text":"password",value:r,onChange:c=>y(c.target.value),placeholder:"Confirm new password",className:"pr-10"}),e.jsx(f,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>x(!g),children:g?e.jsx(de,{className:"h-4 w-4"}):e.jsx(G,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsx("p",{children:"• Password must be at least 6 characters long"}),e.jsx("p",{children:"• The driver will need to use this password to log in"})]})]}),e.jsxs(oe,{className:"flex gap-2",children:[e.jsx(f,{variant:"outline",onClick:k,disabled:b,children:"Cancel"}),e.jsx(f,{onClick:S,disabled:b||!n||!r,children:"Continue"})]})]})]})})};function ys(){const{profile:t}=ee(),[i,s]=v.useState(!1),[n,l]=v.useState(!1),[r,y]=v.useState(null),{data:o=[],isLoading:d,error:g,refetch:x}=ze(),[b,C]=le.useState("testing");le.useEffect(()=>{A(this,null,function*(){try{console.log("Testing Supabase connection..."),C("testing");const{data:S,error:T}=yield U.from("profiles").select("count").limit(1);if(T)console.error("Supabase connection test failed:",T),C("error");else if(console.log("Supabase connection test successful:",S),C("connected"),t!=null&&t.organization_id){console.log("Testing organization query for org:",t.organization_id);const{data:k,error:c}=yield U.from("profiles").select("id, email, first_name, last_name, role, organization_id").eq("organization_id",t.organization_id);c?console.error("Organization query failed:",c):(console.log("Organization profiles found:",k),console.log("Drivers in organization:",k==null?void 0:k.filter(D=>D.role==="driver")))}}catch(S){console.error("Supabase connection test error:",S),C("error")}})},[t==null?void 0:t.organization_id]);const E=()=>{s(!1),x()},a=m=>{y(m),l(!0)},h=()=>{l(!1),y(null)},w=o.length,u=o.filter(m=>m.is_active).length,_=o.filter(m=>!m.is_active).length,N=o.filter(m=>{const S=m.hire_date?new Date(m.hire_date):null,T=new Date;return T.setDate(T.getDate()-30),S&&S>T}).length;return g?e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Driver Management"}),e.jsx(I,{children:e.jsx($,{className:"p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-destructive",children:["Error loading drivers: ",g.message]}),e.jsxs("div",{className:"mt-4 p-4 bg-gray-100 rounded text-left",children:[e.jsx("p",{children:e.jsx("strong",{children:"Debug Info:"})}),e.jsxs("p",{children:["Organization ID: ",(r==null?void 0:r.organization_id)||"Not available"]}),e.jsxs("p",{children:["Error details: ",JSON.stringify(g,null,2)]})]}),e.jsx(f,{onClick:()=>x(),className:"mt-4",children:"Try Again"})]})})})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Driver Management"}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Connection Status:"}),b==="testing"&&e.jsx("span",{className:"text-sm text-yellow-600",children:"Testing..."}),b==="connected"&&e.jsx("span",{className:"text-sm text-green-600",children:"Connected"}),b==="error"&&e.jsx("span",{className:"text-sm text-red-600",children:"Connection Error"})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(f,{onClick:()=>s(!0),children:[e.jsx(Xe,{className:"w-4 h-4 mr-2"}),"Add Driver"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(I,{children:[e.jsxs(L,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(R,{className:"text-sm font-medium",children:"Total Drivers"}),e.jsx(Ye,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs($,{children:[e.jsx("div",{className:"text-2xl font-bold",children:w}),w===0&&!d&&e.jsx("div",{className:"mt-2 p-2 bg-yellow-50 rounded text-xs text-yellow-800",children:"No drivers found. Check console for debug info."})]})]}),e.jsxs(I,{children:[e.jsxs(L,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(R,{className:"text-sm font-medium",children:"Active Drivers"}),e.jsx(pe,{className:"h-4 w-4 text-green-600"})]}),e.jsx($,{children:e.jsx("div",{className:"text-2xl font-bold",children:u})})]}),e.jsxs(I,{children:[e.jsxs(L,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(R,{className:"text-sm font-medium",children:"Inactive Drivers"}),e.jsx(ge,{className:"h-4 w-4 text-red-600"})]}),e.jsx($,{children:e.jsx("div",{className:"text-2xl font-bold",children:_})})]}),e.jsxs(I,{children:[e.jsxs(L,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(R,{className:"text-sm font-medium",children:"New This Month"}),e.jsx(Ke,{className:"h-4 w-4 text-blue-600"})]}),e.jsx($,{children:e.jsx("div",{className:"text-2xl font-bold",children:N})})]})]}),e.jsx(ts,{drivers:o,isLoading:d,onPasswordChange:a}),e.jsx(ns,{open:i,onOpenChange:s,onDriverAdded:E}),e.jsx(is,{isOpen:n,onClose:h,driver:r})]})}export{ys as default};
