var l=(h,i,e)=>new Promise((t,s)=>{var a=c=>{try{f(e.next(c))}catch(d){s(d)}},n=c=>{try{f(e.throw(c))}catch(d){s(d)}},f=c=>c.done?t(c.value):Promise.resolve(c.value).then(a,n);f((e=e.apply(h,i)).next())});import{j as r}from"./ui-vendor-DMUr7mTx.js";import{r as x}from"./react-vendor-BvqlMsL5.js";import{b as N,a as S}from"./router-vendor-CEyBJ8vK.js";import{s as o,l as _,C as T,a as V,b as C,d as R,A as P,g as q,B as p}from"./index-ZwIgorfy.js";import{E as g}from"./emailService-CYvLt_Xb.js";import{h as y,j as I,ao as D,J as A}from"./icons-vendor-b0I7fGSL.js";import"./supabase-vendor-B984m0TI.js";import"./utils-vendor-B2FlkASS.js";import"./query-vendor-B2F_wWlc.js";import"./ui-components-7w1-MJre.js";class v{static generateToken(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}static createVerificationToken(i,e="email_verification"){return l(this,null,function*(){try{const t=this.generateToken(),s=new Date;s.setHours(s.getHours()+24);const{error:a}=yield o.from("verification_tokens").insert({user_id:i,token:t,type:e,expires_at:s.toISOString(),used:!1});return a?(console.error("Error creating verification token:",a),null):t}catch(t){return console.error("Error creating verification token:",t),null}})}static sendVerificationEmail(i){return l(this,null,function*(){try{const{data:e,error:t}=yield o.from("profiles").select("email, first_name").eq("id",i).single();if(t||!e)return console.error("Error fetching user:",t),!1;const s=yield this.createVerificationToken(i,"email_verification");if(!s)return!1;const a=`${window.location.origin}/verify-email?token=${s}`;return yield g.sendVerificationEmail({to:e.email,firstName:e.first_name||"User",verificationUrl:a})}catch(e){return console.error("Error sending verification email:",e),!1}})}static verifyEmailToken(i){return l(this,null,function*(){try{const{data:e,error:t}=yield o.from("verification_tokens").select("*").eq("token",i).eq("type","email_verification").eq("used",!1).single();if(t||!e)return{success:!1,error:"Invalid or expired verification token"};const s=new Date,a=new Date(e.expires_at);if(s>a)return{success:!1,error:"Verification token has expired"};yield o.from("verification_tokens").update({used:!0}).eq("id",e.id);const{error:n}=yield o.from("profiles").update({email_verified:!0,email_verified_at:new Date().toISOString()}).eq("id",e.user_id);return n?(console.error("Error updating user verification status:",n),{success:!1,error:"Failed to update verification status"}):{success:!0,userId:e.user_id}}catch(e){return console.error("Error verifying email token:",e),{success:!1,error:"Verification failed"}}})}static sendPasswordResetEmail(i){return l(this,null,function*(){try{const{data:e,error:t}=yield o.from("profiles").select("id, first_name").eq("email",i).single();if(t||!e)return console.error("User not found:",t),!1;const s=yield this.createVerificationToken(e.id,"password_reset");if(!s)return!1;const a=`${window.location.origin}/reset-password?token=${s}`;return yield g.sendCustomEmail({to:i,subject:"Reset Your Password - LSR Transport",html:`
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Reset Your Password - LSR Transport</title>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .container { max-width: 600px; margin: 0 auto; padding: 20px; }
              .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
              .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
              .button { display: inline-block; background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; }
              .footer { text-align: center; margin-top: 30px; color: #666; font-size: 14px; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>Reset Your Password</h1>
                <p>LSR Transport Account Security</p>
              </div>
              <div class="content">
                <h2>Hi ${e.first_name||"User"},</h2>
                <p>We received a request to reset your password for your LSR Transport account. Click the button below to create a new password:</p>
                
                <div style="text-align: center;">
                  <a href="${a}" class="button">Reset Password</a>
                </div>
                
                <p>If the button doesn't work, you can copy and paste this link into your browser:</p>
                <p style="word-break: break-all; color: #667eea;">${a}</p>
                
                <p><strong>Security Note:</strong></p>
                <ul>
                  <li>This link will expire in 24 hours</li>
                  <li>If you didn't request a password reset, you can safely ignore this email</li>
                  <li>Your password will only be changed if you click the link above</li>
                </ul>
              </div>
              <div class="footer">
                <p>Â© 2024 LSR Transport. All rights reserved.</p>
                <p>This email was sent to ${i}</p>
              </div>
            </div>
          </body>
          </html>
        `})}catch(e){return console.error("Error sending password reset email:",e),!1}})}static verifyPasswordResetToken(i){return l(this,null,function*(){try{const{data:e,error:t}=yield o.from("verification_tokens").select("*").eq("token",i).eq("type","password_reset").eq("used",!1).single();if(t||!e)return{success:!1,error:"Invalid or expired reset token"};const s=new Date,a=new Date(e.expires_at);return s>a?{success:!1,error:"Password reset token has expired"}:{success:!0,userId:e.user_id}}catch(e){return console.error("Error verifying password reset token:",e),{success:!1,error:"Token verification failed"}}})}static resetPassword(i,e){return l(this,null,function*(){try{const t=yield this.verifyPasswordResetToken(i);if(!t.success)return{success:!1,error:t.error};const{error:s}=yield o.auth.admin.updateUserById(t.userId,{password:e});return s?(console.error("Error updating password:",s),{success:!1,error:"Failed to update password"}):(yield o.from("verification_tokens").update({used:!0}).eq("token",i),{success:!0})}catch(t){return console.error("Error resetting password:",t),{success:!1,error:"Password reset failed"}}})}static sendWelcomeEmail(i){return l(this,null,function*(){try{const{data:e,error:t}=yield o.from("profiles").select("email, first_name").eq("id",i).single();return t||!e?(console.error("Error fetching user:",t),!1):yield g.sendWelcomeEmail({to:e.email,firstName:e.first_name||"User",loginUrl:`${window.location.origin}/auth`})}catch(e){return console.error("Error sending welcome email:",e),!1}})}}const z=()=>{const[h]=N(),i=S(),{toast:e}=_(),[t,s]=x.useState("loading"),[a,n]=x.useState(""),[f,c]=x.useState(!1),d=h.get("token");x.useEffect(()=>{if(!d){s("error"),n("No verification token provided");return}k()},[d]);const k=()=>l(void 0,null,function*(){var m;try{const u=yield v.verifyEmailToken(d);u.success?(s("success"),yield v.sendWelcomeEmail(u.userId),e({title:"Email Verified Successfully!",description:"Your email has been verified. Welcome to LSR Transport!"})):(m=u.error)!=null&&m.includes("expired")?s("expired"):(s("error"),n(u.error||"Verification failed"))}catch(u){s("error"),n("An unexpected error occurred")}}),b=()=>l(void 0,null,function*(){if(d){c(!0);try{const{data:m}=yield o.from("verification_tokens").select("user_id").eq("token",d).single();if(m){const u=yield v.sendVerificationEmail(m.user_id);e(u?{title:"Verification Email Sent",description:"A new verification email has been sent to your inbox."}:{title:"Failed to Send Email",description:"Please try again later or contact support.",variant:"destructive"})}}catch(m){e({title:"Error",description:"Failed to resend verification email",variant:"destructive"})}finally{c(!1)}}}),w=()=>{i("/auth")},E=()=>{i("/dashboard")},j=()=>{switch(t){case"loading":return r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),r.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Verifying Your Email"}),r.jsx("p",{className:"text-muted-foreground",children:"Please wait while we verify your email address..."})]});case"success":return r.jsxs("div",{className:"text-center",children:[r.jsx(A,{className:"h-16 w-16 text-green-600 mx-auto mb-4"}),r.jsx("h2",{className:"text-2xl font-bold text-green-600 mb-2",children:"Email Verified Successfully!"}),r.jsx("p",{className:"text-muted-foreground mb-6",children:"Your email address has been verified. You can now access all features of LSR Transport."}),r.jsxs("div",{className:"space-y-3",children:[r.jsx(p,{onClick:E,className:"w-full",children:"Go to Dashboard"}),r.jsx(p,{variant:"outline",onClick:w,className:"w-full",children:"Sign In"})]})]});case"error":return r.jsxs("div",{className:"text-center",children:[r.jsx(D,{className:"h-16 w-16 text-red-600 mx-auto mb-4"}),r.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-2",children:"Verification Failed"}),r.jsx("p",{className:"text-muted-foreground mb-4",children:a||"We couldn't verify your email address. Please try again."}),r.jsxs("div",{className:"space-y-3",children:[r.jsx(p,{onClick:w,className:"w-full",children:"Go to Sign In"}),r.jsx(p,{variant:"outline",onClick:()=>window.location.reload(),className:"w-full",children:"Try Again"})]})]});case"expired":return r.jsxs("div",{className:"text-center",children:[r.jsx(I,{className:"h-16 w-16 text-orange-600 mx-auto mb-4"}),r.jsx("h2",{className:"text-2xl font-bold text-orange-600 mb-2",children:"Verification Link Expired"}),r.jsx("p",{className:"text-muted-foreground mb-6",children:"Your verification link has expired. Please request a new verification email."}),r.jsxs("div",{className:"space-y-3",children:[r.jsx(p,{onClick:b,disabled:f,className:"w-full",children:f?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Sending..."]}):r.jsxs(r.Fragment,{children:[r.jsx(y,{className:"h-4 w-4 mr-2"}),"Resend Verification Email"]})}),r.jsx(p,{variant:"outline",onClick:w,className:"w-full",children:"Go to Sign In"})]})]});default:return null}};return r.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4",children:r.jsxs(T,{className:"w-full max-w-md",children:[r.jsx(V,{className:"text-center",children:r.jsxs(C,{className:"flex items-center justify-center gap-2",children:[r.jsx(y,{className:"h-6 w-6"}),"Email Verification"]})}),r.jsxs(R,{children:[j(),t==="error"&&r.jsx(P,{className:"mt-6",children:r.jsx(q,{children:"If you continue to have issues, please contact our support team or try signing in again."})})]})]})})};export{z as default};
