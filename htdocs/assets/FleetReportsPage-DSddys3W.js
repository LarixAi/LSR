var q=(A,t,p)=>new Promise((R,b)=>{var D=m=>{try{c(p.next(m))}catch(a){b(a)}},V=m=>{try{c(p.throw(m))}catch(a){b(a)}},c=m=>m.done?R(m.value):Promise.resolve(m.value).then(D,V);c((p=p.apply(A,t)).next())});import{j as e}from"./ui-vendor-DMUr7mTx.js";import{r as I}from"./react-vendor-BvqlMsL5.js";import{u as se,s as y,S as O,q as G,r as P,t as U,v as x,B as w,C as l,d as i,h as ae,i as re,j as L,k as E,a as h,b as j,e as T,I as te}from"./index-ZwIgorfy.js";import{u as K}from"./query-vendor-B2F_wWlc.js";import{N as $}from"./router-vendor-CEyBJ8vK.js";import{a as F,Z as ne,ab as M,m as le,f as ie,l as H,J as ce,A as de,D as oe,aa as me,t as xe,g as he,F as je,j as ue}from"./icons-vendor-b0I7fGSL.js";import"./supabase-vendor-B984m0TI.js";import"./utils-vendor-B2FlkASS.js";import"./ui-components-7w1-MJre.js";const Le=()=>{const{user:A,profile:t,loading:p}=se(),[R,b]=I.useState("30d"),[D,V]=I.useState("overview"),[c,m]=I.useState("");if(p)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading fleet reports..."})]})});if(!A||!t)return e.jsx($,{to:"/auth",replace:!0});if(!["admin","council"].includes(t.role))return e.jsx($,{to:"/unauthorized",replace:!0});const{data:a,isLoading:J}=K({queryKey:["fleet-stats",t.organization_id],queryFn:()=>q(void 0,null,function*(){try{const{data:s,error:o}=yield y.from("vehicles").select("*").eq("organization_id",t.organization_id);if(o)return console.error("Error fetching vehicles:",o),null;const{data:N,error:r}=yield y.from("profiles").select("*").eq("organization_id",t.organization_id).eq("role","driver");if(r)return console.error("Error fetching drivers:",r),null;const{data:d,error:f}=yield y.from("fuel_purchases").select("*").eq("organization_id",t.organization_id);f&&console.error("Error fetching fuel purchases:",f);const _=(s==null?void 0:s.length)||0,k=(s==null?void 0:s.filter(n=>n.status==="active").length)||0,v=(s==null?void 0:s.filter(n=>n.status==="maintenance").length)||0,u=(N==null?void 0:N.length)||0,C=(s==null?void 0:s.reduce((n,g)=>n+(g.mileage||0),0))||0,W=(s==null?void 0:s.length)>0?s.reduce((n,g)=>n+(g.fuel_efficiency||0),0)/s.length:0,X=(d==null?void 0:d.reduce((n,g)=>n+(g.total_cost||0),0))||0,Y=(s==null?void 0:s.reduce((n,g)=>n+(g.maintenance_cost||0),0))||0,ee=(s==null?void 0:s.length)>0?s.filter(n=>n.compliance_status==="compliant").length/s.length*100:100;return{totalVehicles:_,activeVehicles:k,maintenanceVehicles:v,totalDrivers:u,totalMileage:C,averageFuelEfficiency:W,totalFuelCost:X,totalMaintenanceCost:Y,complianceRate:ee,incidentsThisMonth:0}}catch(s){return console.error("Error calculating fleet stats:",s),null}}),enabled:!!(t!=null&&t.organization_id)}),{data:z,isLoading:Q}=K({queryKey:["vehicle-reports",t.organization_id],queryFn:()=>q(void 0,null,function*(){try{const{data:s,error:o}=yield y.from("vehicles").select("*").eq("organization_id",t.organization_id);if(o)return console.error("Error fetching vehicles:",o),[];let N=new Map;try{const{data:r,error:d}=yield y.from("driver_vehicle_assignments").select("vehicle_id, driver_id, status").eq("organization_id",t.organization_id).eq("status","active");if(!d&&r&&r.length>0){const f=[...new Set(r.map(v=>v.driver_id))],{data:_,error:k}=yield y.from("profiles").select("id, first_name, last_name").in("id",f);if(!k&&_){const v=new Map;_.forEach(u=>{v.set(u.id,u)}),r.forEach(u=>{const C=v.get(u.driver_id);C&&N.set(u.vehicle_id,C)})}}else d&&console.warn("Driver assignments table not available:",d.message)}catch(r){console.warn("Driver assignments table not available, showing vehicles without driver info")}return o?(console.error("Error fetching vehicle reports:",o),[]):(s==null?void 0:s.map(r=>{const d=N.get(r.id),f=d?`${d.first_name||""} ${d.last_name||""}`.trim():"Unassigned";return{id:r.id,vehicleNumber:r.vehicle_number||"N/A",make:r.make||"N/A",model:r.model||"N/A",licensePlate:r.license_plate||"N/A",status:r.status||"unknown",mileage:r.mileage||0,fuelEfficiency:r.fuel_efficiency||0,lastMaintenance:r.last_maintenance_date?new Date(r.last_maintenance_date).toLocaleDateString():"N/A",nextMaintenance:r.next_maintenance_date?new Date(r.next_maintenance_date).toLocaleDateString():"N/A",driver:f,complianceStatus:r.compliance_status||"unknown"}}))||[]}catch(s){return console.error("Error fetching vehicle reports:",s),[]}}),enabled:!!(t!=null&&t.organization_id)}),Z=J||Q,S=s=>{const o={active:"bg-green-100 text-green-800 border-green-200",maintenance:"bg-yellow-100 text-yellow-800 border-yellow-200",inactive:"bg-gray-100 text-gray-800 border-gray-200",compliant:"bg-green-100 text-green-800 border-green-200",non_compliant:"bg-red-100 text-red-800 border-red-200",unknown:"bg-gray-100 text-gray-800 border-gray-200"};return o[s]||o.unknown},B=(z==null?void 0:z.filter(s=>!c||s.vehicleNumber.toLowerCase().includes(c.toLowerCase())||s.make.toLowerCase().includes(c.toLowerCase())||s.model.toLowerCase().includes(c.toLowerCase())||s.licensePlate.toLowerCase().includes(c.toLowerCase())||s.driver.toLowerCase().includes(c.toLowerCase())))||[];return Z?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading fleet data..."})]})}):e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(F,{className:"w-8 h-8 text-blue-600"}),"Fleet Reports"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Comprehensive fleet analytics and reporting"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(O,{value:R,onValueChange:b,children:[e.jsx(G,{className:"w-40",children:e.jsx(P,{})}),e.jsxs(U,{children:[e.jsx(x,{value:"7d",children:"Last 7 days"}),e.jsx(x,{value:"30d",children:"Last 30 days"}),e.jsx(x,{value:"90d",children:"Last 90 days"}),e.jsx(x,{value:"1y",children:"Last year"})]})]}),e.jsxs(w,{variant:"outline",children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"Refresh"]}),e.jsxs(w,{children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Export Report"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(l,{children:e.jsx(i,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(F,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Vehicles"}),e.jsx("p",{className:"text-2xl font-bold",children:(a==null?void 0:a.totalVehicles)||0}),e.jsxs("p",{className:"text-xs text-green-600 flex items-center gap-1",children:[e.jsx(le,{className:"w-3 h-3"}),(a==null?void 0:a.activeVehicles)||0," active"]})]})]})})}),e.jsx(l,{children:e.jsx(i,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ie,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Drivers"}),e.jsx("p",{className:"text-2xl font-bold",children:(a==null?void 0:a.totalDrivers)||0}),e.jsx("p",{className:"text-xs text-blue-600",children:"Assigned to vehicles"})]})]})})}),e.jsx(l,{children:e.jsx(i,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(H,{className:"w-8 h-8 text-orange-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Fuel Efficiency"}),e.jsxs("p",{className:"text-2xl font-bold",children:[(a==null?void 0:a.averageFuelEfficiency.toFixed(1))||0," mpg"]}),e.jsx("p",{className:"text-xs text-orange-600",children:"Average across fleet"})]})]})})}),e.jsx(l,{children:e.jsx(i,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ce,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Compliance Rate"}),e.jsxs("p",{className:"text-2xl font-bold",children:[(a==null?void 0:a.complianceRate.toFixed(1))||100,"%"]}),e.jsx("p",{className:"text-xs text-green-600",children:"All vehicles compliant"})]})]})})})]}),e.jsxs(ae,{defaultValue:"overview",className:"space-y-6",children:[e.jsxs(re,{className:"grid w-full grid-cols-4",children:[e.jsx(L,{value:"overview",children:"Overview"}),e.jsx(L,{value:"vehicles",children:"Vehicles"}),e.jsx(L,{value:"analytics",children:"Analytics"}),e.jsx(L,{value:"reports",children:"Reports"})]}),e.jsx(E,{value:"overview",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(l,{children:[e.jsx(h,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-5 h-5"}),"Fleet Status"]})}),e.jsx(i,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Active Vehicles"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:(a==null?void 0:a.activeVehicles)||0}),e.jsx(T,{variant:"outline",className:"bg-green-100 text-green-800",children:"Operational"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Maintenance"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:(a==null?void 0:a.maintenanceVehicles)||0}),e.jsx(T,{variant:"outline",className:"bg-yellow-100 text-yellow-800",children:"Service"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Total Mileage"}),e.jsxs("span",{className:"font-medium",children:[(a==null?void 0:a.totalMileage.toLocaleString())||0," miles"]})]})]})})]}),e.jsxs(l,{children:[e.jsx(h,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-5 h-5"}),"Cost Analysis"]})}),e.jsx(i,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Fuel Costs"}),e.jsxs("span",{className:"font-medium",children:["£",(a==null?void 0:a.totalFuelCost.toLocaleString())||0]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Maintenance Costs"}),e.jsxs("span",{className:"font-medium",children:["£",(a==null?void 0:a.totalMaintenanceCost.toLocaleString())||0]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Total Operating Cost"}),e.jsxs("span",{className:"font-medium text-lg",children:["£",(((a==null?void 0:a.totalFuelCost)||0)+((a==null?void 0:a.totalMaintenanceCost)||0)).toLocaleString()]})]})]})})]})]})}),e.jsxs(E,{value:"vehicles",className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(te,{placeholder:"Search vehicles...",value:c,onChange:s=>m(s.target.value),className:"max-w-sm"})}),e.jsxs(O,{value:D,onValueChange:V,children:[e.jsx(G,{className:"w-40",children:e.jsx(P,{})}),e.jsxs(U,{children:[e.jsx(x,{value:"all",children:"All Vehicles"}),e.jsx(x,{value:"active",children:"Active Only"}),e.jsx(x,{value:"maintenance",children:"In Maintenance"}),e.jsx(x,{value:"non_compliant",children:"Non-Compliant"})]})]})]}),e.jsxs(l,{children:[e.jsx(h,{children:e.jsx(j,{children:"Vehicle Details"})}),e.jsx(i,{children:e.jsx("div",{className:"space-y-4",children:B.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(F,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"text-lg font-medium",children:"No vehicles found"}),e.jsx("p",{children:"Try adjusting your search criteria"})]}):B.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx(F,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.vehicleNumber}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.make," ",s.model," • ",s.licensePlate]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Driver: ",s.driver," • Mileage: ",s.mileage.toLocaleString()," miles"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:S(s.status),children:s.status}),e.jsx(T,{className:S(s.complianceStatus),children:s.complianceStatus}),e.jsx(w,{variant:"outline",size:"sm",children:e.jsx(me,{className:"w-4 h-4"})})]})]},s.id))})})]})]}),e.jsx(E,{value:"analytics",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(l,{children:[e.jsx(h,{children:e.jsx(j,{children:"Fuel Efficiency Trends"})}),e.jsx(i,{children:e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(xe,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{children:"Fuel efficiency analytics chart will be displayed here"})]})})]}),e.jsxs(l,{children:[e.jsx(h,{children:e.jsx(j,{children:"Maintenance Schedule"})}),e.jsx(i,{children:e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(he,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{children:"Maintenance schedule chart will be displayed here"})]})})]})]})}),e.jsx(E,{value:"reports",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs(l,{children:[e.jsx(h,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(je,{className:"w-5 h-5"}),"Fleet Summary"]})}),e.jsxs(i,{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Comprehensive fleet summary with vehicle status and performance metrics."}),e.jsxs(w,{variant:"outline",className:"w-full",children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Generate Report"]})]})]}),e.jsxs(l,{children:[e.jsx(h,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(H,{className:"w-5 h-5"}),"Fuel Analysis"]})}),e.jsxs(i,{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Detailed fuel consumption analysis and cost breakdown."}),e.jsxs(w,{variant:"outline",className:"w-full",children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Generate Report"]})]})]}),e.jsxs(l,{children:[e.jsx(h,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-5 h-5"}),"Maintenance Report"]})}),e.jsxs(i,{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Maintenance history and upcoming service schedules."}),e.jsxs(w,{variant:"outline",className:"w-full",children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Generate Report"]})]})]})]})})]}),e.jsxs("div",{className:"text-center text-sm text-muted-foreground",children:["Last updated: ",new Date().toLocaleDateString()]})]})};export{Le as default};
