var de=Object.defineProperty,ce=Object.defineProperties;var oe=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var he=Object.prototype.hasOwnProperty,xe=Object.prototype.propertyIsEnumerable;var H=(t,i,s)=>i in t?de(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s,V=(t,i)=>{for(var s in i||(i={}))he.call(i,s)&&H(t,s,i[s]);if(O)for(var s of O(i))xe.call(i,s)&&H(t,s,i[s]);return t},B=(t,i)=>ce(t,oe(i));var w=(t,i,s)=>new Promise((n,h)=>{var a=x=>{try{j(s.next(x))}catch(l){h(l)}},f=x=>{try{j(s.throw(x))}catch(l){h(l)}},j=x=>x.done?n(x.value):Promise.resolve(x.value).then(a,f);j((s=s.apply(t,i)).next())});import{j as e}from"./ui-vendor-DMUr7mTx.js";import{r as I}from"./react-vendor-BvqlMsL5.js";import{u as z,s as N,D as me,F as je,B as u,m as ue,n as ge,o as ve,L as g,S as b,q as _,r as D,t as S,v as d,I as y,C as v,d as p,h as pe,i as fe,j as k,k as C,a as R,b as P,e as m}from"./index-ZwIgorfy.js";import{u as Z}from"./query-vendor-B2F_wWlc.js";import{T as M,a as U,b as T,c,d as J,e as o}from"./table-6WL4qh3Z.js";import{N as K}from"./router-vendor-CEyBJ8vK.js";import{o as W,E as ye,F as G,D as Ne,T as we,m as Q,a2 as be,aa as _e,ab as X,g as Y}from"./icons-vendor-b0I7fGSL.js";import"./supabase-vendor-B984m0TI.js";import"./utils-vendor-B2FlkASS.js";import"./ui-components-7w1-MJre.js";const $=()=>{const{user:t,profile:i}=z();return Z({queryKey:["infringements",i==null?void 0:i.organization_id],queryFn:()=>w(void 0,null,function*(){if(!(i!=null&&i.organization_id))throw new Error("Organization ID is required");console.log("Fetching infringements from database...");try{const{data:s,error:n}=yield N.from("infringements").select("*").eq("organization_id",i.organization_id).order("created_at",{ascending:!1});if(n){if(console.error("Error fetching infringements:",n),n.code==="42P01"||n.code==="42703")return console.warn("Infringements table or column not found, returning empty data"),[];throw n}const h=yield Promise.all((s||[]).map(a=>w(void 0,null,function*(){let f=null;if(a.driver_id)try{const{data:l}=yield N.from("profiles").select("id, first_name, last_name, email").eq("id",a.driver_id).single();f=l}catch(l){console.warn("Could not fetch driver data for infringement:",a.id)}let j=null;if(a.vehicle_id)try{const{data:l}=yield N.from("vehicles").select("id, vehicle_number, make, model").eq("id",a.vehicle_id).single();j=l}catch(l){console.warn("Could not fetch vehicle data for infringement:",a.id)}let x=null;if(a.infringement_type_id)try{const{data:l}=yield N.from("infringement_types").select("*").eq("id",a.infringement_type_id).single();x=l}catch(l){console.warn("Could not fetch infringement type data for infringement:",a.id)}return B(V({},a),{driver:f||{id:a.driver_id,first_name:"Unknown",last_name:"Driver",email:"unknown@example.com"},vehicle:j||{id:a.vehicle_id,vehicle_number:"Unknown",make:"Unknown",model:"Unknown"},infringement_type_rel:x})})));return console.log("Fetched infringements with relations:",h),h||[]}catch(s){return console.error("Error in useInfringements:",s),[]}}),enabled:!!(i!=null&&i.organization_id)})},De=t=>{const{user:i,profile:s}=z();return Z({queryKey:["driver_points_history",s==null?void 0:s.organization_id,t],queryFn:()=>w(void 0,null,function*(){if(!(s!=null&&s.organization_id))throw new Error("Organization ID is required");console.log("Fetching driver points history from database...");try{let n=N.from("driver_points_history").select("*").eq("organization_id",s.organization_id).order("recorded_date",{ascending:!1});const{data:h,error:a}=yield n;if(a){if(console.error("Error fetching driver points history:",a),a.code==="42P01"||a.code==="42703")return console.warn("Driver points history table or column not found, returning empty data"),[];throw a}return console.log("Fetched driver points history:",h),h||[]}catch(n){return console.error("Error in useDriverPointsHistory:",n),[]}}),enabled:!!(s!=null&&s.organization_id)})},Se=()=>{const{data:t=[]}=$();return De(),{total_infringements:t.length,pending_infringements:t.filter(s=>s.status==="pending").length,confirmed_infringements:t.filter(s=>s.status==="confirmed").length,resolved_infringements:t.filter(s=>s.status==="resolved").length,total_fines:t.reduce((s,n)=>s+(n.fine_amount||0),0),total_points:t.reduce((s,n)=>s+(n.penalty_points||n.points_deducted||0),0),by_severity:t.reduce((s,n)=>(s[n.severity]=(s[n.severity]||0)+1,s),{}),by_status:t.reduce((s,n)=>(s[n.status]=(s[n.status]||0)+1,s),{}),monthly_trend:t.reduce((s,n)=>{const h=new Date(n.created_at).toISOString().slice(0,7);return s[h]=(s[h]||0)+1,s},{})}},Ee=()=>{const{user:t,profile:i,loading:s}=z(),[n,h]=I.useState(""),[a,f]=I.useState(""),[j,x]=I.useState(!1),{data:l=[],isLoading:ee}=$(),F=Se();if(s||ee)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading infringement management..."})]})});if(!t||!i)return e.jsx(K,{to:"/auth",replace:!0});if(!["admin","council"].includes(i.role))return e.jsx(K,{to:"/unauthorized",replace:!0});l.filter(r=>{var A,q,E;const L=!n||r.description.toLowerCase().includes(n.toLowerCase())||(((A=r.driver)==null?void 0:A.first_name)||"").toLowerCase().includes(n.toLowerCase())||(((q=r.driver)==null?void 0:q.last_name)||"").toLowerCase().includes(n.toLowerCase())||(((E=r.vehicle)==null?void 0:E.vehicle_number)||"").toLowerCase().includes(n.toLowerCase()),le=!a||r.driver_id===a;return L&&le});const se=[{driverId:"1",driverName:"John Smith",totalInfringements:3,totalPoints:9,totalFines:450,riskLevel:"high"},{driverId:"2",driverName:"Sarah Johnson",totalInfringements:1,totalPoints:0,totalFines:80,riskLevel:"low"},{driverId:"3",driverName:"Mike Davis",totalInfringements:2,totalPoints:6,totalFines:380,riskLevel:"medium"}],re=r=>{switch(r){case"pending":return e.jsx(m,{className:"bg-yellow-100 text-yellow-800 hover:bg-yellow-100",children:"Pending"});case"paid":return e.jsx(m,{className:"bg-green-100 text-green-800 hover:bg-green-100",children:"Paid"});case"disputed":return e.jsx(m,{className:"bg-blue-100 text-blue-800 hover:bg-blue-100",children:"Disputed"});case"overdue":return e.jsx(m,{className:"bg-red-100 text-red-800 hover:bg-red-100",children:"Overdue"});default:return e.jsx(m,{variant:"secondary",children:r})}},ne=r=>{switch(r){case"low":return e.jsx(m,{className:"bg-green-100 text-green-800 hover:bg-green-100",children:"Low Risk"});case"medium":return e.jsx(m,{className:"bg-yellow-100 text-yellow-800 hover:bg-yellow-100",children:"Medium Risk"});case"high":return e.jsx(m,{className:"bg-red-100 text-red-800 hover:bg-red-100",children:"High Risk"});default:return e.jsx(m,{variant:"secondary",children:r})}},ie=F.total_fines,te=l.filter(r=>r.status==="pending").reduce((r,L)=>r+(L.fine_amount||0),0),ae=F.total_points;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx(W,{className:"w-8 h-8 text-red-600"}),"Infringement Management"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Track and manage driver infringements and violations"})]}),e.jsxs(me,{open:j,onOpenChange:x,children:[e.jsx(je,{asChild:!0,children:e.jsxs(u,{className:"bg-red-600 hover:bg-red-700",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"Record Infringement"]})}),e.jsxs(ue,{className:"max-w-md",children:[e.jsx(ge,{children:e.jsx(ve,{children:"Record New Infringement"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"driver",children:"Driver"}),e.jsxs(b,{children:[e.jsx(_,{children:e.jsx(D,{placeholder:"Select driver"})}),e.jsxs(S,{children:[e.jsx(d,{value:"john",children:"John Smith"}),e.jsx(d,{value:"sarah",children:"Sarah Johnson"}),e.jsx(d,{value:"mike",children:"Mike Davis"})]})]})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"vehicle",children:"Vehicle"}),e.jsxs(b,{children:[e.jsx(_,{children:e.jsx(D,{placeholder:"Select vehicle"})}),e.jsxs(S,{children:[e.jsx(d,{value:"LSR-001",children:"LSR-001"}),e.jsx(d,{value:"LSR-002",children:"LSR-002"}),e.jsx(d,{value:"LSR-003",children:"LSR-003"})]})]})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"type",children:"Infringement Type"}),e.jsxs(b,{children:[e.jsx(_,{children:e.jsx(D,{placeholder:"Select type"})}),e.jsxs(S,{children:[e.jsx(d,{value:"speeding",children:"Speeding"}),e.jsx(d,{value:"parking",children:"Parking Violation"}),e.jsx(d,{value:"weight",children:"Weight Violation"}),e.jsx(d,{value:"hours",children:"Driving Hours Violation"}),e.jsx(d,{value:"other",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"date",children:"Date"}),e.jsx(y,{id:"date",type:"date"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"location",children:"Location"}),e.jsx(y,{id:"location",placeholder:"Location of infringement"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"fine",children:"Fine Amount (£)"}),e.jsx(y,{id:"fine",type:"number",step:"0.01",placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"points",children:"Penalty Points"}),e.jsx(y,{id:"points",type:"number",placeholder:"0"})]}),e.jsx(u,{className:"w-full bg-red-600 hover:bg-red-700",children:"Record Infringement"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(v,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(G,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Infringements"}),e.jsx("p",{className:"text-2xl font-bold",children:F.total_infringements})]})]})})}),e.jsx(v,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ne,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Fines"}),e.jsxs("p",{className:"text-2xl font-bold",children:["£",ie.toFixed(2)]})]})]})})}),e.jsx(v,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(we,{className:"w-8 h-8 text-yellow-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Pending Fines"}),e.jsxs("p",{className:"text-2xl font-bold text-yellow-600",children:["£",te.toFixed(2)]})]})]})})}),e.jsx(v,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Q,{className:"w-8 h-8 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Points"}),e.jsx("p",{className:"text-2xl font-bold",children:ae})]})]})})})]}),e.jsxs(pe,{defaultValue:"infringements",className:"space-y-6",children:[e.jsxs(fe,{className:"grid w-full grid-cols-3",children:[e.jsx(k,{value:"infringements",children:"All Infringements"}),e.jsx(k,{value:"driver-summary",children:"Driver Summary"}),e.jsx(k,{value:"reports",children:"Reports & Analytics"})]}),e.jsx(C,{value:"infringements",className:"space-y-4",children:e.jsxs(v,{children:[e.jsxs(R,{children:[e.jsxs(P,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"w-5 h-5"}),"Infringement Records"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(y,{placeholder:"Search infringements...",value:n,onChange:r=>h(r.target.value),className:"pl-10"})]}),e.jsxs(b,{children:[e.jsx(_,{className:"w-48",children:e.jsx(D,{placeholder:"Filter by status"})}),e.jsxs(S,{children:[e.jsx(d,{value:"all",children:"All Status"}),e.jsx(d,{value:"pending",children:"Pending"}),e.jsx(d,{value:"paid",children:"Paid"}),e.jsx(d,{value:"disputed",children:"Disputed"}),e.jsx(d,{value:"overdue",children:"Overdue"})]})]})]})]}),e.jsx(p,{children:e.jsxs(M,{children:[e.jsx(U,{children:e.jsxs(T,{children:[e.jsx(c,{children:"Driver"}),e.jsx(c,{children:"Vehicle"}),e.jsx(c,{children:"Type"}),e.jsx(c,{children:"Date"}),e.jsx(c,{children:"Location"}),e.jsx(c,{children:"Fine Amount"}),e.jsx(c,{children:"Points"}),e.jsx(c,{children:"Status"}),e.jsx(c,{children:"Due Date"}),e.jsx(c,{children:"Actions"})]})}),e.jsx(J,{children:l.map(r=>e.jsxs(T,{children:[e.jsx(o,{className:"font-medium",children:r.driverName}),e.jsx(o,{children:r.vehicleNumber}),e.jsx(o,{children:r.infringementType}),e.jsx(o,{children:r.date}),e.jsx(o,{children:r.location}),e.jsxs(o,{children:["£",r.fineAmount.toFixed(2)]}),e.jsx(o,{children:r.points}),e.jsx(o,{children:re(r.status)}),e.jsx(o,{children:r.dueDate}),e.jsx(o,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",size:"sm",children:e.jsx(_e,{className:"w-4 h-4"})}),e.jsx(u,{variant:"outline",size:"sm",children:e.jsx(X,{className:"w-4 h-4"})})]})})]},r.id))})]})})]})}),e.jsx(C,{value:"driver-summary",className:"space-y-4",children:e.jsxs(v,{children:[e.jsx(R,{children:e.jsxs(P,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"Driver Risk Summary"]})}),e.jsx(p,{children:e.jsxs(M,{children:[e.jsx(U,{children:e.jsxs(T,{children:[e.jsx(c,{children:"Driver Name"}),e.jsx(c,{children:"Total Infringements"}),e.jsx(c,{children:"Total Points"}),e.jsx(c,{children:"Total Fines"}),e.jsx(c,{children:"Risk Level"}),e.jsx(c,{children:"Actions"})]})}),e.jsx(J,{children:se.map(r=>e.jsxs(T,{children:[e.jsx(o,{className:"font-medium",children:r.driverName}),e.jsx(o,{children:r.totalInfringements}),e.jsx(o,{children:r.totalPoints}),e.jsxs(o,{children:["£",r.totalFines.toFixed(2)]}),e.jsx(o,{children:ne(r.riskLevel)}),e.jsx(o,{children:e.jsx(u,{variant:"outline",size:"sm",children:"View Details"})})]},r.driverId))})]})})]})}),e.jsx(C,{value:"reports",className:"space-y-4",children:e.jsxs(v,{children:[e.jsx(R,{children:e.jsxs(P,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-5 h-5"}),"Reports & Analytics"]})}),e.jsx(p,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(G,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Infringement Analytics"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Generate detailed reports on driver behavior, infringement trends, and risk analysis."}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsxs(u,{className:"bg-red-600 hover:bg-red-700",children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Monthly Report"]}),e.jsxs(u,{variant:"outline",children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),"Custom Date Range"]})]})]})})]})})]})]})};export{Ee as default};
