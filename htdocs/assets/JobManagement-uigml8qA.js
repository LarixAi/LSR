var W=Object.defineProperty,X=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var K=(a,t,s)=>t in a?W(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s,d=(a,t)=>{for(var s in t||(t={}))Z.call(t,s)&&K(a,s,t[s]);if(V)for(var s of V(t))$.call(t,s)&&K(a,s,t[s]);return a},h=(a,t)=>X(a,Y(t));var _=(a,t,s)=>new Promise((o,c)=>{var u=n=>{try{i(s.next(n))}catch(m){c(m)}},g=n=>{try{i(s.throw(n))}catch(m){c(m)}},i=n=>n.done?o(n.value):Promise.resolve(n.value).then(u,g);i((s=s.apply(a,t)).next())});import{j as e}from"./ui-vendor-DMUr7mTx.js";import{r as q}from"./react-vendor-BvqlMsL5.js";import{u as I,s as v,J as N,D as ee,F as se,B as T,m as re,n as te,o as ae,L as j,I as p,S as ie,q as ne,r as le,t as oe,v as E,C as J,d as D,a as ce,b as de,e as R}from"./index-ZwIgorfy.js";import{T as he,a as ue,b as k,c as b,d as me,e as x}from"./table-6WL4qh3Z.js";import{u as xe,a as B,b as H}from"./query-vendor-B2F_wWlc.js";import{u as ge}from"./useDrivers-BY9VTvBN.js";import{u as je}from"./useVehicles-uD3YILF5.js";import{V as A,F as z,E as pe,J as be,j as ve,D as ye,a2 as fe,aa as _e,ak as Ne}from"./icons-vendor-b0I7fGSL.js";import{N as U}from"./router-vendor-CEyBJ8vK.js";import"./supabase-vendor-B984m0TI.js";import"./utils-vendor-B2FlkASS.js";import"./ui-components-7w1-MJre.js";const G=()=>{const{user:a,profile:t}=I();return xe({queryKey:["jobs",t==null?void 0:t.organization_id],queryFn:()=>_(void 0,null,function*(){if(!(t!=null&&t.organization_id))throw new Error("Organization ID is required");console.log("Fetching jobs from database...");try{const{data:s,error:o}=yield v.from("jobs").select("*").eq("organization_id",t.organization_id).order("created_at",{ascending:!1});if(o){if(console.error("Error fetching jobs:",o),o.code==="42P01"||o.code==="PGRST200")return console.warn("jobs table not found or foreign key relationship issue, returning empty data"),[];throw o}if(!s||s.length===0)return[];const c=s.filter(l=>l.assigned_driver_id).map(l=>l.assigned_driver_id),u=s.filter(l=>l.assigned_vehicle_id).map(l=>l.assigned_vehicle_id),g=s.filter(l=>l.created_by).map(l=>l.created_by),[i,n,m]=yield Promise.all([c.length>0?v.from("profiles").select("*").in("id",c):Promise.resolve({data:[],error:null}),u.length>0?v.from("vehicles").select("*").in("id",u):Promise.resolve({data:[],error:null}),g.length>0?v.from("profiles").select("*").in("id",g):Promise.resolve({data:[],error:null})]),S=s.map(l=>{var F,L,w;const y=(F=i.data)==null?void 0:F.find(r=>r.id===l.assigned_driver_id),C=(L=n.data)==null?void 0:L.find(r=>r.id===l.assigned_vehicle_id),P=(w=m.data)==null?void 0:w.find(r=>r.id===l.created_by);return h(d({},l),{assigned_driver:y||null,assigned_vehicle:C||null,creator:P||null})});return console.log("Fetched jobs with relations:",S),S||[]}catch(s){return console.error("Error in useJobs:",s),[]}}),enabled:!!(t!=null&&t.organization_id)})},Ce=()=>{const{profile:a}=I(),t=B();return H({mutationFn:s=>_(void 0,null,function*(){if(!(a!=null&&a.organization_id)||!(a!=null&&a.id))throw new Error("Organization and user information required");const{data:o,error:c}=yield v.from("jobs").insert(h(d({},s),{organization_id:a.organization_id,created_by:a.id})).select().single();if(c)throw c;return o}),onSuccess:()=>{t.invalidateQueries({queryKey:["jobs"]}),N.success("Job created successfully")},onError:s=>{console.error("Error creating job:",s),N.error("Failed to create job: "+s.message)}})},we=()=>{const a=B();return H({mutationFn:o=>_(void 0,[o],function*({id:t,updates:s}){const{data:c,error:u}=yield v.from("jobs").update(s).eq("id",t).select().single();if(u)throw u;return c}),onSuccess:()=>{a.invalidateQueries({queryKey:["jobs"]}),N.success("Job updated successfully")},onError:t=>{console.error("Error updating job:",t),N.error("Failed to update job: "+t.message)}})},Je=()=>{const a=B();return H({mutationFn:t=>_(void 0,null,function*(){const{error:s}=yield v.from("jobs").delete().eq("id",t);if(s)throw s}),onSuccess:()=>{a.invalidateQueries({queryKey:["jobs"]}),N.success("Job deleted successfully")},onError:t=>{console.error("Error deleting job:",t),N.error("Failed to delete job: "+t.message)}})},De=()=>{const{data:a=[]}=G();return{total:a.length,pending:a.filter(s=>s.status==="pending").length,assigned:a.filter(s=>s.status==="assigned").length,in_progress:a.filter(s=>s.status==="in_progress").length,completed:a.filter(s=>s.status==="completed").length,cancelled:a.filter(s=>s.status==="cancelled").length,high_priority:a.filter(s=>s.priority==="high"||s.priority==="urgent").length}},Oe=()=>{const{user:a,profile:t,loading:s}=I(),[o,c]=q.useState(""),[u,g]=q.useState(!1),[i,n]=q.useState({title:"",description:"",priority:"medium",pickup_location:"",delivery_location:"",customer_name:"",customer_contact:"",start_date:"",end_date:"",assigned_driver_id:"",assigned_vehicle_id:""}),{data:m=[],isLoading:S,error:l}=G(),y=De();ge(),je();const C=Ce();if(we(),Je(),s||S)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx(A,{className:"h-8 w-8 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading job management..."})]})});if(!a||!t)return e.jsx(U,{to:"/auth",replace:!0});if(!["admin","council"].includes(t.role))return e.jsx(U,{to:"/unauthorized",replace:!0});const P=()=>_(void 0,null,function*(){try{yield C.mutateAsync(i),g(!1),n({title:"",description:"",priority:"medium",pickup_location:"",delivery_location:"",customer_name:"",customer_contact:"",start_date:"",end_date:"",assigned_driver_id:"",assigned_vehicle_id:""})}catch(r){console.error("Failed to create job:",r)}}),F=r=>{const f={pending:"bg-yellow-100 text-yellow-800",assigned:"bg-blue-100 text-blue-800",in_progress:"bg-purple-100 text-purple-800",completed:"bg-green-100 text-green-800",cancelled:"bg-red-100 text-red-800"};return e.jsx(R,{className:f[r]||"bg-gray-100 text-gray-800",children:r==null?void 0:r.replace("_"," ")})},L=r=>{const f={low:"bg-gray-100 text-gray-800",medium:"bg-blue-100 text-blue-800",high:"bg-orange-100 text-orange-800",urgent:"bg-red-100 text-red-800"};return e.jsx(R,{className:f[r]||"bg-gray-100 text-gray-800",children:r})},w=m.filter(r=>{var f,M,O,Q;return((f=r.title)==null?void 0:f.toLowerCase().includes(o.toLowerCase()))||((M=r.customer_name)==null?void 0:M.toLowerCase().includes(o.toLowerCase()))||((O=r.job_number)==null?void 0:O.toLowerCase().includes(o.toLowerCase()))||((Q=r.description)==null?void 0:Q.toLowerCase().includes(o.toLowerCase()))});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx(z,{className:"w-8 h-8 text-blue-600"}),"Job Management"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Create, assign, and track transport jobs"})]}),e.jsxs(ee,{open:u,onOpenChange:g,children:[e.jsx(se,{asChild:!0,children:e.jsxs(T,{className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"Create Job"]})}),e.jsxs(re,{className:"max-w-2xl",children:[e.jsx(te,{children:e.jsx(ae,{children:"Create New Job"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(j,{htmlFor:"job-title",children:"Job Title *"}),e.jsx(p,{id:"job-title",placeholder:"Enter job title",value:i.title,onChange:r=>n(h(d({},i),{title:r.target.value}))})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"customer",children:"Customer Name *"}),e.jsx(p,{id:"customer",placeholder:"Customer name",value:i.customer_name,onChange:r=>n(h(d({},i),{customer_name:r.target.value}))})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"pickup",children:"Pickup Location"}),e.jsx(p,{id:"pickup",placeholder:"Pickup address",value:i.pickup_location,onChange:r=>n(h(d({},i),{pickup_location:r.target.value}))})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"delivery",children:"Delivery Location"}),e.jsx(p,{id:"delivery",placeholder:"Delivery address",value:i.delivery_location,onChange:r=>n(h(d({},i),{delivery_location:r.target.value}))})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"start-date",children:"Start Date"}),e.jsx(p,{id:"start-date",type:"date",value:i.start_date,onChange:r=>n(h(d({},i),{start_date:r.target.value}))})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"priority",children:"Priority"}),e.jsxs(ie,{value:i.priority,onValueChange:r=>n(h(d({},i),{priority:r})),children:[e.jsx(ne,{children:e.jsx(le,{placeholder:"Select priority"})}),e.jsxs(oe,{children:[e.jsx(E,{value:"low",children:"Low"}),e.jsx(E,{value:"medium",children:"Medium"}),e.jsx(E,{value:"high",children:"High"}),e.jsx(E,{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(j,{htmlFor:"description",children:"Description"}),e.jsx(p,{id:"description",placeholder:"Job description",value:i.description,onChange:r=>n(h(d({},i),{description:r.target.value}))})]}),e.jsx("div",{className:"col-span-2",children:e.jsx(T,{className:"w-full bg-blue-600 hover:bg-blue-700",onClick:P,disabled:C.isPending||!i.title||!i.customer_name,children:C.isPending?e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-4 h-4 mr-2 animate-spin"}),"Creating..."]}):"Create Job"})})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(J,{children:e.jsx(D,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Jobs"}),e.jsx("p",{className:"text-2xl font-bold",children:y.total})]})]})})}),e.jsx(J,{children:e.jsx(D,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(be,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"In Progress"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:y.in_progress})]})]})})}),e.jsx(J,{children:e.jsx(D,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ve,{className:"w-8 h-8 text-yellow-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Pending"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:y.pending})]})]})})}),e.jsx(J,{children:e.jsx(D,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ye,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Completed"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:y.completed})]})]})})})]}),e.jsxs(J,{children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-5 h-5"}),"Job List"]}),e.jsx("div",{className:"flex gap-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(fe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(p,{placeholder:"Search jobs...",value:o,onChange:r=>c(r.target.value),className:"pl-10"})]})})]}),e.jsx(D,{children:e.jsxs(he,{children:[e.jsx(ue,{children:e.jsxs(k,{children:[e.jsx(b,{children:"Job Number"}),e.jsx(b,{children:"Title"}),e.jsx(b,{children:"Customer"}),e.jsx(b,{children:"Priority"}),e.jsx(b,{children:"Status"}),e.jsx(b,{children:"Created"}),e.jsx(b,{children:"Actions"})]})}),e.jsx(me,{children:w.length===0?e.jsx(k,{children:e.jsx(x,{colSpan:7,className:"text-center py-8 text-gray-500",children:m.length===0?"No jobs found. Create your first job to get started.":"No jobs match your search criteria."})}):w.map(r=>e.jsxs(k,{children:[e.jsx(x,{className:"font-medium",children:r.job_number||r.id.slice(0,8)}),e.jsx(x,{children:r.title||"Untitled Job"}),e.jsx(x,{children:r.customer_name||"No customer"}),e.jsx(x,{children:L(r.priority||"medium")}),e.jsx(x,{children:F(r.status||"pending")}),e.jsx(x,{children:new Date(r.created_at).toLocaleDateString()}),e.jsx(x,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{variant:"outline",size:"sm",children:e.jsx(_e,{className:"w-4 h-4"})}),e.jsx(T,{variant:"outline",size:"sm",children:e.jsx(Ne,{className:"w-4 h-4"})})]})})]},r.id))})]})})]})]})};export{Oe as default};
