var Ee=Object.defineProperty,ke=Object.defineProperties;var Te=Object.getOwnPropertyDescriptors;var he=Object.getOwnPropertySymbols;var Me=Object.prototype.hasOwnProperty,Se=Object.prototype.propertyIsEnumerable;var ue=(c,s,t)=>s in c?Ee(c,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[s]=t,N=(c,s)=>{for(var t in s||(s={}))Me.call(s,t)&&ue(c,t,s[t]);if(he)for(var t of he(s))Se.call(s,t)&&ue(c,t,s[t]);return c},_=(c,s)=>ke(c,Te(s));var P=(c,s,t)=>new Promise((m,h)=>{var b=l=>{try{n(t.next(l))}catch(u){h(u)}},j=l=>{try{n(t.throw(l))}catch(u){h(u)}},n=l=>l.done?m(l.value):Promise.resolve(l.value).then(b,j);n((t=t.apply(c,s)).next())});import{j as e}from"./ui-vendor-DMUr7mTx.js";import{r as L}from"./react-vendor-BvqlMsL5.js";import{s as O,J as Q,u as fe,D as Ne,m as _e,n as be,o as we,p as Ce,L as p,S as Z,q as ee,r as se,t as ie,v as x,B as A,I as k,e as D,T as Ae,C as T,a as H,b as $,c as z,d as M,P as Fe,A as ce,g as de,h as Ie,i as Be,j as oe,k as xe}from"./index-ZwIgorfy.js";import{T as Pe,a as Ue,b as ye,c as R,d as qe,e as V}from"./table-6WL4qh3Z.js";import{u as me,a as De,b as Le}from"./query-vendor-B2F_wWlc.js";import{u as Re}from"./useDrivers-BY9VTvBN.js";import{a as Ve,N as He}from"./router-vendor-CEyBJ8vK.js";import{E as re,X as ge,Z as $e,m as ze,aN as Oe,ao as pe,T as ae,A as Y,J as W,F as je,f as Ke,a2 as Qe,g as Je,aa as Ge,aF as We,Y as Xe,k as Ye,j as Ze}from"./icons-vendor-b0I7fGSL.js";import{a as ve,b as G,i as S,f as U}from"./utils-vendor-B2FlkASS.js";import"./supabase-vendor-B984m0TI.js";import"./ui-components-7w1-MJre.js";const es=c=>me({queryKey:["licenses",c],queryFn:()=>P(void 0,null,function*(){if(!c)return[];console.log("ðŸ” Fetching licenses for organization:",c);try{const{data:s,error:t}=yield O.from("driver_licenses").select("*").eq("organization_id",c).order("created_at",{ascending:!1});if(t)return console.error("Error fetching licenses:",t),[];if(!s||s.length===0)return[];const m=s.map(l=>l.driver_id),{data:h,error:b}=yield O.from("profiles").select("id, first_name, last_name, email").in("id",m);if(b)return console.error("Error fetching drivers:",b),s.map(l=>_(N({},l),{driver_name:"Unknown Driver",driver_email:""}));const j=new Map;h==null||h.forEach(l=>{j.set(l.id,l)});const n=s.map(l=>{const u=j.get(l.driver_id);return _(N({},l),{driver_name:u?`${u.first_name} ${u.last_name}`:"Unknown Driver",driver_email:(u==null?void 0:u.email)||""})});return console.log("ðŸ“‹ Licenses data:",n),n}catch(s){return console.error("Error in useLicenses:",s),[]}}),enabled:!!c}),ss=()=>{const c=De(),{profile:s}=fe();return Le({mutationFn:t=>P(void 0,null,function*(){if(!(s!=null&&s.organization_id))throw new Error("Organization ID is required");const{data:m,error:h}=yield O.from("driver_licenses").insert(_(N({},t),{organization_id:s.organization_id,status:"active",points_balance:0,endorsements:t.endorsements||[],restrictions:t.restrictions||[]})).select().single();if(h)throw h;return m}),onSuccess:()=>{c.invalidateQueries({queryKey:["licenses"]}),c.invalidateQueries({queryKey:["driver-licenses"]}),Q.success("License created successfully")},onError:t=>{console.error("Error creating license:",t),Q.error("Failed to create license: "+t.message)}})},is=()=>{const c=De();return Le({mutationFn:s=>P(void 0,null,function*(){const{error:t}=yield O.from("driver_licenses").delete().eq("id",s);if(t)throw t}),onSuccess:()=>{c.invalidateQueries({queryKey:["licenses"]}),c.invalidateQueries({queryKey:["driver-licenses"]}),Q.success("License deleted successfully")},onError:s=>{console.error("Error deleting license:",s),Q.error("Failed to delete license: "+s.message)}})},rs=c=>me({queryKey:["license-stats",c],queryFn:()=>P(void 0,null,function*(){if(!c)return null;const{data:s,error:t}=yield O.from("driver_licenses").select("status, expiry_date").eq("organization_id",c);if(t)return console.error("Error fetching license stats:",t),null;const m=new Date,h=new Date(m.getTime()+30*24*60*60*1e3);return{total:(s==null?void 0:s.length)||0,active:(s==null?void 0:s.filter(j=>j.status==="active").length)||0,expired:(s==null?void 0:s.filter(j=>j.status==="expired").length)||0,suspended:(s==null?void 0:s.filter(j=>j.status==="suspended").length)||0,revoked:(s==null?void 0:s.filter(j=>j.status==="revoked").length)||0,expiringSoon:(s==null?void 0:s.filter(j=>{const n=new Date(j.expiry_date);return n<=h&&n>m&&j.status==="active"}).length)||0}}),enabled:!!c}),as=(c,s=30)=>me({queryKey:["expiring-licenses",c,s],queryFn:()=>P(void 0,null,function*(){if(!c)return[];const t=new Date;t.setDate(t.getDate()+s);try{const{data:m,error:h}=yield O.from("driver_licenses").select("*").eq("organization_id",c).eq("status","active").lte("expiry_date",t.toISOString().split("T")[0]).gte("expiry_date",new Date().toISOString().split("T")[0]).order("expiry_date",{ascending:!0});if(h)return console.error("Error fetching expiring licenses:",h),[];if(!m||m.length===0)return[];const b=m.map(u=>u.driver_id),{data:j,error:n}=yield O.from("profiles").select("id, first_name, last_name, email").in("id",b);if(n)return console.error("Error fetching drivers:",n),m.map(u=>_(N({},u),{driver_name:"Unknown Driver",driver_email:""}));const l=new Map;return j==null||j.forEach(u=>{l.set(u.id,u)}),m.map(u=>{const w=l.get(u.driver_id);return _(N({},u),{driver_name:w?`${w.first_name} ${w.last_name}`:"Unknown Driver",driver_email:(w==null?void 0:w.email)||""})})}catch(m){return console.error("Error in useExpiringLicenses:",m),[]}}),enabled:!!c}),ts=[{value:"CDL-A",label:"CDL-A (Commercial Driver License - Class A)"},{value:"CDL-B",label:"CDL-B (Commercial Driver License - Class B)"},{value:"CDL-C",label:"CDL-C (Commercial Driver License - Class C)"},{value:"Regular",label:"Regular Driver License"},{value:"Provisional",label:"Provisional Driver License"},{value:"Learner",label:"Learner Driver License"},{value:"International",label:"International Driver License"},{value:"International-Permit",label:"International Driving Permit"},{value:"Motorcycle",label:"Motorcycle License"},{value:"Motorcycle-A",label:"Motorcycle License - Class A"},{value:"Motorcycle-A1",label:"Motorcycle License - Class A1"},{value:"Motorcycle-A2",label:"Motorcycle License - Class A2"},{value:"Heavy-Vehicle",label:"Heavy Vehicle License"},{value:"Heavy-Vehicle-C1",label:"Heavy Vehicle License - Class C1"},{value:"Heavy-Vehicle-C",label:"Heavy Vehicle License - Class C"},{value:"Heavy-Vehicle-C+E",label:"Heavy Vehicle License - Class C+E"},{value:"Bus-D1",label:"Bus License - Class D1"},{value:"Bus-D",label:"Bus License - Class D"},{value:"Bus-D+E",label:"Bus License - Class D+E"},{value:"Coach",label:"Coach License"},{value:"School-Bus",label:"School Bus License"},{value:"Hazmat",label:"Hazardous Materials License"},{value:"Tanker",label:"Tanker Vehicle License"},{value:"Passenger",label:"Passenger Transport License"},{value:"Chauffeur",label:"Chauffeur License"},{value:"Taxi",label:"Taxi License"},{value:"Private-Hire",label:"Private Hire License"},{value:"Agricultural",label:"Agricultural Vehicle License"},{value:"Tractor",label:"Tractor License"},{value:"Forklift",label:"Forklift License"},{value:"Crane",label:"Crane Operator License"},{value:"Military",label:"Military Driver License"},{value:"Emergency",label:"Emergency Vehicle License"},{value:"Police",label:"Police Vehicle License"},{value:"Fire",label:"Fire Service Vehicle License"},{value:"Ambulance",label:"Ambulance Driver License"},{value:"Disabled",label:"Disabled Driver License"},{value:"Student",label:"Student Driver License"},{value:"Temporary",label:"Temporary Driver License"},{value:"Replacement",label:"Replacement Driver License"},{value:"Duplicate",label:"Duplicate Driver License"}],ns=["Hazmat","Tanker","Passenger","School Bus","Double/Triple","Air Brakes"],ls=["Corrective Lenses","Prosthetic Aid","Automatic Transmission","Outside Mirror","Daylight Only"],cs=({open:c,onOpenChange:s})=>{const t=ss(),{data:m,isLoading:h,error:b}=Re(),j=Ve();console.log("ðŸ” AddLicenseDialog - Drivers data:",{drivers:m,driversLoading:h,driversError:b,driversCount:(m==null?void 0:m.length)||0});const[n,l]=L.useState({driver_id:"",license_number:"",license_type:"",issuing_authority:"",issue_date:"",expiry_date:"",license_class:"",endorsements:[],restrictions:[],medical_certificate_expiry:"",background_check_expiry:"",drug_test_expiry:"",training_expiry:"",notes:""}),[u,w]=L.useState(""),[o,F]=L.useState(""),q=i=>P(void 0,null,function*(){if(i.preventDefault(),!(!n.driver_id||!n.license_number||!n.license_type||!n.issuing_authority||!n.issue_date||!n.expiry_date))try{yield t.mutateAsync(n),B(),s(!1)}catch(d){console.error("Error creating license:",d)}}),B=()=>{l({driver_id:"",license_number:"",license_type:"",issuing_authority:"",issue_date:"",expiry_date:"",license_class:"",endorsements:[],restrictions:[],medical_certificate_expiry:"",background_check_expiry:"",drug_test_expiry:"",training_expiry:"",notes:""}),w(""),F("")},r=()=>{u.trim()&&!n.endorsements.includes(u.trim())&&(l(i=>_(N({},i),{endorsements:[...i.endorsements,u.trim()]})),w(""))},f=i=>{l(d=>_(N({},d),{endorsements:d.endorsements.filter(I=>I!==i)}))},C=()=>{o.trim()&&!n.restrictions.includes(o.trim())&&(l(i=>_(N({},i),{restrictions:[...i.restrictions,o.trim()]})),F(""))},E=i=>{l(d=>_(N({},d),{restrictions:d.restrictions.filter(I=>I!==i)}))};return e.jsx(Ne,{open:c,onOpenChange:s,children:e.jsxs(_e,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(be,{children:[e.jsx(we,{children:"Add New Driver License"}),e.jsx(Ce,{children:"Enter all required license information for the driver."})]}),e.jsxs("form",{onSubmit:q,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"driver_id",children:"Driver *"}),e.jsxs(Z,{value:n.driver_id,onValueChange:i=>l(d=>_(N({},d),{driver_id:i})),children:[e.jsx(ee,{children:e.jsx(se,{placeholder:h?"Loading drivers...":"Select driver"})}),e.jsx(ie,{children:h?e.jsx(x,{value:"",disabled:!0,children:"Loading drivers..."}):b?e.jsx(x,{value:"",disabled:!0,children:"Error loading drivers"}):m&&m.length>0?m.map(i=>e.jsxs(x,{value:i.id,children:[i.first_name," ",i.last_name]},i.id)):e.jsx(x,{value:"",disabled:!0,children:"No drivers found in organization"})})]}),b&&e.jsxs("p",{className:"text-sm text-red-500",children:["Error loading drivers: ",b.message]}),!h&&!b&&m&&m.length===0&&e.jsxs("div",{className:"text-sm text-yellow-600 space-y-2",children:[e.jsx("p",{children:"No drivers found in your organization."}),e.jsx("p",{children:"To add a license, you need to:"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1 ml-2",children:[e.jsxs("li",{children:["Go to ",e.jsx("strong",{children:"Driver Management"})," page"]}),e.jsx("li",{children:"Add drivers to your organization"}),e.jsx("li",{children:"Return here to add licenses for those drivers"})]}),e.jsx(A,{type:"button",variant:"outline",size:"sm",onClick:()=>{s(!1),j("/drivers")},className:"mt-2",children:"Go to Driver Management"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"license_number",children:"License Number *"}),e.jsx(k,{id:"license_number",value:n.license_number,onChange:i=>l(d=>_(N({},d),{license_number:i.target.value})),placeholder:"Enter license number",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"license_type",children:"License Type *"}),e.jsxs(Z,{value:n.license_type,onValueChange:i=>l(d=>_(N({},d),{license_type:i})),children:[e.jsx(ee,{children:e.jsx(se,{placeholder:"Select license type"})}),e.jsx(ie,{children:ts.map(i=>e.jsx(x,{value:i.value,children:i.label},i.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"issuing_authority",children:"Issuing Authority *"}),e.jsx(k,{id:"issuing_authority",value:n.issuing_authority,onChange:i=>l(d=>_(N({},d),{issuing_authority:i.target.value})),placeholder:"e.g., DMV, DVLA",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"issue_date",children:"Issue Date *"}),e.jsx(k,{id:"issue_date",type:"date",value:n.issue_date,onChange:i=>l(d=>_(N({},d),{issue_date:i.target.value})),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"expiry_date",children:"Expiry Date *"}),e.jsx(k,{id:"expiry_date",type:"date",value:n.expiry_date,onChange:i=>l(d=>_(N({},d),{expiry_date:i.target.value})),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"license_class",children:"License Class"}),e.jsx(k,{id:"license_class",value:n.license_class,onChange:i=>l(d=>_(N({},d),{license_class:i.target.value})),placeholder:"e.g., Class 1, Class 2"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(p,{children:"Endorsements"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{value:u,onChange:i=>w(i.target.value),placeholder:"Add endorsement",onKeyPress:i=>i.key==="Enter"&&(i.preventDefault(),r())}),e.jsx(A,{type:"button",onClick:r,size:"sm",children:e.jsx(re,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:n.endorsements.map(i=>e.jsxs(D,{variant:"secondary",className:"flex items-center gap-1",children:[i,e.jsx(ge,{className:"w-3 h-3 cursor-pointer",onClick:()=>f(i)})]},i))}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Common endorsements: ",ns.join(", ")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(p,{children:"Restrictions"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{value:o,onChange:i=>F(i.target.value),placeholder:"Add restriction",onKeyPress:i=>i.key==="Enter"&&(i.preventDefault(),C())}),e.jsx(A,{type:"button",onClick:C,size:"sm",children:e.jsx(re,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:n.restrictions.map(i=>e.jsxs(D,{variant:"destructive",className:"flex items-center gap-1",children:[i,e.jsx(ge,{className:"w-3 h-3 cursor-pointer",onClick:()=>E(i)})]},i))}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Common restrictions: ",ls.join(", ")]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"medical_certificate_expiry",children:"Medical Certificate Expiry"}),e.jsx(k,{id:"medical_certificate_expiry",type:"date",value:n.medical_certificate_expiry,onChange:i=>l(d=>_(N({},d),{medical_certificate_expiry:i.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"background_check_expiry",children:"Background Check Expiry"}),e.jsx(k,{id:"background_check_expiry",type:"date",value:n.background_check_expiry,onChange:i=>l(d=>_(N({},d),{background_check_expiry:i.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"drug_test_expiry",children:"Drug Test Expiry"}),e.jsx(k,{id:"drug_test_expiry",type:"date",value:n.drug_test_expiry,onChange:i=>l(d=>_(N({},d),{drug_test_expiry:i.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"training_expiry",children:"Training Expiry"}),e.jsx(k,{id:"training_expiry",type:"date",value:n.training_expiry,onChange:i=>l(d=>_(N({},d),{training_expiry:i.target.value}))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"notes",children:"Notes"}),e.jsx(Ae,{id:"notes",value:n.notes,onChange:i=>l(d=>_(N({},d),{notes:i.target.value})),placeholder:"Additional notes about the license...",rows:3})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(A,{type:"button",variant:"outline",onClick:()=>s(!1),children:"Cancel"}),e.jsx(A,{type:"submit",disabled:t.isPending,children:t.isPending?"Creating...":"Create License"})]})]})]})})},ds=({licenses:c,onRefresh:s})=>{const[t,m]=L.useState([]),[h,b]=L.useState({total:0,compliant:0,nonCompliant:0,criticalIssues:0,warnings:0,complianceRate:0}),[j,n]=L.useState(!1),l=()=>{n(!0);const r=[],f=new Date,C=ve(f,30),E=ve(f,90);c.forEach(g=>{const J=new Date(g.expiry_date),a=G(J,f);if(S(J,f)?r.push({type:"expired",severity:"critical",message:`License expired ${Math.abs(a)} days ago`,license:g,daysUntilExpiry:a}):S(J,C)&&r.push({type:"expiring-soon",severity:"warning",message:`License expires in ${a} days`,license:g,daysUntilExpiry:a}),g.medical_certificate_expiry){const y=new Date(g.medical_certificate_expiry),v=G(y,f);S(y,f)?r.push({type:"missing-medical",severity:"critical",message:`Medical certificate expired ${Math.abs(v)} days ago`,license:g,daysUntilExpiry:v}):S(y,C)&&r.push({type:"missing-medical",severity:"warning",message:`Medical certificate expires in ${v} days`,license:g,daysUntilExpiry:v})}else r.push({type:"missing-medical",severity:"warning",message:"Medical certificate expiry date not set",license:g});if(g.background_check_expiry){const y=new Date(g.background_check_expiry),v=G(y,f);S(y,f)?r.push({type:"missing-background",severity:"critical",message:`Background check expired ${Math.abs(v)} days ago`,license:g,daysUntilExpiry:v}):S(y,E)&&r.push({type:"missing-background",severity:"warning",message:`Background check expires in ${v} days`,license:g,daysUntilExpiry:v})}else r.push({type:"missing-background",severity:"info",message:"Background check expiry date not set",license:g});if(g.drug_test_expiry){const y=new Date(g.drug_test_expiry),v=G(y,f);S(y,f)?r.push({type:"missing-drug-test",severity:"critical",message:`Drug test expired ${Math.abs(v)} days ago`,license:g,daysUntilExpiry:v}):S(y,E)&&r.push({type:"missing-drug-test",severity:"warning",message:`Drug test expires in ${v} days`,license:g,daysUntilExpiry:v})}else r.push({type:"missing-drug-test",severity:"info",message:"Drug test expiry date not set",license:g});if(g.training_expiry){const y=new Date(g.training_expiry),v=G(y,f);S(y,f)?r.push({type:"missing-training",severity:"critical",message:`Training expired ${Math.abs(v)} days ago`,license:g,daysUntilExpiry:v}):S(y,E)&&r.push({type:"missing-training",severity:"warning",message:`Training expires in ${v} days`,license:g,daysUntilExpiry:v})}else r.push({type:"missing-training",severity:"info",message:"Training expiry date not set",license:g})}),m(r);const i=c.length,d=r.filter(g=>g.severity==="critical").length,I=r.filter(g=>g.severity==="warning").length,X=d+I,K=i-X,te=i>0?Math.round(K/i*100):100;b({total:i,compliant:K,nonCompliant:X,criticalIssues:d,warnings:I,complianceRate:te}),n(!1)};L.useEffect(()=>{l()},[c]);const u=r=>{switch(r){case"critical":return e.jsx(pe,{className:"w-4 h-4 text-red-500"});case"warning":return e.jsx(ae,{className:"w-4 h-4 text-yellow-500"});case"info":return e.jsx(Y,{className:"w-4 h-4 text-blue-500"});default:return e.jsx(Y,{className:"w-4 h-4 text-gray-500"})}},w=r=>{switch(r){case"critical":return"border-red-200 bg-red-50";case"warning":return"border-yellow-200 bg-yellow-50";case"info":return"border-blue-200 bg-blue-50";default:return"border-gray-200 bg-gray-50"}},o=r=>{switch(r){case"expired":return"License Expired";case"expiring-soon":return"License Expiring Soon";case"missing-medical":return"Medical Certificate";case"missing-background":return"Background Check";case"missing-drug-test":return"Drug Test";case"missing-training":return"Training";default:return r}},F=t.filter(r=>r.severity==="critical"),q=t.filter(r=>r.severity==="warning"),B=t.filter(r=>r.severity==="info");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(T,{children:[e.jsx(H,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx($,{children:"License Compliance Overview"}),e.jsx(z,{children:"Automated compliance checking for all driver licenses"})]}),e.jsxs(A,{onClick:()=>{l(),s==null||s()},disabled:j,variant:"outline",size:"sm",children:[e.jsx($e,{className:`w-4 h-4 mr-2 ${j?"animate-spin":""}`}),"Refresh"]})]})}),e.jsxs(M,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:h.total}),e.jsx("div",{className:"text-sm text-gray-600",children:"Total Licenses"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:h.compliant}),e.jsx("div",{className:"text-sm text-gray-600",children:"Compliant"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:h.criticalIssues}),e.jsx("div",{className:"text-sm text-gray-600",children:"Critical Issues"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:h.warnings}),e.jsx("div",{className:"text-sm text-gray-600",children:"Warnings"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Compliance Rate"}),e.jsxs("span",{children:[h.complianceRate,"%"]})]}),e.jsx(Fe,{value:h.complianceRate,className:"h-2"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[h.complianceRate>=90?e.jsx(ze,{className:"w-4 h-4 text-green-500"}):e.jsx(Oe,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:h.complianceRate>=90?"text-green-600":"text-red-600",children:h.complianceRate>=90?"Excellent":"Needs Attention"})]})]})]})]}),F.length>0&&e.jsxs(T,{className:"border-red-200",children:[e.jsxs(H,{children:[e.jsxs($,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(pe,{className:"w-5 h-5"}),"Critical Issues (",F.length,")"]}),e.jsx(z,{children:"These issues require immediate attention"})]}),e.jsx(M,{children:e.jsx("div",{className:"space-y-3",children:F.map((r,f)=>e.jsx(ce,{className:w(r.severity),children:e.jsxs("div",{className:"flex items-start gap-3",children:[u(r.severity),e.jsx("div",{className:"flex-1",children:e.jsxs(de,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("strong",{children:r.license.driver_name})," - ",o(r.type)]}),e.jsx(D,{variant:"destructive",className:"ml-2",children:r.daysUntilExpiry!==void 0?`${Math.abs(r.daysUntilExpiry)} days`:"Unknown"})]}),e.jsx("p",{className:"text-sm mt-1",children:r.message}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["License: ",r.license.license_number," | Type: ",r.license.license_type]})]})})]})},f))})})]}),q.length>0&&e.jsxs(T,{className:"border-yellow-200",children:[e.jsxs(H,{children:[e.jsxs($,{className:"flex items-center gap-2 text-yellow-700",children:[e.jsx(ae,{className:"w-5 h-5"}),"Warnings (",q.length,")"]}),e.jsx(z,{children:"These issues should be addressed soon"})]}),e.jsx(M,{children:e.jsx("div",{className:"space-y-3",children:q.map((r,f)=>e.jsx(ce,{className:w(r.severity),children:e.jsxs("div",{className:"flex items-start gap-3",children:[u(r.severity),e.jsx("div",{className:"flex-1",children:e.jsxs(de,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("strong",{children:r.license.driver_name})," - ",o(r.type)]}),e.jsx(D,{variant:"secondary",className:"ml-2",children:r.daysUntilExpiry!==void 0?`${r.daysUntilExpiry} days`:"Unknown"})]}),e.jsx("p",{className:"text-sm mt-1",children:r.message}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["License: ",r.license.license_number," | Type: ",r.license.license_type]})]})})]})},f))})})]}),B.length>0&&e.jsxs(T,{className:"border-blue-200",children:[e.jsxs(H,{children:[e.jsxs($,{className:"flex items-center gap-2 text-blue-700",children:[e.jsx(Y,{className:"w-5 h-5"}),"Information (",B.length,")"]}),e.jsx(z,{children:"Missing information that should be completed"})]}),e.jsx(M,{children:e.jsx("div",{className:"space-y-3",children:B.map((r,f)=>e.jsx(ce,{className:w(r.severity),children:e.jsxs("div",{className:"flex items-start gap-3",children:[u(r.severity),e.jsx("div",{className:"flex-1",children:e.jsxs(de,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("strong",{children:r.license.driver_name})," - ",o(r.type)]})}),e.jsx("p",{className:"text-sm mt-1",children:r.message}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["License: ",r.license.license_number," | Type: ",r.license.license_type]})]})})]})},f))})})]}),t.length===0&&e.jsxs(T,{className:"border-green-200",children:[e.jsxs(H,{children:[e.jsxs($,{className:"flex items-center gap-2 text-green-700",children:[e.jsx(W,{className:"w-5 h-5"}),"All Clear"]}),e.jsx(z,{children:"All licenses are compliant with current requirements"})]}),e.jsx(M,{children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(W,{className:"w-16 h-16 text-green-500 mx-auto mb-4"}),e.jsx("p",{className:"text-green-700 font-medium",children:"No compliance issues found"}),e.jsx("p",{className:"text-sm text-gray-600 mt-2",children:"All driver licenses are up to date and compliant"})]})})]})]})},_s=()=>{const{user:c,profile:s,loading:t}=fe(),[m,h]=L.useState(""),[b,j]=L.useState("all"),[n,l]=L.useState("all"),[u,w]=L.useState(!1),[o,F]=L.useState(null),[q,B]=L.useState(!1),{data:r,isLoading:f}=es(s==null?void 0:s.organization_id),{data:C}=rs(s==null?void 0:s.organization_id),{data:E}=as(s==null?void 0:s.organization_id,30),i=is();if(t)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading..."})]})});if(!c||!s)return e.jsx(He,{to:"/auth",replace:!0});const d=(r==null?void 0:r.filter(a=>{var le;const y=((le=a.driver_name)==null?void 0:le.toLowerCase().includes(m.toLowerCase()))||a.license_number.toLowerCase().includes(m.toLowerCase())||a.issuing_authority.toLowerCase().includes(m.toLowerCase()),v=b==="all"||a.status===b,ne=n==="all"||a.license_type===n;return y&&v&&ne}))||[],I=a=>{switch(a){case"active":return"bg-green-100 text-green-800";case"expired":return"bg-red-100 text-red-800";case"suspended":return"bg-yellow-100 text-yellow-800";case"revoked":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}},X=a=>{switch(a){case"active":return e.jsx(W,{className:"w-4 h-4"});case"expired":return e.jsx(ae,{className:"w-4 h-4"});case"suspended":return e.jsx(Ze,{className:"w-4 h-4"});case"revoked":return e.jsx(Ye,{className:"w-4 h-4"});default:return e.jsx(Y,{className:"w-4 h-4"})}},K=a=>{const y=new Date(a),v=new Date,ne=y.getTime()-v.getTime();return Math.ceil(ne/(1e3*60*60*24))},te=a=>{const y=K(a);return y<0?"expired":y<=30?"expiring-soon":y<=90?"expiring-warning":"valid"},g=a=>P(void 0,null,function*(){if(window.confirm("Are you sure you want to delete this license? This action cannot be undone."))try{yield i.mutateAsync(a),Q.success("License deleted successfully")}catch(y){Q.error("Failed to delete license")}}),J=a=>{F(a),B(!0)};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"License Management"}),e.jsx("p",{className:"text-gray-600",children:"Manage driver licenses, renewals, and compliance"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(T,{children:e.jsx(M,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Total Licenses"}),e.jsx("p",{className:"text-2xl font-bold",children:(C==null?void 0:C.total)||0})]}),e.jsx(je,{className:"w-8 h-8 text-blue-500"})]})})}),e.jsx(T,{children:e.jsx(M,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Active"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:(C==null?void 0:C.active)||0})]}),e.jsx(W,{className:"w-8 h-8 text-green-500"})]})})}),e.jsx(T,{children:e.jsx(M,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Expiring Soon"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:(C==null?void 0:C.expiringSoon)||0})]}),e.jsx(ae,{className:"w-8 h-8 text-yellow-500"})]})})}),e.jsx(T,{children:e.jsx(M,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Expired"}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:(C==null?void 0:C.expired)||0})]}),e.jsx(Ke,{className:"w-8 h-8 text-red-500"})]})})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 justify-between items-start md:items-center",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 flex-1",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(Qe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(k,{placeholder:"Search licenses...",value:m,onChange:a=>h(a.target.value),className:"pl-10"})]}),e.jsxs(Z,{value:b,onValueChange:j,children:[e.jsx(ee,{className:"w-full md:w-40",children:e.jsx(se,{placeholder:"Status"})}),e.jsxs(ie,{children:[e.jsx(x,{value:"all",children:"All Status"}),e.jsx(x,{value:"active",children:"Active"}),e.jsx(x,{value:"expired",children:"Expired"}),e.jsx(x,{value:"suspended",children:"Suspended"}),e.jsx(x,{value:"revoked",children:"Revoked"})]})]}),e.jsxs(Z,{value:n,onValueChange:l,children:[e.jsx(ee,{className:"w-full md:w-40",children:e.jsx(se,{placeholder:"Type"})}),e.jsxs(ie,{children:[e.jsx(x,{value:"all",children:"All Types"}),e.jsx(x,{value:"CDL-A",children:"CDL-A"}),e.jsx(x,{value:"CDL-B",children:"CDL-B"}),e.jsx(x,{value:"CDL-C",children:"CDL-C"}),e.jsx(x,{value:"Regular",children:"Regular"}),e.jsx(x,{value:"Provisional",children:"Provisional"}),e.jsx(x,{value:"Learner",children:"Learner"}),e.jsx(x,{value:"International",children:"International"}),e.jsx(x,{value:"International-Permit",children:"International Permit"}),e.jsx(x,{value:"Motorcycle",children:"Motorcycle"}),e.jsx(x,{value:"Heavy-Vehicle",children:"Heavy Vehicle"}),e.jsx(x,{value:"Bus-D",children:"Bus"}),e.jsx(x,{value:"Coach",children:"Coach"}),e.jsx(x,{value:"School-Bus",children:"School Bus"}),e.jsx(x,{value:"Hazmat",children:"Hazmat"}),e.jsx(x,{value:"Tanker",children:"Tanker"}),e.jsx(x,{value:"Passenger",children:"Passenger"}),e.jsx(x,{value:"Taxi",children:"Taxi"}),e.jsx(x,{value:"Private-Hire",children:"Private Hire"}),e.jsx(x,{value:"Agricultural",children:"Agricultural"}),e.jsx(x,{value:"Military",children:"Military"}),e.jsx(x,{value:"Emergency",children:"Emergency"}),e.jsx(x,{value:"Police",children:"Police"}),e.jsx(x,{value:"Fire",children:"Fire"}),e.jsx(x,{value:"Ambulance",children:"Ambulance"})]})]})]}),e.jsxs(A,{onClick:()=>w(!0),children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"Add License"]})]}),e.jsxs(Ie,{defaultValue:"all",className:"space-y-6",children:[e.jsxs(Be,{children:[e.jsxs(oe,{value:"all",children:["All Licenses (",d.length,")"]}),e.jsxs(oe,{value:"expiring",children:["Expiring Soon (",(E==null?void 0:E.length)||0,")"]}),e.jsx(oe,{value:"compliance",children:"Compliance Check"})]}),e.jsx(xe,{value:"all",children:e.jsxs(T,{children:[e.jsxs(H,{children:[e.jsx($,{children:"Driver Licenses"}),e.jsx(z,{children:"Manage all driver licenses in your organization"})]}),e.jsx(M,{children:f?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{children:"Loading licenses..."})]}):d.length>0?e.jsxs(Pe,{children:[e.jsx(Ue,{children:e.jsxs(ye,{children:[e.jsx(R,{children:"Driver"}),e.jsx(R,{children:"License Number"}),e.jsx(R,{children:"Type"}),e.jsx(R,{children:"Status"}),e.jsx(R,{children:"Expiry Date"}),e.jsx(R,{children:"Days Left"}),e.jsx(R,{children:"Actions"})]})}),e.jsx(qe,{children:d.map(a=>{const y=K(a.expiry_date),v=te(a.expiry_date);return e.jsxs(ye,{children:[e.jsx(V,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.driver_name}),e.jsx("div",{className:"text-sm text-gray-500",children:a.driver_email})]})}),e.jsx(V,{className:"font-mono",children:a.license_number}),e.jsx(V,{children:e.jsx(D,{variant:"outline",children:a.license_type})}),e.jsx(V,{children:e.jsx(D,{className:I(a.status),children:e.jsxs("div",{className:"flex items-center gap-1",children:[X(a.status),a.status]})})}),e.jsx(V,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Je,{className:"w-4 h-4 text-gray-400"}),U(new Date(a.expiry_date),"MMM dd, yyyy")]})}),e.jsx(V,{children:y>=0?e.jsxs(D,{variant:v==="expiring-soon"?"destructive":v==="expiring-warning"?"secondary":"default",children:[y," days"]}):e.jsxs(D,{variant:"destructive",children:["Expired ",Math.abs(y)," days ago"]})}),e.jsx(V,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{variant:"ghost",size:"sm",onClick:()=>J(a),children:e.jsx(Ge,{className:"w-4 h-4"})}),e.jsx(A,{variant:"ghost",size:"sm",onClick:()=>g(a.id),disabled:i.isPending,children:e.jsx(We,{className:"w-4 h-4"})})]})})]},a.id)})})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(je,{className:"w-12 h-12 mx-auto text-gray-400 mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No licenses found"}),e.jsxs(A,{onClick:()=>w(!0),className:"mt-4",children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"Add First License"]})]})})]})}),e.jsx(xe,{value:"expiring",children:e.jsxs(T,{children:[e.jsxs(H,{children:[e.jsx($,{children:"Licenses Expiring Soon"}),e.jsx(z,{children:"Licenses that will expire within the next 30 days"})]}),e.jsx(M,{children:E&&E.length>0?e.jsx("div",{className:"space-y-4",children:E.map(a=>{const y=K(a.expiry_date);return e.jsx("div",{className:"border rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:a.driver_name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a.license_type," - ",a.license_number]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Issued by: ",a.issuing_authority]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs(D,{variant:"destructive",className:"mb-2",children:[e.jsx(Xe,{className:"w-4 h-4 mr-1"}),y," days left"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Expires: ",U(new Date(a.expiry_date),"MMM dd, yyyy")]})]})]})},a.id)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(W,{className:"w-12 h-12 mx-auto text-green-400 mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No licenses expiring soon"})]})})]})}),e.jsx(xe,{value:"compliance",children:e.jsx(ds,{licenses:r||[],onRefresh:()=>{}})})]}),e.jsx(cs,{open:u,onOpenChange:w}),e.jsx(Ne,{open:q,onOpenChange:B,children:e.jsxs(_e,{className:"max-w-2xl",children:[e.jsxs(be,{children:[e.jsx(we,{children:"License Details"}),e.jsx(Ce,{children:"Complete information about the selected license"})]}),o&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Driver"}),e.jsx("p",{className:"font-medium",children:o.driver_name})]}),e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"License Number"}),e.jsx("p",{className:"font-mono",children:o.license_number})]}),e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Type"}),e.jsx(D,{variant:"outline",children:o.license_type})]}),e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Status"}),e.jsx(D,{className:I(o.status),children:o.status})]}),e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Issuing Authority"}),e.jsx("p",{children:o.issuing_authority})]}),e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"License Class"}),e.jsx("p",{children:o.license_class||"N/A"})]}),e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Issue Date"}),e.jsx("p",{children:U(new Date(o.issue_date),"MMM dd, yyyy")})]}),e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Expiry Date"}),e.jsx("p",{children:U(new Date(o.expiry_date),"MMM dd, yyyy")})]})]}),o.endorsements&&o.endorsements.length>0&&e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Endorsements"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:o.endorsements.map(a=>e.jsx(D,{variant:"secondary",children:a},a))})]}),o.restrictions&&o.restrictions.length>0&&e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Restrictions"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:o.restrictions.map(a=>e.jsx(D,{variant:"destructive",children:a},a))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[o.medical_certificate_expiry&&e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Medical Certificate Expiry"}),e.jsx("p",{children:U(new Date(o.medical_certificate_expiry),"MMM dd, yyyy")})]}),o.background_check_expiry&&e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Background Check Expiry"}),e.jsx("p",{children:U(new Date(o.background_check_expiry),"MMM dd, yyyy")})]}),o.drug_test_expiry&&e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Drug Test Expiry"}),e.jsx("p",{children:U(new Date(o.drug_test_expiry),"MMM dd, yyyy")})]}),o.training_expiry&&e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Training Expiry"}),e.jsx("p",{children:U(new Date(o.training_expiry),"MMM dd, yyyy")})]})]}),o.notes&&e.jsxs("div",{children:[e.jsx(p,{className:"text-sm font-medium text-gray-500",children:"Notes"}),e.jsx("p",{className:"mt-2 text-sm",children:o.notes})]})]})]})})]})};export{_s as default};
