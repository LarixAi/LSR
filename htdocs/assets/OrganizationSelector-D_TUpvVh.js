var u=(v,l,a)=>new Promise((m,p)=>{var c=n=>{try{d(a.next(n))}catch(x){p(x)}},h=n=>{try{d(a.throw(n))}catch(x){p(x)}},d=n=>n.done?m(n.value):Promise.resolve(n.value).then(c,h);d((a=a.apply(v,l)).next())});import{j as e}from"./ui-vendor-DMUr7mTx.js";import{r as j}from"./react-vendor-BvqlMsL5.js";import{u as $,s as N,y as O,C as D,a as k,b as E,e as C,c as T,D as U,F as Z,B as r,m as ee,n as se,o as ae,p as te,S as B,q as Q,r as P,t as J,v as Y,T as ne,G as ie,d as F,I as re}from"./index-ZwIgorfy.js";import{a as le,u as A,b as I}from"./query-vendor-B2F_wWlc.js";import{B as g,E as f,J as ce,j as de,X as oe,C as me,b as he,a2 as V}from"./icons-vendor-b0I7fGSL.js";const be=({onOrganizationSelect:v,selectedOrganizationId:l})=>{const{profile:a}=$(),m=le(),[p,c]=j.useState(!1),[h,d]=j.useState(""),[n,x]=j.useState(""),[o,L]=j.useState(""),[z,H]=j.useState(!1),{data:i=[],isLoading:xe,error:ue}=A({queryKey:["active-mechanic-organizations",a==null?void 0:a.id],queryFn:()=>u(void 0,null,function*(){if(!(a!=null&&a.id))return[];const{data:s,error:t}=yield N.from("mechanic_organization_requests").select(`
          *,
          organization:organizations(*)
        `).eq("mechanic_id",a.id).in("status",["active","approved"]).order("created_at",{ascending:!1});return t?(console.error("Error fetching active organizations:",t),[]):(s==null?void 0:s.map(W=>W.organization))||[]}),enabled:!!(a!=null&&a.id)&&a.role==="mechanic"}),{data:S=[]}=A({queryKey:["pending-mechanic-requests",a==null?void 0:a.id],queryFn:()=>u(void 0,null,function*(){if(!(a!=null&&a.id))return[];const{data:s,error:t}=yield N.from("mechanic_organization_requests").select(`
          *,
          organization:organizations(*)
        `).eq("mechanic_id",a.id).eq("status","pending").order("created_at",{ascending:!1});return t?(console.error("Error fetching pending requests:",t),[]):s||[]}),enabled:!!(a!=null&&a.id)&&a.role==="mechanic"}),{data:b=[]}=A({queryKey:["available-organizations-for-requests",a==null?void 0:a.id],queryFn:()=>u(void 0,null,function*(){if(!(a!=null&&a.id))return[];const{data:s,error:t}=yield N.rpc("get_available_organizations_for_mechanic",{mechanic_uuid:a.id});return t?(console.error("Error fetching available organizations:",t),[]):s||[]}),enabled:!!(a!=null&&a.id)&&a.role==="mechanic"}),_=I({mutationFn:W=>u(void 0,[W],function*({organizationId:s,message:t}){const{data:X,error:K}=yield N.from("mechanic_organization_requests").insert({mechanic_id:a==null?void 0:a.id,organization_id:s,request_type:"mechanic_to_org",requested_by:a==null?void 0:a.id,message:t.trim()||null}).select().single();if(K)throw K;return X}),onSuccess:()=>{O({title:"Request Sent",description:"Your request has been sent to the organization."}),c(!1),d(""),x(""),m.invalidateQueries({queryKey:["pending-mechanic-requests"]}),m.invalidateQueries({queryKey:["available-organizations-for-requests"]})},onError:s=>{O({title:"Error",description:s.message||"Failed to send request.",variant:"destructive"})}}),M=I({mutationFn:s=>u(void 0,null,function*(){const{error:t}=yield N.from("mechanic_organization_requests").update({status:"terminated",terminated_by:a==null?void 0:a.id,terminated_at:new Date().toISOString(),termination_reason:"Cancelled by mechanic"}).eq("id",s);if(t)throw t}),onSuccess:()=>{O({title:"Request Cancelled",description:"Your request has been cancelled."}),m.invalidateQueries({queryKey:["pending-mechanic-requests"]}),m.invalidateQueries({queryKey:["available-organizations-for-requests"]})}});if(j.useEffect(()=>{var s;i&&i.length>0&&!l&&v((s=i[0])==null?void 0:s.id)},[i,l,v]),(a==null?void 0:a.role)!=="mechanic")return null;const w=i.find(s=>(s==null?void 0:s.id)===l),q=i.length,G=S.length,R=q<3,y=b.filter(s=>s.name.toLowerCase().includes(o.toLowerCase())||s.type.toLowerCase().includes(o.toLowerCase())||s.slug&&s.slug.toLowerCase().includes(o.toLowerCase()));return e.jsxs("div",{className:"mb-6 space-y-4",children:[e.jsxs(D,{children:[e.jsx(k,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(E,{className:"text-lg flex items-center space-x-2",children:[e.jsx(g,{className:"h-5 w-5"}),e.jsx("span",{children:"Working Organizations"}),e.jsxs(C,{variant:"outline",className:"ml-2",children:[q,"/3 Active"]})]}),e.jsx(T,{children:"Select which company you want to work with"})]}),R&&e.jsxs(U,{open:p,onOpenChange:c,children:[e.jsx(Z,{asChild:!0,children:e.jsxs(r,{size:"sm",className:"flex items-center space-x-2",children:[e.jsx(f,{className:"h-4 w-4"}),e.jsx("span",{children:"Request to Join"})]})}),e.jsxs(ee,{children:[e.jsxs(se,{children:[e.jsx(ae,{children:"Request to Join Organization"}),e.jsx(te,{children:"Send a request to join a new organization. You can work with up to 3 companies."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Organization"}),e.jsxs(B,{value:h,onValueChange:d,children:[e.jsx(Q,{children:e.jsx(P,{placeholder:"Choose an organization..."})}),e.jsx(J,{children:b.map(s=>e.jsx(Y,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Message (Optional)"}),e.jsx(ne,{placeholder:"Tell them why you'd like to work with them...",value:n,onChange:s=>x(s.target.value),rows:3})]})]}),e.jsxs(ie,{children:[e.jsx(r,{variant:"outline",onClick:()=>c(!1),children:"Cancel"}),e.jsx(r,{onClick:()=>{h&&_.mutate({organizationId:h,message:n})},disabled:!h||_.isPending,children:_.isPending?"Sending...":"Send Request"})]})]})]})]})}),e.jsx(F,{children:i.length>0?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Select Organization"}),e.jsxs(B,{value:l||"",onValueChange:v,children:[e.jsx(Q,{className:"w-full",children:e.jsx(P,{placeholder:"Choose an organization..."})}),e.jsx(J,{children:i.map(s=>e.jsx(Y,{value:s==null?void 0:s.id,children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(g,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{children:s==null?void 0:s.name}),l===(s==null?void 0:s.id)&&e.jsx(ce,{className:"h-4 w-4 text-blue-600 ml-auto"})]})},s==null?void 0:s.id))})]})]}),w&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-full",children:e.jsx(g,{className:"h-4 w-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-900",children:w==null?void 0:w.name}),e.jsxs("p",{className:"text-sm text-blue-600",children:["Currently active â€¢ ",q," organization",q>1?"s":""," available"]})]})]}),e.jsx(C,{variant:"secondary",className:"bg-blue-100 text-blue-700",children:"Active"})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(g,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Active Organizations"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"You need to request to join organizations to start working."}),R&&e.jsxs(r,{onClick:()=>c(!0),children:[e.jsx(f,{className:"h-4 w-4 mr-2"}),"Request to Join Organization"]})]})})]}),S.length>0&&e.jsxs(D,{children:[e.jsx(k,{children:e.jsxs(E,{className:"text-lg flex items-center space-x-2",children:[e.jsx(de,{className:"h-5 w-5"}),e.jsx("span",{children:"Pending Requests"}),e.jsx(C,{variant:"outline",children:G})]})}),e.jsx(F,{children:e.jsx("div",{className:"space-y-3",children:S.map(s=>{var t;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(g,{className:"h-5 w-5 text-orange-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:(t=s.organization)==null?void 0:t.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Requested ",new Date(s.created_at).toLocaleDateString()]}),s.message&&e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:['"',s.message,'"']})]})]}),e.jsxs(r,{variant:"outline",size:"sm",onClick:()=>M.mutate(s.id),disabled:M.isPending,children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Cancel"]})]},s.id)})})})]}),b.length>0&&R&&e.jsxs(D,{children:[e.jsxs(k,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(E,{className:"text-lg flex items-center space-x-2",children:[e.jsx(f,{className:"h-5 w-5"}),e.jsx("span",{children:"Available Organizations"}),e.jsx(C,{variant:"outline",children:b.length})]}),e.jsx(r,{variant:"ghost",size:"sm",onClick:()=>H(!z),className:"p-1 h-8 w-8",children:z?e.jsx(me,{className:"h-4 w-4"}):e.jsx(he,{className:"h-4 w-4"})})]}),e.jsx(T,{children:"Organizations you can request to join"})]}),z&&e.jsxs(F,{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(V,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(re,{placeholder:"Search organizations by name, type, or slug...",value:o,onChange:s=>L(s.target.value),className:"pl-10"})]})}),e.jsx("div",{className:"grid gap-3",children:y.length>0?y.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(g,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600",children:s.type}),s.slug&&e.jsxs("p",{className:"text-xs text-gray-500",children:["@",s.slug]})]})]}),e.jsxs(r,{size:"sm",onClick:()=>{d(s.id),c(!0)},children:[e.jsx(f,{className:"h-4 w-4 mr-1"}),"Request"]})]},s.id)):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(V,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Organizations Found"}),e.jsx("p",{className:"text-gray-600",children:o?`No organizations match "${o}"`:"No organizations available to request"}),o&&e.jsx(r,{variant:"outline",size:"sm",onClick:()=>L(""),className:"mt-2",children:"Clear Search"})]})}),y.length>5&&e.jsx("div",{className:"mt-3 text-center",children:e.jsxs("p",{className:"text-sm text-gray-500",children:["Showing ",Math.min(5,y.length)," of ",y.length," organizations"]})})]})]})]})};export{be as O};
