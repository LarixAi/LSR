var $e=Object.defineProperty,Ke=Object.defineProperties;var Be=Object.getOwnPropertyDescriptors;var Fe=Object.getOwnPropertySymbols;var We=Object.prototype.hasOwnProperty,He=Object.prototype.propertyIsEnumerable;var Te=(r,a,m)=>a in r?$e(r,a,{enumerable:!0,configurable:!0,writable:!0,value:m}):r[a]=m,je=(r,a)=>{for(var m in a||(a={}))We.call(a,m)&&Te(r,m,a[m]);if(Fe)for(var m of Fe(a))He.call(a,m)&&Te(r,m,a[m]);return r},ge=(r,a)=>Ke(r,Be(a));var C=(r,a,m)=>new Promise((S,F)=>{var D=N=>{try{T(m.next(N))}catch(n){F(n)}},J=N=>{try{T(m.throw(N))}catch(n){F(n)}},T=N=>N.done?S(N.value):Promise.resolve(N.value).then(D,J);T((m=m.apply(r,a)).next())});import{j as e}from"./ui-vendor-DMUr7mTx.js";import{r as _}from"./react-vendor-BvqlMsL5.js";import{u as ze,l as ke,s as y,C as L,a as E,b as I,d as U,L as x,S as O,q as $,r as K,t as B,v as o,B as v,A as Qe,g as Ge,e as W,P as Je,D as de,m as ce,n as oe,o as he,p as Ye,I as q,T as ve,h as Ze,i as Xe,j as Ce,k as Se}from"./index-ZwIgorfy.js";import{T as pe,a as _e,b as H,c as j,d as ye,e as u}from"./table-6WL4qh3Z.js";import{a as Ae,u as Q,b as fe}from"./query-vendor-B2F_wWlc.js";import{bx as qe,by as es,bq as ss,br as Re,J as xe,y as De,Z as Ve,ab as as,aL as ts,F as Ne,T as is,S as rs,a as ns,f as ls,af as we,k as Ue,m as Me,a2 as be,aa as Oe,ak as Pe,aG as Le,Y as ds}from"./icons-vendor-b0I7fGSL.js";import{N as Ee}from"./router-vendor-CEyBJ8vK.js";import"./supabase-vendor-B984m0TI.js";import"./utils-vendor-B2FlkASS.js";import"./ui-components-7w1-MJre.js";const cs=({onDataDownloaded:r})=>{const{profile:a}=ze(),{toast:m}=ke(),S=Ae(),[F,D]=_.useState(!1),[J,T]=_.useState(!1),[N,n]=_.useState(0),[G,X]=_.useState(null),[p,ie]=_.useState(null),[V,d]=_.useState("");_.useState(!1);const[ue,re]=_.useState(!1),[ee,z]=_.useState(!1),[Y,se]=_.useState("disconnected"),{data:P=[],isLoading:me}=Q({queryKey:["card-readers",a==null?void 0:a.organization_id],queryFn:()=>C(void 0,null,function*(){if(!(a!=null&&a.organization_id))return[];const{data:i,error:g}=yield y.from("tachograph_card_readers").select("*").eq("organization_id",a.organization_id).eq("status","active");return g?(console.error("Error fetching card readers:",g),[]):i||[]}),enabled:!!(a!=null&&a.organization_id)}),{data:R=[]}=Q({queryKey:["download-sessions",a==null?void 0:a.organization_id],queryFn:()=>C(void 0,null,function*(){if(!(a!=null&&a.organization_id))return[];const{data:i,error:g}=yield y.from("tachograph_download_sessions").select("*").eq("organization_id",a.organization_id).order("download_start_time",{ascending:!1}).limit(10);return g?(console.error("Error fetching download sessions:",g),[]):i||[]}),enabled:!!(a!=null&&a.organization_id)}),{data:ae=[]}=Q({queryKey:["vehicles",a==null?void 0:a.organization_id],queryFn:()=>C(void 0,null,function*(){if(!(a!=null&&a.organization_id))return[];const{data:i,error:g}=yield y.from("vehicles").select("id, vehicle_number, license_plate").eq("organization_id",a.organization_id);return g?[]:i||[]}),enabled:!!(a!=null&&a.organization_id)}),{data:Z=[]}=Q({queryKey:["drivers",a==null?void 0:a.organization_id],queryFn:()=>C(void 0,null,function*(){if(!(a!=null&&a.organization_id))return[];const{data:i,error:g}=yield y.from("profiles").select("id, first_name, last_name").eq("organization_id",a.organization_id).eq("role","driver");return g?[]:i||[]}),enabled:!!(a!=null&&a.organization_id)}),t=()=>C(void 0,null,function*(){if(!V){m({title:"No Reader Selected",description:"Please select a card reader first",variant:"destructive"});return}try{se("connecting"),D(!1),n(0),ie(null),X(null),z(!1),yield new Promise(i=>setTimeout(i,2e3)),D(!0),se("connected"),m({title:"Connected",description:"Card reader is connected. Please insert a tachograph card manually."})}catch(i){console.error("Failed to connect to card reader:",i),se("error"),m({title:"Connection Failed",description:"Failed to connect to card reader. Please check the connection and try again.",variant:"destructive"})}}),l=()=>{D(!1),se("disconnected"),ie(null),X(null),z(!1),n(0),m({title:"Disconnected",description:"Disconnected from card reader"})},w=()=>C(void 0,null,function*(){if(!F){m({title:"Not Connected",description:"Please connect to a card reader first",variant:"destructive"});return}try{m({title:"Manual Detection Required",description:"Please insert a tachograph card and use the card reader's detection button or software.",variant:"destructive"})}catch(i){console.error("Failed to detect card:",i),m({title:"Card Detection Failed",description:"Failed to detect card. Please check the card and try again.",variant:"destructive"})}}),s=()=>{ie(null),X(null),z(!1),m({title:"Card Ejected",description:"Card has been ejected from reader"})},c=()=>C(void 0,null,function*(){var i,g;if(!F||!G||!V||!p){m({title:"Cannot Download",description:"Please ensure a card is detected and reader is connected",variant:"destructive"});return}T(!0),n(0);try{const{data:M,error:k}=yield y.from("tachograph_download_sessions").insert({organization_id:a==null?void 0:a.organization_id,card_reader_id:V,card_type:G,card_number:p.card_number,download_status:"in_progress",download_method:"card_reader"}).select().single();if(k)throw k;const h=[{progress:10,message:"Initializing download..."},{progress:25,message:"Reading card data..."},{progress:50,message:"Processing records..."},{progress:75,message:"Validating data..."},{progress:90,message:"Saving to database..."},{progress:100,message:"Download complete!"}];for(const A of h)yield new Promise(le=>setTimeout(le,800)),n(A.progress);const ne={id:`record_${Date.now()}`,driver_id:((i=Z[0])==null?void 0:i.id)||"",vehicle_id:((g=ae[0])==null?void 0:g.id)||"",record_date:new Date().toISOString().split("T")[0],start_time:new Date().toISOString(),end_time:new Date(Date.now()+36e5).toISOString(),activity_type:"driving",distance_km:0,start_location:"Manual Entry Required",end_location:"Manual Entry Required",speed_data:{max_speed:0},violations:[]},{error:te}=yield y.from("tachograph_records").insert(ge(je({},ne),{organization_id:a==null?void 0:a.organization_id,card_type:G,card_number:p.card_number,download_method:"card_reader"}));if(te)throw te;yield y.from("tachograph_download_sessions").update({download_status:"completed",download_end_time:new Date().toISOString(),records_downloaded:1}).eq("id",M.id),T(!1),n(0),m({title:"Download Complete",description:"Download process completed. Note: This is a placeholder - real card data requires actual card reader integration."}),r&&r({cardType:G,recordsCount:1}),S.invalidateQueries({queryKey:["tachograph-records"]}),S.invalidateQueries({queryKey:["download-sessions"]})}catch(M){console.error("Download failed:",M),T(!1),n(0),m({title:"Download Failed",description:"Failed to download card data. Please try again.",variant:"destructive"})}}),f=()=>{switch(Y){case"connected":return e.jsx(xe,{className:"w-5 h-5 text-green-500"});case"connecting":return e.jsx(Ve,{className:"w-5 h-5 text-yellow-500 animate-spin"});case"error":return e.jsx(is,{className:"w-5 h-5 text-red-500"});default:return e.jsx(Re,{className:"w-5 h-5 text-gray-400"})}},b=i=>{switch(i){case"driver":return e.jsx(ls,{className:"w-4 h-4"});case"vehicle":return e.jsx(ns,{className:"w-4 h-4"});case"workshop":return e.jsx(rs,{className:"w-4 h-4"});default:return e.jsx(De,{className:"w-4 h-4"})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(L,{children:[e.jsx(E,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[f(),"Card Reader Status"]})}),e.jsxs(U,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(x,{children:"Card Reader"}),e.jsxs(O,{value:V,onValueChange:d,children:[e.jsx($,{children:e.jsx(K,{placeholder:"Select card reader"})}),e.jsx(B,{children:me?e.jsx(o,{value:"loading",disabled:!0,children:"Loading readers..."}):P.length===0?e.jsx(o,{value:"no-readers",disabled:!0,children:"No card readers available"}):P.map(i=>e.jsx(o,{value:i.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[i.device_type==="usb_reader"&&e.jsx(qe,{className:"w-4 h-4"}),i.device_type==="bluetooth_reader"&&e.jsx(es,{className:"w-4 h-4"}),(i.device_type==="digivu_plus"||i.device_type==="generation_2")&&e.jsx(ss,{className:"w-4 h-4"}),i.device_name]})},i.id))})]})]}),e.jsx("div",{className:"flex items-end gap-2",children:F?e.jsxs(v,{variant:"outline",onClick:l,children:[e.jsx(Re,{className:"w-4 h-4 mr-2"}),"Disconnect"]}):e.jsxs(v,{onClick:t,disabled:!V||Y==="connecting",children:[e.jsx(qe,{className:"w-4 h-4 mr-2"}),"Connect"]})})]}),F&&e.jsxs(Qe,{children:[e.jsx(xe,{className:"h-4 w-4"}),e.jsx(Ge,{children:"Card reader is connected. Please insert a tachograph card and use the card reader's software to detect it."})]})]})]}),F&&e.jsxs(L,{children:[e.jsx(E,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(De,{className:"w-5 h-5"}),"Card Detection"]})}),e.jsx(U,{children:ee?p&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(x,{children:"Card Type"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[b(p.card_type),e.jsx("span",{className:"capitalize",children:p.card_type}),e.jsx(W,{variant:p.card_status==="valid"?"default":"destructive",children:p.card_status})]})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Card Number"}),e.jsx("p",{className:"font-mono text-sm mt-1",children:p.card_number})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Card Holder"}),e.jsx("p",{className:"mt-1",children:p.holder_name})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Issuing Authority"}),e.jsx("p",{className:"mt-1",children:p.issuing_authority})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Expiry Date"}),e.jsx("p",{className:"mt-1",children:new Date(p.expiry_date).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Records Available"}),e.jsxs("p",{className:"mt-1",children:[p.records_count," records"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{onClick:c,disabled:J,children:[e.jsx(as,{className:"w-4 h-4 mr-2"}),"Download Data"]}),e.jsxs(v,{variant:"outline",onClick:s,children:[e.jsx(ts,{className:"w-4 h-4 mr-2"}),"Eject Card"]})]}),J&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Downloading..."}),e.jsxs("span",{children:[N,"%"]})]}),e.jsx(Je,{value:N})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(De,{className:"w-16 h-16 mx-auto text-gray-400 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"No card detected"}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Insert a tachograph card and use your card reader's software to detect it."}),e.jsxs(v,{onClick:w,variant:"outline",className:"mt-4",disabled:!F,children:[e.jsx(Ve,{className:"w-4 h-4 mr-2"}),"Manual Detection"]})]})})]}),e.jsxs(L,{children:[e.jsx(E,{children:e.jsxs(I,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-5 h-5"}),"Recent Downloads"]}),e.jsx(v,{variant:"outline",size:"sm",onClick:()=>re(!0),children:"View All"})]})}),e.jsx(U,{children:e.jsxs(pe,{children:[e.jsx(_e,{children:e.jsxs(H,{children:[e.jsx(j,{children:"Date"}),e.jsx(j,{children:"Card Type"}),e.jsx(j,{children:"Card Number"}),e.jsx(j,{children:"Status"}),e.jsx(j,{children:"Records"})]})}),e.jsx(ye,{children:R.slice(0,5).map(i=>e.jsxs(H,{children:[e.jsx(u,{children:new Date(i.download_start_time).toLocaleDateString()}),e.jsx(u,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[b(i.card_type),e.jsx("span",{className:"capitalize",children:i.card_type})]})}),e.jsx(u,{className:"font-mono text-sm",children:i.card_number}),e.jsx(u,{children:e.jsx(W,{variant:i.download_status==="completed"?"default":i.download_status==="failed"?"destructive":"secondary",children:i.download_status})}),e.jsx(u,{children:i.records_downloaded||0})]},i.id))})]})})]}),e.jsx(de,{open:ue,onOpenChange:re,children:e.jsxs(ce,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(oe,{children:[e.jsx(he,{children:"Download History"}),e.jsx(Ye,{children:"View all tachograph card download sessions"})]}),e.jsxs(pe,{children:[e.jsx(_e,{children:e.jsxs(H,{children:[e.jsx(j,{children:"Date & Time"}),e.jsx(j,{children:"Card Type"}),e.jsx(j,{children:"Card Number"}),e.jsx(j,{children:"Status"}),e.jsx(j,{children:"Records"}),e.jsx(j,{children:"Method"})]})}),e.jsx(ye,{children:R.map(i=>e.jsxs(H,{children:[e.jsx(u,{children:new Date(i.download_start_time).toLocaleString()}),e.jsx(u,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[b(i.card_type),e.jsx("span",{className:"capitalize",children:i.card_type})]})}),e.jsx(u,{className:"font-mono text-sm",children:i.card_number}),e.jsx(u,{children:e.jsx(W,{variant:i.download_status==="completed"?"default":i.download_status==="failed"?"destructive":"secondary",children:i.download_status})}),e.jsx(u,{children:i.records_downloaded||0}),e.jsx(u,{className:"capitalize",children:i.download_method})]},i.id))})]})]})})]})};var Ie={};const os=()=>{const{profile:r}=ze(),{toast:a}=ke(),m=Ae(),[S,F]=_.useState(""),[D,J]=_.useState("all");_.useState("all");const[T,N]=_.useState(!1),[n,G]=_.useState(null),[X,p]=_.useState(!1),[ie,V]=_.useState(!1),{data:d=[],isLoading:ue}=Q({queryKey:["analog-charts",r==null?void 0:r.organization_id],queryFn:()=>C(void 0,null,function*(){if(!(r!=null&&r.organization_id))return[];const{data:t,error:l}=yield y.from("analog_tachograph_charts").select(`
          *,
          profiles!analog_tachograph_charts_driver_id_fkey(
            first_name,
            last_name
          ),
          vehicles!analog_tachograph_charts_vehicle_id_fkey(
            vehicle_number,
            license_plate
          )
        `).eq("organization_id",r.organization_id).order("chart_date",{ascending:!1});return l?(console.error("Error fetching analog charts:",l),a({title:"Error",description:"Failed to load analog charts",variant:"destructive"}),[]):(t==null?void 0:t.map(w=>{var s,c;return ge(je({},w),{driver_name:w.profiles?`${w.profiles.first_name||""} ${w.profiles.last_name||""}`.trim():"Unknown Driver",vehicle_number:((s=w.vehicles)==null?void 0:s.vehicle_number)||"Unknown Vehicle",vehicle_license_plate:((c=w.vehicles)==null?void 0:c.license_plate)||"No Plate"})}))||[]}),enabled:!!(r!=null&&r.organization_id)}),{data:re=[]}=Q({queryKey:["vehicles",r==null?void 0:r.organization_id],queryFn:()=>C(void 0,null,function*(){if(!(r!=null&&r.organization_id))return[];const{data:t,error:l}=yield y.from("vehicles").select("id, vehicle_number, license_plate").eq("organization_id",r.organization_id);return l?[]:t||[]}),enabled:!!(r!=null&&r.organization_id)}),{data:ee=[]}=Q({queryKey:["drivers",r==null?void 0:r.organization_id],queryFn:()=>C(void 0,null,function*(){if(!(r!=null&&r.organization_id))return[];const{data:t,error:l}=yield y.from("profiles").select("id, first_name, last_name").eq("organization_id",r.organization_id).eq("role","driver");return l?[]:t||[]}),enabled:!!(r!=null&&r.organization_id)}),z=fe({mutationFn:t=>C(void 0,null,function*(){const l=t.get("chart_file"),w=t.get("chart_number"),s=t.get("chart_date"),{data:c,error:f}=yield y.storage.from("analog-charts").upload(`${r==null?void 0:r.organization_id}/${s}_${w}_${Date.now()}.jpg`,l);if(f)throw f;const b={organization_id:r==null?void 0:r.organization_id,driver_id:t.get("driver_id")||null,vehicle_id:t.get("vehicle_id")||null,chart_number:w,chart_date:s,start_time:t.get("start_time")||null,end_time:t.get("end_time")||null,total_distance_km:parseFloat(t.get("total_distance_km"))||null,chart_type:t.get("chart_type"),chart_format:t.get("chart_format"),chart_size:t.get("chart_size"),chart_image_url:c.path,chart_condition:t.get("chart_condition"),uploaded_by:r==null?void 0:r.id,driving_periods:[],rest_periods:[],violations:[],manual_analysis_completed:!1},{error:i}=yield y.from("analog_tachograph_charts").insert(b);if(i)throw i}),onSuccess:()=>{m.invalidateQueries({queryKey:["analog-charts"]}),N(!1),a({title:"Success",description:"Analog chart uploaded successfully"})},onError:t=>{console.error("Upload error:",t),a({title:"Error",description:"Failed to upload analog chart",variant:"destructive"})}}),Y=fe({mutationFn:w=>C(void 0,[w],function*({chartId:t,analysisData:l}){const{error:s}=yield y.from("analog_tachograph_charts").update({driving_periods:l.driving_periods,rest_periods:l.rest_periods,work_periods:l.work_periods,availability_periods:l.availability_periods,break_periods:l.break_periods,violations:l.violations,manual_analysis_completed:!0,analysis_notes:l.notes,analyzed_by:r==null?void 0:r.id,analyzed_at:new Date().toISOString()}).eq("id",t);if(s)throw s}),onSuccess:()=>{m.invalidateQueries({queryKey:["analog-charts"]}),V(!1),a({title:"Success",description:"Chart analysis completed"})},onError:t=>{console.error("Analysis error:",t),a({title:"Error",description:"Failed to save analysis",variant:"destructive"})}}),P=(()=>{if(d.length===0)return{totalCharts:0,analyzedCharts:0,pendingAnalysis:0,chartsWithViolations:0,averageDistance:0,complianceRate:100};const t=d.length,l=d.filter(i=>i.manual_analysis_completed).length,w=t-l,s=d.filter(i=>i.violations&&Array.isArray(i.violations)&&i.violations.length>0).length,f=d.reduce((i,g)=>i+(g.total_distance_km||0),0)/t,b=t>0?(t-s)/t*100:100;return{totalCharts:t,analyzedCharts:l,pendingAnalysis:w,chartsWithViolations:s,averageDistance:Math.round(f*100)/100,complianceRate:Math.round(b*100)/100}})(),me=d.filter(t=>{var s,c,f;const l=S===""||((s=t.driver_name)==null?void 0:s.toLowerCase().includes(S.toLowerCase()))||((c=t.vehicle_number)==null?void 0:c.toLowerCase().includes(S.toLowerCase()))||((f=t.chart_number)==null?void 0:f.toLowerCase().includes(S.toLowerCase())),w=D==="all"||D==="analyzed"&&t.manual_analysis_completed||D==="pending"&&!t.manual_analysis_completed||D==="violations"&&t.violations&&Array.isArray(t.violations)&&t.violations.length>0;return l&&w}),R=t=>t.manual_analysis_completed?e.jsx(W,{variant:"default",className:"bg-green-100 text-green-800",children:"Analyzed"}):t.violations&&Array.isArray(t.violations)&&t.violations.length>0?e.jsx(W,{variant:"destructive",children:"Violations"}):e.jsx(W,{variant:"secondary",children:"Pending Analysis"}),ae=t=>{const l={"24_hour":"bg-blue-100 text-blue-800","7_day":"bg-purple-100 text-purple-800",custom:"bg-orange-100 text-orange-800"};return e.jsx(W,{className:l[t]||"bg-gray-100 text-gray-800",children:t.replace("_"," ").toUpperCase()})},Z=t=>{const l={excellent:"bg-green-100 text-green-800",good:"bg-blue-100 text-blue-800",fair:"bg-yellow-100 text-yellow-800",poor:"bg-orange-100 text-orange-800",damaged:"bg-red-100 text-red-800"};return e.jsx(W,{className:l[t]||"bg-gray-100 text-gray-800",children:t.charAt(0).toUpperCase()+t.slice(1)})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Analog Charts"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage analog tachograph charts and manual analysis"})]}),e.jsxs(v,{onClick:()=>N(!0),className:"inline-flex items-center",children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Upload Chart"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(L,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Total Charts"}),e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsx("div",{className:"text-2xl font-bold",children:P.totalCharts}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"All time analog charts"})]})]}),e.jsxs(L,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Analyzed Charts"}),e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsx("div",{className:"text-2xl font-bold",children:P.analyzedCharts}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[P.totalCharts>0?Math.round(P.analyzedCharts/P.totalCharts*100):0,"% of total"]})]})]}),e.jsxs(L,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Compliance Rate"}),e.jsx(Ue,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[P.complianceRate,"%"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[P.chartsWithViolations," violations detected"]})]})]}),e.jsxs(L,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Avg Distance"}),e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[P.averageDistance," km"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Per chart"})]})]})]}),e.jsxs(L,{children:[e.jsx(E,{children:e.jsx(I,{children:"Analog Charts"})}),e.jsxs(U,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(q,{placeholder:"Search by driver, vehicle, or chart number...",value:S,onChange:t=>F(t.target.value),className:"pl-10"})]})}),e.jsxs(O,{value:D,onValueChange:J,children:[e.jsx($,{className:"w-full sm:w-[180px]",children:e.jsx(K,{placeholder:"Filter by status"})}),e.jsxs(B,{children:[e.jsx(o,{value:"all",children:"All Status"}),e.jsx(o,{value:"analyzed",children:"Analyzed"}),e.jsx(o,{value:"pending",children:"Pending Analysis"}),e.jsx(o,{value:"violations",children:"With Violations"})]})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(pe,{children:[e.jsx(_e,{children:e.jsxs(H,{children:[e.jsx(j,{children:"Date"}),e.jsx(j,{children:"Chart Number"}),e.jsx(j,{children:"Driver"}),e.jsx(j,{children:"Vehicle"}),e.jsx(j,{children:"Type"}),e.jsx(j,{children:"Distance"}),e.jsx(j,{children:"Condition"}),e.jsx(j,{children:"Status"}),e.jsx(j,{children:"Actions"})]})}),e.jsx(ye,{children:me.length===0?e.jsx(H,{children:e.jsx(u,{colSpan:9,className:"text-center py-8",children:e.jsx("div",{className:"text-muted-foreground",children:d.length===0?e.jsxs("div",{children:[e.jsx(Ne,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No analog charts found"}),e.jsx("p",{className:"text-sm",children:"Upload your first analog chart to get started"}),e.jsxs(v,{onClick:()=>N(!0),className:"mt-4",variant:"outline",children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Upload First Chart"]})]}):e.jsxs("div",{children:[e.jsx(be,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No charts match your filters"}),e.jsx("p",{className:"text-sm",children:"Try adjusting your search criteria"})]})})})}):me.map(t=>e.jsxs(H,{children:[e.jsx(u,{children:e.jsx("div",{className:"font-medium",children:new Date(t.chart_date).toLocaleDateString()})}),e.jsx(u,{children:e.jsx("div",{className:"font-medium",children:t.chart_number})}),e.jsx(u,{children:e.jsx("div",{className:"font-medium",children:t.driver_name})}),e.jsx(u,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.vehicle_number}),e.jsx("div",{className:"text-sm text-muted-foreground",children:t.vehicle_license_plate})]})}),e.jsx(u,{children:ae(t.chart_type)}),e.jsx(u,{children:t.total_distance_km?`${t.total_distance_km} km`:"-"}),e.jsx(u,{children:Z(t.chart_condition)}),e.jsx(u,{children:R(t)}),e.jsx(u,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>{G(t),p(!0)},children:e.jsx(Oe,{className:"h-4 w-4"})}),!t.manual_analysis_completed&&e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>{G(t),V(!0)},children:e.jsx(Pe,{className:"h-4 w-4"})})]})})]},t.id))})]})})]})]}),e.jsx(de,{open:T,onOpenChange:N,children:e.jsxs(ce,{className:"max-w-2xl",children:[e.jsx(oe,{children:e.jsx(he,{children:"Upload Analog Chart"})}),e.jsxs("form",{onSubmit:t=>{t.preventDefault();const l=new FormData(t.currentTarget);z.mutate(l)},children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"chart_number",children:"Chart Number"}),e.jsx(q,{name:"chart_number",required:!0,placeholder:"e.g., CHART-2024-001"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"chart_date",children:"Chart Date"}),e.jsx(q,{type:"date",name:"chart_date",required:!0})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"driver_id",children:"Driver"}),e.jsxs(O,{name:"driver_id",required:!0,children:[e.jsx($,{children:e.jsx(K,{placeholder:"Select driver"})}),e.jsx(B,{children:ee.map(t=>e.jsxs(o,{value:t.id,children:[t.first_name," ",t.last_name]},t.id))})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"vehicle_id",children:"Vehicle"}),e.jsxs(O,{name:"vehicle_id",required:!0,children:[e.jsx($,{children:e.jsx(K,{placeholder:"Select vehicle"})}),e.jsx(B,{children:re.map(t=>e.jsxs(o,{value:t.id,children:[t.vehicle_number," (",t.license_plate,")"]},t.id))})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"chart_type",children:"Chart Type"}),e.jsxs(O,{name:"chart_type",required:!0,children:[e.jsx($,{children:e.jsx(K,{placeholder:"Select chart type"})}),e.jsxs(B,{children:[e.jsx(o,{value:"24_hour",children:"24 Hour"}),e.jsx(o,{value:"7_day",children:"7 Day"}),e.jsx(o,{value:"custom",children:"Custom"})]})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"chart_format",children:"Chart Format"}),e.jsxs(O,{name:"chart_format",required:!0,children:[e.jsx($,{children:e.jsx(K,{placeholder:"Select format"})}),e.jsxs(B,{children:[e.jsx(o,{value:"circular",children:"Circular"}),e.jsx(o,{value:"strip",children:"Strip"})]})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"start_time",children:"Start Time"}),e.jsx(q,{type:"time",name:"start_time"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"end_time",children:"End Time"}),e.jsx(q,{type:"time",name:"end_time"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"total_distance_km",children:"Total Distance (km)"}),e.jsx(q,{type:"number",name:"total_distance_km",step:"0.1"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"chart_condition",children:"Chart Condition"}),e.jsxs(O,{name:"chart_condition",required:!0,children:[e.jsx($,{children:e.jsx(K,{placeholder:"Select condition"})}),e.jsxs(B,{children:[e.jsx(o,{value:"excellent",children:"Excellent"}),e.jsx(o,{value:"good",children:"Good"}),e.jsx(o,{value:"fair",children:"Fair"}),e.jsx(o,{value:"poor",children:"Poor"}),e.jsx(o,{value:"damaged",children:"Damaged"})]})]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(x,{htmlFor:"chart_file",children:"Chart Image"}),e.jsx(q,{type:"file",name:"chart_file",accept:"image/*,.pdf",required:!0,className:"mt-1"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Upload a clear image or PDF of the analog chart"})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-6",children:[e.jsx(v,{type:"button",variant:"outline",onClick:()=>N(!1),children:"Cancel"}),e.jsx(v,{type:"submit",disabled:z.isPending,children:z.isPending?"Uploading...":"Upload Chart"})]})]})]})}),e.jsx(de,{open:X,onOpenChange:p,children:e.jsxs(ce,{className:"max-w-4xl",children:[e.jsx(oe,{children:e.jsx(he,{children:"Analog Chart Details"})}),n&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Chart Number:"})," ",n.chart_number]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(n.chart_date).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Driver:"})," ",n.driver_name]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle:"})," ",n.vehicle_number," (",n.vehicle_license_plate,")"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",ae(n.chart_type)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Format:"})," ",n.chart_format]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Distance:"})," ",n.total_distance_km?`${n.total_distance_km} km`:"Not recorded"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Analysis Status"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",R(n)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Condition:"})," ",Z(n.chart_condition)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Uploaded:"})," ",new Date(n.uploaded_at).toLocaleString()]}),n.analysis_notes&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Notes:"})," ",n.analysis_notes]})]})]})]}),n.chart_image_url&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Image"}),e.jsx("div",{className:"border rounded-lg p-4",children:e.jsx("img",{src:`${Ie.REACT_APP_SUPABASE_URL}/storage/v1/object/public/analog-charts/${n.chart_image_url}`,alt:"Analog Chart",className:"max-w-full h-auto rounded"})})]}),n.violations&&Array.isArray(n.violations)&&n.violations.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Violations Detected"}),e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-red-800",children:n.violations.map((t,l)=>e.jsx("li",{children:t},l))})})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(v,{variant:"outline",onClick:()=>p(!1),children:"Close"}),!n.manual_analysis_completed&&e.jsxs(v,{onClick:()=>{p(!1),V(!0)},children:[e.jsx(Pe,{className:"mr-2 h-4 w-4"}),"Analyze Chart"]})]})]})]})}),e.jsx(de,{open:ie,onOpenChange:V,children:e.jsxs(ce,{className:"max-w-4xl",children:[e.jsx(oe,{children:e.jsx(he,{children:"Analyze Analog Chart"})}),n&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Chart:"})," ",n.chart_number]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(n.chart_date).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Driver:"})," ",n.driver_name]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle:"})," ",n.vehicle_number]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Image"}),n.chart_image_url&&e.jsx("img",{src:`${Ie.REACT_APP_SUPABASE_URL}/storage/v1/object/public/analog-charts/${n.chart_image_url}`,alt:"Analog Chart",className:"max-w-full h-auto rounded border"})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Manual Analysis"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Analyze the chart and record the periods of activity, rest, and any violations detected."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"analysis_notes",children:"Analysis Notes"}),e.jsx(ve,{id:"analysis_notes",placeholder:"Record your analysis findings, violations detected, and any notes...",className:"mt-1"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"driving_periods",children:"Driving Periods"}),e.jsx(ve,{id:"driving_periods",placeholder:"e.g., 06:00-12:00, 14:00-18:00",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"rest_periods",children:"Rest Periods"}),e.jsx(ve,{id:"rest_periods",placeholder:"e.g., 12:00-14:00, 18:00-06:00",className:"mt-1"})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"violations",children:"Violations Detected"}),e.jsx(ve,{id:"violations",placeholder:"List any violations found during analysis...",className:"mt-1"})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(v,{variant:"outline",onClick:()=>V(!1),children:"Cancel"}),e.jsx(v,{onClick:()=>{var l;const t={driving_periods:[],rest_periods:[],work_periods:[],availability_periods:[],break_periods:[],violations:[],notes:((l=document.getElementById("analysis_notes"))==null?void 0:l.value)||""};Y.mutate({chartId:n.id,analysisData:t})},disabled:Y.isPending,children:Y.isPending?"Saving...":"Save Analysis"})]})]})]})})]})},Ns=()=>{const{user:r,profile:a,loading:m}=ze(),{toast:S}=ke(),F=Ae(),[D,J]=_.useState(""),[T,N]=_.useState("all"),[n,G]=_.useState("all"),[X,p]=_.useState(!1),[ie,V]=_.useState(!1),[d,ue]=_.useState(null),[re,ee]=_.useState(!1),{data:z=[],isLoading:Y}=Q({queryKey:["tachograph-records",a==null?void 0:a.organization_id],queryFn:()=>C(void 0,null,function*(){if(!(a!=null&&a.organization_id))return[];const{data:s,error:c}=yield y.from("tachograph_records").select("*").eq("organization_id",a.organization_id).order("record_date",{ascending:!1}).order("start_time",{ascending:!1});if(c)return console.error("Error fetching tachograph records:",c),S({title:"Error",description:"Failed to load tachograph records",variant:"destructive"}),[];const f=[...new Set((s==null?void 0:s.filter(h=>h.driver_id).map(h=>h.driver_id))||[])],b=[...new Set((s==null?void 0:s.filter(h=>h.vehicle_id).map(h=>h.vehicle_id))||[])];let i=[],g=[];if(f.length>0){const{data:h}=yield y.from("profiles").select("id, first_name, last_name").in("id",f);i=h||[]}if(b.length>0){const{data:h}=yield y.from("vehicles").select("id, vehicle_number, license_plate").in("id",b);g=h||[]}const M=new Map(i.map(h=>[h.id,h])),k=new Map(g.map(h=>[h.id,h]));return(s==null?void 0:s.map(h=>{var ne,te,A,le;return ge(je({},h),{driver_name:h.driver_id&&M.has(h.driver_id)?`${((ne=M.get(h.driver_id))==null?void 0:ne.first_name)||""} ${((te=M.get(h.driver_id))==null?void 0:te.last_name)||""}`.trim():"Unknown Driver",vehicle_number:h.vehicle_id&&k.has(h.vehicle_id)&&((A=k.get(h.vehicle_id))==null?void 0:A.vehicle_number)||"Unknown Vehicle",vehicle_license_plate:h.vehicle_id&&k.has(h.vehicle_id)&&((le=k.get(h.vehicle_id))==null?void 0:le.license_plate)||"No Plate"})}))||[]}),enabled:!!(a!=null&&a.organization_id)}),{data:se=[]}=Q({queryKey:["vehicles",a==null?void 0:a.organization_id],queryFn:()=>C(void 0,null,function*(){if(!(a!=null&&a.organization_id))return[];const{data:s,error:c}=yield y.from("vehicles").select("id, vehicle_number, license_plate").eq("organization_id",a.organization_id);return c?(console.error("Error fetching vehicles:",c),[]):s||[]}),enabled:!!(a!=null&&a.organization_id)}),{data:P=[]}=Q({queryKey:["drivers",a==null?void 0:a.organization_id],queryFn:()=>C(void 0,null,function*(){if(!(a!=null&&a.organization_id))return[];const{data:s,error:c}=yield y.from("profiles").select("id, first_name, last_name").eq("organization_id",a.organization_id).eq("role","driver");return c?(console.error("Error fetching drivers:",c),[]):s||[]}),enabled:!!(a!=null&&a.organization_id)}),R=(()=>{if(z.length===0)return{totalRecords:0,validatedRecords:0,pendingValidation:0,recordsWithViolations:0,averageDistance:0,complianceRate:100,totalDrivingTime:0,totalRestTime:0};const s=z.length,c=z.filter(A=>A.is_validated).length,f=s-c,b=z.filter(A=>A.violations&&Array.isArray(A.violations)&&A.violations.length>0).length,g=z.reduce((A,le)=>A+(le.distance_km||0),0)/s,M=z.filter(A=>A.activity_type==="driving"),k=z.filter(A=>A.activity_type==="rest"),h=M.length,ne=k.length,te=s>0?(s-b)/s*100:100;return{totalRecords:s,validatedRecords:c,pendingValidation:f,recordsWithViolations:b,averageDistance:Math.round(g*100)/100,complianceRate:Math.round(te*100)/100,totalDrivingTime:h,totalRestTime:ne}})(),ae=z.filter(s=>{var i,g,M;const c=D===""||((i=s.driver_name)==null?void 0:i.toLowerCase().includes(D.toLowerCase()))||((g=s.vehicle_number)==null?void 0:g.toLowerCase().includes(D.toLowerCase()))||((M=s.activity_type)==null?void 0:M.toLowerCase().includes(D.toLowerCase())),f=T==="all"||T==="validated"&&s.is_validated||T==="pending"&&!s.is_validated||T==="violations"&&s.violations&&Array.isArray(s.violations)&&s.violations.length>0,b=n==="all"||n==="today"&&s.record_date===new Date().toISOString().split("T")[0]||n==="week"&&(()=>{const k=new Date;return k.setDate(k.getDate()-7),new Date(s.record_date)>=k})()||n==="month"&&(()=>{const k=new Date;return k.setMonth(k.getMonth()-1),new Date(s.record_date)>=k})();return c&&f&&b}),Z=fe({mutationFn:s=>C(void 0,null,function*(){const c=s.get("file"),{data:f,error:b}=yield y.storage.from("tachograph-files").upload(`${a==null?void 0:a.organization_id}/${Date.now()}_${c.name}`,c);if(b)throw b;const i={organization_id:a==null?void 0:a.organization_id,driver_id:s.get("driver_id")||null,vehicle_id:s.get("vehicle_id")||null,record_date:s.get("record_date"),start_time:s.get("start_time"),end_time:s.get("end_time")||null,activity_type:s.get("activity_type"),distance_km:parseFloat(s.get("distance_km"))||null,start_location:s.get("start_location")||null,end_location:s.get("end_location")||null,file_path:f.path,raw_data:{},violations:[],is_validated:!1},{error:g}=yield y.from("tachograph_records").insert(i);if(g)throw g}),onSuccess:()=>{F.invalidateQueries({queryKey:["tachograph-records"]}),p(!1),S({title:"Success",description:"Tachograph record uploaded successfully"})},onError:s=>{console.error("Upload error:",s),S({title:"Error",description:"Failed to upload tachograph record",variant:"destructive"})}}),t=fe({mutationFn:b=>C(void 0,[b],function*({recordId:s,isValidated:c,notes:f}){const{error:i}=yield y.from("tachograph_records").update({is_validated:c,validation_notes:f||null}).eq("id",s);if(i)throw i}),onSuccess:()=>{F.invalidateQueries({queryKey:["tachograph-records"]}),S({title:"Success",description:"Record validation updated"})},onError:s=>{console.error("Validation error:",s),S({title:"Error",description:"Failed to update validation",variant:"destructive"})}});if(m||Y)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading tachograph manager..."})]})});if(!r||!a)return e.jsx(Ee,{to:"/auth",replace:!0});if(!["admin","council"].includes(a.role))return e.jsx(Ee,{to:"/unauthorized",replace:!0});const l=s=>s.is_validated?e.jsx(W,{variant:"default",className:"bg-green-100 text-green-800",children:"Validated"}):s.violations&&Array.isArray(s.violations)&&s.violations.length>0?e.jsx(W,{variant:"destructive",children:"Violations"}):e.jsx(W,{variant:"secondary",children:"Pending"}),w=s=>{const c={driving:"bg-blue-100 text-blue-800",rest:"bg-green-100 text-green-800",work:"bg-yellow-100 text-yellow-800",availability:"bg-purple-100 text-purple-800",break:"bg-orange-100 text-orange-800"};return e.jsx(W,{className:c[s]||"bg-gray-100 text-gray-800",children:s.charAt(0).toUpperCase()+s.slice(1)})};return e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Tachograph Manager"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage digital and analog tachograph records"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(v,{onClick:()=>p(!0),variant:"outline",children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Upload Digital"]}),e.jsxs(v,{onClick:()=>V(!0),children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"}),"Upload Analog"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(L,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Total Records"}),e.jsx(Le,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsx("div",{className:"text-2xl font-bold",children:R.totalRecords}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"All time tachograph records"})]})]}),e.jsxs(L,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Validated Records"}),e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsx("div",{className:"text-2xl font-bold",children:R.validatedRecords}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[R.totalRecords>0?Math.round(R.validatedRecords/R.totalRecords*100):0,"% of total"]})]})]}),e.jsxs(L,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Compliance Rate"}),e.jsx(Ue,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[R.complianceRate,"%"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[R.recordsWithViolations," violations detected"]})]})]}),e.jsxs(L,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Avg Distance"}),e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(U,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[R.averageDistance," km"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Per tachograph record"})]})]})]}),e.jsxs(Ze,{defaultValue:"digital",className:"space-y-6",children:[e.jsxs(Xe,{className:"grid w-full grid-cols-3",children:[e.jsx(Ce,{value:"digital",children:"Digital Records"}),e.jsx(Ce,{value:"card-reader",children:"Card Reader"}),e.jsx(Ce,{value:"analog",children:"Analog Charts"})]}),e.jsxs(Se,{value:"digital",className:"space-y-6",children:[e.jsxs(L,{children:[e.jsx(E,{children:e.jsx(I,{children:"Records"})}),e.jsxs(U,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(q,{placeholder:"Search by driver, vehicle, or activity...",value:D,onChange:s=>J(s.target.value),className:"pl-10"})]})}),e.jsxs(O,{value:T,onValueChange:N,children:[e.jsx($,{className:"w-full sm:w-[180px]",children:e.jsx(K,{placeholder:"Filter by status"})}),e.jsxs(B,{children:[e.jsx(o,{value:"all",children:"All Status"}),e.jsx(o,{value:"validated",children:"Validated"}),e.jsx(o,{value:"pending",children:"Pending"}),e.jsx(o,{value:"violations",children:"With Violations"})]})]}),e.jsxs(O,{value:n,onValueChange:G,children:[e.jsx($,{className:"w-full sm:w-[180px]",children:e.jsx(K,{placeholder:"Filter by date"})}),e.jsxs(B,{children:[e.jsx(o,{value:"all",children:"All Time"}),e.jsx(o,{value:"today",children:"Today"}),e.jsx(o,{value:"week",children:"Last 7 Days"}),e.jsx(o,{value:"month",children:"Last 30 Days"})]})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(pe,{children:[e.jsx(_e,{children:e.jsxs(H,{children:[e.jsx(j,{children:"Date"}),e.jsx(j,{children:"Driver"}),e.jsx(j,{children:"Vehicle"}),e.jsx(j,{children:"Activity"}),e.jsx(j,{children:"Time"}),e.jsx(j,{children:"Distance"}),e.jsx(j,{children:"Status"}),e.jsx(j,{children:"Actions"})]})}),e.jsx(ye,{children:ae.length===0?e.jsx(H,{children:e.jsx(u,{colSpan:8,className:"text-center py-8",children:e.jsx("div",{className:"text-muted-foreground",children:z.length===0?e.jsxs("div",{children:[e.jsx(Le,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No tachograph records found"}),e.jsx("p",{className:"text-sm",children:"Upload your first tachograph record to get started"}),e.jsxs(v,{onClick:()=>p(!0),className:"mt-4",variant:"outline",children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Upload First Record"]})]}):e.jsxs("div",{children:[e.jsx(be,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No records match your filters"}),e.jsx("p",{className:"text-sm",children:"Try adjusting your search criteria"})]})})})}):ae.map(s=>e.jsxs(H,{children:[e.jsx(u,{children:e.jsx("div",{className:"font-medium",children:new Date(s.record_date).toLocaleDateString()})}),e.jsx(u,{children:e.jsx("div",{className:"font-medium",children:s.driver_name})}),e.jsx(u,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.vehicle_number}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.vehicle_license_plate})]})}),e.jsx(u,{children:w(s.activity_type)}),e.jsx(u,{children:e.jsx("div",{children:e.jsxs("div",{className:"font-medium",children:[s.start_time," - ",s.end_time||"Ongoing"]})})}),e.jsx(u,{children:s.distance_km?`${s.distance_km} km`:"-"}),e.jsx(u,{children:l(s)}),e.jsx(u,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>{ue(s),ee(!0)},children:e.jsx(Oe,{className:"h-4 w-4"})}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>{t.mutate({recordId:s.id,isValidated:!s.is_validated,notes:s.validation_notes||void 0})},disabled:t.isPending,children:s.is_validated?e.jsx(ds,{className:"h-4 w-4"}):e.jsx(xe,{className:"h-4 w-4"})})]})})]},s.id))})]})})]})]}),e.jsx(de,{open:X,onOpenChange:p,children:e.jsxs(ce,{className:"max-w-2xl",children:[e.jsx(oe,{children:e.jsx(he,{children:"Upload Tachograph Record"})}),e.jsxs("form",{onSubmit:s=>{s.preventDefault();const c=new FormData(s.currentTarget);Z.mutate(c)},children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"driver_id",children:"Driver"}),e.jsxs(O,{name:"driver_id",required:!0,children:[e.jsx($,{children:e.jsx(K,{placeholder:"Select driver"})}),e.jsx(B,{children:P.map(s=>e.jsxs(o,{value:s.id,children:[s.first_name," ",s.last_name]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"vehicle_id",children:"Vehicle"}),e.jsxs(O,{name:"vehicle_id",required:!0,children:[e.jsx($,{children:e.jsx(K,{placeholder:"Select vehicle"})}),e.jsx(B,{children:se.map(s=>e.jsxs(o,{value:s.id,children:[s.vehicle_number," (",s.license_plate,")"]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"record_date",children:"Record Date"}),e.jsx(q,{type:"date",name:"record_date",required:!0,defaultValue:new Date().toISOString().split("T")[0]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"activity_type",children:"Activity Type"}),e.jsxs(O,{name:"activity_type",required:!0,children:[e.jsx($,{children:e.jsx(K,{placeholder:"Select activity"})}),e.jsxs(B,{children:[e.jsx(o,{value:"driving",children:"Driving"}),e.jsx(o,{value:"rest",children:"Rest"}),e.jsx(o,{value:"work",children:"Work"}),e.jsx(o,{value:"availability",children:"Availability"}),e.jsx(o,{value:"break",children:"Break"})]})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"start_time",children:"Start Time"}),e.jsx(q,{type:"time",name:"start_time",required:!0})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"end_time",children:"End Time"}),e.jsx(q,{type:"time",name:"end_time"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"distance_km",children:"Distance (km)"}),e.jsx(q,{type:"number",name:"distance_km",step:"0.1"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"file",children:"Tachograph File"}),e.jsx(q,{type:"file",name:"file",accept:".ddd,.tgd,.c1b,.v1b,.v2b,.esm",required:!0})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(x,{htmlFor:"start_location",children:"Start Location"}),e.jsx(q,{name:"start_location",placeholder:"Enter start location"})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(x,{htmlFor:"end_location",children:"End Location"}),e.jsx(q,{name:"end_location",placeholder:"Enter end location"})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-6",children:[e.jsx(v,{type:"button",variant:"outline",onClick:()=>p(!1),children:"Cancel"}),e.jsx(v,{type:"submit",disabled:Z.isPending,children:Z.isPending?"Uploading...":"Upload Record"})]})]})]})}),e.jsx(de,{open:re,onOpenChange:ee,children:e.jsxs(ce,{className:"max-w-4xl",children:[e.jsx(oe,{children:e.jsx(he,{children:"Tachograph Record Details"})}),d&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Basic Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(d.record_date).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Driver:"})," ",d.driver_name]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle:"})," ",d.vehicle_number," (",d.vehicle_license_plate,")"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Activity:"})," ",w(d.activity_type)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Time:"})," ",d.start_time," - ",d.end_time||"Ongoing"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Distance:"})," ",d.distance_km?`${d.distance_km} km`:"Not recorded"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Location & Validation"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Start Location:"})," ",d.start_location||"Not specified"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"End Location:"})," ",d.end_location||"Not specified"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Card Number:"})," ",d.card_number||"Not recorded"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Downloaded:"})," ",d.downloaded_at?new Date(d.downloaded_at).toLocaleString():"Not downloaded"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",l(d)]})]})]})]}),d.violations&&Array.isArray(d.violations)&&d.violations.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Violations Detected"}),e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-red-800",children:d.violations.map((s,c)=>e.jsx("li",{children:s},c))})})]}),d.validation_notes&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Validation Notes"}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4",children:e.jsx("p",{className:"text-sm text-blue-800",children:d.validation_notes})})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(v,{variant:"outline",onClick:()=>ee(!1),children:"Close"}),e.jsx(v,{onClick:()=>{t.mutate({recordId:d.id,isValidated:!d.is_validated,notes:d.validation_notes||void 0})},disabled:t.isPending,children:d.is_validated?"Mark as Pending":"Mark as Validated"})]})]})]})})]}),e.jsx(Se,{value:"card-reader",className:"space-y-6",children:e.jsx(cs,{onDataDownloaded:s=>{S({title:"Card Data Downloaded",description:`Successfully downloaded ${s.recordsCount} records from ${s.cardType} card`}),F.invalidateQueries({queryKey:["tachograph-records"]})}})}),e.jsx(Se,{value:"analog",className:"space-y-6",children:e.jsx(os,{})})]})]})};export{Ns as default};
