var f=(a,e,r)=>new Promise((i,t)=>{var n=c=>{try{l(r.next(c))}catch(x){t(x)}},o=c=>{try{l(r.throw(c))}catch(x){t(x)}},l=c=>c.done?i(c.value):Promise.resolve(c.value).then(n,o);l((r=r.apply(a,e)).next())});import{j as s}from"./ui-vendor-DMUr7mTx.js";import{s as u,u as j,C as w,a as b,b as N,c as y,d as v,B as h,J as m}from"./index-ZwIgorfy.js";import{r as p}from"./react-vendor-BvqlMsL5.js";import{k as g,J as C,Y as k,V as F,aH as D}from"./icons-vendor-b0I7fGSL.js";import{a as E}from"./router-vendor-CEyBJ8vK.js";import"./supabase-vendor-B984m0TI.js";import"./utils-vendor-B2FlkASS.js";import"./query-vendor-B2F_wWlc.js";import"./ui-components-7w1-MJre.js";const _=a=>f(void 0,null,function*(){try{console.log("🔧 Attempting to fix access denied for:",a);const{data:e,error:r}=yield u.from("profiles").select("*").eq("email",a).maybeSingle();if(r)return console.error("Error checking profile:",r),{success:!1,message:"Failed to check existing profile",error:r.message};if(e){if(console.log("✅ Profile exists:",e),e.role==="admin"||e.role==="council")return{success:!0,message:"User already has admin privileges",profile:e};const{data:i,error:t}=yield u.from("profiles").update({role:"admin",employment_status:"active",onboarding_status:"completed",is_active:!0,updated_at:new Date().toISOString()}).eq("email",a).select().single();return t?(console.error("Error updating profile:",t),{success:!1,message:"Failed to update profile role",error:t.message}):(console.log("✅ Profile updated to admin:",i),{success:!0,message:"Profile updated to admin role successfully",profile:i})}else{console.log("⚠️ Profile does not exist, creating new admin profile");const{data:{user:i}}=yield u.auth.getUser();if(!i)return{success:!1,message:"No authenticated user found",error:"User not authenticated"};const{data:t,error:n}=yield u.from("profiles").insert({id:i.id,email:a,first_name:"Larone",last_name:"Laing",role:"admin",employment_status:"active",onboarding_status:"completed",is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();return n?(console.error("Error creating profile:",n),{success:!1,message:"Failed to create admin profile",error:n.message}):(console.log("✅ New admin profile created:",t),{success:!0,message:"New admin profile created successfully",profile:t})}}catch(e){return console.error("❌ Error in fixAccessDenied:",e),{success:!1,message:"Unexpected error occurred",error:e instanceof Error?e.message:"Unknown error"}}}),S=()=>f(void 0,null,function*(){try{const{data:{user:a}}=yield u.auth.getUser();if(!a)return!1;const{data:e}=yield u.from("profiles").select("role").eq("id",a.id).maybeSingle();return(e==null?void 0:e.role)==="admin"||(e==null?void 0:e.role)==="council"}catch(a){return console.error("Error checking admin access:",a),!1}}),P=({userEmail:a,onFixComplete:e})=>{const{user:r,refreshProfile:i}=j(),[t,n]=p.useState(!1),[o,l]=p.useState(null),c=a||(r==null?void 0:r.email)||"",x=()=>f(void 0,null,function*(){if(!c){m.error("No user email available");return}n(!0),l(null);try{const d=yield _(c);l({success:d.success,message:d.message}),d.success?(m.success("Access fixed successfully!"),yield i(),e&&e(),setTimeout(()=>{window.location.reload()},1e3)):m.error(`Failed to fix access: ${d.error||d.message}`)}catch(d){console.error("Error fixing access:",d),l({success:!1,message:"An unexpected error occurred"}),m.error("An unexpected error occurred while fixing access")}finally{n(!1)}}),A=()=>f(void 0,null,function*(){(yield S())?m.success("You already have admin access!"):m.info('You do not have admin access. Click "Fix Access" to resolve this.')});return s.jsxs(w,{className:"w-full max-w-md mx-auto",children:[s.jsxs(b,{className:"text-center",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4",children:s.jsx(g,{className:"w-8 h-8 text-red-600"})}),s.jsx(N,{className:"text-2xl font-bold text-gray-900",children:"Access Denied"}),s.jsx(y,{children:"You don't have permission to access this page. This can be fixed by ensuring you have the proper role."})]}),s.jsxs(v,{className:"space-y-4",children:[o&&s.jsx("div",{className:`p-3 rounded-lg ${o.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:s.jsxs("div",{className:"flex items-center",children:[o.success?s.jsx(C,{className:"w-5 h-5 text-green-600 mr-2"}):s.jsx(k,{className:"w-5 h-5 text-red-600 mr-2"}),s.jsx("span",{className:`text-sm ${o.success?"text-green-800":"text-red-800"}`,children:o.message})]})}),s.jsxs("div",{className:"space-y-3",children:[s.jsx(h,{onClick:x,disabled:t,className:"w-full",variant:"default",children:t?s.jsxs(s.Fragment,{children:[s.jsx(F,{className:"w-4 h-4 mr-2 animate-spin"}),"Fixing Access..."]}):s.jsxs(s.Fragment,{children:[s.jsx(g,{className:"w-4 h-4 mr-2"}),"Fix Access"]})}),s.jsx(h,{onClick:A,disabled:t,variant:"outline",className:"w-full",children:"Check Current Access"})]}),s.jsxs("div",{className:"text-xs text-gray-500 text-center",children:[s.jsxs("p",{children:["Target Email: ",c]}),s.jsx("p",{children:"This will update your role to admin if needed."})]})]})]})},$=()=>{var n,o,l,c;const a=E(),{user:e,profile:r}=j(),i=((n=e==null?void 0:e.email)==null?void 0:n.includes("admin"))||((o=e==null?void 0:e.email)==null?void 0:o.includes("transport"))||((l=e==null?void 0:e.email)==null?void 0:l.includes("laronelaing"))&&((c=e==null?void 0:e.user_metadata)==null?void 0:c.role)==="admin",t=()=>(r==null?void 0:r.role)==="driver"?"/driver-dashboard":(r==null?void 0:r.role)==="parent"?"/parent/dashboard":(r==null?void 0:r.role)==="mechanic"?"/mechanic-dashboard":"/dashboard";return s.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:i?s.jsx(P,{userEmail:e==null?void 0:e.email,onFixComplete:()=>{a("/dashboard")}}):s.jsxs(w,{className:"w-full max-w-md",children:[s.jsxs(b,{className:"text-center",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4",children:s.jsx(g,{className:"w-8 h-8 text-red-600"})}),s.jsx(N,{className:"text-2xl font-bold text-gray-900",children:"Access Denied"}),s.jsxs(y,{children:["You don't have permission to access this page.",(r==null?void 0:r.role)==="driver"&&" This page is for administrators only."]})]}),s.jsx(v,{className:"text-center",children:s.jsxs(h,{onClick:()=>a(t()),className:"w-full",children:[s.jsx(D,{className:"w-4 h-4 mr-2"}),"Back to ",(r==null?void 0:r.role)==="driver"?"Driver":""," Dashboard"]})})]})})};export{$ as default};
