import{m as $,G as X,r as T,H as U,a2 as V,J as q,al as k,j as e,e as c,g as d,h as o,E as Q,k as x,C as O,B as _,ak as Y,F,a4 as Z,a5 as ee,a6 as se,a7 as ae,a8 as te,q as g,s as re,aA as ne,a0 as K,n as b,d as H,at as W,bP as C,N as B,O as ie,Q as le,V as P,a as ce,l as de,Y as D,U as oe}from"./main-DVuL102c.js";import{T as J}from"./trending-down-DwD0VVi4.js";const xe=()=>{var M,S;const{user:N,profile:i}=$(),R=X(),[r,f]=T.useState(null),[n,a]=T.useState(!1),[t,l]=T.useState(""),{data:m=[],isLoading:v}=U({queryKey:["approval-requests"],queryFn:async()=>{const{data:s,error:h}=await q.from("parts_approval_requests").select(`
          *,
          part:parts_inventory!parts_approval_requests_part_id_fkey(part_number, name, quantity, unit_price)
        `).eq("organization_id",i==null?void 0:i.organization_id).order("created_at",{ascending:!1});return h?(console.error("Error fetching approval requests:",h),[]):await Promise.all((s||[]).map(async p=>{if(p.requester_id){const{data:G}=await q.from("profiles").select("full_name, email").eq("id",p.requester_id).single();return{...p,requester:G||{full_name:"Unknown User",email:"unknown@example.com"}}}return{...p,requester:{full_name:"Unknown User",email:"unknown@example.com"}}}))}}),y=V({mutationFn:async({requestId:s,notes:h})=>{const{data:j,error:p}=await q.from("parts_approval_requests").update({status:"approved",approved_by:N==null?void 0:N.id,approved_at:new Date().toISOString(),admin_notes:h}).eq("id",s).select().single();if(p)throw p;return j},onSuccess:()=>{R.invalidateQueries({queryKey:["approval-requests"]}),R.invalidateQueries({queryKey:["parts-inventory"]}),k({title:"Success",description:"Request approved successfully"}),a(!1),f(null),l("")},onError:s=>{k({title:"Error",description:"Failed to approve request",variant:"destructive"})}}),u=V({mutationFn:async({requestId:s,notes:h})=>{const{data:j,error:p}=await q.from("parts_approval_requests").update({status:"rejected",approved_by:N==null?void 0:N.id,approved_at:new Date().toISOString(),admin_notes:h}).eq("id",s).select().single();if(p)throw p;return j},onSuccess:()=>{R.invalidateQueries({queryKey:["approval-requests"]}),k({title:"Success",description:"Request rejected successfully"}),a(!1),f(null),l("")},onError:s=>{k({title:"Error",description:"Failed to reject request",variant:"destructive"})}}),w=()=>{r&&y.mutate({requestId:r.id,notes:t})},A=()=>{r&&u.mutate({requestId:r.id,notes:t})},z=s=>{switch(s){case"pending":return e.jsxs(b,{className:"bg-yellow-100 text-yellow-800",children:[e.jsx(H,{className:"w-3 h-3 mr-1"}),"Pending"]});case"approved":return e.jsxs(b,{className:"bg-green-100 text-green-800",children:[e.jsx(O,{className:"w-3 h-3 mr-1"}),"Approved"]});case"rejected":return e.jsxs(b,{className:"bg-red-100 text-red-800",children:[e.jsx(K,{className:"w-3 h-3 mr-1"}),"Rejected"]});case"cancelled":return e.jsx(b,{className:"bg-gray-100 text-gray-800",children:"Cancelled"});default:return e.jsx(b,{variant:"secondary",children:s})}},L=s=>{switch(s){case"new_part":return e.jsx(C,{className:"w-4 h-4"});case"quantity_increase":return e.jsx(Q,{className:"w-4 h-4"});case"price_change":return e.jsx(W,{className:"w-4 h-4"});default:return e.jsx(F,{className:"w-4 h-4"})}},E=m.filter(s=>s.status==="pending"),I=m.filter(s=>s.status!=="pending");return v?e.jsx("div",{className:"flex items-center justify-center min-h-[200px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{children:"Loading approval requests..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(c,{children:[e.jsx(d,{children:e.jsxs(o,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5 text-yellow-600"}),"Pending Approval Requests (",E.length,")"]})}),e.jsx(x,{children:E.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(O,{className:"w-12 h-12 mx-auto mb-4 text-green-500"}),e.jsx("p",{children:"No pending approval requests"})]}):e.jsx("div",{className:"space-y-4",children:E.map(s=>{var h,j;return e.jsxs("div",{className:"border rounded-lg p-4 hover:bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[L(s.request_type),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold capitalize",children:s.request_type.replace("_"," ")}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Requested by ",((h=s.requester)==null?void 0:h.full_name)||"Unknown"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[z(s.status),e.jsxs(_,{size:"sm",variant:"outline",onClick:()=>{f(s),a(!0)},children:[e.jsx(Y,{className:"w-4 h-4 mr-1"}),"Review"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Part:"}),e.jsx("p",{className:"text-gray-600",children:((j=s.part)==null?void 0:j.name)||"New Part"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Quantity:"}),e.jsx("p",{className:"text-gray-600",children:s.quantity_requested||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Date:"}),e.jsx("p",{className:"text-gray-600",children:new Date(s.created_at).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Reason:"}),e.jsx("p",{className:"text-gray-600 truncate",children:s.reason})]})]})]},s.id)})})})]}),e.jsxs(c,{children:[e.jsx(d,{children:e.jsxs(o,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-5 h-5"}),"Processed Requests (",I.length,")"]})}),e.jsx(x,{children:I.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No processed requests yet"})}):e.jsx("div",{className:"space-y-3",children:I.slice(0,10).map(s=>{var h,j;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[L(s.request_type),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium capitalize",children:s.request_type.replace("_"," ")}),e.jsxs("p",{className:"text-sm text-gray-600",children:[((h=s.part)==null?void 0:h.name)||"New Part"," • ",(j=s.requester)==null?void 0:j.full_name]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[z(s.status),e.jsx("span",{className:"text-sm text-gray-500",children:new Date(s.created_at).toLocaleDateString()})]})]},s.id)})})})]}),e.jsx(Z,{open:n,onOpenChange:a,children:e.jsxs(ee,{className:"max-w-2xl",children:[e.jsxs(se,{children:[e.jsx(ae,{children:"Review Approval Request"}),e.jsx(te,{children:"Review the details and approve or reject this request"})]}),r&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{className:"font-medium",children:"Request Type"}),e.jsx("p",{className:"text-sm text-gray-600 capitalize",children:r.request_type.replace("_"," ")})]}),e.jsxs("div",{children:[e.jsx(g,{className:"font-medium",children:"Status"}),e.jsx("div",{className:"mt-1",children:z(r.status)})]}),e.jsxs("div",{children:[e.jsx(g,{className:"font-medium",children:"Requester"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[(M=r.requester)==null?void 0:M.full_name," (",(S=r.requester)==null?void 0:S.email,")"]})]}),e.jsxs("div",{children:[e.jsx(g,{className:"font-medium",children:"Date Requested"}),e.jsx("p",{className:"text-sm text-gray-600",children:new Date(r.created_at).toLocaleString()})]})]}),r.part&&e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium mb-3",children:"Part Details"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Part Number:"}),e.jsx("p",{className:"text-gray-600",children:r.part.part_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Name:"}),e.jsx("p",{className:"text-gray-600",children:r.part.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Current Quantity:"}),e.jsx("p",{className:"text-gray-600",children:r.part.current_quantity})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Unit Price:"}),e.jsxs("p",{className:"text-gray-600",children:["£",r.part.unit_price]})]})]})]}),e.jsxs("div",{children:[e.jsx(g,{className:"font-medium",children:"Reason for Request"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:r.reason})]}),r.quantity_requested&&e.jsxs("div",{children:[e.jsx(g,{className:"font-medium",children:"Quantity Requested"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:r.quantity_requested})]}),r.current_value&&r.requested_value&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{className:"font-medium",children:"Current Value"}),e.jsx("pre",{className:"text-sm text-gray-600 mt-1 bg-gray-50 p-2 rounded",children:JSON.stringify(JSON.parse(r.current_value),null,2)})]}),e.jsxs("div",{children:[e.jsx(g,{className:"font-medium",children:"Requested Value"}),e.jsx("pre",{className:"text-sm text-gray-600 mt-1 bg-blue-50 p-2 rounded",children:JSON.stringify(JSON.parse(r.requested_value),null,2)})]})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"admin-notes",children:"Admin Notes (Optional)"}),e.jsx(re,{id:"admin-notes",value:t,onChange:s=>l(s.target.value),placeholder:"Add notes about your decision...",className:"mt-1"})]})]}),e.jsxs(ne,{children:[e.jsx(_,{variant:"outline",onClick:()=>a(!1),children:"Cancel"}),e.jsxs(_,{variant:"destructive",onClick:A,disabled:y.isPending||u.isPending,children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"Reject"]}),e.jsxs(_,{onClick:w,disabled:y.isPending||u.isPending,children:[e.jsx(O,{className:"w-4 h-4 mr-2"}),"Approve"]})]})]})})]})},ue=()=>{const{user:N,profile:i,loading:R}=$(),[r,f]=T.useState("overview");if(R)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading admin dashboard..."})]})});if(!N||!i)return e.jsx(B,{to:"/auth",replace:!0});if(!["admin","council"].includes(i.role))return e.jsx(B,{to:"/unauthorized",replace:!0});const{data:n}=U({queryKey:["inventory-stats"],queryFn:async()=>{const{data:t,error:l}=await q.from("parts_inventory").select("*").eq("organization_id",i==null?void 0:i.organization_id);if(l)return console.error("Error fetching parts:",l),null;const m=(t==null?void 0:t.length)||0,v=(t==null?void 0:t.filter(w=>w.status==="low_stock").length)||0,y=(t==null?void 0:t.filter(w=>w.status==="out_of_stock").length)||0,u=(t==null?void 0:t.reduce((w,A)=>w+A.quantity*A.unit_price,0))||0;return{totalParts:m,lowStock:v,outOfStock:y,totalValue:u}}}),{data:a}=U({queryKey:["approval-stats"],queryFn:async()=>{const{data:t,error:l}=await q.from("parts_approval_requests").select("status").eq("organization_id",i==null?void 0:i.organization_id);if(l)return console.error("Error fetching approval requests:",l),null;const m=(t==null?void 0:t.filter(u=>u.status==="pending").length)||0,v=(t==null?void 0:t.filter(u=>u.status==="approved").length)||0,y=(t==null?void 0:t.filter(u=>u.status==="rejected").length)||0;return{pending:m,approved:v,rejected:y}}});return e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Inventory Management"}),e.jsx("p",{className:"text-gray-600",children:"Admin dashboard for inventory control and approvals"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{variant:"outline",children:i.role}),e.jsx("span",{className:"text-sm text-gray-500",children:i.full_name})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(c,{children:[e.jsxs(d,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(o,{className:"text-sm font-medium",children:"Total Parts"}),e.jsx(C,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(x,{children:[e.jsx("div",{className:"text-2xl font-bold",children:(n==null?void 0:n.totalParts)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Parts in inventory"})]})]}),e.jsxs(c,{children:[e.jsxs(d,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(o,{className:"text-sm font-medium",children:"Low Stock"}),e.jsx(Q,{className:"h-4 w-4 text-yellow-600"})]}),e.jsxs(x,{children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:(n==null?void 0:n.lowStock)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Need reordering"})]})]}),e.jsxs(c,{children:[e.jsxs(d,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(o,{className:"text-sm font-medium",children:"Out of Stock"}),e.jsx(J,{className:"h-4 w-4 text-red-600"})]}),e.jsxs(x,{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:(n==null?void 0:n.outOfStock)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Urgent orders needed"})]})]}),e.jsxs(c,{children:[e.jsxs(d,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(o,{className:"text-sm font-medium",children:"Total Value"}),e.jsx(W,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(x,{children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:["£",((n==null?void 0:n.totalValue)||0).toFixed(2)]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Inventory value"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(c,{children:[e.jsxs(d,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(o,{className:"text-sm font-medium",children:"Pending Approvals"}),e.jsx(H,{className:"h-4 w-4 text-yellow-600"})]}),e.jsxs(x,{children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:(a==null?void 0:a.pending)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Awaiting review"})]})]}),e.jsxs(c,{children:[e.jsxs(d,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(o,{className:"text-sm font-medium",children:"Approved"}),e.jsx(O,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(x,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:(a==null?void 0:a.approved)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"This month"})]})]}),e.jsxs(c,{children:[e.jsxs(d,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(o,{className:"text-sm font-medium",children:"Rejected"}),e.jsx(J,{className:"h-4 w-4 text-red-600"})]}),e.jsxs(x,{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:(a==null?void 0:a.rejected)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"This month"})]})]})]}),e.jsxs(ie,{value:r,onValueChange:f,className:"space-y-6",children:[e.jsxs(le,{className:"grid w-full grid-cols-4",children:[e.jsxs(P,{value:"overview",className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-4 h-4"}),"Overview"]}),e.jsxs(P,{value:"approvals",className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-4 h-4"}),"Approvals"]}),e.jsxs(P,{value:"inventory",className:"flex items-center gap-2",children:[e.jsx(C,{className:"w-4 h-4"}),"Inventory"]}),e.jsxs(P,{value:"settings",className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4"}),"Settings"]})]}),e.jsxs(D,{value:"overview",className:"space-y-6",children:[e.jsxs(c,{children:[e.jsx(d,{children:e.jsx(o,{children:"Quick Actions"})}),e.jsx(x,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs(_,{variant:"outline",className:"h-20 flex flex-col items-center justify-center gap-2",onClick:()=>f("approvals"),children:[e.jsx(F,{className:"w-6 h-6"}),e.jsx("span",{children:"Review Approvals"}),(a==null?void 0:a.pending)>0&&e.jsx(b,{className:"bg-red-500 text-white",children:a.pending})]}),e.jsxs(_,{variant:"outline",className:"h-20 flex flex-col items-center justify-center gap-2",onClick:()=>f("inventory"),children:[e.jsx(C,{className:"w-6 h-6"}),e.jsx("span",{children:"Manage Inventory"})]}),e.jsxs(_,{variant:"outline",className:"h-20 flex flex-col items-center justify-center gap-2",children:[e.jsx(oe,{className:"w-6 h-6"}),e.jsx("span",{children:"User Management"})]})]})})]}),e.jsxs(c,{children:[e.jsx(d,{children:e.jsx(o,{children:"Recent Activity"})}),e.jsx(x,{children:e.jsx("div",{className:"space-y-4",children:(()=>{if(!((n==null?void 0:n.totalParts)>0||(a==null?void 0:a.pending)>0||(a==null?void 0:a.approved)>0))return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(C,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No recent activity"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Activity will appear here as you manage inventory"})]});const l=[];return(n==null?void 0:n.totalParts)>0&&l.push({type:"success",title:"Inventory Available",description:`${n.totalParts} parts in stock`,time:"Current"}),(a==null?void 0:a.pending)>0&&l.push({type:"warning",title:"Pending Approvals",description:`${a.pending} requests awaiting review`,time:"Current"}),(a==null?void 0:a.approved)>0&&l.push({type:"success",title:"Approved Requests",description:`${a.approved} requests approved this month`,time:"This month"}),l.map((m,v)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${m.type==="success"?"bg-green-500":m.type==="warning"?"bg-yellow-500":"bg-red-500"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium",children:m.title}),e.jsxs("p",{className:"text-xs text-gray-500",children:[m.description," - ",m.time]})]})]},v))})()})})]})]}),e.jsx(D,{value:"approvals",className:"space-y-6",children:e.jsx(xe,{})}),e.jsx(D,{value:"inventory",className:"space-y-6",children:e.jsxs(c,{children:[e.jsx(d,{children:e.jsx(o,{children:"Inventory Management"})}),e.jsx(x,{children:e.jsx("p",{className:"text-gray-600",children:"Full inventory management interface will be implemented here. This will include part management, stock movements, and reporting."})})]})}),e.jsx(D,{value:"settings",className:"space-y-6",children:e.jsxs(c,{children:[e.jsx(d,{children:e.jsx(o,{children:"Organization Settings"})}),e.jsx(x,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Approval Thresholds"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Configure automatic approval thresholds for different types of requests."})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Notification Settings"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Manage email and in-app notifications for inventory alerts."})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"User Permissions"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Configure what different user roles can do in the inventory system."})]})]})})]})})]})]})};export{ue as default};
