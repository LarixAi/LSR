import{m as ie,G as re,r as x,H as le,J as S,a2 as L,j as e,e as i,k as r,ap as ce,d as T,C as N,a0 as v,au as de,I as me,ab as oe,ac as xe,ad as he,ae as je,af as h,O as ue,Q as ge,V as q,Y as A,a4 as pe,a5 as Ne,a6 as ve,a7 as be,a8 as ye,s as we,aA as fe,B as j,al as F,U as Re,n as u}from"./main-DVuL102c.js";import{T as P}from"./trash-2-uDLx8yM9.js";import{U as X}from"./user-x-Ct1jgzv0.js";import{U as G}from"./user-check-ocIY3ZDi.js";const qe=()=>{var Q,U;const{profile:a}=ie(),z=re(),[l,b]=x.useState(null),[D,M]=x.useState(""),[J,m]=x.useState(!1),[o,Y]=x.useState(""),[k,W]=x.useState("all"),[Z,$]=x.useState("pending"),{data:ee=[],isLoading:se}=le({queryKey:["admin-all-requests",a==null?void 0:a.organization_id],queryFn:async()=>{if(!(a!=null&&a.organization_id))return[];const{data:s,error:t}=await S.from("mechanic_organization_requests").select(`
          *,
          mechanic:profiles!mechanic_id(id, first_name, last_name, email, phone),
          organization:organizations(id, name),
          approver:profiles!approved_by(id, first_name, last_name)
        `).eq("organization_id",a.organization_id).order("created_at",{ascending:!1});return t?(console.error("Error fetching requests:",t),[]):s||[]},enabled:!!(a!=null&&a.organization_id)&&a.role==="admin"}),y=ee.filter(s=>{var g,p,B,K,V,E,H;const t=o===""||((p=(g=s.mechanic)==null?void 0:g.first_name)==null?void 0:p.toLowerCase().includes(o.toLowerCase()))||((K=(B=s.mechanic)==null?void 0:B.last_name)==null?void 0:K.toLowerCase().includes(o.toLowerCase()))||((E=(V=s.mechanic)==null?void 0:V.email)==null?void 0:E.toLowerCase().includes(o.toLowerCase()))||((H=s.message)==null?void 0:H.toLowerCase().includes(o.toLowerCase())),n=k==="all"||s.status===k;return t&&n}),w=y.filter(s=>s.status==="pending"),f=y.filter(s=>s.status==="active"||s.status==="approved"),R=y.filter(s=>s.status==="rejected"),_=y.filter(s=>s.status==="terminated"),c=L({mutationFn:async({requestId:s,responseMessage:t})=>{const{error:n}=await S.from("mechanic_organization_requests").update({status:"approved",approved_by:a==null?void 0:a.id,approved_at:new Date().toISOString(),response_message:t.trim()||null}).eq("id",s);if(n)throw n},onSuccess:()=>{F({title:"Request Approved",description:"The mechanic has been approved to work with your organization."}),m(!1),b(null),M(""),z.invalidateQueries({queryKey:["admin-all-requests"]})}}),d=L({mutationFn:async({requestId:s,responseMessage:t})=>{const{error:n}=await S.from("mechanic_organization_requests").update({status:"rejected",approved_by:a==null?void 0:a.id,approved_at:new Date().toISOString(),response_message:t.trim()||null}).eq("id",s);if(n)throw n},onSuccess:()=>{F({title:"Request Rejected",description:"The request has been rejected."}),m(!1),b(null),M(""),z.invalidateQueries({queryKey:["admin-all-requests"]})}}),I=L({mutationFn:async({requestId:s,reason:t})=>{const{error:n}=await S.from("mechanic_organization_requests").update({status:"terminated",terminated_by:a==null?void 0:a.id,terminated_at:new Date().toISOString(),termination_reason:t.trim()||"Terminated by admin"}).eq("id",s);if(n)throw n},onSuccess:()=>{F({title:"Relationship Terminated",description:"The mechanic relationship has been terminated."}),z.invalidateQueries({queryKey:["admin-all-requests"]})}}),ae=s=>{b(s),m(!0)},te=s=>{b(s),m(!0)},O=s=>{l&&(s==="approve"?c.mutate({requestId:l.id,responseMessage:D}):d.mutate({requestId:l.id,responseMessage:D}))},ne=s=>{switch(s){case"pending":return e.jsxs(u,{variant:"outline",className:"bg-yellow-50 text-yellow-700 border-yellow-200",children:[e.jsx(T,{className:"h-3 w-3 mr-1"}),"Pending"]});case"approved":return e.jsxs(u,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200",children:[e.jsx(N,{className:"h-3 w-3 mr-1"}),"Approved"]});case"active":return e.jsxs(u,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:[e.jsx(N,{className:"h-3 w-3 mr-1"}),"Active"]});case"rejected":return e.jsxs(u,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200",children:[e.jsx(v,{className:"h-3 w-3 mr-1"}),"Rejected"]});case"terminated":return e.jsxs(u,{variant:"outline",className:"bg-gray-50 text-gray-700 border-gray-200",children:[e.jsx(v,{className:"h-3 w-3 mr-1"}),"Terminated"]});default:return e.jsx(u,{variant:"outline",children:s})}},C=({request:s})=>{var t,n,g,p;return e.jsx(i,{className:"hover:shadow-md transition-shadow",children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-full",children:e.jsx(Re,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsxs("h3",{className:"font-medium",children:[(t=s.mechanic)==null?void 0:t.first_name," ",(n=s.mechanic)==null?void 0:n.last_name]}),ne(s.status)]}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:(g=s.mechanic)==null?void 0:g.email}),((p=s.mechanic)==null?void 0:p.phone)&&e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:s.mechanic.phone}),e.jsxs("p",{className:"text-xs text-gray-500 mb-2",children:["Requested ",new Date(s.created_at).toLocaleDateString()," at ",new Date(s.created_at).toLocaleTimeString()]}),s.message&&e.jsx("div",{className:"bg-gray-50 p-2 rounded text-sm mb-2",children:e.jsxs("p",{className:"text-gray-700",children:['"',s.message,'"']})}),s.response_message&&e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-sm",children:[e.jsx("p",{className:"text-blue-700 font-medium",children:"Response:"}),e.jsxs("p",{className:"text-blue-600",children:['"',s.response_message,'"']})]})]})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs(j,{size:"sm",onClick:()=>ae(s),disabled:c.isPending||d.isPending,children:[e.jsx(G,{className:"h-4 w-4 mr-1"}),"Approve"]}),e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>te(s),disabled:c.isPending||d.isPending,children:[e.jsx(X,{className:"h-4 w-4 mr-1"}),"Reject"]})]}),(s.status==="active"||s.status==="approved")&&e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>{confirm("Are you sure you want to terminate this relationship?")&&I.mutate({requestId:s.id,reason:"Terminated by admin"})},disabled:I.isPending,children:[e.jsx(P,{className:"h-4 w-4 mr-1"}),"Terminate"]})]})]})})})};return(a==null?void 0:a.role)!=="admin"?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(i,{children:e.jsxs(r,{className:"p-8 text-center",children:[e.jsx(ce,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"Only administrators can access this page."})]})})}):e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Mechanic Request Management"}),e.jsx("p",{className:"text-gray-600",children:"Manage mechanic requests and working relationships"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8",children:[e.jsx(i,{children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{className:"h-5 w-5 text-yellow-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:w.length}),e.jsx("p",{className:"text-sm text-gray-600",children:"Pending Requests"})]})]})})}),e.jsx(i,{children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(N,{className:"h-5 w-5 text-green-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:f.length}),e.jsx("p",{className:"text-sm text-gray-600",children:"Active Mechanics"})]})]})})}),e.jsx(i,{children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(v,{className:"h-5 w-5 text-red-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:R.length}),e.jsx("p",{className:"text-sm text-gray-600",children:"Rejected Requests"})]})]})})}),e.jsx(i,{children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(P,{className:"h-5 w-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:_.length}),e.jsx("p",{className:"text-sm text-gray-600",children:"Terminated"})]})]})})})]}),e.jsx(i,{className:"mb-6",children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(de,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(me,{placeholder:"Search by mechanic name, email, or message...",value:o,onChange:s=>Y(s.target.value),className:"pl-10"})]})}),e.jsx("div",{className:"w-full md:w-48",children:e.jsxs(oe,{value:k,onValueChange:W,children:[e.jsx(xe,{children:e.jsx(he,{placeholder:"Filter by status"})}),e.jsxs(je,{children:[e.jsx(h,{value:"all",children:"All Status"}),e.jsx(h,{value:"pending",children:"Pending"}),e.jsx(h,{value:"approved",children:"Approved"}),e.jsx(h,{value:"active",children:"Active"}),e.jsx(h,{value:"rejected",children:"Rejected"}),e.jsx(h,{value:"terminated",children:"Terminated"})]})]})})]})})}),e.jsxs(ue,{value:Z,onValueChange:$,className:"space-y-6",children:[e.jsxs(ge,{className:"grid w-full grid-cols-4",children:[e.jsxs(q,{value:"pending",className:"flex items-center space-x-2",children:[e.jsx(T,{className:"h-4 w-4"}),e.jsxs("span",{children:["Pending (",w.length,")"]})]}),e.jsxs(q,{value:"active",className:"flex items-center space-x-2",children:[e.jsx(N,{className:"h-4 w-4"}),e.jsxs("span",{children:["Active (",f.length,")"]})]}),e.jsxs(q,{value:"rejected",className:"flex items-center space-x-2",children:[e.jsx(v,{className:"h-4 w-4"}),e.jsxs("span",{children:["Rejected (",R.length,")"]})]}),e.jsxs(q,{value:"terminated",className:"flex items-center space-x-2",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsxs("span",{children:["Terminated (",_.length,")"]})]})]}),e.jsx(A,{value:"pending",className:"space-y-4",children:se?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{children:"Loading requests..."})]}):w.length===0?e.jsx(i,{children:e.jsxs(r,{className:"p-8 text-center",children:[e.jsx(T,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Pending Requests"}),e.jsx("p",{className:"text-gray-600",children:"All mechanic requests have been reviewed."})]})}):e.jsx("div",{className:"grid gap-4",children:w.map(s=>e.jsx(C,{request:s},s.id))})}),e.jsx(A,{value:"active",className:"space-y-4",children:f.length===0?e.jsx(i,{children:e.jsxs(r,{className:"p-8 text-center",children:[e.jsx(N,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Active Mechanics"}),e.jsx("p",{className:"text-gray-600",children:"No mechanics are currently working with your organization."})]})}):e.jsx("div",{className:"grid gap-4",children:f.map(s=>e.jsx(C,{request:s},s.id))})}),e.jsx(A,{value:"rejected",className:"space-y-4",children:R.length===0?e.jsx(i,{children:e.jsxs(r,{className:"p-8 text-center",children:[e.jsx(v,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Rejected Requests"}),e.jsx("p",{className:"text-gray-600",children:"No requests have been rejected."})]})}):e.jsx("div",{className:"grid gap-4",children:R.map(s=>e.jsx(C,{request:s},s.id))})}),e.jsx(A,{value:"terminated",className:"space-y-4",children:_.length===0?e.jsx(i,{children:e.jsxs(r,{className:"p-8 text-center",children:[e.jsx(P,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Terminated Relationships"}),e.jsx("p",{className:"text-gray-600",children:"No mechanic relationships have been terminated."})]})}):e.jsx("div",{className:"grid gap-4",children:_.map(s=>e.jsx(C,{request:s},s.id))})})]}),e.jsx(pe,{open:J,onOpenChange:m,children:e.jsxs(Ne,{children:[e.jsxs(ve,{children:[e.jsx(be,{children:l&&e.jsx(e.Fragment,{children:c.isPending||d.isPending?"Processing...":"Respond to Request"})}),e.jsx(ye,{children:l&&e.jsxs(e.Fragment,{children:["Respond to ",(Q=l.mechanic)==null?void 0:Q.first_name," ",(U=l.mechanic)==null?void 0:U.last_name,"'s request to join your organization."]})})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Response Message (Optional)"}),e.jsx(we,{placeholder:"Add a personal message...",value:D,onChange:s=>M(s.target.value),rows:3})]})}),e.jsxs(fe,{children:[e.jsx(j,{variant:"outline",onClick:()=>m(!1),disabled:c.isPending||d.isPending,children:"Cancel"}),e.jsxs(j,{variant:"outline",onClick:()=>O("reject"),disabled:c.isPending||d.isPending,children:[e.jsx(X,{className:"h-4 w-4 mr-1"}),"Reject"]}),e.jsxs(j,{onClick:()=>O("approve"),disabled:c.isPending||d.isPending,children:[e.jsx(G,{className:"h-4 w-4 mr-1"}),"Approve"]})]})]})})]})};export{qe as default};
