import{c as ie,j as e,aI as ge,aJ as pe,aK as je,C as le,a0 as fe,aL as we,n as ye,S as Ne,P as ve,F as be,at as _e,w as Ce,m as Z,aa as Pe,f as Ee,ax as Se,B as p,ak as Y,aj as K,u as Te,e as I,g as B,h as L,i as ze,k as O,r as N,a1 as oe,G as De,a2 as ke,a4 as ce,a5 as de,a6 as Q,a7 as W,a8 as G,q as u,I as g,A as R,v as Fe,z as H,E as he,J as M,aM as ae,aA as te,y as re,am as Ae,U as Ie,d as Oe}from"./main-DVuL102c.js";import{u as Me}from"./useDrivers-BoUOpm5H.js";import{T as $e,a as Ue,b as V,c as k,d as Be,e as P}from"./table-Jjtal2IW.js";import{E as Le,O as qe}from"./DriverStatusBadges-DgBYoBKx.js";import{H as Re}from"./heart-CNuKn9NJ.js";import{U as me}from"./user-x-Ct1jgzv0.js";import{U as xe}from"./user-check-ocIY3ZDi.js";import{C as ne}from"./copy-CYsGklED.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=ie("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=ie("MailX",[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h9",key:"1j9vog"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"m17 17 4 4",key:"1b3523"}],["path",{d:"m21 17-4 4",key:"uinynz"}]]),Ve=({missingDocuments:n=[],completedDocuments:x=[]})=>{const t={driver_license:{icon:He,label:"Driver License"},medical_certificate:{icon:Re,label:"Medical Certificate"},insurance:{icon:Ne,label:"Insurance Documents"},emergency_contact:{icon:ve,label:"Emergency Contact"},tax_forms:{icon:be,label:"Tax Forms (W-4)"},direct_deposit:{icon:_e,label:"Direct Deposit Form"},photo_id:{icon:Ce,label:"Photo ID Badge"}},r=Object.keys(t);return e.jsx(ge,{children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[r.map(l=>{const a=t[l],w=a.icon,o=x.includes(l),v=n.includes(l);return e.jsxs(pe,{children:[e.jsx(je,{asChild:!0,children:e.jsxs("div",{className:"relative",children:[e.jsx(w,{className:`w-4 h-4 ${o?"text-green-600":v?"text-red-500":"text-gray-400"}`}),o&&e.jsx(le,{className:"w-2 h-2 text-green-600 absolute -top-1 -right-1 bg-white rounded-full"}),v&&e.jsx(fe,{className:"w-2 h-2 text-red-500 absolute -top-1 -right-1 bg-white rounded-full"})]})}),e.jsx(we,{children:e.jsxs("p",{children:[a.label,": ",o?"Completed":v?"Missing":"Not Required"]})})]},l)}),n.length>0&&e.jsxs(ye,{variant:"destructive",className:"ml-2 text-xs",children:[n.length," missing"]})]})})},ue=()=>{const{profile:n}=Z(),x=(n==null?void 0:n.role)==="admin",t=(n==null?void 0:n.role)==="council",r=(n==null?void 0:n.role)==="super_admin",l=x||t||r,a=n==null?void 0:n.organization_id;return{isAdmin:x,isCouncil:t,isSuperAdmin:r,canManagePasswords:l,organizationId:a,profile:n}},Xe=({drivers:n,onViewDriver:x,onPasswordChange:t})=>{const{canManagePasswords:r,organizationId:l}=ue();return e.jsx("div",{className:"overflow-x-auto",children:e.jsxs($e,{children:[e.jsx(Ue,{children:e.jsxs(V,{children:[e.jsx(k,{children:"Name"}),e.jsx(k,{children:"Email"}),e.jsx(k,{children:"Employment Status"}),e.jsx(k,{children:"Onboarding Status"}),e.jsx(k,{children:"Progress"}),e.jsx(k,{children:"Documents"}),e.jsx(k,{children:"Hire Date"}),e.jsx(k,{children:"Actions"})]})}),e.jsxs(Be,{children:[n==null?void 0:n.map(a=>e.jsxs(V,{children:[e.jsxs(P,{className:"font-medium",children:[a.first_name," ",a.last_name]}),e.jsx(P,{children:a.email}),e.jsx(P,{children:e.jsx(Le,{status:a.employment_status||"applicant"})}),e.jsx(P,{children:e.jsx(qe,{status:a.onboarding_status||"pending"})}),e.jsx(P,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Pe,{value:a.onboarding_progress||0,className:"w-20"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[a.completed_tasks||0,"/",a.total_tasks||0]})]})}),e.jsx(P,{children:e.jsx(Ve,{missingDocuments:a.missing_documents,completedDocuments:a.completed_documents})}),e.jsx(P,{children:a.hire_date?e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Ee,{className:"w-4 h-4"}),e.jsx("span",{children:Se(new Date(a.hire_date),"MMM dd, yyyy")})]}):e.jsx("span",{className:"text-gray-400",children:"Not hired"})}),e.jsx(P,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>x(a.id),className:"flex items-center space-x-1",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsx("span",{children:"View"})]}),t&&r&&(a.organization_id===l?e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>t({id:a.id,email:a.email,first_name:a.first_name,last_name:a.last_name,organization_id:a.organization_id}),className:"flex items-center space-x-1",children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{children:"Password"})]}):e.jsxs(p,{variant:"outline",size:"sm",disabled:!0,className:"flex items-center space-x-1 opacity-50 cursor-not-allowed",title:"Can only change passwords for drivers in your organization",children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{children:"Password"})]}))]})})]},a.id)),(!n||n.length===0)&&e.jsx(V,{children:e.jsx(P,{colSpan:8,className:"text-center py-8",children:e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx(me,{className:"w-8 h-8 text-gray-400"}),e.jsx("span",{className:"text-gray-500",children:"No drivers found"})]})})})]})]})})},Ye=({drivers:n,isLoading:x,onPasswordChange:t})=>{const r=Te(),l=a=>{r(`/drivers/${a}`)};return x?e.jsx("div",{className:"flex items-center justify-center p-8",children:"Loading drivers..."}):e.jsx(e.Fragment,{children:e.jsxs(I,{children:[e.jsxs(B,{children:[e.jsxs(L,{className:"flex items-center space-x-2",children:[e.jsx(xe,{className:"w-5 h-5"}),e.jsx("span",{children:"Drivers Overview"})]}),e.jsx(ze,{children:"Manage driver onboarding and employment status"})]}),e.jsx(O,{children:e.jsx(Xe,{drivers:n,onViewDriver:l,onPasswordChange:t})})]})})},Ke="https://dznbihypzmvcmradijqn.supabase.co",Qe=({open:n,onOpenChange:x,onDriverAdded:t})=>{const[r,l]=N.useState({first_name:"",last_name:"",email:"",phone:"",address:"",city:"",state:"",zip_code:"",hire_date:"",termination_date:"",cdl_number:"",medical_card_expiry:""}),[a,w]=N.useState(null),{toast:o}=oe(),v=De(),y=ke({mutationFn:async s=>{console.log("Creating driver with data:",s);const{data:{session:c},error:j}=await M.auth.getSession();if(j||!c)throw new Error("You must be logged in to create drivers. Please log in and try again.");console.log("Session found, calling create-driver function...");const{data:m,error:_}=await M.functions.invoke("create-driver",{body:{email:s.email,firstName:s.first_name,lastName:s.last_name,phone:s.phone||null,address:s.address||null,city:s.city||null,state:s.state||null,zipCode:s.zip_code||null,hireDate:s.hire_date||null,cdlNumber:s.cdl_number||null,medicalCardExpiry:s.medical_card_expiry||null}});if(console.log("Edge Function response:",{data:m,error:_}),_)if(console.error("Error creating driver:",_),_.message&&_.message.includes("non-2xx status code")){console.log("Attempting direct fetch to get detailed error...");try{const f=await fetch(`${Ke}/functions/v1/create-driver`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c.access_token}`},body:JSON.stringify({email:s.email,firstName:s.first_name,lastName:s.last_name,phone:s.phone||null,address:s.address||null,city:s.city||null,state:s.state||null,zipCode:s.zip_code||null,hireDate:s.hire_date||null,cdlNumber:s.cdl_number||null,medicalCardExpiry:s.medical_card_expiry||null})}),d=await f.text();if(console.log("Direct fetch response:",{status:f.status,statusText:f.statusText,body:d}),!f.ok)throw new Error(`Driver creation failed: ${f.status} ${f.statusText} - ${d}`)}catch(f){throw console.error("Direct fetch also failed:",f),new Error("Driver creation failed. Please check the Edge Function logs for details.")}}else throw _;if(m!=null&&m.error)throw console.error("Edge Function returned error:",m.error),new Error(m.error);return m},onSuccess:s=>{v.invalidateQueries({queryKey:["drivers"]}),w({email:r.email,temporaryPassword:s.temporaryPassword||"Contact admin for password",emailSent:s.emailSent});const c=s.emailSent?"Driver created successfully and welcome email sent!":"Driver created successfully. Email failed - please share credentials manually.";o({title:"Success",description:c}),t==null||t()},onError:s=>{var j;console.error("Driver creation error:",s);let c="Failed to create driver. Please try again.";if(s.message)c=s.message;else if((j=s.context)!=null&&j.body)try{c=(typeof s.context.body=="string"?JSON.parse(s.context.body):s.context.body).error||c}catch(m){console.error("Error parsing error body:",m)}else s.details&&(c=s.details);o({title:"Error",description:c,variant:"destructive"})}}),h=s=>{const{name:c,value:j}=s.target;l(m=>({...m,[c]:j}))},b=async s=>{if(s.preventDefault(),!r.first_name||!r.last_name||!r.email){o({title:"Validation Error",description:"Please fill in all required fields (First Name, Last Name, Email).",variant:"destructive"});return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.email)){o({title:"Validation Error",description:"Please enter a valid email address.",variant:"destructive"});return}y.mutate(r)},C=async s=>{try{await navigator.clipboard.writeText(s),o({title:"Copied",description:"Copied to clipboard"})}catch(c){console.error("Failed to copy: ",c)}},E=()=>{w(null),l({first_name:"",last_name:"",email:"",phone:"",address:"",city:"",state:"",zip_code:"",hire_date:"",termination_date:"",cdl_number:"",medical_card_expiry:""}),x(!1)};return e.jsx(ce,{open:n,onOpenChange:E,children:e.jsx(de,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:a?e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsxs(W,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5 text-green-600"}),"Driver Created Successfully"]}),e.jsx(G,{children:"The driver account has been created. Please share these login credentials with the new driver."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(R,{className:a.emailSent?"border-green-200 bg-green-50":"border-yellow-200 bg-yellow-50",children:[a.emailSent?e.jsx(Fe,{className:"h-4 w-4 text-green-600"}):e.jsx(Je,{className:"h-4 w-4 text-yellow-600"}),e.jsx(H,{children:a.emailSent?e.jsxs("span",{className:"text-green-800",children:[e.jsx("strong",{children:"Email Sent:"})," Welcome email with login credentials has been sent to the driver."]}):e.jsxs("span",{className:"text-yellow-800",children:[e.jsx("strong",{children:"Email Failed:"})," Please share the credentials manually with the driver."]})})]}),e.jsxs(R,{children:[e.jsx(he,{className:"h-4 w-4"}),e.jsxs(H,{children:[e.jsx("strong",{children:"Important:"})," The driver will be required to change their password on first login for security."]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg space-y-3",children:[e.jsxs("div",{children:[e.jsx(u,{className:"text-sm font-medium text-gray-700",children:"Email"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(g,{value:a.email,readOnly:!0,className:"bg-white"}),e.jsx(p,{variant:"outline",size:"sm",onClick:()=>C(a.email),children:e.jsx(ne,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-sm font-medium text-gray-700",children:"Temporary Password"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(g,{value:a.temporaryPassword,readOnly:!0,className:"bg-white font-mono"}),e.jsx(p,{variant:"outline",size:"sm",onClick:()=>C(a.temporaryPassword),children:e.jsx(ne,{className:"w-4 h-4"})})]})]})]}),e.jsxs("div",{className:"text-sm text-gray-600 space-y-2",children:[e.jsx("p",{children:e.jsx("strong",{children:"Next Steps:"})}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e.jsx("li",{children:"Share these credentials with the new driver"}),e.jsx("li",{children:"The driver must log in and change their password immediately"}),e.jsx("li",{children:"The temporary password will only work for the first login"})]})]}),e.jsx(p,{onClick:E,className:"w-full",children:"Close"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx(W,{children:"Add New Driver"}),e.jsx(G,{children:"Fill out the form below to add a new driver to the system. Required fields are marked with *."})]}),e.jsxs("form",{onSubmit:b,className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"first_name",children:"First Name *"}),e.jsx(g,{type:"text",id:"first_name",name:"first_name",value:r.first_name,onChange:h,required:!0,placeholder:"Enter first name"})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"last_name",children:"Last Name *"}),e.jsx(g,{type:"text",id:"last_name",name:"last_name",value:r.last_name,onChange:h,required:!0,placeholder:"Enter last name"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"email",children:"Email *"}),e.jsx(g,{type:"email",id:"email",name:"email",value:r.email,onChange:h,required:!0,placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"phone",children:"Phone Number"}),e.jsx(g,{type:"tel",id:"phone",name:"phone",value:r.phone,onChange:h,placeholder:"Enter phone number"})]})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"address",children:"Address"}),e.jsx(g,{type:"text",id:"address",name:"address",value:r.address,onChange:h,placeholder:"Enter street address"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"city",children:"City"}),e.jsx(g,{type:"text",id:"city",name:"city",value:r.city,onChange:h,placeholder:"Enter city"})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"state",children:"State"}),e.jsx(g,{type:"text",id:"state",name:"state",value:r.state,onChange:h,placeholder:"Enter state"})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"zip_code",children:"Zip Code"}),e.jsx(g,{type:"text",id:"zip_code",name:"zip_code",value:r.zip_code,onChange:h,placeholder:"Enter zip code"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"hire_date",children:"Hire Date"}),e.jsx(g,{type:"date",id:"hire_date",name:"hire_date",value:r.hire_date,onChange:h})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"termination_date",children:"Termination Date (Optional)"}),e.jsx(g,{type:"date",id:"termination_date",name:"termination_date",value:r.termination_date,onChange:h})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"cdl_number",children:"CDL Number"}),e.jsx(g,{type:"text",id:"cdl_number",name:"cdl_number",value:r.cdl_number,onChange:h,placeholder:"Enter CDL number"})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"medical_card_expiry",children:"Medical Card Expiry"}),e.jsx(g,{type:"date",id:"medical_card_expiry",name:"medical_card_expiry",value:r.medical_card_expiry,onChange:h})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx(p,{type:"button",variant:"outline",onClick:E,disabled:y.isPending,children:"Cancel"}),e.jsx(p,{type:"submit",disabled:y.isPending,children:y.isPending?"Creating...":"Create Driver"})]})]})]})})})},X="https://dznbihypzmvcmradijqn.supabase.co",We=({isOpen:n,onClose:x,driver:t})=>{const[r,l]=N.useState(""),[a,w]=N.useState(""),[o,v]=N.useState(!1),[y,h]=N.useState(!1),[b,C]=N.useState(!1),[E,s]=N.useState(""),[c,j]=N.useState(!1),{toast:m}=oe(),{canManagePasswords:_,organizationId:f}=ue(),{user:d}=Z(),S=async()=>{if(!(!t||!_)){if(t.organization_id&&t.organization_id!==f){s("You can only change passwords for drivers in your organization.");return}if(!r||!a){s("Please fill in all fields");return}if(r.length<6){s("Password must be at least 6 characters long");return}if(r!==a){s("Passwords do not match");return}j(!0)}},T=async()=>{if(!(!t||!d)){C(!0),s("");try{if(!t.id)throw new Error("Invalid driver selected. Please refresh the page and try again.");if(t.organization_id&&t.organization_id!==f)throw new Error("Access denied: You can only change passwords for drivers in your organization.");console.log("Calling Edge Function with parameters:",{targetUserId:t.id,adminUserId:d.id,hasNewPassword:!!r});const{data:{session:i}}=await M.auth.getSession();if(!i)throw new Error("No active session found. Please log in again.");const{data:z,error:A}=await M.functions.invoke("change-user-password",{body:{targetUserId:t.id,newPassword:r,adminUserId:d.id}});if(console.log("Edge Function response:",{data:z,error:A}),A)if(console.error("Edge Function error:",A),A.message&&A.message.includes("non-2xx status code")){console.log("Attempting direct fetch to get detailed error...");try{const D=await fetch(`${X}/functions/v1/change-user-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`},body:JSON.stringify({targetUserId:t.id,newPassword:r,adminUserId:d.id})}),J=await D.text();if(console.log("Direct fetch response:",{status:D.status,statusText:D.statusText,body:J}),!D.ok){const q=JSON.parse(J);if(q.error&&q.error.includes("Target user not found"))throw new Error("The selected driver no longer exists. Please refresh the page and try again.");if(q.error&&q.error.includes("User not found in authentication system")){console.log("User not found in Auth, attempting to create Auth user...");const $=await fetch(`${X}/functions/v1/create-missing-auth-user`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`},body:JSON.stringify({profileId:t.id,adminUserId:d.id})}),ee=await $.text();if(console.log("Create Auth user response:",{status:$.status,body:ee}),$.ok){console.log("Auth user created successfully, now trying password change again...");const U=await fetch(`${X}/functions/v1/change-user-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`},body:JSON.stringify({targetUserId:t.id,newPassword:r,adminUserId:d.id})}),se=await U.text();if(console.log("Retry password change response:",{status:U.status,body:se}),!U.ok)throw new Error(`Password change failed after creating Auth user: ${U.status} ${U.statusText} - ${se}`);m({title:"Password Updated",description:`Password for ${t.email} has been successfully updated.`}),l(""),w(""),j(!1),x();return}else throw new Error(`Failed to create Auth user: ${$.status} ${$.statusText} - ${ee}`)}else throw new Error(`Password change failed: ${D.status} ${D.statusText} - ${J}`)}}catch(D){throw console.error("Direct fetch also failed:",D),new Error("Password change failed. Please check the Edge Function logs for details.")}}else throw A;if(z!=null&&z.error)throw console.error("Edge Function data error:",z.error),new Error(z.error);m({title:"Password Updated",description:`Password for ${t.email} has been successfully updated.`}),l(""),w(""),j(!1),x()}catch(i){console.error("Error updating password:",i),console.error("Error details:",{message:i.message,status:i.status,statusText:i.statusText,data:i.data}),i.message&&(i.message.includes("no longer exists")||i.message.includes("Invalid driver selected")||i.message.includes("Target user not found"))?s(`${i.message} The driver list may be outdated. Please refresh the page.`):s(i.message||"Failed to update password. Please try again.")}finally{C(!1)}}},F=()=>{l(""),w(""),s(""),v(!1),h(!1),j(!1),x()};return!t||!_?null:e.jsx(ce,{open:n,onOpenChange:F,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsxs(Q,{children:[e.jsxs(W,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5"}),"Change Driver Password"]}),e.jsxs(G,{children:["Update the password for"," ",e.jsxs("span",{className:"font-medium",children:[t.first_name," ",t.last_name]})," ","(",t.email,")"]})]}),c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-4",children:e.jsxs(R,{children:[e.jsx(he,{className:"h-4 w-4"}),e.jsxs(H,{children:["Are you sure you want to change the password for"," ",e.jsxs("span",{className:"font-medium",children:[t.first_name," ",t.last_name]}),"?",e.jsx("br",{}),e.jsx("br",{}),"This action will immediately update their login credentials. They will need to use the new password to access their account."]})]})}),e.jsxs(te,{className:"flex gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>j(!1),disabled:b,children:"Back"}),e.jsx(p,{onClick:T,disabled:b,variant:"destructive",children:b?"Updating...":"Confirm Password Change"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4",children:[E&&e.jsx(R,{variant:"destructive",children:e.jsx(H,{children:E})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"newPassword",children:"New Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(g,{id:"newPassword",type:o?"text":"password",value:r,onChange:i=>l(i.target.value),placeholder:"Enter new password",className:"pr-10"}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>v(!o),children:o?e.jsx(ae,{className:"h-4 w-4"}):e.jsx(Y,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"confirmPassword",children:"Confirm Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(g,{id:"confirmPassword",type:y?"text":"password",value:a,onChange:i=>w(i.target.value),placeholder:"Confirm new password",className:"pr-10"}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>h(!y),children:y?e.jsx(ae,{className:"h-4 w-4"}):e.jsx(Y,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsx("p",{children:"• Password must be at least 6 characters long"}),e.jsx("p",{children:"• The driver will need to use this password to log in"})]})]}),e.jsxs(te,{className:"flex gap-2",children:[e.jsx(p,{variant:"outline",onClick:F,disabled:b,children:"Cancel"}),e.jsx(p,{onClick:S,disabled:b||!r||!a,children:"Continue"})]})]})]})})};function is(){const{profile:n}=Z(),[x,t]=N.useState(!1),[r,l]=N.useState(!1),[a,w]=N.useState(null),{data:o=[],isLoading:v,error:y,refetch:h}=Me(),[b,C]=re.useState("testing");re.useEffect(()=>{(async()=>{try{console.log("Testing Supabase connection..."),C("testing");const{data:S,error:T}=await M.from("profiles").select("count").limit(1);if(T)console.error("Supabase connection test failed:",T),C("error");else if(console.log("Supabase connection test successful:",S),C("connected"),n!=null&&n.organization_id){console.log("Testing organization query for org:",n.organization_id);const{data:F,error:i}=await M.from("profiles").select("id, email, first_name, last_name, role, organization_id").eq("organization_id",n.organization_id);i?console.error("Organization query failed:",i):(console.log("Organization profiles found:",F),console.log("Drivers in organization:",F==null?void 0:F.filter(z=>z.role==="driver")))}}catch(S){console.error("Supabase connection test error:",S),C("error")}})()},[n==null?void 0:n.organization_id]);const E=()=>{t(!1),h()},s=d=>{w(d),l(!0)},c=()=>{l(!1),w(null)},j=o.length,m=o.filter(d=>d.is_active).length,_=o.filter(d=>!d.is_active).length,f=o.filter(d=>{const S=d.hire_date?new Date(d.hire_date):null,T=new Date;return T.setDate(T.getDate()-30),S&&S>T}).length;return y?e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Driver Management"}),e.jsx(I,{children:e.jsx(O,{className:"p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-destructive",children:["Error loading drivers: ",y.message]}),e.jsxs("div",{className:"mt-4 p-4 bg-gray-100 rounded text-left",children:[e.jsx("p",{children:e.jsx("strong",{children:"Debug Info:"})}),e.jsxs("p",{children:["Organization ID: ",(a==null?void 0:a.organization_id)||"Not available"]}),e.jsxs("p",{children:["Error details: ",JSON.stringify(y,null,2)]})]}),e.jsx(p,{onClick:()=>h(),className:"mt-4",children:"Try Again"})]})})})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Driver Management"}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Connection Status:"}),b==="testing"&&e.jsx("span",{className:"text-sm text-yellow-600",children:"Testing..."}),b==="connected"&&e.jsx("span",{className:"text-sm text-green-600",children:"Connected"}),b==="error"&&e.jsx("span",{className:"text-sm text-red-600",children:"Connection Error"})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(p,{onClick:()=>t(!0),children:[e.jsx(Ae,{className:"w-4 h-4 mr-2"}),"Add Driver"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(I,{children:[e.jsxs(B,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium",children:"Total Drivers"}),e.jsx(Ie,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(O,{children:[e.jsx("div",{className:"text-2xl font-bold",children:j}),j===0&&!v&&e.jsx("div",{className:"mt-2 p-2 bg-yellow-50 rounded text-xs text-yellow-800",children:"No drivers found. Check console for debug info."})]})]}),e.jsxs(I,{children:[e.jsxs(B,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium",children:"Active Drivers"}),e.jsx(xe,{className:"h-4 w-4 text-green-600"})]}),e.jsx(O,{children:e.jsx("div",{className:"text-2xl font-bold",children:m})})]}),e.jsxs(I,{children:[e.jsxs(B,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium",children:"Inactive Drivers"}),e.jsx(me,{className:"h-4 w-4 text-red-600"})]}),e.jsx(O,{children:e.jsx("div",{className:"text-2xl font-bold",children:_})})]}),e.jsxs(I,{children:[e.jsxs(B,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium",children:"New This Month"}),e.jsx(Oe,{className:"h-4 w-4 text-blue-600"})]}),e.jsx(O,{children:e.jsx("div",{className:"text-2xl font-bold",children:f})})]})]}),e.jsx(Ye,{drivers:o,isLoading:v,onPasswordChange:s}),e.jsx(Qe,{open:x,onOpenChange:t,onDriverAdded:E}),e.jsx(We,{isOpen:r,onClose:c,driver:a})]})}export{is as default};
