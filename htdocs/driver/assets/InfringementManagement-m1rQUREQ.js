import{m as P,H as Q,J as p,r as I,j as e,N as E,ah as O,a4 as ne,as as ie,B as m,am as ae,a5 as te,a6 as le,a7 as de,q as j,ab as N,ac as w,ad as b,ae as _,af as a,I as v,e as u,k as g,F as H,at as ce,E as oe,b as V,O as he,Q as xe,V as L,Y as k,g as C,h as R,au as me,ak as je,D as B,f as M,n as x}from"./main-DVuL102c.js";import{T as J,a as U,b as D,c as t,d as K,e as l}from"./table-Jjtal2IW.js";const W=()=>{const{user:d,profile:c}=P();return Q({queryKey:["infringements",c==null?void 0:c.organization_id],queryFn:async()=>{if(!(c!=null&&c.organization_id))throw new Error("Organization ID is required");console.log("Fetching infringements from database...");try{const{data:s,error:n}=await p.from("infringements").select("*").eq("organization_id",c.organization_id).order("created_at",{ascending:!1});if(n){if(console.error("Error fetching infringements:",n),n.code==="42P01"||n.code==="42703")return console.warn("Infringements table or column not found, returning empty data"),[];throw n}const h=await Promise.all((s||[]).map(async i=>{let S=null;if(i.driver_id)try{const{data:o}=await p.from("profiles").select("id, first_name, last_name, email").eq("id",i.driver_id).single();S=o}catch{console.warn("Could not fetch driver data for infringement:",i.id)}let f=null;if(i.vehicle_id)try{const{data:o}=await p.from("vehicles").select("id, vehicle_number, make, model").eq("id",i.vehicle_id).single();f=o}catch{console.warn("Could not fetch vehicle data for infringement:",i.id)}let y=null;if(i.infringement_type_id)try{const{data:o}=await p.from("infringement_types").select("*").eq("id",i.infringement_type_id).single();y=o}catch{console.warn("Could not fetch infringement type data for infringement:",i.id)}return{...i,driver:S||{id:i.driver_id,first_name:"Unknown",last_name:"Driver",email:"unknown@example.com"},vehicle:f||{id:i.vehicle_id,vehicle_number:"Unknown",make:"Unknown",model:"Unknown"},infringement_type_rel:y}}));return console.log("Fetched infringements with relations:",h),h||[]}catch(s){return console.error("Error in useInfringements:",s),[]}},enabled:!!(c!=null&&c.organization_id)})},ue=d=>{const{user:c,profile:s}=P();return Q({queryKey:["driver_points_history",s==null?void 0:s.organization_id,d],queryFn:async()=>{if(!(s!=null&&s.organization_id))throw new Error("Organization ID is required");console.log("Fetching driver points history from database...");try{let n=p.from("driver_points_history").select("*").eq("organization_id",s.organization_id).order("recorded_date",{ascending:!1});const{data:h,error:i}=await n;if(i){if(console.error("Error fetching driver points history:",i),i.code==="42P01"||i.code==="42703")return console.warn("Driver points history table or column not found, returning empty data"),[];throw i}return console.log("Fetched driver points history:",h),h||[]}catch(n){return console.error("Error in useDriverPointsHistory:",n),[]}},enabled:!!(s!=null&&s.organization_id)})},ge=()=>{const{data:d=[]}=W();return ue(),{total_infringements:d.length,pending_infringements:d.filter(s=>s.status==="pending").length,confirmed_infringements:d.filter(s=>s.status==="confirmed").length,resolved_infringements:d.filter(s=>s.status==="resolved").length,total_fines:d.reduce((s,n)=>s+(n.fine_amount||0),0),total_points:d.reduce((s,n)=>s+(n.penalty_points||n.points_deducted||0),0),by_severity:d.reduce((s,n)=>(s[n.severity]=(s[n.severity]||0)+1,s),{}),by_status:d.reduce((s,n)=>(s[n.status]=(s[n.status]||0)+1,s),{}),monthly_trend:d.reduce((s,n)=>{const h=new Date(n.created_at).toISOString().slice(0,7);return s[h]=(s[h]||0)+1,s},{})}},fe=()=>{const{user:d,profile:c,loading:s}=P(),[n,h]=I.useState(""),[i,S]=I.useState(""),[f,y]=I.useState(!1),{data:o=[],isLoading:G}=W(),T=ge();if(s||G)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading infringement management..."})]})});if(!d||!c)return e.jsx(E,{to:"/auth",replace:!0});if(!["admin","council"].includes(c.role))return e.jsx(E,{to:"/unauthorized",replace:!0});o.filter(r=>{var z,A,q;const F=!n||r.description.toLowerCase().includes(n.toLowerCase())||(((z=r.driver)==null?void 0:z.first_name)||"").toLowerCase().includes(n.toLowerCase())||(((A=r.driver)==null?void 0:A.last_name)||"").toLowerCase().includes(n.toLowerCase())||(((q=r.vehicle)==null?void 0:q.vehicle_number)||"").toLowerCase().includes(n.toLowerCase()),re=!i||r.driver_id===i;return F&&re});const Y=[{driverId:"1",driverName:"John Smith",totalInfringements:3,totalPoints:9,totalFines:450,riskLevel:"high"},{driverId:"2",driverName:"Sarah Johnson",totalInfringements:1,totalPoints:0,totalFines:80,riskLevel:"low"},{driverId:"3",driverName:"Mike Davis",totalInfringements:2,totalPoints:6,totalFines:380,riskLevel:"medium"}],X=r=>{switch(r){case"pending":return e.jsx(x,{className:"bg-yellow-100 text-yellow-800 hover:bg-yellow-100",children:"Pending"});case"paid":return e.jsx(x,{className:"bg-green-100 text-green-800 hover:bg-green-100",children:"Paid"});case"disputed":return e.jsx(x,{className:"bg-blue-100 text-blue-800 hover:bg-blue-100",children:"Disputed"});case"overdue":return e.jsx(x,{className:"bg-red-100 text-red-800 hover:bg-red-100",children:"Overdue"});default:return e.jsx(x,{variant:"secondary",children:r})}},Z=r=>{switch(r){case"low":return e.jsx(x,{className:"bg-green-100 text-green-800 hover:bg-green-100",children:"Low Risk"});case"medium":return e.jsx(x,{className:"bg-yellow-100 text-yellow-800 hover:bg-yellow-100",children:"Medium Risk"});case"high":return e.jsx(x,{className:"bg-red-100 text-red-800 hover:bg-red-100",children:"High Risk"});default:return e.jsx(x,{variant:"secondary",children:r})}},$=T.total_fines,ee=o.filter(r=>r.status==="pending").reduce((r,F)=>r+(F.fine_amount||0),0),se=T.total_points;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx(O,{className:"w-8 h-8 text-red-600"}),"Infringement Management"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Track and manage driver infringements and violations"})]}),e.jsxs(ne,{open:f,onOpenChange:y,children:[e.jsx(ie,{asChild:!0,children:e.jsxs(m,{className:"bg-red-600 hover:bg-red-700",children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"Record Infringement"]})}),e.jsxs(te,{className:"max-w-md",children:[e.jsx(le,{children:e.jsx(de,{children:"Record New Infringement"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(j,{htmlFor:"driver",children:"Driver"}),e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(b,{placeholder:"Select driver"})}),e.jsxs(_,{children:[e.jsx(a,{value:"john",children:"John Smith"}),e.jsx(a,{value:"sarah",children:"Sarah Johnson"}),e.jsx(a,{value:"mike",children:"Mike Davis"})]})]})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"vehicle",children:"Vehicle"}),e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(b,{placeholder:"Select vehicle"})}),e.jsxs(_,{children:[e.jsx(a,{value:"LSR-001",children:"LSR-001"}),e.jsx(a,{value:"LSR-002",children:"LSR-002"}),e.jsx(a,{value:"LSR-003",children:"LSR-003"})]})]})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"type",children:"Infringement Type"}),e.jsxs(N,{children:[e.jsx(w,{children:e.jsx(b,{placeholder:"Select type"})}),e.jsxs(_,{children:[e.jsx(a,{value:"speeding",children:"Speeding"}),e.jsx(a,{value:"parking",children:"Parking Violation"}),e.jsx(a,{value:"weight",children:"Weight Violation"}),e.jsx(a,{value:"hours",children:"Driving Hours Violation"}),e.jsx(a,{value:"other",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"date",children:"Date"}),e.jsx(v,{id:"date",type:"date"})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"location",children:"Location"}),e.jsx(v,{id:"location",placeholder:"Location of infringement"})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"fine",children:"Fine Amount (£)"}),e.jsx(v,{id:"fine",type:"number",step:"0.01",placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"points",children:"Penalty Points"}),e.jsx(v,{id:"points",type:"number",placeholder:"0"})]}),e.jsx(m,{className:"w-full bg-red-600 hover:bg-red-700",children:"Record Infringement"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(u,{children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(H,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Infringements"}),e.jsx("p",{className:"text-2xl font-bold",children:T.total_infringements})]})]})})}),e.jsx(u,{children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ce,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Fines"}),e.jsxs("p",{className:"text-2xl font-bold",children:["£",$.toFixed(2)]})]})]})})}),e.jsx(u,{children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(oe,{className:"w-8 h-8 text-yellow-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Pending Fines"}),e.jsxs("p",{className:"text-2xl font-bold text-yellow-600",children:["£",ee.toFixed(2)]})]})]})})}),e.jsx(u,{children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(V,{className:"w-8 h-8 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Points"}),e.jsx("p",{className:"text-2xl font-bold",children:se})]})]})})})]}),e.jsxs(he,{defaultValue:"infringements",className:"space-y-6",children:[e.jsxs(xe,{className:"grid w-full grid-cols-3",children:[e.jsx(L,{value:"infringements",children:"All Infringements"}),e.jsx(L,{value:"driver-summary",children:"Driver Summary"}),e.jsx(L,{value:"reports",children:"Reports & Analytics"})]}),e.jsx(k,{value:"infringements",className:"space-y-4",children:e.jsxs(u,{children:[e.jsxs(C,{children:[e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"w-5 h-5"}),"Infringement Records"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(me,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(v,{placeholder:"Search infringements...",value:n,onChange:r=>h(r.target.value),className:"pl-10"})]}),e.jsxs(N,{children:[e.jsx(w,{className:"w-48",children:e.jsx(b,{placeholder:"Filter by status"})}),e.jsxs(_,{children:[e.jsx(a,{value:"all",children:"All Status"}),e.jsx(a,{value:"pending",children:"Pending"}),e.jsx(a,{value:"paid",children:"Paid"}),e.jsx(a,{value:"disputed",children:"Disputed"}),e.jsx(a,{value:"overdue",children:"Overdue"})]})]})]})]}),e.jsx(g,{children:e.jsxs(J,{children:[e.jsx(U,{children:e.jsxs(D,{children:[e.jsx(t,{children:"Driver"}),e.jsx(t,{children:"Vehicle"}),e.jsx(t,{children:"Type"}),e.jsx(t,{children:"Date"}),e.jsx(t,{children:"Location"}),e.jsx(t,{children:"Fine Amount"}),e.jsx(t,{children:"Points"}),e.jsx(t,{children:"Status"}),e.jsx(t,{children:"Due Date"}),e.jsx(t,{children:"Actions"})]})}),e.jsx(K,{children:o.map(r=>e.jsxs(D,{children:[e.jsx(l,{className:"font-medium",children:r.driverName}),e.jsx(l,{children:r.vehicleNumber}),e.jsx(l,{children:r.infringementType}),e.jsx(l,{children:r.date}),e.jsx(l,{children:r.location}),e.jsxs(l,{children:["£",r.fineAmount.toFixed(2)]}),e.jsx(l,{children:r.points}),e.jsx(l,{children:X(r.status)}),e.jsx(l,{children:r.dueDate}),e.jsx(l,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{variant:"outline",size:"sm",children:e.jsx(je,{className:"w-4 h-4"})}),e.jsx(m,{variant:"outline",size:"sm",children:e.jsx(B,{className:"w-4 h-4"})})]})})]},r.id))})]})})]})}),e.jsx(k,{value:"driver-summary",className:"space-y-4",children:e.jsxs(u,{children:[e.jsx(C,{children:e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"w-5 h-5"}),"Driver Risk Summary"]})}),e.jsx(g,{children:e.jsxs(J,{children:[e.jsx(U,{children:e.jsxs(D,{children:[e.jsx(t,{children:"Driver Name"}),e.jsx(t,{children:"Total Infringements"}),e.jsx(t,{children:"Total Points"}),e.jsx(t,{children:"Total Fines"}),e.jsx(t,{children:"Risk Level"}),e.jsx(t,{children:"Actions"})]})}),e.jsx(K,{children:Y.map(r=>e.jsxs(D,{children:[e.jsx(l,{className:"font-medium",children:r.driverName}),e.jsx(l,{children:r.totalInfringements}),e.jsx(l,{children:r.totalPoints}),e.jsxs(l,{children:["£",r.totalFines.toFixed(2)]}),e.jsx(l,{children:Z(r.riskLevel)}),e.jsx(l,{children:e.jsx(m,{variant:"outline",size:"sm",children:"View Details"})})]},r.driverId))})]})})]})}),e.jsx(k,{value:"reports",className:"space-y-4",children:e.jsxs(u,{children:[e.jsx(C,{children:e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"Reports & Analytics"]})}),e.jsx(g,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(H,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Infringement Analytics"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Generate detailed reports on driver behavior, infringement trends, and risk analysis."}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsxs(m,{className:"bg-red-600 hover:bg-red-700",children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"Monthly Report"]}),e.jsxs(m,{variant:"outline",children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Custom Date Range"]})]})]})})]})})]})]})};export{fe as default};
