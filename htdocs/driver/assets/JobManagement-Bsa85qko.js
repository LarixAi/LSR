import{m as k,H as R,J as g,G as q,a2 as z,a3 as p,r as T,j as e,$ as M,N as O,F as P,a4 as V,as as A,B as D,am as U,a5 as G,a6 as W,a7 as $,q as h,I as u,ab as X,ac as Y,ad as Z,ae as ee,af as F,e as f,k as _,C as se,d as re,at as te,g as ae,h as ie,au as ne,ak as le,an as oe,n as Q}from"./main-DVuL102c.js";import{T as ce,a as de,b as E,c as x,d as he,e as d}from"./table-Jjtal2IW.js";import{u as ue}from"./useDrivers-BoUOpm5H.js";import{u as xe}from"./useVehicles-DG5ys_xt.js";const K=()=>{const{user:a,profile:t}=k();return R({queryKey:["jobs",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))throw new Error("Organization ID is required");console.log("Fetching jobs from database...");try{const{data:r,error:l}=await g.from("jobs").select("*").eq("organization_id",t.organization_id).order("created_at",{ascending:!1});if(l){if(console.error("Error fetching jobs:",l),l.code==="42P01"||l.code==="PGRST200")return console.warn("jobs table not found or foreign key relationship issue, returning empty data"),[];throw l}if(!r||r.length===0)return[];const o=r.filter(n=>n.assigned_driver_id).map(n=>n.assigned_driver_id),N=r.filter(n=>n.assigned_vehicle_id).map(n=>n.assigned_vehicle_id),b=r.filter(n=>n.created_by).map(n=>n.created_by),[i,c,C]=await Promise.all([o.length>0?g.from("profiles").select("*").in("id",o):Promise.resolve({data:[],error:null}),N.length>0?g.from("vehicles").select("*").in("id",N):Promise.resolve({data:[],error:null}),b.length>0?g.from("profiles").select("*").in("id",b):Promise.resolve({data:[],error:null})]),w=r.map(n=>{var J,S,y;const m=(J=i.data)==null?void 0:J.find(s=>s.id===n.assigned_driver_id),v=(S=c.data)==null?void 0:S.find(s=>s.id===n.assigned_vehicle_id),L=(y=C.data)==null?void 0:y.find(s=>s.id===n.created_by);return{...n,assigned_driver:m||null,assigned_vehicle:v||null,creator:L||null}});return console.log("Fetched jobs with relations:",w),w||[]}catch(r){return console.error("Error in useJobs:",r),[]}},enabled:!!(t!=null&&t.organization_id)})},ge=()=>{const{profile:a}=k(),t=q();return z({mutationFn:async r=>{if(!(a!=null&&a.organization_id)||!(a!=null&&a.id))throw new Error("Organization and user information required");const{data:l,error:o}=await g.from("jobs").insert({...r,organization_id:a.organization_id,created_by:a.id}).select().single();if(o)throw o;return l},onSuccess:()=>{t.invalidateQueries({queryKey:["jobs"]}),p.success("Job created successfully")},onError:r=>{console.error("Error creating job:",r),p.error("Failed to create job: "+r.message)}})},me=()=>{const a=q();return z({mutationFn:async({id:t,updates:r})=>{const{data:l,error:o}=await g.from("jobs").update(r).eq("id",t).select().single();if(o)throw o;return l},onSuccess:()=>{a.invalidateQueries({queryKey:["jobs"]}),p.success("Job updated successfully")},onError:t=>{console.error("Error updating job:",t),p.error("Failed to update job: "+t.message)}})},je=()=>{const a=q();return z({mutationFn:async t=>{const{error:r}=await g.from("jobs").delete().eq("id",t);if(r)throw r},onSuccess:()=>{a.invalidateQueries({queryKey:["jobs"]}),p.success("Job deleted successfully")},onError:t=>{console.error("Error deleting job:",t),p.error("Failed to delete job: "+t.message)}})},pe=()=>{const{data:a=[]}=K();return{total:a.length,pending:a.filter(r=>r.status==="pending").length,assigned:a.filter(r=>r.status==="assigned").length,in_progress:a.filter(r=>r.status==="in_progress").length,completed:a.filter(r=>r.status==="completed").length,cancelled:a.filter(r=>r.status==="cancelled").length,high_priority:a.filter(r=>r.priority==="high"||r.priority==="urgent").length}},_e=()=>{const{user:a,profile:t,loading:r}=k(),[l,o]=T.useState(""),[N,b]=T.useState(!1),[i,c]=T.useState({title:"",description:"",priority:"medium",pickup_location:"",delivery_location:"",customer_name:"",customer_contact:"",start_date:"",end_date:"",assigned_driver_id:"",assigned_vehicle_id:""}),{data:C=[],isLoading:w,error:n}=K(),m=pe();ue(),xe();const v=ge();if(me(),je(),r||w)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx(M,{className:"h-8 w-8 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading job management..."})]})});if(!a||!t)return e.jsx(O,{to:"/auth",replace:!0});if(!["admin","council"].includes(t.role))return e.jsx(O,{to:"/unauthorized",replace:!0});const L=async()=>{try{await v.mutateAsync(i),b(!1),c({title:"",description:"",priority:"medium",pickup_location:"",delivery_location:"",customer_name:"",customer_contact:"",start_date:"",end_date:"",assigned_driver_id:"",assigned_vehicle_id:""})}catch(s){console.error("Failed to create job:",s)}},J=s=>{const j={pending:"bg-yellow-100 text-yellow-800",assigned:"bg-blue-100 text-blue-800",in_progress:"bg-purple-100 text-purple-800",completed:"bg-green-100 text-green-800",cancelled:"bg-red-100 text-red-800"};return e.jsx(Q,{className:j[s]||"bg-gray-100 text-gray-800",children:s==null?void 0:s.replace("_"," ")})},S=s=>{const j={low:"bg-gray-100 text-gray-800",medium:"bg-blue-100 text-blue-800",high:"bg-orange-100 text-orange-800",urgent:"bg-red-100 text-red-800"};return e.jsx(Q,{className:j[s]||"bg-gray-100 text-gray-800",children:s})},y=C.filter(s=>{var j,I,B,H;return((j=s.title)==null?void 0:j.toLowerCase().includes(l.toLowerCase()))||((I=s.customer_name)==null?void 0:I.toLowerCase().includes(l.toLowerCase()))||((B=s.job_number)==null?void 0:B.toLowerCase().includes(l.toLowerCase()))||((H=s.description)==null?void 0:H.toLowerCase().includes(l.toLowerCase()))});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx(P,{className:"w-8 h-8 text-blue-600"}),"Job Management"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Create, assign, and track transport jobs"})]}),e.jsxs(V,{open:N,onOpenChange:b,children:[e.jsx(A,{asChild:!0,children:e.jsxs(D,{className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Create Job"]})}),e.jsxs(G,{className:"max-w-2xl",children:[e.jsx(W,{children:e.jsx($,{children:"Create New Job"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"job-title",children:"Job Title *"}),e.jsx(u,{id:"job-title",placeholder:"Enter job title",value:i.title,onChange:s=>c({...i,title:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"customer",children:"Customer Name *"}),e.jsx(u,{id:"customer",placeholder:"Customer name",value:i.customer_name,onChange:s=>c({...i,customer_name:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"pickup",children:"Pickup Location"}),e.jsx(u,{id:"pickup",placeholder:"Pickup address",value:i.pickup_location,onChange:s=>c({...i,pickup_location:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"delivery",children:"Delivery Location"}),e.jsx(u,{id:"delivery",placeholder:"Delivery address",value:i.delivery_location,onChange:s=>c({...i,delivery_location:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"start-date",children:"Start Date"}),e.jsx(u,{id:"start-date",type:"date",value:i.start_date,onChange:s=>c({...i,start_date:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"priority",children:"Priority"}),e.jsxs(X,{value:i.priority,onValueChange:s=>c({...i,priority:s}),children:[e.jsx(Y,{children:e.jsx(Z,{placeholder:"Select priority"})}),e.jsxs(ee,{children:[e.jsx(F,{value:"low",children:"Low"}),e.jsx(F,{value:"medium",children:"Medium"}),e.jsx(F,{value:"high",children:"High"}),e.jsx(F,{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(h,{htmlFor:"description",children:"Description"}),e.jsx(u,{id:"description",placeholder:"Job description",value:i.description,onChange:s=>c({...i,description:s.target.value})})]}),e.jsx("div",{className:"col-span-2",children:e.jsx(D,{className:"w-full bg-blue-600 hover:bg-blue-700",onClick:L,disabled:v.isPending||!i.title||!i.customer_name,children:v.isPending?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"w-4 h-4 mr-2 animate-spin"}),"Creating..."]}):"Create Job"})})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(f,{children:e.jsx(_,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(P,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Jobs"}),e.jsx("p",{className:"text-2xl font-bold",children:m.total})]})]})})}),e.jsx(f,{children:e.jsx(_,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(se,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"In Progress"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:m.in_progress})]})]})})}),e.jsx(f,{children:e.jsx(_,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(re,{className:"w-8 h-8 text-yellow-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Pending"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:m.pending})]})]})})}),e.jsx(f,{children:e.jsx(_,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Completed"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:m.completed})]})]})})})]}),e.jsxs(f,{children:[e.jsxs(ae,{children:[e.jsxs(ie,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"Job List"]}),e.jsx("div",{className:"flex gap-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(u,{placeholder:"Search jobs...",value:l,onChange:s=>o(s.target.value),className:"pl-10"})]})})]}),e.jsx(_,{children:e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(E,{children:[e.jsx(x,{children:"Job Number"}),e.jsx(x,{children:"Title"}),e.jsx(x,{children:"Customer"}),e.jsx(x,{children:"Priority"}),e.jsx(x,{children:"Status"}),e.jsx(x,{children:"Created"}),e.jsx(x,{children:"Actions"})]})}),e.jsx(he,{children:y.length===0?e.jsx(E,{children:e.jsx(d,{colSpan:7,className:"text-center py-8 text-gray-500",children:C.length===0?"No jobs found. Create your first job to get started.":"No jobs match your search criteria."})}):y.map(s=>e.jsxs(E,{children:[e.jsx(d,{className:"font-medium",children:s.job_number||s.id.slice(0,8)}),e.jsx(d,{children:s.title||"Untitled Job"}),e.jsx(d,{children:s.customer_name||"No customer"}),e.jsx(d,{children:S(s.priority||"medium")}),e.jsx(d,{children:J(s.status||"pending")}),e.jsx(d,{children:new Date(s.created_at).toLocaleDateString()}),e.jsx(d,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(D,{variant:"outline",size:"sm",children:e.jsx(le,{className:"w-4 h-4"})}),e.jsx(D,{variant:"outline",size:"sm",children:e.jsx(oe,{className:"w-4 h-4"})})]})})]},s.id))})]})})]})]})};export{_e as default};
