import{av as oe,aG as Ce,H as de,G as pe,a2 as je,J as R,a3 as $,m as ve,u as De,r as C,j as e,a4 as fe,a5 as Ne,a6 as _e,a7 as be,a8 as we,q as g,ab as J,ac as W,ad as X,ae as Z,af as m,B as M,I as L,am as ee,n as w,X as xe,s as Le,e as E,g as q,h as H,i as V,aq as Ee,k,aa as ke,b as Te,a0 as me,A as te,z as ne,E as se,K as Y,C as Q,aH as T,N as Me,F as he,U as Se,au as Ae,O as Fe,Q as Ie,V as le,Y as ce,f as Be,ax as I,ak as Pe,ap as Ue,S as qe,d as He}from"./main-DVuL102c.js";import{T as Ve,a as Re,b as ue,c as P,d as ze,e as U}from"./table-Jjtal2IW.js";import{u as $e}from"./useDrivers-BoUOpm5H.js";import{T as Oe}from"./trending-down-DwD0VVi4.js";import{a as ye}from"./addDays-CXxLH7jZ.js";import{T as Ke}from"./trash-2-uDLx8yM9.js";function K(l,i){const n=oe(l),d=oe(i),h=ge(n,d),N=Math.abs(Ce(n,d));n.setDate(n.getDate()-h*N);const j=+(ge(n,d)===-h),t=h*(N-j);return t===0?0:t}function ge(l,i){const n=l.getFullYear()-i.getFullYear()||l.getMonth()-i.getMonth()||l.getDate()-i.getDate()||l.getHours()-i.getHours()||l.getMinutes()-i.getMinutes()||l.getSeconds()-i.getSeconds()||l.getMilliseconds()-i.getMilliseconds();return n<0?-1:n>0?1:n}const Qe=l=>de({queryKey:["licenses",l],queryFn:async()=>{if(!l)return[];console.log("ðŸ” Fetching licenses for organization:",l);try{const{data:i,error:n}=await R.from("driver_licenses").select("*").eq("organization_id",l).order("created_at",{ascending:!1});if(n)return console.error("Error fetching licenses:",n),[];if(!i||i.length===0)return[];const d=i.map(o=>o.driver_id),{data:h,error:N}=await R.from("profiles").select("id, first_name, last_name, email").in("id",d);if(N)return console.error("Error fetching drivers:",N),i.map(o=>({...o,driver_name:"Unknown Driver",driver_email:""}));const j=new Map;h==null||h.forEach(o=>{j.set(o.id,o)});const t=i.map(o=>{const p=j.get(o.driver_id);return{...o,driver_name:p?`${p.first_name} ${p.last_name}`:"Unknown Driver",driver_email:(p==null?void 0:p.email)||""}});return console.log("ðŸ“‹ Licenses data:",t),t}catch(i){return console.error("Error in useLicenses:",i),[]}},enabled:!!l}),Ge=()=>{const l=pe(),{profile:i}=ve();return je({mutationFn:async n=>{if(!(i!=null&&i.organization_id))throw new Error("Organization ID is required");const{data:d,error:h}=await R.from("driver_licenses").insert({...n,organization_id:i.organization_id,status:"active",points_balance:0,endorsements:n.endorsements||[],restrictions:n.restrictions||[]}).select().single();if(h)throw h;return d},onSuccess:()=>{l.invalidateQueries({queryKey:["licenses"]}),l.invalidateQueries({queryKey:["driver-licenses"]}),$.success("License created successfully")},onError:n=>{console.error("Error creating license:",n),$.error("Failed to create license: "+n.message)}})},Ye=()=>{const l=pe();return je({mutationFn:async i=>{const{error:n}=await R.from("driver_licenses").delete().eq("id",i);if(n)throw n},onSuccess:()=>{l.invalidateQueries({queryKey:["licenses"]}),l.invalidateQueries({queryKey:["driver-licenses"]}),$.success("License deleted successfully")},onError:i=>{console.error("Error deleting license:",i),$.error("Failed to delete license: "+i.message)}})},Je=l=>de({queryKey:["license-stats",l],queryFn:async()=>{if(!l)return null;const{data:i,error:n}=await R.from("driver_licenses").select("status, expiry_date").eq("organization_id",l);if(n)return console.error("Error fetching license stats:",n),null;const d=new Date,h=new Date(d.getTime()+30*24*60*60*1e3);return{total:(i==null?void 0:i.length)||0,active:(i==null?void 0:i.filter(j=>j.status==="active").length)||0,expired:(i==null?void 0:i.filter(j=>j.status==="expired").length)||0,suspended:(i==null?void 0:i.filter(j=>j.status==="suspended").length)||0,revoked:(i==null?void 0:i.filter(j=>j.status==="revoked").length)||0,expiringSoon:(i==null?void 0:i.filter(j=>{const t=new Date(j.expiry_date);return t<=h&&t>d&&j.status==="active"}).length)||0}},enabled:!!l}),We=(l,i=30)=>de({queryKey:["expiring-licenses",l,i],queryFn:async()=>{if(!l)return[];const n=new Date;n.setDate(n.getDate()+i);try{const{data:d,error:h}=await R.from("driver_licenses").select("*").eq("organization_id",l).eq("status","active").lte("expiry_date",n.toISOString().split("T")[0]).gte("expiry_date",new Date().toISOString().split("T")[0]).order("expiry_date",{ascending:!0});if(h)return console.error("Error fetching expiring licenses:",h),[];if(!d||d.length===0)return[];const N=d.map(p=>p.driver_id),{data:j,error:t}=await R.from("profiles").select("id, first_name, last_name, email").in("id",N);if(t)return console.error("Error fetching drivers:",t),d.map(p=>({...p,driver_name:"Unknown Driver",driver_email:""}));const o=new Map;return j==null||j.forEach(p=>{o.set(p.id,p)}),d.map(p=>{const _=o.get(p.driver_id);return{...p,driver_name:_?`${_.first_name} ${_.last_name}`:"Unknown Driver",driver_email:(_==null?void 0:_.email)||""}})}catch(d){return console.error("Error in useExpiringLicenses:",d),[]}},enabled:!!l}),Xe=[{value:"CDL-A",label:"CDL-A (Commercial Driver License - Class A)"},{value:"CDL-B",label:"CDL-B (Commercial Driver License - Class B)"},{value:"CDL-C",label:"CDL-C (Commercial Driver License - Class C)"},{value:"Regular",label:"Regular Driver License"},{value:"Provisional",label:"Provisional Driver License"},{value:"Learner",label:"Learner Driver License"},{value:"International",label:"International Driver License"},{value:"International-Permit",label:"International Driving Permit"},{value:"Motorcycle",label:"Motorcycle License"},{value:"Motorcycle-A",label:"Motorcycle License - Class A"},{value:"Motorcycle-A1",label:"Motorcycle License - Class A1"},{value:"Motorcycle-A2",label:"Motorcycle License - Class A2"},{value:"Heavy-Vehicle",label:"Heavy Vehicle License"},{value:"Heavy-Vehicle-C1",label:"Heavy Vehicle License - Class C1"},{value:"Heavy-Vehicle-C",label:"Heavy Vehicle License - Class C"},{value:"Heavy-Vehicle-C+E",label:"Heavy Vehicle License - Class C+E"},{value:"Bus-D1",label:"Bus License - Class D1"},{value:"Bus-D",label:"Bus License - Class D"},{value:"Bus-D+E",label:"Bus License - Class D+E"},{value:"Coach",label:"Coach License"},{value:"School-Bus",label:"School Bus License"},{value:"Hazmat",label:"Hazardous Materials License"},{value:"Tanker",label:"Tanker Vehicle License"},{value:"Passenger",label:"Passenger Transport License"},{value:"Chauffeur",label:"Chauffeur License"},{value:"Taxi",label:"Taxi License"},{value:"Private-Hire",label:"Private Hire License"},{value:"Agricultural",label:"Agricultural Vehicle License"},{value:"Tractor",label:"Tractor License"},{value:"Forklift",label:"Forklift License"},{value:"Crane",label:"Crane Operator License"},{value:"Military",label:"Military Driver License"},{value:"Emergency",label:"Emergency Vehicle License"},{value:"Police",label:"Police Vehicle License"},{value:"Fire",label:"Fire Service Vehicle License"},{value:"Ambulance",label:"Ambulance Driver License"},{value:"Disabled",label:"Disabled Driver License"},{value:"Student",label:"Student Driver License"},{value:"Temporary",label:"Temporary Driver License"},{value:"Replacement",label:"Replacement Driver License"},{value:"Duplicate",label:"Duplicate Driver License"}],Ze=["Hazmat","Tanker","Passenger","School Bus","Double/Triple","Air Brakes"],es=["Corrective Lenses","Prosthetic Aid","Automatic Transmission","Outside Mirror","Daylight Only"],ss=({open:l,onOpenChange:i})=>{const n=Ge(),{data:d,isLoading:h,error:N}=$e(),j=De();console.log("ðŸ” AddLicenseDialog - Drivers data:",{drivers:d,driversLoading:h,driversError:N,driversCount:(d==null?void 0:d.length)||0});const[t,o]=C.useState({driver_id:"",license_number:"",license_type:"",issuing_authority:"",issue_date:"",expiry_date:"",license_class:"",endorsements:[],restrictions:[],medical_certificate_expiry:"",background_check_expiry:"",drug_test_expiry:"",training_expiry:"",notes:""}),[p,_]=C.useState(""),[x,S]=C.useState(""),B=async s=>{if(s.preventDefault(),!(!t.driver_id||!t.license_number||!t.license_type||!t.issuing_authority||!t.issue_date||!t.expiry_date))try{await n.mutateAsync(t),F(),i(!1)}catch(c){console.error("Error creating license:",c)}},F=()=>{o({driver_id:"",license_number:"",license_type:"",issuing_authority:"",issue_date:"",expiry_date:"",license_class:"",endorsements:[],restrictions:[],medical_certificate_expiry:"",background_check_expiry:"",drug_test_expiry:"",training_expiry:"",notes:""}),_(""),S("")},r=()=>{p.trim()&&!t.endorsements.includes(p.trim())&&(o(s=>({...s,endorsements:[...s.endorsements,p.trim()]})),_(""))},f=s=>{o(c=>({...c,endorsements:c.endorsements.filter(A=>A!==s)}))},b=()=>{x.trim()&&!t.restrictions.includes(x.trim())&&(o(s=>({...s,restrictions:[...s.restrictions,x.trim()]})),S(""))},D=s=>{o(c=>({...c,restrictions:c.restrictions.filter(A=>A!==s)}))};return e.jsx(fe,{open:l,onOpenChange:i,children:e.jsxs(Ne,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(_e,{children:[e.jsx(be,{children:"Add New Driver License"}),e.jsx(we,{children:"Enter all required license information for the driver."})]}),e.jsxs("form",{onSubmit:B,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"driver_id",children:"Driver *"}),e.jsxs(J,{value:t.driver_id,onValueChange:s=>o(c=>({...c,driver_id:s})),children:[e.jsx(W,{children:e.jsx(X,{placeholder:h?"Loading drivers...":"Select driver"})}),e.jsx(Z,{children:h?e.jsx(m,{value:"",disabled:!0,children:"Loading drivers..."}):N?e.jsx(m,{value:"",disabled:!0,children:"Error loading drivers"}):d&&d.length>0?d.map(s=>e.jsxs(m,{value:s.id,children:[s.first_name," ",s.last_name]},s.id)):e.jsx(m,{value:"",disabled:!0,children:"No drivers found in organization"})})]}),N&&e.jsxs("p",{className:"text-sm text-red-500",children:["Error loading drivers: ",N.message]}),!h&&!N&&d&&d.length===0&&e.jsxs("div",{className:"text-sm text-yellow-600 space-y-2",children:[e.jsx("p",{children:"No drivers found in your organization."}),e.jsx("p",{children:"To add a license, you need to:"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1 ml-2",children:[e.jsxs("li",{children:["Go to ",e.jsx("strong",{children:"Driver Management"})," page"]}),e.jsx("li",{children:"Add drivers to your organization"}),e.jsx("li",{children:"Return here to add licenses for those drivers"})]}),e.jsx(M,{type:"button",variant:"outline",size:"sm",onClick:()=>{i(!1),j("/drivers")},className:"mt-2",children:"Go to Driver Management"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"license_number",children:"License Number *"}),e.jsx(L,{id:"license_number",value:t.license_number,onChange:s=>o(c=>({...c,license_number:s.target.value})),placeholder:"Enter license number",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"license_type",children:"License Type *"}),e.jsxs(J,{value:t.license_type,onValueChange:s=>o(c=>({...c,license_type:s})),children:[e.jsx(W,{children:e.jsx(X,{placeholder:"Select license type"})}),e.jsx(Z,{children:Xe.map(s=>e.jsx(m,{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"issuing_authority",children:"Issuing Authority *"}),e.jsx(L,{id:"issuing_authority",value:t.issuing_authority,onChange:s=>o(c=>({...c,issuing_authority:s.target.value})),placeholder:"e.g., DMV, DVLA",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"issue_date",children:"Issue Date *"}),e.jsx(L,{id:"issue_date",type:"date",value:t.issue_date,onChange:s=>o(c=>({...c,issue_date:s.target.value})),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"expiry_date",children:"Expiry Date *"}),e.jsx(L,{id:"expiry_date",type:"date",value:t.expiry_date,onChange:s=>o(c=>({...c,expiry_date:s.target.value})),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"license_class",children:"License Class"}),e.jsx(L,{id:"license_class",value:t.license_class,onChange:s=>o(c=>({...c,license_class:s.target.value})),placeholder:"e.g., Class 1, Class 2"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(g,{children:"Endorsements"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{value:p,onChange:s=>_(s.target.value),placeholder:"Add endorsement",onKeyPress:s=>s.key==="Enter"&&(s.preventDefault(),r())}),e.jsx(M,{type:"button",onClick:r,size:"sm",children:e.jsx(ee,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.endorsements.map(s=>e.jsxs(w,{variant:"secondary",className:"flex items-center gap-1",children:[s,e.jsx(xe,{className:"w-3 h-3 cursor-pointer",onClick:()=>f(s)})]},s))}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Common endorsements: ",Ze.join(", ")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(g,{children:"Restrictions"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{value:x,onChange:s=>S(s.target.value),placeholder:"Add restriction",onKeyPress:s=>s.key==="Enter"&&(s.preventDefault(),b())}),e.jsx(M,{type:"button",onClick:b,size:"sm",children:e.jsx(ee,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.restrictions.map(s=>e.jsxs(w,{variant:"destructive",className:"flex items-center gap-1",children:[s,e.jsx(xe,{className:"w-3 h-3 cursor-pointer",onClick:()=>D(s)})]},s))}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Common restrictions: ",es.join(", ")]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"medical_certificate_expiry",children:"Medical Certificate Expiry"}),e.jsx(L,{id:"medical_certificate_expiry",type:"date",value:t.medical_certificate_expiry,onChange:s=>o(c=>({...c,medical_certificate_expiry:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"background_check_expiry",children:"Background Check Expiry"}),e.jsx(L,{id:"background_check_expiry",type:"date",value:t.background_check_expiry,onChange:s=>o(c=>({...c,background_check_expiry:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"drug_test_expiry",children:"Drug Test Expiry"}),e.jsx(L,{id:"drug_test_expiry",type:"date",value:t.drug_test_expiry,onChange:s=>o(c=>({...c,drug_test_expiry:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"training_expiry",children:"Training Expiry"}),e.jsx(L,{id:"training_expiry",type:"date",value:t.training_expiry,onChange:s=>o(c=>({...c,training_expiry:s.target.value}))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"notes",children:"Notes"}),e.jsx(Le,{id:"notes",value:t.notes,onChange:s=>o(c=>({...c,notes:s.target.value})),placeholder:"Additional notes about the license...",rows:3})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(M,{type:"button",variant:"outline",onClick:()=>i(!1),children:"Cancel"}),e.jsx(M,{type:"submit",disabled:n.isPending,children:n.isPending?"Creating...":"Create License"})]})]})]})})},is=({licenses:l,onRefresh:i})=>{const[n,d]=C.useState([]),[h,N]=C.useState({total:0,compliant:0,nonCompliant:0,criticalIssues:0,warnings:0,complianceRate:0}),[j,t]=C.useState(!1),o=()=>{t(!0);const r=[],f=new Date,b=ye(f,30),D=ye(f,90);l.forEach(y=>{const O=new Date(y.expiry_date),a=K(O,f);if(T(O,f)?r.push({type:"expired",severity:"critical",message:`License expired ${Math.abs(a)} days ago`,license:y,daysUntilExpiry:a}):T(O,b)&&r.push({type:"expiring-soon",severity:"warning",message:`License expires in ${a} days`,license:y,daysUntilExpiry:a}),y.medical_certificate_expiry){const u=new Date(y.medical_certificate_expiry),v=K(u,f);T(u,f)?r.push({type:"missing-medical",severity:"critical",message:`Medical certificate expired ${Math.abs(v)} days ago`,license:y,daysUntilExpiry:v}):T(u,b)&&r.push({type:"missing-medical",severity:"warning",message:`Medical certificate expires in ${v} days`,license:y,daysUntilExpiry:v})}else r.push({type:"missing-medical",severity:"warning",message:"Medical certificate expiry date not set",license:y});if(y.background_check_expiry){const u=new Date(y.background_check_expiry),v=K(u,f);T(u,f)?r.push({type:"missing-background",severity:"critical",message:`Background check expired ${Math.abs(v)} days ago`,license:y,daysUntilExpiry:v}):T(u,D)&&r.push({type:"missing-background",severity:"warning",message:`Background check expires in ${v} days`,license:y,daysUntilExpiry:v})}else r.push({type:"missing-background",severity:"info",message:"Background check expiry date not set",license:y});if(y.drug_test_expiry){const u=new Date(y.drug_test_expiry),v=K(u,f);T(u,f)?r.push({type:"missing-drug-test",severity:"critical",message:`Drug test expired ${Math.abs(v)} days ago`,license:y,daysUntilExpiry:v}):T(u,D)&&r.push({type:"missing-drug-test",severity:"warning",message:`Drug test expires in ${v} days`,license:y,daysUntilExpiry:v})}else r.push({type:"missing-drug-test",severity:"info",message:"Drug test expiry date not set",license:y});if(y.training_expiry){const u=new Date(y.training_expiry),v=K(u,f);T(u,f)?r.push({type:"missing-training",severity:"critical",message:`Training expired ${Math.abs(v)} days ago`,license:y,daysUntilExpiry:v}):T(u,D)&&r.push({type:"missing-training",severity:"warning",message:`Training expires in ${v} days`,license:y,daysUntilExpiry:v})}else r.push({type:"missing-training",severity:"info",message:"Training expiry date not set",license:y})}),d(r);const s=l.length,c=r.filter(y=>y.severity==="critical").length,A=r.filter(y=>y.severity==="warning").length,G=c+A,z=s-G,ie=s>0?Math.round(z/s*100):100;N({total:s,compliant:z,nonCompliant:G,criticalIssues:c,warnings:A,complianceRate:ie}),t(!1)};C.useEffect(()=>{o()},[l]);const p=r=>{switch(r){case"critical":return e.jsx(me,{className:"w-4 h-4 text-red-500"});case"warning":return e.jsx(se,{className:"w-4 h-4 text-yellow-500"});case"info":return e.jsx(Y,{className:"w-4 h-4 text-blue-500"});default:return e.jsx(Y,{className:"w-4 h-4 text-gray-500"})}},_=r=>{switch(r){case"critical":return"border-red-200 bg-red-50";case"warning":return"border-yellow-200 bg-yellow-50";case"info":return"border-blue-200 bg-blue-50";default:return"border-gray-200 bg-gray-50"}},x=r=>{switch(r){case"expired":return"License Expired";case"expiring-soon":return"License Expiring Soon";case"missing-medical":return"Medical Certificate";case"missing-background":return"Background Check";case"missing-drug-test":return"Drug Test";case"missing-training":return"Training";default:return r}},S=n.filter(r=>r.severity==="critical"),B=n.filter(r=>r.severity==="warning"),F=n.filter(r=>r.severity==="info");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(E,{children:[e.jsx(q,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(H,{children:"License Compliance Overview"}),e.jsx(V,{children:"Automated compliance checking for all driver licenses"})]}),e.jsxs(M,{onClick:()=>{o(),i==null||i()},disabled:j,variant:"outline",size:"sm",children:[e.jsx(Ee,{className:`w-4 h-4 mr-2 ${j?"animate-spin":""}`}),"Refresh"]})]})}),e.jsxs(k,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:h.total}),e.jsx("div",{className:"text-sm text-gray-600",children:"Total Licenses"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:h.compliant}),e.jsx("div",{className:"text-sm text-gray-600",children:"Compliant"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:h.criticalIssues}),e.jsx("div",{className:"text-sm text-gray-600",children:"Critical Issues"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:h.warnings}),e.jsx("div",{className:"text-sm text-gray-600",children:"Warnings"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Compliance Rate"}),e.jsxs("span",{children:[h.complianceRate,"%"]})]}),e.jsx(ke,{value:h.complianceRate,className:"h-2"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[h.complianceRate>=90?e.jsx(Te,{className:"w-4 h-4 text-green-500"}):e.jsx(Oe,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:h.complianceRate>=90?"text-green-600":"text-red-600",children:h.complianceRate>=90?"Excellent":"Needs Attention"})]})]})]})]}),S.length>0&&e.jsxs(E,{className:"border-red-200",children:[e.jsxs(q,{children:[e.jsxs(H,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(me,{className:"w-5 h-5"}),"Critical Issues (",S.length,")"]}),e.jsx(V,{children:"These issues require immediate attention"})]}),e.jsx(k,{children:e.jsx("div",{className:"space-y-3",children:S.map((r,f)=>e.jsx(te,{className:_(r.severity),children:e.jsxs("div",{className:"flex items-start gap-3",children:[p(r.severity),e.jsx("div",{className:"flex-1",children:e.jsxs(ne,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("strong",{children:r.license.driver_name})," - ",x(r.type)]}),e.jsx(w,{variant:"destructive",className:"ml-2",children:r.daysUntilExpiry!==void 0?`${Math.abs(r.daysUntilExpiry)} days`:"Unknown"})]}),e.jsx("p",{className:"text-sm mt-1",children:r.message}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["License: ",r.license.license_number," | Type: ",r.license.license_type]})]})})]})},f))})})]}),B.length>0&&e.jsxs(E,{className:"border-yellow-200",children:[e.jsxs(q,{children:[e.jsxs(H,{className:"flex items-center gap-2 text-yellow-700",children:[e.jsx(se,{className:"w-5 h-5"}),"Warnings (",B.length,")"]}),e.jsx(V,{children:"These issues should be addressed soon"})]}),e.jsx(k,{children:e.jsx("div",{className:"space-y-3",children:B.map((r,f)=>e.jsx(te,{className:_(r.severity),children:e.jsxs("div",{className:"flex items-start gap-3",children:[p(r.severity),e.jsx("div",{className:"flex-1",children:e.jsxs(ne,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("strong",{children:r.license.driver_name})," - ",x(r.type)]}),e.jsx(w,{variant:"secondary",className:"ml-2",children:r.daysUntilExpiry!==void 0?`${r.daysUntilExpiry} days`:"Unknown"})]}),e.jsx("p",{className:"text-sm mt-1",children:r.message}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["License: ",r.license.license_number," | Type: ",r.license.license_type]})]})})]})},f))})})]}),F.length>0&&e.jsxs(E,{className:"border-blue-200",children:[e.jsxs(q,{children:[e.jsxs(H,{className:"flex items-center gap-2 text-blue-700",children:[e.jsx(Y,{className:"w-5 h-5"}),"Information (",F.length,")"]}),e.jsx(V,{children:"Missing information that should be completed"})]}),e.jsx(k,{children:e.jsx("div",{className:"space-y-3",children:F.map((r,f)=>e.jsx(te,{className:_(r.severity),children:e.jsxs("div",{className:"flex items-start gap-3",children:[p(r.severity),e.jsx("div",{className:"flex-1",children:e.jsxs(ne,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("strong",{children:r.license.driver_name})," - ",x(r.type)]})}),e.jsx("p",{className:"text-sm mt-1",children:r.message}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["License: ",r.license.license_number," | Type: ",r.license.license_type]})]})})]})},f))})})]}),n.length===0&&e.jsxs(E,{className:"border-green-200",children:[e.jsxs(q,{children:[e.jsxs(H,{className:"flex items-center gap-2 text-green-700",children:[e.jsx(Q,{className:"w-5 h-5"}),"All Clear"]}),e.jsx(V,{children:"All licenses are compliant with current requirements"})]}),e.jsx(k,{children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Q,{className:"w-16 h-16 text-green-500 mx-auto mb-4"}),e.jsx("p",{className:"text-green-700 font-medium",children:"No compliance issues found"}),e.jsx("p",{className:"text-sm text-gray-600 mt-2",children:"All driver licenses are up to date and compliant"})]})})]})]})},ds=()=>{const{user:l,profile:i,loading:n}=ve(),[d,h]=C.useState(""),[N,j]=C.useState("all"),[t,o]=C.useState("all"),[p,_]=C.useState(!1),[x,S]=C.useState(null),[B,F]=C.useState(!1),{data:r,isLoading:f}=Qe(i==null?void 0:i.organization_id),{data:b}=Je(i==null?void 0:i.organization_id),{data:D}=We(i==null?void 0:i.organization_id,30),s=Ye();if(n)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading..."})]})});if(!l||!i)return e.jsx(Me,{to:"/auth",replace:!0});const c=(r==null?void 0:r.filter(a=>{var ae;const u=((ae=a.driver_name)==null?void 0:ae.toLowerCase().includes(d.toLowerCase()))||a.license_number.toLowerCase().includes(d.toLowerCase())||a.issuing_authority.toLowerCase().includes(d.toLowerCase()),v=N==="all"||a.status===N,re=t==="all"||a.license_type===t;return u&&v&&re}))||[],A=a=>{switch(a){case"active":return"bg-green-100 text-green-800";case"expired":return"bg-red-100 text-red-800";case"suspended":return"bg-yellow-100 text-yellow-800";case"revoked":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}},G=a=>{switch(a){case"active":return e.jsx(Q,{className:"w-4 h-4"});case"expired":return e.jsx(se,{className:"w-4 h-4"});case"suspended":return e.jsx(He,{className:"w-4 h-4"});case"revoked":return e.jsx(qe,{className:"w-4 h-4"});default:return e.jsx(Y,{className:"w-4 h-4"})}},z=a=>{const u=new Date(a),v=new Date,re=u.getTime()-v.getTime();return Math.ceil(re/(1e3*60*60*24))},ie=a=>{const u=z(a);return u<0?"expired":u<=30?"expiring-soon":u<=90?"expiring-warning":"valid"},y=async a=>{if(window.confirm("Are you sure you want to delete this license? This action cannot be undone."))try{await s.mutateAsync(a),$.success("License deleted successfully")}catch{$.error("Failed to delete license")}},O=a=>{S(a),F(!0)};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"License Management"}),e.jsx("p",{className:"text-gray-600",children:"Manage driver licenses, renewals, and compliance"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(E,{children:e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Total Licenses"}),e.jsx("p",{className:"text-2xl font-bold",children:(b==null?void 0:b.total)||0})]}),e.jsx(he,{className:"w-8 h-8 text-blue-500"})]})})}),e.jsx(E,{children:e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Active"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:(b==null?void 0:b.active)||0})]}),e.jsx(Q,{className:"w-8 h-8 text-green-500"})]})})}),e.jsx(E,{children:e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Expiring Soon"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:(b==null?void 0:b.expiringSoon)||0})]}),e.jsx(se,{className:"w-8 h-8 text-yellow-500"})]})})}),e.jsx(E,{children:e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Expired"}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:(b==null?void 0:b.expired)||0})]}),e.jsx(Se,{className:"w-8 h-8 text-red-500"})]})})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 justify-between items-start md:items-center",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 flex-1",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(Ae,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(L,{placeholder:"Search licenses...",value:d,onChange:a=>h(a.target.value),className:"pl-10"})]}),e.jsxs(J,{value:N,onValueChange:j,children:[e.jsx(W,{className:"w-full md:w-40",children:e.jsx(X,{placeholder:"Status"})}),e.jsxs(Z,{children:[e.jsx(m,{value:"all",children:"All Status"}),e.jsx(m,{value:"active",children:"Active"}),e.jsx(m,{value:"expired",children:"Expired"}),e.jsx(m,{value:"suspended",children:"Suspended"}),e.jsx(m,{value:"revoked",children:"Revoked"})]})]}),e.jsxs(J,{value:t,onValueChange:o,children:[e.jsx(W,{className:"w-full md:w-40",children:e.jsx(X,{placeholder:"Type"})}),e.jsxs(Z,{children:[e.jsx(m,{value:"all",children:"All Types"}),e.jsx(m,{value:"CDL-A",children:"CDL-A"}),e.jsx(m,{value:"CDL-B",children:"CDL-B"}),e.jsx(m,{value:"CDL-C",children:"CDL-C"}),e.jsx(m,{value:"Regular",children:"Regular"}),e.jsx(m,{value:"Provisional",children:"Provisional"}),e.jsx(m,{value:"Learner",children:"Learner"}),e.jsx(m,{value:"International",children:"International"}),e.jsx(m,{value:"International-Permit",children:"International Permit"}),e.jsx(m,{value:"Motorcycle",children:"Motorcycle"}),e.jsx(m,{value:"Heavy-Vehicle",children:"Heavy Vehicle"}),e.jsx(m,{value:"Bus-D",children:"Bus"}),e.jsx(m,{value:"Coach",children:"Coach"}),e.jsx(m,{value:"School-Bus",children:"School Bus"}),e.jsx(m,{value:"Hazmat",children:"Hazmat"}),e.jsx(m,{value:"Tanker",children:"Tanker"}),e.jsx(m,{value:"Passenger",children:"Passenger"}),e.jsx(m,{value:"Taxi",children:"Taxi"}),e.jsx(m,{value:"Private-Hire",children:"Private Hire"}),e.jsx(m,{value:"Agricultural",children:"Agricultural"}),e.jsx(m,{value:"Military",children:"Military"}),e.jsx(m,{value:"Emergency",children:"Emergency"}),e.jsx(m,{value:"Police",children:"Police"}),e.jsx(m,{value:"Fire",children:"Fire"}),e.jsx(m,{value:"Ambulance",children:"Ambulance"})]})]})]}),e.jsxs(M,{onClick:()=>_(!0),children:[e.jsx(ee,{className:"w-4 h-4 mr-2"}),"Add License"]})]}),e.jsxs(Fe,{defaultValue:"all",className:"space-y-6",children:[e.jsxs(Ie,{children:[e.jsxs(le,{value:"all",children:["All Licenses (",c.length,")"]}),e.jsxs(le,{value:"expiring",children:["Expiring Soon (",(D==null?void 0:D.length)||0,")"]}),e.jsx(le,{value:"compliance",children:"Compliance Check"})]}),e.jsx(ce,{value:"all",children:e.jsxs(E,{children:[e.jsxs(q,{children:[e.jsx(H,{children:"Driver Licenses"}),e.jsx(V,{children:"Manage all driver licenses in your organization"})]}),e.jsx(k,{children:f?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{children:"Loading licenses..."})]}):c.length>0?e.jsxs(Ve,{children:[e.jsx(Re,{children:e.jsxs(ue,{children:[e.jsx(P,{children:"Driver"}),e.jsx(P,{children:"License Number"}),e.jsx(P,{children:"Type"}),e.jsx(P,{children:"Status"}),e.jsx(P,{children:"Expiry Date"}),e.jsx(P,{children:"Days Left"}),e.jsx(P,{children:"Actions"})]})}),e.jsx(ze,{children:c.map(a=>{const u=z(a.expiry_date),v=ie(a.expiry_date);return e.jsxs(ue,{children:[e.jsx(U,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.driver_name}),e.jsx("div",{className:"text-sm text-gray-500",children:a.driver_email})]})}),e.jsx(U,{className:"font-mono",children:a.license_number}),e.jsx(U,{children:e.jsx(w,{variant:"outline",children:a.license_type})}),e.jsx(U,{children:e.jsx(w,{className:A(a.status),children:e.jsxs("div",{className:"flex items-center gap-1",children:[G(a.status),a.status]})})}),e.jsx(U,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Be,{className:"w-4 h-4 text-gray-400"}),I(new Date(a.expiry_date),"MMM dd, yyyy")]})}),e.jsx(U,{children:u>=0?e.jsxs(w,{variant:v==="expiring-soon"?"destructive":v==="expiring-warning"?"secondary":"default",children:[u," days"]}):e.jsxs(w,{variant:"destructive",children:["Expired ",Math.abs(u)," days ago"]})}),e.jsx(U,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>O(a),children:e.jsx(Pe,{className:"w-4 h-4"})}),e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>y(a.id),disabled:s.isPending,children:e.jsx(Ke,{className:"w-4 h-4"})})]})})]},a.id)})})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(he,{className:"w-12 h-12 mx-auto text-gray-400 mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No licenses found"}),e.jsxs(M,{onClick:()=>_(!0),className:"mt-4",children:[e.jsx(ee,{className:"w-4 h-4 mr-2"}),"Add First License"]})]})})]})}),e.jsx(ce,{value:"expiring",children:e.jsxs(E,{children:[e.jsxs(q,{children:[e.jsx(H,{children:"Licenses Expiring Soon"}),e.jsx(V,{children:"Licenses that will expire within the next 30 days"})]}),e.jsx(k,{children:D&&D.length>0?e.jsx("div",{className:"space-y-4",children:D.map(a=>{const u=z(a.expiry_date);return e.jsx("div",{className:"border rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:a.driver_name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a.license_type," - ",a.license_number]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Issued by: ",a.issuing_authority]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs(w,{variant:"destructive",className:"mb-2",children:[e.jsx(Ue,{className:"w-4 h-4 mr-1"}),u," days left"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Expires: ",I(new Date(a.expiry_date),"MMM dd, yyyy")]})]})]})},a.id)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Q,{className:"w-12 h-12 mx-auto text-green-400 mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No licenses expiring soon"})]})})]})}),e.jsx(ce,{value:"compliance",children:e.jsx(is,{licenses:r||[],onRefresh:()=>{}})})]}),e.jsx(ss,{open:p,onOpenChange:_}),e.jsx(fe,{open:B,onOpenChange:F,children:e.jsxs(Ne,{className:"max-w-2xl",children:[e.jsxs(_e,{children:[e.jsx(be,{children:"License Details"}),e.jsx(we,{children:"Complete information about the selected license"})]}),x&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Driver"}),e.jsx("p",{className:"font-medium",children:x.driver_name})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"License Number"}),e.jsx("p",{className:"font-mono",children:x.license_number})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Type"}),e.jsx(w,{variant:"outline",children:x.license_type})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Status"}),e.jsx(w,{className:A(x.status),children:x.status})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Issuing Authority"}),e.jsx("p",{children:x.issuing_authority})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"License Class"}),e.jsx("p",{children:x.license_class||"N/A"})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Issue Date"}),e.jsx("p",{children:I(new Date(x.issue_date),"MMM dd, yyyy")})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Expiry Date"}),e.jsx("p",{children:I(new Date(x.expiry_date),"MMM dd, yyyy")})]})]}),x.endorsements&&x.endorsements.length>0&&e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Endorsements"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:x.endorsements.map(a=>e.jsx(w,{variant:"secondary",children:a},a))})]}),x.restrictions&&x.restrictions.length>0&&e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Restrictions"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:x.restrictions.map(a=>e.jsx(w,{variant:"destructive",children:a},a))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[x.medical_certificate_expiry&&e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Medical Certificate Expiry"}),e.jsx("p",{children:I(new Date(x.medical_certificate_expiry),"MMM dd, yyyy")})]}),x.background_check_expiry&&e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Background Check Expiry"}),e.jsx("p",{children:I(new Date(x.background_check_expiry),"MMM dd, yyyy")})]}),x.drug_test_expiry&&e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Drug Test Expiry"}),e.jsx("p",{children:I(new Date(x.drug_test_expiry),"MMM dd, yyyy")})]}),x.training_expiry&&e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Training Expiry"}),e.jsx("p",{children:I(new Date(x.training_expiry),"MMM dd, yyyy")})]})]}),x.notes&&e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-500",children:"Notes"}),e.jsx("p",{className:"mt-2 text-sm",children:x.notes})]})]})]})})]})};export{ds as default};
