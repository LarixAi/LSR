import{c as Ve,m as Ce,a1 as Se,G as De,r as p,H as W,J as f,j as e,e as q,g as R,h as V,k as L,q as m,ab as U,ac as I,ad as M,ae as O,af as o,B as g,A as Ue,C as me,z as Ie,w as Ne,aq as ke,n as $,D as Me,aa as Oe,F as je,a4 as le,a5 as de,a6 as ce,a7 as oe,a8 as $e,E as Be,l as Ke,T as We,U as He,a2 as ge,a9 as ve,S as Le,b as Pe,au as pe,I as z,ak as Ee,an as ze,s as ue,N as Ae,O as Qe,Q as Ge,V as we,Y as be,ap as Ze}from"./main-DVuL102c.js";import{T as _e,a as ye,b as H,c as u,d as fe,e as x}from"./table-Jjtal2IW.js";import{W as Je,a as Fe}from"./wifi-CoafhbsB.js";import{S as Ye}from"./square-BmtWbktP.js";import{D as Te}from"./database-BkhDcnAk.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=Ve("Bluetooth",[["path",{d:"m7 7 10 10-5 5V2l5 5L7 17",key:"1q5490"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=Ve("Usb",[["circle",{cx:"10",cy:"7",r:"1",key:"dypaad"}],["circle",{cx:"4",cy:"20",r:"1",key:"22iqad"}],["path",{d:"M4.7 19.3 19 5",key:"1enqfc"}],["path",{d:"m21 3-3 1 2 2Z",key:"d3ov82"}],["path",{d:"M9.26 7.68 5 12l2 5",key:"1esawj"}],["path",{d:"m10 14 5 2 3.5-3.5",key:"v8oal5"}],["path",{d:"m18 12 1-1 1 1-1 1Z",key:"1bh22v"}]]),es=({onDataDownloaded:r})=>{const{profile:t}=Ce(),{toast:C}=Se(),D=De(),[P,k]=p.useState(!1),[ae,B]=p.useState(!1),[K,n]=p.useState(0),[Q,J]=p.useState(null),[v,te]=p.useState(null),[F,d]=p.useState("");p.useState(!1);const[xe,ie]=p.useState(!1),[Y,w]=p.useState(!1),[G,X]=p.useState("disconnected"),{data:T=[],isLoading:he}=W({queryKey:["card-readers",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:i,error:j}=await f.from("tachograph_card_readers").select("*").eq("organization_id",t.organization_id).eq("status","active");return j?(console.error("Error fetching card readers:",j),[]):i||[]},enabled:!!(t!=null&&t.organization_id)}),{data:A=[]}=W({queryKey:["download-sessions",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:i,error:j}=await f.from("tachograph_download_sessions").select("*").eq("organization_id",t.organization_id).order("download_start_time",{ascending:!1}).limit(10);return j?(console.error("Error fetching download sessions:",j),[]):i||[]},enabled:!!(t!=null&&t.organization_id)}),{data:ee=[]}=W({queryKey:["vehicles",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:i,error:j}=await f.from("vehicles").select("id, vehicle_number, license_plate").eq("organization_id",t.organization_id);return j?[]:i||[]},enabled:!!(t!=null&&t.organization_id)}),{data:Z=[]}=W({queryKey:["drivers",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:i,error:j}=await f.from("profiles").select("id, first_name, last_name").eq("organization_id",t.organization_id).eq("role","driver");return j?[]:i||[]},enabled:!!(t!=null&&t.organization_id)}),a=async()=>{if(!F){C({title:"No Reader Selected",description:"Please select a card reader first",variant:"destructive"});return}try{X("connecting"),k(!1),n(0),te(null),J(null),w(!1),await new Promise(i=>setTimeout(i,2e3)),k(!0),X("connected"),C({title:"Connected",description:"Card reader is connected. Please insert a tachograph card manually."})}catch(i){console.error("Failed to connect to card reader:",i),X("error"),C({title:"Connection Failed",description:"Failed to connect to card reader. Please check the connection and try again.",variant:"destructive"})}},l=()=>{k(!1),X("disconnected"),te(null),J(null),w(!1),n(0),C({title:"Disconnected",description:"Disconnected from card reader"})},_=async()=>{if(!P){C({title:"Not Connected",description:"Please connect to a card reader first",variant:"destructive"});return}try{C({title:"Manual Detection Required",description:"Please insert a tachograph card and use the card reader's detection button or software.",variant:"destructive"})}catch(i){console.error("Failed to detect card:",i),C({title:"Card Detection Failed",description:"Failed to detect card. Please check the card and try again.",variant:"destructive"})}},s=()=>{te(null),J(null),w(!1),C({title:"Card Ejected",description:"Card has been ejected from reader"})},c=async()=>{var i,j;if(!P||!Q||!F||!v){C({title:"Cannot Download",description:"Please ensure a card is detected and reader is connected",variant:"destructive"});return}B(!0),n(0);try{const{data:E,error:b}=await f.from("tachograph_download_sessions").insert({organization_id:t==null?void 0:t.organization_id,card_reader_id:F,card_type:Q,card_number:v.card_number,download_status:"in_progress",download_method:"card_reader"}).select().single();if(b)throw b;const h=[{progress:10,message:"Initializing download..."},{progress:25,message:"Reading card data..."},{progress:50,message:"Processing records..."},{progress:75,message:"Validating data..."},{progress:90,message:"Saving to database..."},{progress:100,message:"Download complete!"}];for(const S of h)await new Promise(ne=>setTimeout(ne,800)),n(S.progress);const re={id:`record_${Date.now()}`,driver_id:((i=Z[0])==null?void 0:i.id)||"",vehicle_id:((j=ee[0])==null?void 0:j.id)||"",record_date:new Date().toISOString().split("T")[0],start_time:new Date().toISOString(),end_time:new Date(Date.now()+36e5).toISOString(),activity_type:"driving",distance_km:0,start_location:"Manual Entry Required",end_location:"Manual Entry Required",speed_data:{max_speed:0},violations:[]},{error:se}=await f.from("tachograph_records").insert({...re,organization_id:t==null?void 0:t.organization_id,card_type:Q,card_number:v.card_number,download_method:"card_reader"});if(se)throw se;await f.from("tachograph_download_sessions").update({download_status:"completed",download_end_time:new Date().toISOString(),records_downloaded:1}).eq("id",E.id),B(!1),n(0),C({title:"Download Complete",description:"Download process completed. Note: This is a placeholder - real card data requires actual card reader integration."}),r&&r({cardType:Q,recordsCount:1}),D.invalidateQueries({queryKey:["tachograph-records"]}),D.invalidateQueries({queryKey:["download-sessions"]})}catch(E){console.error("Download failed:",E),B(!1),n(0),C({title:"Download Failed",description:"Failed to download card data. Please try again.",variant:"destructive"})}},N=()=>{switch(G){case"connected":return e.jsx(me,{className:"w-5 h-5 text-green-500"});case"connecting":return e.jsx(ke,{className:"w-5 h-5 text-yellow-500 animate-spin"});case"error":return e.jsx(Be,{className:"w-5 h-5 text-red-500"});default:return e.jsx(Fe,{className:"w-5 h-5 text-gray-400"})}},y=i=>{switch(i){case"driver":return e.jsx(He,{className:"w-4 h-4"});case"vehicle":return e.jsx(We,{className:"w-4 h-4"});case"workshop":return e.jsx(Ke,{className:"w-4 h-4"});default:return e.jsx(Ne,{className:"w-4 h-4"})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(q,{children:[e.jsx(R,{children:e.jsxs(V,{className:"flex items-center gap-2",children:[N(),"Card Reader Status"]})}),e.jsxs(L,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{children:"Card Reader"}),e.jsxs(U,{value:F,onValueChange:d,children:[e.jsx(I,{children:e.jsx(M,{placeholder:"Select card reader"})}),e.jsx(O,{children:he?e.jsx(o,{value:"loading",disabled:!0,children:"Loading readers..."}):T.length===0?e.jsx(o,{value:"no-readers",disabled:!0,children:"No card readers available"}):T.map(i=>e.jsx(o,{value:i.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[i.device_type==="usb_reader"&&e.jsx(qe,{className:"w-4 h-4"}),i.device_type==="bluetooth_reader"&&e.jsx(Xe,{className:"w-4 h-4"}),(i.device_type==="digivu_plus"||i.device_type==="generation_2")&&e.jsx(Je,{className:"w-4 h-4"}),i.device_name]})},i.id))})]})]}),e.jsx("div",{className:"flex items-end gap-2",children:P?e.jsxs(g,{variant:"outline",onClick:l,children:[e.jsx(Fe,{className:"w-4 h-4 mr-2"}),"Disconnect"]}):e.jsxs(g,{onClick:a,disabled:!F||G==="connecting",children:[e.jsx(qe,{className:"w-4 h-4 mr-2"}),"Connect"]})})]}),P&&e.jsxs(Ue,{children:[e.jsx(me,{className:"h-4 w-4"}),e.jsx(Ie,{children:"Card reader is connected. Please insert a tachograph card and use the card reader's software to detect it."})]})]})]}),P&&e.jsxs(q,{children:[e.jsx(R,{children:e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-5 h-5"}),"Card Detection"]})}),e.jsx(L,{children:Y?v&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{children:"Card Type"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[y(v.card_type),e.jsx("span",{className:"capitalize",children:v.card_type}),e.jsx($,{variant:v.card_status==="valid"?"default":"destructive",children:v.card_status})]})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Card Number"}),e.jsx("p",{className:"font-mono text-sm mt-1",children:v.card_number})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Card Holder"}),e.jsx("p",{className:"mt-1",children:v.holder_name})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Issuing Authority"}),e.jsx("p",{className:"mt-1",children:v.issuing_authority})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Expiry Date"}),e.jsx("p",{className:"mt-1",children:new Date(v.expiry_date).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Records Available"}),e.jsxs("p",{className:"mt-1",children:[v.records_count," records"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(g,{onClick:c,disabled:ae,children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Download Data"]}),e.jsxs(g,{variant:"outline",onClick:s,children:[e.jsx(Ye,{className:"w-4 h-4 mr-2"}),"Eject Card"]})]}),ae&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Downloading..."}),e.jsxs("span",{children:[K,"%"]})]}),e.jsx(Oe,{value:K})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ne,{className:"w-16 h-16 mx-auto text-gray-400 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"No card detected"}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Insert a tachograph card and use your card reader's software to detect it."}),e.jsxs(g,{onClick:_,variant:"outline",className:"mt-4",disabled:!P,children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"Manual Detection"]})]})})]}),e.jsxs(q,{children:[e.jsx(R,{children:e.jsxs(V,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{className:"w-5 h-5"}),"Recent Downloads"]}),e.jsx(g,{variant:"outline",size:"sm",onClick:()=>ie(!0),children:"View All"})]})}),e.jsx(L,{children:e.jsxs(_e,{children:[e.jsx(ye,{children:e.jsxs(H,{children:[e.jsx(u,{children:"Date"}),e.jsx(u,{children:"Card Type"}),e.jsx(u,{children:"Card Number"}),e.jsx(u,{children:"Status"}),e.jsx(u,{children:"Records"})]})}),e.jsx(fe,{children:A.slice(0,5).map(i=>e.jsxs(H,{children:[e.jsx(x,{children:new Date(i.download_start_time).toLocaleDateString()}),e.jsx(x,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[y(i.card_type),e.jsx("span",{className:"capitalize",children:i.card_type})]})}),e.jsx(x,{className:"font-mono text-sm",children:i.card_number}),e.jsx(x,{children:e.jsx($,{variant:i.download_status==="completed"?"default":i.download_status==="failed"?"destructive":"secondary",children:i.download_status})}),e.jsx(x,{children:i.records_downloaded||0})]},i.id))})]})})]}),e.jsx(le,{open:xe,onOpenChange:ie,children:e.jsxs(de,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(ce,{children:[e.jsx(oe,{children:"Download History"}),e.jsx($e,{children:"View all tachograph card download sessions"})]}),e.jsxs(_e,{children:[e.jsx(ye,{children:e.jsxs(H,{children:[e.jsx(u,{children:"Date & Time"}),e.jsx(u,{children:"Card Type"}),e.jsx(u,{children:"Card Number"}),e.jsx(u,{children:"Status"}),e.jsx(u,{children:"Records"}),e.jsx(u,{children:"Method"})]})}),e.jsx(fe,{children:A.map(i=>e.jsxs(H,{children:[e.jsx(x,{children:new Date(i.download_start_time).toLocaleString()}),e.jsx(x,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[y(i.card_type),e.jsx("span",{className:"capitalize",children:i.card_type})]})}),e.jsx(x,{className:"font-mono text-sm",children:i.card_number}),e.jsx(x,{children:e.jsx($,{variant:i.download_status==="completed"?"default":i.download_status==="failed"?"destructive":"secondary",children:i.download_status})}),e.jsx(x,{children:i.records_downloaded||0}),e.jsx(x,{className:"capitalize",children:i.download_method})]},i.id))})]})]})})]})};var Re={};const ss=()=>{const{profile:r}=Ce(),{toast:t}=Se(),C=De(),[D,P]=p.useState(""),[k,ae]=p.useState("all");p.useState("all");const[B,K]=p.useState(!1),[n,Q]=p.useState(null),[J,v]=p.useState(!1),[te,F]=p.useState(!1),{data:d=[],isLoading:xe}=W({queryKey:["analog-charts",r==null?void 0:r.organization_id],queryFn:async()=>{if(!(r!=null&&r.organization_id))return[];const{data:a,error:l}=await f.from("analog_tachograph_charts").select(`
          *,
          profiles!analog_tachograph_charts_driver_id_fkey(
            first_name,
            last_name
          ),
          vehicles!analog_tachograph_charts_vehicle_id_fkey(
            vehicle_number,
            license_plate
          )
        `).eq("organization_id",r.organization_id).order("chart_date",{ascending:!1});return l?(console.error("Error fetching analog charts:",l),t({title:"Error",description:"Failed to load analog charts",variant:"destructive"}),[]):(a==null?void 0:a.map(_=>{var s,c;return{..._,driver_name:_.profiles?`${_.profiles.first_name||""} ${_.profiles.last_name||""}`.trim():"Unknown Driver",vehicle_number:((s=_.vehicles)==null?void 0:s.vehicle_number)||"Unknown Vehicle",vehicle_license_plate:((c=_.vehicles)==null?void 0:c.license_plate)||"No Plate"}}))||[]},enabled:!!(r!=null&&r.organization_id)}),{data:ie=[]}=W({queryKey:["vehicles",r==null?void 0:r.organization_id],queryFn:async()=>{if(!(r!=null&&r.organization_id))return[];const{data:a,error:l}=await f.from("vehicles").select("id, vehicle_number, license_plate").eq("organization_id",r.organization_id);return l?[]:a||[]},enabled:!!(r!=null&&r.organization_id)}),{data:Y=[]}=W({queryKey:["drivers",r==null?void 0:r.organization_id],queryFn:async()=>{if(!(r!=null&&r.organization_id))return[];const{data:a,error:l}=await f.from("profiles").select("id, first_name, last_name").eq("organization_id",r.organization_id).eq("role","driver");return l?[]:a||[]},enabled:!!(r!=null&&r.organization_id)}),w=ge({mutationFn:async a=>{const l=a.get("chart_file"),_=a.get("chart_number"),s=a.get("chart_date"),{data:c,error:N}=await f.storage.from("analog-charts").upload(`${r==null?void 0:r.organization_id}/${s}_${_}_${Date.now()}.jpg`,l);if(N)throw N;const y={organization_id:r==null?void 0:r.organization_id,driver_id:a.get("driver_id")||null,vehicle_id:a.get("vehicle_id")||null,chart_number:_,chart_date:s,start_time:a.get("start_time")||null,end_time:a.get("end_time")||null,total_distance_km:parseFloat(a.get("total_distance_km"))||null,chart_type:a.get("chart_type"),chart_format:a.get("chart_format"),chart_size:a.get("chart_size"),chart_image_url:c.path,chart_condition:a.get("chart_condition"),uploaded_by:r==null?void 0:r.id,driving_periods:[],rest_periods:[],violations:[],manual_analysis_completed:!1},{error:i}=await f.from("analog_tachograph_charts").insert(y);if(i)throw i},onSuccess:()=>{C.invalidateQueries({queryKey:["analog-charts"]}),K(!1),t({title:"Success",description:"Analog chart uploaded successfully"})},onError:a=>{console.error("Upload error:",a),t({title:"Error",description:"Failed to upload analog chart",variant:"destructive"})}}),G=ge({mutationFn:async({chartId:a,analysisData:l})=>{const{error:_}=await f.from("analog_tachograph_charts").update({driving_periods:l.driving_periods,rest_periods:l.rest_periods,work_periods:l.work_periods,availability_periods:l.availability_periods,break_periods:l.break_periods,violations:l.violations,manual_analysis_completed:!0,analysis_notes:l.notes,analyzed_by:r==null?void 0:r.id,analyzed_at:new Date().toISOString()}).eq("id",a);if(_)throw _},onSuccess:()=>{C.invalidateQueries({queryKey:["analog-charts"]}),F(!1),t({title:"Success",description:"Chart analysis completed"})},onError:a=>{console.error("Analysis error:",a),t({title:"Error",description:"Failed to save analysis",variant:"destructive"})}}),T=(()=>{if(d.length===0)return{totalCharts:0,analyzedCharts:0,pendingAnalysis:0,chartsWithViolations:0,averageDistance:0,complianceRate:100};const a=d.length,l=d.filter(i=>i.manual_analysis_completed).length,_=a-l,s=d.filter(i=>i.violations&&Array.isArray(i.violations)&&i.violations.length>0).length,N=d.reduce((i,j)=>i+(j.total_distance_km||0),0)/a,y=a>0?(a-s)/a*100:100;return{totalCharts:a,analyzedCharts:l,pendingAnalysis:_,chartsWithViolations:s,averageDistance:Math.round(N*100)/100,complianceRate:Math.round(y*100)/100}})(),he=d.filter(a=>{var s,c,N;const l=D===""||((s=a.driver_name)==null?void 0:s.toLowerCase().includes(D.toLowerCase()))||((c=a.vehicle_number)==null?void 0:c.toLowerCase().includes(D.toLowerCase()))||((N=a.chart_number)==null?void 0:N.toLowerCase().includes(D.toLowerCase())),_=k==="all"||k==="analyzed"&&a.manual_analysis_completed||k==="pending"&&!a.manual_analysis_completed||k==="violations"&&a.violations&&Array.isArray(a.violations)&&a.violations.length>0;return l&&_}),A=a=>a.manual_analysis_completed?e.jsx($,{variant:"default",className:"bg-green-100 text-green-800",children:"Analyzed"}):a.violations&&Array.isArray(a.violations)&&a.violations.length>0?e.jsx($,{variant:"destructive",children:"Violations"}):e.jsx($,{variant:"secondary",children:"Pending Analysis"}),ee=a=>{const l={"24_hour":"bg-blue-100 text-blue-800","7_day":"bg-purple-100 text-purple-800",custom:"bg-orange-100 text-orange-800"};return e.jsx($,{className:l[a]||"bg-gray-100 text-gray-800",children:a.replace("_"," ").toUpperCase()})},Z=a=>{const l={excellent:"bg-green-100 text-green-800",good:"bg-blue-100 text-blue-800",fair:"bg-yellow-100 text-yellow-800",poor:"bg-orange-100 text-orange-800",damaged:"bg-red-100 text-red-800"};return e.jsx($,{className:l[a]||"bg-gray-100 text-gray-800",children:a.charAt(0).toUpperCase()+a.slice(1)})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Analog Charts"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage analog tachograph charts and manual analysis"})]}),e.jsxs(g,{onClick:()=>K(!0),className:"inline-flex items-center",children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Upload Chart"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(q,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(V,{className:"text-sm font-medium",children:"Total Charts"}),e.jsx(je,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsx("div",{className:"text-2xl font-bold",children:T.totalCharts}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"All time analog charts"})]})]}),e.jsxs(q,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(V,{className:"text-sm font-medium",children:"Analyzed Charts"}),e.jsx(me,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsx("div",{className:"text-2xl font-bold",children:T.analyzedCharts}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[T.totalCharts>0?Math.round(T.analyzedCharts/T.totalCharts*100):0,"% of total"]})]})]}),e.jsxs(q,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(V,{className:"text-sm font-medium",children:"Compliance Rate"}),e.jsx(Le,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[T.complianceRate,"%"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[T.chartsWithViolations," violations detected"]})]})]}),e.jsxs(q,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(V,{className:"text-sm font-medium",children:"Avg Distance"}),e.jsx(Pe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[T.averageDistance," km"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Per chart"})]})]})]}),e.jsxs(q,{children:[e.jsx(R,{children:e.jsx(V,{children:"Analog Charts"})}),e.jsxs(L,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(pe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(z,{placeholder:"Search by driver, vehicle, or chart number...",value:D,onChange:a=>P(a.target.value),className:"pl-10"})]})}),e.jsxs(U,{value:k,onValueChange:ae,children:[e.jsx(I,{className:"w-full sm:w-[180px]",children:e.jsx(M,{placeholder:"Filter by status"})}),e.jsxs(O,{children:[e.jsx(o,{value:"all",children:"All Status"}),e.jsx(o,{value:"analyzed",children:"Analyzed"}),e.jsx(o,{value:"pending",children:"Pending Analysis"}),e.jsx(o,{value:"violations",children:"With Violations"})]})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(_e,{children:[e.jsx(ye,{children:e.jsxs(H,{children:[e.jsx(u,{children:"Date"}),e.jsx(u,{children:"Chart Number"}),e.jsx(u,{children:"Driver"}),e.jsx(u,{children:"Vehicle"}),e.jsx(u,{children:"Type"}),e.jsx(u,{children:"Distance"}),e.jsx(u,{children:"Condition"}),e.jsx(u,{children:"Status"}),e.jsx(u,{children:"Actions"})]})}),e.jsx(fe,{children:he.length===0?e.jsx(H,{children:e.jsx(x,{colSpan:9,className:"text-center py-8",children:e.jsx("div",{className:"text-muted-foreground",children:d.length===0?e.jsxs("div",{children:[e.jsx(je,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No analog charts found"}),e.jsx("p",{className:"text-sm",children:"Upload your first analog chart to get started"}),e.jsxs(g,{onClick:()=>K(!0),className:"mt-4",variant:"outline",children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Upload First Chart"]})]}):e.jsxs("div",{children:[e.jsx(pe,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No charts match your filters"}),e.jsx("p",{className:"text-sm",children:"Try adjusting your search criteria"})]})})})}):he.map(a=>e.jsxs(H,{children:[e.jsx(x,{children:e.jsx("div",{className:"font-medium",children:new Date(a.chart_date).toLocaleDateString()})}),e.jsx(x,{children:e.jsx("div",{className:"font-medium",children:a.chart_number})}),e.jsx(x,{children:e.jsx("div",{className:"font-medium",children:a.driver_name})}),e.jsx(x,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.vehicle_number}),e.jsx("div",{className:"text-sm text-muted-foreground",children:a.vehicle_license_plate})]})}),e.jsx(x,{children:ee(a.chart_type)}),e.jsx(x,{children:a.total_distance_km?`${a.total_distance_km} km`:"-"}),e.jsx(x,{children:Z(a.chart_condition)}),e.jsx(x,{children:A(a)}),e.jsx(x,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>{Q(a),v(!0)},children:e.jsx(Ee,{className:"h-4 w-4"})}),!a.manual_analysis_completed&&e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>{Q(a),F(!0)},children:e.jsx(ze,{className:"h-4 w-4"})})]})})]},a.id))})]})})]})]}),e.jsx(le,{open:B,onOpenChange:K,children:e.jsxs(de,{className:"max-w-2xl",children:[e.jsx(ce,{children:e.jsx(oe,{children:"Upload Analog Chart"})}),e.jsxs("form",{onSubmit:a=>{a.preventDefault();const l=new FormData(a.currentTarget);w.mutate(l)},children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"chart_number",children:"Chart Number"}),e.jsx(z,{name:"chart_number",required:!0,placeholder:"e.g., CHART-2024-001"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"chart_date",children:"Chart Date"}),e.jsx(z,{type:"date",name:"chart_date",required:!0})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"driver_id",children:"Driver"}),e.jsxs(U,{name:"driver_id",required:!0,children:[e.jsx(I,{children:e.jsx(M,{placeholder:"Select driver"})}),e.jsx(O,{children:Y.map(a=>e.jsxs(o,{value:a.id,children:[a.first_name," ",a.last_name]},a.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"vehicle_id",children:"Vehicle"}),e.jsxs(U,{name:"vehicle_id",required:!0,children:[e.jsx(I,{children:e.jsx(M,{placeholder:"Select vehicle"})}),e.jsx(O,{children:ie.map(a=>e.jsxs(o,{value:a.id,children:[a.vehicle_number," (",a.license_plate,")"]},a.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"chart_type",children:"Chart Type"}),e.jsxs(U,{name:"chart_type",required:!0,children:[e.jsx(I,{children:e.jsx(M,{placeholder:"Select chart type"})}),e.jsxs(O,{children:[e.jsx(o,{value:"24_hour",children:"24 Hour"}),e.jsx(o,{value:"7_day",children:"7 Day"}),e.jsx(o,{value:"custom",children:"Custom"})]})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"chart_format",children:"Chart Format"}),e.jsxs(U,{name:"chart_format",required:!0,children:[e.jsx(I,{children:e.jsx(M,{placeholder:"Select format"})}),e.jsxs(O,{children:[e.jsx(o,{value:"circular",children:"Circular"}),e.jsx(o,{value:"strip",children:"Strip"})]})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"start_time",children:"Start Time"}),e.jsx(z,{type:"time",name:"start_time"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"end_time",children:"End Time"}),e.jsx(z,{type:"time",name:"end_time"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"total_distance_km",children:"Total Distance (km)"}),e.jsx(z,{type:"number",name:"total_distance_km",step:"0.1"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"chart_condition",children:"Chart Condition"}),e.jsxs(U,{name:"chart_condition",required:!0,children:[e.jsx(I,{children:e.jsx(M,{placeholder:"Select condition"})}),e.jsxs(O,{children:[e.jsx(o,{value:"excellent",children:"Excellent"}),e.jsx(o,{value:"good",children:"Good"}),e.jsx(o,{value:"fair",children:"Fair"}),e.jsx(o,{value:"poor",children:"Poor"}),e.jsx(o,{value:"damaged",children:"Damaged"})]})]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(m,{htmlFor:"chart_file",children:"Chart Image"}),e.jsx(z,{type:"file",name:"chart_file",accept:"image/*,.pdf",required:!0,className:"mt-1"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Upload a clear image or PDF of the analog chart"})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-6",children:[e.jsx(g,{type:"button",variant:"outline",onClick:()=>K(!1),children:"Cancel"}),e.jsx(g,{type:"submit",disabled:w.isPending,children:w.isPending?"Uploading...":"Upload Chart"})]})]})]})}),e.jsx(le,{open:J,onOpenChange:v,children:e.jsxs(de,{className:"max-w-4xl",children:[e.jsx(ce,{children:e.jsx(oe,{children:"Analog Chart Details"})}),n&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Chart Number:"})," ",n.chart_number]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(n.chart_date).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Driver:"})," ",n.driver_name]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle:"})," ",n.vehicle_number," (",n.vehicle_license_plate,")"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",ee(n.chart_type)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Format:"})," ",n.chart_format]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Distance:"})," ",n.total_distance_km?`${n.total_distance_km} km`:"Not recorded"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Analysis Status"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",A(n)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Condition:"})," ",Z(n.chart_condition)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Uploaded:"})," ",new Date(n.uploaded_at).toLocaleString()]}),n.analysis_notes&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Notes:"})," ",n.analysis_notes]})]})]})]}),n.chart_image_url&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Image"}),e.jsx("div",{className:"border rounded-lg p-4",children:e.jsx("img",{src:`${Re.REACT_APP_SUPABASE_URL}/storage/v1/object/public/analog-charts/${n.chart_image_url}`,alt:"Analog Chart",className:"max-w-full h-auto rounded"})})]}),n.violations&&Array.isArray(n.violations)&&n.violations.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Violations Detected"}),e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-red-800",children:n.violations.map((a,l)=>e.jsx("li",{children:a},l))})})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(g,{variant:"outline",onClick:()=>v(!1),children:"Close"}),!n.manual_analysis_completed&&e.jsxs(g,{onClick:()=>{v(!1),F(!0)},children:[e.jsx(ze,{className:"mr-2 h-4 w-4"}),"Analyze Chart"]})]})]})]})}),e.jsx(le,{open:te,onOpenChange:F,children:e.jsxs(de,{className:"max-w-4xl",children:[e.jsx(ce,{children:e.jsx(oe,{children:"Analyze Analog Chart"})}),n&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Chart:"})," ",n.chart_number]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(n.chart_date).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Driver:"})," ",n.driver_name]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle:"})," ",n.vehicle_number]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Image"}),n.chart_image_url&&e.jsx("img",{src:`${Re.REACT_APP_SUPABASE_URL}/storage/v1/object/public/analog-charts/${n.chart_image_url}`,alt:"Analog Chart",className:"max-w-full h-auto rounded border"})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Manual Analysis"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Analyze the chart and record the periods of activity, rest, and any violations detected."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"analysis_notes",children:"Analysis Notes"}),e.jsx(ue,{id:"analysis_notes",placeholder:"Record your analysis findings, violations detected, and any notes...",className:"mt-1"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"driving_periods",children:"Driving Periods"}),e.jsx(ue,{id:"driving_periods",placeholder:"e.g., 06:00-12:00, 14:00-18:00",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"rest_periods",children:"Rest Periods"}),e.jsx(ue,{id:"rest_periods",placeholder:"e.g., 12:00-14:00, 18:00-06:00",className:"mt-1"})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"violations",children:"Violations Detected"}),e.jsx(ue,{id:"violations",placeholder:"List any violations found during analysis...",className:"mt-1"})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(g,{variant:"outline",onClick:()=>F(!1),children:"Cancel"}),e.jsx(g,{onClick:()=>{var l;const a={driving_periods:[],rest_periods:[],work_periods:[],availability_periods:[],break_periods:[],violations:[],notes:((l=document.getElementById("analysis_notes"))==null?void 0:l.value)||""};G.mutate({chartId:n.id,analysisData:a})},disabled:G.isPending,children:G.isPending?"Saving...":"Save Analysis"})]})]})]})})]})},ls=()=>{const{user:r,profile:t,loading:C}=Ce(),{toast:D}=Se(),P=De(),[k,ae]=p.useState(""),[B,K]=p.useState("all"),[n,Q]=p.useState("all"),[J,v]=p.useState(!1),[te,F]=p.useState(!1),[d,xe]=p.useState(null),[ie,Y]=p.useState(!1),{data:w=[],isLoading:G}=W({queryKey:["tachograph-records",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:s,error:c}=await f.from("tachograph_records").select("*").eq("organization_id",t.organization_id).order("record_date",{ascending:!1}).order("start_time",{ascending:!1});if(c)return console.error("Error fetching tachograph records:",c),D({title:"Error",description:"Failed to load tachograph records",variant:"destructive"}),[];const N=[...new Set((s==null?void 0:s.filter(h=>h.driver_id).map(h=>h.driver_id))||[])],y=[...new Set((s==null?void 0:s.filter(h=>h.vehicle_id).map(h=>h.vehicle_id))||[])];let i=[],j=[];if(N.length>0){const{data:h}=await f.from("profiles").select("id, first_name, last_name").in("id",N);i=h||[]}if(y.length>0){const{data:h}=await f.from("vehicles").select("id, vehicle_number, license_plate").in("id",y);j=h||[]}const E=new Map(i.map(h=>[h.id,h])),b=new Map(j.map(h=>[h.id,h]));return(s==null?void 0:s.map(h=>{var re,se,S,ne;return{...h,driver_name:h.driver_id&&E.has(h.driver_id)?`${((re=E.get(h.driver_id))==null?void 0:re.first_name)||""} ${((se=E.get(h.driver_id))==null?void 0:se.last_name)||""}`.trim():"Unknown Driver",vehicle_number:h.vehicle_id&&b.has(h.vehicle_id)&&((S=b.get(h.vehicle_id))==null?void 0:S.vehicle_number)||"Unknown Vehicle",vehicle_license_plate:h.vehicle_id&&b.has(h.vehicle_id)&&((ne=b.get(h.vehicle_id))==null?void 0:ne.license_plate)||"No Plate"}}))||[]},enabled:!!(t!=null&&t.organization_id)}),{data:X=[]}=W({queryKey:["vehicles",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:s,error:c}=await f.from("vehicles").select("id, vehicle_number, license_plate").eq("organization_id",t.organization_id);return c?(console.error("Error fetching vehicles:",c),[]):s||[]},enabled:!!(t!=null&&t.organization_id)}),{data:T=[]}=W({queryKey:["drivers",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:s,error:c}=await f.from("profiles").select("id, first_name, last_name").eq("organization_id",t.organization_id).eq("role","driver");return c?(console.error("Error fetching drivers:",c),[]):s||[]},enabled:!!(t!=null&&t.organization_id)}),A=(()=>{if(w.length===0)return{totalRecords:0,validatedRecords:0,pendingValidation:0,recordsWithViolations:0,averageDistance:0,complianceRate:100,totalDrivingTime:0,totalRestTime:0};const s=w.length,c=w.filter(S=>S.is_validated).length,N=s-c,y=w.filter(S=>S.violations&&Array.isArray(S.violations)&&S.violations.length>0).length,j=w.reduce((S,ne)=>S+(ne.distance_km||0),0)/s,E=w.filter(S=>S.activity_type==="driving"),b=w.filter(S=>S.activity_type==="rest"),h=E.length,re=b.length,se=s>0?(s-y)/s*100:100;return{totalRecords:s,validatedRecords:c,pendingValidation:N,recordsWithViolations:y,averageDistance:Math.round(j*100)/100,complianceRate:Math.round(se*100)/100,totalDrivingTime:h,totalRestTime:re}})(),ee=w.filter(s=>{var i,j,E;const c=k===""||((i=s.driver_name)==null?void 0:i.toLowerCase().includes(k.toLowerCase()))||((j=s.vehicle_number)==null?void 0:j.toLowerCase().includes(k.toLowerCase()))||((E=s.activity_type)==null?void 0:E.toLowerCase().includes(k.toLowerCase())),N=B==="all"||B==="validated"&&s.is_validated||B==="pending"&&!s.is_validated||B==="violations"&&s.violations&&Array.isArray(s.violations)&&s.violations.length>0,y=n==="all"||n==="today"&&s.record_date===new Date().toISOString().split("T")[0]||n==="week"&&(()=>{const b=new Date;return b.setDate(b.getDate()-7),new Date(s.record_date)>=b})()||n==="month"&&(()=>{const b=new Date;return b.setMonth(b.getMonth()-1),new Date(s.record_date)>=b})();return c&&N&&y}),Z=ge({mutationFn:async s=>{const c=s.get("file"),{data:N,error:y}=await f.storage.from("tachograph-files").upload(`${t==null?void 0:t.organization_id}/${Date.now()}_${c.name}`,c);if(y)throw y;const i={organization_id:t==null?void 0:t.organization_id,driver_id:s.get("driver_id")||null,vehicle_id:s.get("vehicle_id")||null,record_date:s.get("record_date"),start_time:s.get("start_time"),end_time:s.get("end_time")||null,activity_type:s.get("activity_type"),distance_km:parseFloat(s.get("distance_km"))||null,start_location:s.get("start_location")||null,end_location:s.get("end_location")||null,file_path:N.path,raw_data:{},violations:[],is_validated:!1},{error:j}=await f.from("tachograph_records").insert(i);if(j)throw j},onSuccess:()=>{P.invalidateQueries({queryKey:["tachograph-records"]}),v(!1),D({title:"Success",description:"Tachograph record uploaded successfully"})},onError:s=>{console.error("Upload error:",s),D({title:"Error",description:"Failed to upload tachograph record",variant:"destructive"})}}),a=ge({mutationFn:async({recordId:s,isValidated:c,notes:N})=>{const{error:y}=await f.from("tachograph_records").update({is_validated:c,validation_notes:N||null}).eq("id",s);if(y)throw y},onSuccess:()=>{P.invalidateQueries({queryKey:["tachograph-records"]}),D({title:"Success",description:"Record validation updated"})},onError:s=>{console.error("Validation error:",s),D({title:"Error",description:"Failed to update validation",variant:"destructive"})}});if(C||G)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading tachograph manager..."})]})});if(!r||!t)return e.jsx(Ae,{to:"/auth",replace:!0});if(!["admin","council"].includes(t.role))return e.jsx(Ae,{to:"/unauthorized",replace:!0});const l=s=>s.is_validated?e.jsx($,{variant:"default",className:"bg-green-100 text-green-800",children:"Validated"}):s.violations&&Array.isArray(s.violations)&&s.violations.length>0?e.jsx($,{variant:"destructive",children:"Violations"}):e.jsx($,{variant:"secondary",children:"Pending"}),_=s=>{const c={driving:"bg-blue-100 text-blue-800",rest:"bg-green-100 text-green-800",work:"bg-yellow-100 text-yellow-800",availability:"bg-purple-100 text-purple-800",break:"bg-orange-100 text-orange-800"};return e.jsx($,{className:c[s]||"bg-gray-100 text-gray-800",children:s.charAt(0).toUpperCase()+s.slice(1)})};return e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Tachograph Manager"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage digital and analog tachograph records"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(g,{onClick:()=>v(!0),variant:"outline",children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Upload Digital"]}),e.jsxs(g,{onClick:()=>F(!0),children:[e.jsx(je,{className:"mr-2 h-4 w-4"}),"Upload Analog"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(q,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(V,{className:"text-sm font-medium",children:"Total Records"}),e.jsx(Te,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsx("div",{className:"text-2xl font-bold",children:A.totalRecords}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"All time tachograph records"})]})]}),e.jsxs(q,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(V,{className:"text-sm font-medium",children:"Validated Records"}),e.jsx(me,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsx("div",{className:"text-2xl font-bold",children:A.validatedRecords}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[A.totalRecords>0?Math.round(A.validatedRecords/A.totalRecords*100):0,"% of total"]})]})]}),e.jsxs(q,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(V,{className:"text-sm font-medium",children:"Compliance Rate"}),e.jsx(Le,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[A.complianceRate,"%"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[A.recordsWithViolations," violations detected"]})]})]}),e.jsxs(q,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(V,{className:"text-sm font-medium",children:"Avg Distance"}),e.jsx(Pe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[A.averageDistance," km"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Per tachograph record"})]})]})]}),e.jsxs(Qe,{defaultValue:"digital",className:"space-y-6",children:[e.jsxs(Ge,{className:"grid w-full grid-cols-3",children:[e.jsx(we,{value:"digital",children:"Digital Records"}),e.jsx(we,{value:"card-reader",children:"Card Reader"}),e.jsx(we,{value:"analog",children:"Analog Charts"})]}),e.jsxs(be,{value:"digital",className:"space-y-6",children:[e.jsxs(q,{children:[e.jsx(R,{children:e.jsx(V,{children:"Records"})}),e.jsxs(L,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(pe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(z,{placeholder:"Search by driver, vehicle, or activity...",value:k,onChange:s=>ae(s.target.value),className:"pl-10"})]})}),e.jsxs(U,{value:B,onValueChange:K,children:[e.jsx(I,{className:"w-full sm:w-[180px]",children:e.jsx(M,{placeholder:"Filter by status"})}),e.jsxs(O,{children:[e.jsx(o,{value:"all",children:"All Status"}),e.jsx(o,{value:"validated",children:"Validated"}),e.jsx(o,{value:"pending",children:"Pending"}),e.jsx(o,{value:"violations",children:"With Violations"})]})]}),e.jsxs(U,{value:n,onValueChange:Q,children:[e.jsx(I,{className:"w-full sm:w-[180px]",children:e.jsx(M,{placeholder:"Filter by date"})}),e.jsxs(O,{children:[e.jsx(o,{value:"all",children:"All Time"}),e.jsx(o,{value:"today",children:"Today"}),e.jsx(o,{value:"week",children:"Last 7 Days"}),e.jsx(o,{value:"month",children:"Last 30 Days"})]})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(_e,{children:[e.jsx(ye,{children:e.jsxs(H,{children:[e.jsx(u,{children:"Date"}),e.jsx(u,{children:"Driver"}),e.jsx(u,{children:"Vehicle"}),e.jsx(u,{children:"Activity"}),e.jsx(u,{children:"Time"}),e.jsx(u,{children:"Distance"}),e.jsx(u,{children:"Status"}),e.jsx(u,{children:"Actions"})]})}),e.jsx(fe,{children:ee.length===0?e.jsx(H,{children:e.jsx(x,{colSpan:8,className:"text-center py-8",children:e.jsx("div",{className:"text-muted-foreground",children:w.length===0?e.jsxs("div",{children:[e.jsx(Te,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No tachograph records found"}),e.jsx("p",{className:"text-sm",children:"Upload your first tachograph record to get started"}),e.jsxs(g,{onClick:()=>v(!0),className:"mt-4",variant:"outline",children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Upload First Record"]})]}):e.jsxs("div",{children:[e.jsx(pe,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No records match your filters"}),e.jsx("p",{className:"text-sm",children:"Try adjusting your search criteria"})]})})})}):ee.map(s=>e.jsxs(H,{children:[e.jsx(x,{children:e.jsx("div",{className:"font-medium",children:new Date(s.record_date).toLocaleDateString()})}),e.jsx(x,{children:e.jsx("div",{className:"font-medium",children:s.driver_name})}),e.jsx(x,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.vehicle_number}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.vehicle_license_plate})]})}),e.jsx(x,{children:_(s.activity_type)}),e.jsx(x,{children:e.jsx("div",{children:e.jsxs("div",{className:"font-medium",children:[s.start_time," - ",s.end_time||"Ongoing"]})})}),e.jsx(x,{children:s.distance_km?`${s.distance_km} km`:"-"}),e.jsx(x,{children:l(s)}),e.jsx(x,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>{xe(s),Y(!0)},children:e.jsx(Ee,{className:"h-4 w-4"})}),e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>{a.mutate({recordId:s.id,isValidated:!s.is_validated,notes:s.validation_notes||void 0})},disabled:a.isPending,children:s.is_validated?e.jsx(Ze,{className:"h-4 w-4"}):e.jsx(me,{className:"h-4 w-4"})})]})})]},s.id))})]})})]})]}),e.jsx(le,{open:J,onOpenChange:v,children:e.jsxs(de,{className:"max-w-2xl",children:[e.jsx(ce,{children:e.jsx(oe,{children:"Upload Tachograph Record"})}),e.jsxs("form",{onSubmit:s=>{s.preventDefault();const c=new FormData(s.currentTarget);Z.mutate(c)},children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"driver_id",children:"Driver"}),e.jsxs(U,{name:"driver_id",required:!0,children:[e.jsx(I,{children:e.jsx(M,{placeholder:"Select driver"})}),e.jsx(O,{children:T.map(s=>e.jsxs(o,{value:s.id,children:[s.first_name," ",s.last_name]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"vehicle_id",children:"Vehicle"}),e.jsxs(U,{name:"vehicle_id",required:!0,children:[e.jsx(I,{children:e.jsx(M,{placeholder:"Select vehicle"})}),e.jsx(O,{children:X.map(s=>e.jsxs(o,{value:s.id,children:[s.vehicle_number," (",s.license_plate,")"]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"record_date",children:"Record Date"}),e.jsx(z,{type:"date",name:"record_date",required:!0,defaultValue:new Date().toISOString().split("T")[0]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"activity_type",children:"Activity Type"}),e.jsxs(U,{name:"activity_type",required:!0,children:[e.jsx(I,{children:e.jsx(M,{placeholder:"Select activity"})}),e.jsxs(O,{children:[e.jsx(o,{value:"driving",children:"Driving"}),e.jsx(o,{value:"rest",children:"Rest"}),e.jsx(o,{value:"work",children:"Work"}),e.jsx(o,{value:"availability",children:"Availability"}),e.jsx(o,{value:"break",children:"Break"})]})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"start_time",children:"Start Time"}),e.jsx(z,{type:"time",name:"start_time",required:!0})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"end_time",children:"End Time"}),e.jsx(z,{type:"time",name:"end_time"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"distance_km",children:"Distance (km)"}),e.jsx(z,{type:"number",name:"distance_km",step:"0.1"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"file",children:"Tachograph File"}),e.jsx(z,{type:"file",name:"file",accept:".ddd,.tgd,.c1b,.v1b,.v2b,.esm",required:!0})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(m,{htmlFor:"start_location",children:"Start Location"}),e.jsx(z,{name:"start_location",placeholder:"Enter start location"})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(m,{htmlFor:"end_location",children:"End Location"}),e.jsx(z,{name:"end_location",placeholder:"Enter end location"})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-6",children:[e.jsx(g,{type:"button",variant:"outline",onClick:()=>v(!1),children:"Cancel"}),e.jsx(g,{type:"submit",disabled:Z.isPending,children:Z.isPending?"Uploading...":"Upload Record"})]})]})]})}),e.jsx(le,{open:ie,onOpenChange:Y,children:e.jsxs(de,{className:"max-w-4xl",children:[e.jsx(ce,{children:e.jsx(oe,{children:"Tachograph Record Details"})}),d&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Basic Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(d.record_date).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Driver:"})," ",d.driver_name]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle:"})," ",d.vehicle_number," (",d.vehicle_license_plate,")"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Activity:"})," ",_(d.activity_type)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Time:"})," ",d.start_time," - ",d.end_time||"Ongoing"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Distance:"})," ",d.distance_km?`${d.distance_km} km`:"Not recorded"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Location & Validation"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Start Location:"})," ",d.start_location||"Not specified"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"End Location:"})," ",d.end_location||"Not specified"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Card Number:"})," ",d.card_number||"Not recorded"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Downloaded:"})," ",d.downloaded_at?new Date(d.downloaded_at).toLocaleString():"Not downloaded"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",l(d)]})]})]})]}),d.violations&&Array.isArray(d.violations)&&d.violations.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Violations Detected"}),e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-red-800",children:d.violations.map((s,c)=>e.jsx("li",{children:s},c))})})]}),d.validation_notes&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Validation Notes"}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4",children:e.jsx("p",{className:"text-sm text-blue-800",children:d.validation_notes})})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(g,{variant:"outline",onClick:()=>Y(!1),children:"Close"}),e.jsx(g,{onClick:()=>{a.mutate({recordId:d.id,isValidated:!d.is_validated,notes:d.validation_notes||void 0})},disabled:a.isPending,children:d.is_validated?"Mark as Pending":"Mark as Validated"})]})]})]})})]}),e.jsx(be,{value:"card-reader",className:"space-y-6",children:e.jsx(es,{onDataDownloaded:s=>{D({title:"Card Data Downloaded",description:`Successfully downloaded ${s.recordsCount} records from ${s.cardType} card`}),P.invalidateQueries({queryKey:["tachograph-records"]})}})}),e.jsx(be,{value:"analog",className:"space-y-6",children:e.jsx(ss,{})})]})]})};export{ls as default};
