import{J as u,m as g,r as h,j as s,e as p,g as j,S as x,h as w,i as N,k as b,C as A,ap as C,B as f,$ as k,a3 as m,u as F}from"./main-DVuL102c.js";import{A as D}from"./arrow-left-DxhsiT2w.js";const E=async a=>{try{console.log("ðŸ”§ Attempting to fix access denied for:",a);const{data:e,error:r}=await u.from("profiles").select("*").eq("email",a).maybeSingle();if(r)return console.error("Error checking profile:",r),{success:!1,message:"Failed to check existing profile",error:r.message};if(e){if(console.log("âœ… Profile exists:",e),e.role==="admin"||e.role==="council")return{success:!0,message:"User already has admin privileges",profile:e};const{data:c,error:t}=await u.from("profiles").update({role:"admin",employment_status:"active",onboarding_status:"completed",is_active:!0,updated_at:new Date().toISOString()}).eq("email",a).select().single();return t?(console.error("Error updating profile:",t),{success:!1,message:"Failed to update profile role",error:t.message}):(console.log("âœ… Profile updated to admin:",c),{success:!0,message:"Profile updated to admin role successfully",profile:c})}else{console.log("âš ï¸ Profile does not exist, creating new admin profile");const{data:{user:c}}=await u.auth.getUser();if(!c)return{success:!1,message:"No authenticated user found",error:"User not authenticated"};const{data:t,error:i}=await u.from("profiles").insert({id:c.id,email:a,first_name:"Larone",last_name:"Laing",role:"admin",employment_status:"active",onboarding_status:"completed",is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();return i?(console.error("Error creating profile:",i),{success:!1,message:"Failed to create admin profile",error:i.message}):(console.log("âœ… New admin profile created:",t),{success:!0,message:"New admin profile created successfully",profile:t})}}catch(e){return console.error("âŒ Error in fixAccessDenied:",e),{success:!1,message:"Unexpected error occurred",error:e instanceof Error?e.message:"Unknown error"}}},S=async()=>{try{const{data:{user:a}}=await u.auth.getUser();if(!a)return!1;const{data:e}=await u.from("profiles").select("role").eq("id",a.id).maybeSingle();return(e==null?void 0:e.role)==="admin"||(e==null?void 0:e.role)==="council"}catch(a){return console.error("Error checking admin access:",a),!1}},_=({userEmail:a,onFixComplete:e})=>{const{user:r,refreshProfile:c}=g(),[t,i]=h.useState(!1),[n,l]=h.useState(null),d=a||(r==null?void 0:r.email)||"",y=async()=>{if(!d){m.error("No user email available");return}i(!0),l(null);try{const o=await E(d);l({success:o.success,message:o.message}),o.success?(m.success("Access fixed successfully!"),await c(),e&&e(),setTimeout(()=>{window.location.reload()},1e3)):m.error(`Failed to fix access: ${o.error||o.message}`)}catch(o){console.error("Error fixing access:",o),l({success:!1,message:"An unexpected error occurred"}),m.error("An unexpected error occurred while fixing access")}finally{i(!1)}},v=async()=>{await S()?m.success("You already have admin access!"):m.info('You do not have admin access. Click "Fix Access" to resolve this.')};return s.jsxs(p,{className:"w-full max-w-md mx-auto",children:[s.jsxs(j,{className:"text-center",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4",children:s.jsx(x,{className:"w-8 h-8 text-red-600"})}),s.jsx(w,{className:"text-2xl font-bold text-gray-900",children:"Access Denied"}),s.jsx(N,{children:"You don't have permission to access this page. This can be fixed by ensuring you have the proper role."})]}),s.jsxs(b,{className:"space-y-4",children:[n&&s.jsx("div",{className:`p-3 rounded-lg ${n.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:s.jsxs("div",{className:"flex items-center",children:[n.success?s.jsx(A,{className:"w-5 h-5 text-green-600 mr-2"}):s.jsx(C,{className:"w-5 h-5 text-red-600 mr-2"}),s.jsx("span",{className:`text-sm ${n.success?"text-green-800":"text-red-800"}`,children:n.message})]})}),s.jsxs("div",{className:"space-y-3",children:[s.jsx(f,{onClick:y,disabled:t,className:"w-full",variant:"default",children:t?s.jsxs(s.Fragment,{children:[s.jsx(k,{className:"w-4 h-4 mr-2 animate-spin"}),"Fixing Access..."]}):s.jsxs(s.Fragment,{children:[s.jsx(x,{className:"w-4 h-4 mr-2"}),"Fix Access"]})}),s.jsx(f,{onClick:v,disabled:t,variant:"outline",className:"w-full",children:"Check Current Access"})]}),s.jsxs("div",{className:"text-xs text-gray-500 text-center",children:[s.jsxs("p",{children:["Target Email: ",d]}),s.jsx("p",{children:"This will update your role to admin if needed."})]})]})]})},T=()=>{var i,n,l,d;const a=F(),{user:e,profile:r}=g(),c=((i=e==null?void 0:e.email)==null?void 0:i.includes("admin"))||((n=e==null?void 0:e.email)==null?void 0:n.includes("transport"))||((l=e==null?void 0:e.email)==null?void 0:l.includes("laronelaing"))&&((d=e==null?void 0:e.user_metadata)==null?void 0:d.role)==="admin",t=()=>(r==null?void 0:r.role)==="driver"?"/driver-dashboard":(r==null?void 0:r.role)==="parent"?"/parent/dashboard":(r==null?void 0:r.role)==="mechanic"?"/mechanic-dashboard":"/dashboard";return s.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:c?s.jsx(_,{userEmail:e==null?void 0:e.email,onFixComplete:()=>{a("/dashboard")}}):s.jsxs(p,{className:"w-full max-w-md",children:[s.jsxs(j,{className:"text-center",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4",children:s.jsx(x,{className:"w-8 h-8 text-red-600"})}),s.jsx(w,{className:"text-2xl font-bold text-gray-900",children:"Access Denied"}),s.jsxs(N,{children:["You don't have permission to access this page.",(r==null?void 0:r.role)==="driver"&&" This page is for administrators only."]})]}),s.jsx(b,{className:"text-center",children:s.jsxs(f,{onClick:()=>a(t()),className:"w-full",children:[s.jsx(D,{className:"w-4 h-4 mr-2"}),"Back to ",(r==null?void 0:r.role)==="driver"?"Driver":""," Dashboard"]})})]})})};export{T as default};
