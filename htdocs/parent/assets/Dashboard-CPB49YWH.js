import{u as k,z as q,j as e,A as C,E as v,B as h,X as T,G as A,H as y,v as W,q as G,J,N as U,s as x,i as f,n as j,k as p,l as N,T as R,U as M,W as I,K as O,O as X,C as Z,P as w,R as ee,F as se}from"./main-piTIAPSx.js";import{T as ae,a as te,b as L,c as B}from"./tabs-N5TLptOb.js";import{u as z}from"./useQuery-Dbdyc74j.js";import{u as F}from"./useMutation-B8vlA97s.js";import{u as E}from"./useTrialManagement-DIBEvD_t.js";import{S as ne}from"./star-D5LO9sgD.js";import{D as P}from"./database-BK6ac866.js";import{U as Y}from"./user-check-CRW2UDzB.js";import{C as K}from"./circle-check-big-CD0jvDn0.js";const ie=({className:s=""})=>{const{data:n,isLoading:l,error:m}=E(),c=k(),[d,o]=q.useState(!0);if(l||!d||m||!n||!n.isActive)return null;const D=r=>r<=3?"destructive":(r<=7,"default"),b=r=>r<=3?e.jsx(y,{className:"h-4 w-4"}):r<=7?e.jsx(W,{className:"h-4 w-4"}):e.jsx(ne,{className:"h-4 w-4"}),S=r=>r<=3?"Trial Expiring Soon":r<=7?"Trial Ending Soon":"Free Trial Active",_=r=>r<=3?`Your trial expires in ${r} day${r===1?"":"s"}. Upgrade now to continue using all features.`:r<=7?`Your trial ends in ${r} days. Upgrade to keep your data and continue using the platform.`:`You have ${r} days left in your free trial. Upgrade anytime to unlock all features.`;return e.jsxs(C,{className:`mb-6 ${s}`,variant:D(n.daysLeft),children:[b(n.daysLeft),e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:S(n.daysLeft)}),e.jsxs(v,{variant:"outline",children:[n.currentDrivers,"/",n.maxDrivers," Drivers"]}),e.jsxs(v,{variant:"secondary",children:[n.daysLeft," days left"]})]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>o(!1),className:"h-6 w-6 p-0 hover:bg-background/20",children:e.jsx(T,{className:"h-4 w-4"})})]}),e.jsxs(A,{className:"flex items-center justify-between",children:[e.jsx("span",{children:_(n.daysLeft)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{size:"sm",onClick:()=>c("/subscriptions"),variant:n.daysLeft<=3?"default":"outline",children:n.daysLeft<=3?"Upgrade Now":"View Plans"}),n.daysLeft>3&&e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>c("/subscriptions"),children:"Learn More"})]})]})]})},re=({className:s=""})=>{const{data:n,isLoading:l}=E(),m=k(),[c,d]=q.useState(!0);return l||!n||!c||n.isActive||n.daysLeft>0?null:e.jsxs(C,{className:`mb-6 ${s}`,variant:"destructive",children:[e.jsx(y,{className:"h-4 w-4"}),e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("div",{className:"font-medium",children:"Trial Expired"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>d(!1),className:"h-6 w-6 p-0 hover:bg-destructive/20",children:e.jsx(T,{className:"h-4 w-4"})})]}),e.jsxs(A,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Your free trial has expired. Upgrade to a paid plan to continue using the platform and access your data."}),e.jsx(h,{size:"sm",onClick:()=>m("/subscriptions"),variant:"destructive",children:"Upgrade Now"})]})]})},ce=({className:s=""})=>{const{data:n,isLoading:l}=E(),m=k(),[c,d]=q.useState(!0);if(l||!n||!c)return null;const o=n.currentDrivers/n.maxDrivers*100;return o<80?null:e.jsxs(C,{className:`mb-6 ${s}`,variant:o>=100?"destructive":"default",children:[e.jsx(y,{className:"h-4 w-4"}),e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("div",{className:"font-medium",children:o>=100?"Driver Limit Reached":"Approaching Driver Limit"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>d(!1),className:"h-6 w-6 p-0 hover:bg-background/20",children:e.jsx(T,{className:"h-4 w-4"})})]}),e.jsxs(A,{className:"flex items-center justify-between",children:[e.jsx("span",{children:o>=100?`You've reached your limit of ${n.maxDrivers} drivers. Upgrade to add more drivers.`:`You're using ${n.currentDrivers} of ${n.maxDrivers} drivers. Consider upgrading soon.`}),e.jsx(h,{size:"sm",onClick:()=>m("/subscriptions"),variant:o>=100?"destructive":"outline",children:o>=100?"Upgrade Now":"View Plans"})]})]})};function je(){const{profile:s}=G(),n=J();if((s==null?void 0:s.role)==="driver")return e.jsx(U,{to:"/driver-dashboard",replace:!0});if((s==null?void 0:s.role)==="mechanic")return e.jsx(U,{to:"/mechanic-dashboard",replace:!0});const{data:l=[]}=z({queryKey:["vehicles",s==null?void 0:s.organization_id],queryFn:async()=>{if(!(s!=null&&s.organization_id))return[];const{data:a,error:t}=await x.from("vehicles").select("*").eq("organization_id",s.organization_id).limit(100);return t?(console.error("Error fetching vehicles:",t),[]):a||[]},enabled:!!(s!=null&&s.organization_id)}),{data:m=[]}=z({queryKey:["drivers",s==null?void 0:s.organization_id],queryFn:async()=>{if(!(s!=null&&s.organization_id))return[];const{data:a,error:t}=await x.from("profiles").select("*").eq("role","driver").eq("organization_id",s.organization_id).limit(100);return t?(console.error("Error fetching drivers:",t),[]):a||[]},enabled:!!(s!=null&&s.organization_id)}),{data:c=[]}=z({queryKey:["recent-incidents",s==null?void 0:s.organization_id],queryFn:async()=>{if(!(s!=null&&s.organization_id))return[];const{data:a,error:t}=await x.from("incidents").select("*").eq("organization_id",s.organization_id).order("created_at",{ascending:!1}).limit(5);return t?(console.error("Error fetching incidents:",t),[]):a||[]},enabled:!!(s!=null&&s.organization_id)}),{data:d=[]}=z({queryKey:["maintenance-requests",s==null?void 0:s.organization_id],queryFn:async()=>{if(!(s!=null&&s.organization_id))return[];const{data:a,error:t}=await x.from("maintenance_requests").select("*").eq("organization_id",s.organization_id).order("created_at",{ascending:!1}).limit(10);return t?(console.error("Error fetching maintenance requests:",t),[]):a||[]},enabled:!!(s!=null&&s.organization_id)}),o=F({mutationFn:async()=>{const a=[];try{if(l.length>0){console.log(`Deleting ${l.length} vehicles...`);for(const t of l){const{error:i}=await x.from("vehicles").delete().eq("id",t.id);i&&(console.error(`Error deleting vehicle ${t.id}:`,i),a.push(`Vehicle ${t.id}: ${i.message}`))}}if(c.length>0){console.log(`Deleting ${c.length} incidents...`);for(const t of c){const{error:i}=await x.from("incidents").delete().eq("id",t.id);i&&(console.error(`Error deleting incident ${t.id}:`,i),a.push(`Incident ${t.id}: ${i.message}`))}}if(d.length>0){console.log(`Deleting ${d.length} maintenance requests...`);for(const t of d){const{error:i}=await x.from("maintenance_requests").delete().eq("id",t.id);i&&(console.error(`Error deleting maintenance request ${t.id}:`,i),a.push(`Maintenance ${t.id}: ${i.message}`))}}m.length>0&&console.log(`Found ${m.length} drivers - keeping user profiles intact`)}catch(t){throw console.error("Unexpected error during deletion:",t),new Error(`Unexpected error: ${t.message}`)}if(a.length>0)throw console.warn("Some deletions failed:",a),new Error(`Some deletions failed: ${a.join(", ")}`);return console.log("✅ All dashboard data cleared successfully"),{success:!0}},onSuccess:()=>{n.invalidateQueries(),w({title:"Success!",description:"All dashboard data has been cleared."})},onError:a=>{console.error("Error clearing dashboard data:",a),w({title:"Error",description:`Failed to clear all data: ${a.message}`,variant:"destructive"})}}),D=async()=>{if(l.length+c.length+d.length===0){w({title:"No Data",description:"There is no data to clear."});return}confirm(`Are you sure you want to clear dashboard data?

This will permanently delete:
- ${l.length} vehicles
- ${c.length} incidents
- ${d.length} maintenance requests

Driver profiles will be kept intact.

This action cannot be undone.`)&&o.mutate()},b=F({mutationFn:async()=>{if(!(s!=null&&s.organization_id))throw new Error("No organization ID found");const a=[];try{const t=[{organization_id:s.organization_id,vehicle_number:"BUS001",license_plate:"LDN 001A",make:"Mercedes",model:"Citaro",year:2022,vehicle_type:"Bus",status:"active"},{organization_id:s.organization_id,vehicle_number:"BUS002",license_plate:"LDN 002B",make:"Volvo",model:"B8RLE",year:2021,vehicle_type:"Bus",status:"active"},{organization_id:s.organization_id,vehicle_number:"VAN001",license_plate:"LDN 101V",make:"Ford",model:"Transit",year:2022,vehicle_type:"Van",status:"active"}];for(const g of t){const{error:u}=await x.from("vehicles").insert(g);u&&(console.error(`Error adding vehicle ${g.vehicle_number}:`,u),a.push(`Vehicle ${g.vehicle_number}: ${u.message}`))}const i=[{organization_id:s.organization_id,title:"Minor Traffic Incident",description:"Vehicle BUS001 experienced a minor bump in the depot parking area. No injuries reported.",incident_type:"accident",severity:"low",status:"open",reported_by:s.id,incident_date:new Date().toISOString().split("T")[0]}];for(const g of i){const{error:u}=await x.from("incidents").insert(g);u&&(console.error("Error adding incident:",u),a.push(`Incident: ${u.message}`))}const H=[{organization_id:s.organization_id,description:"Routine brake inspection required",status:"pending",user_id:s.id},{organization_id:s.organization_id,description:"Air conditioning system making unusual noises",status:"pending",user_id:s.id}];for(const g of H){const{error:u}=await x.from("maintenance_requests").insert(g);u&&(console.error("Error adding maintenance request:",u),a.push(`Maintenance: ${u.message}`))}}catch(t){throw console.error("Unexpected error during sample data creation:",t),new Error(`Unexpected error: ${t.message}`)}if(a.length>0)throw console.warn("Some sample data creation failed:",a),new Error(`Some operations failed: ${a.join(", ")}`);return console.log("✅ Sample data added successfully"),{success:!0}},onSuccess:()=>{n.invalidateQueries(),w({title:"Success!",description:"Sample data has been added to your dashboard."})},onError:a=>{console.error("Error adding sample data:",a),w({title:"Error",description:`Failed to add sample data: ${a.message}`,variant:"destructive"})}}),S=async()=>{confirm(`Add sample data to your dashboard?

This will add:
- 3 sample vehicles
- 1 sample incident
- 2 sample maintenance requests

This will help you see how the dashboard works with real data.`)&&b.mutate()},_=l.filter(a=>a.status==="active").length,r=m.filter(a=>a.is_active).length,$=d.filter(a=>a.status==="pending").length,V=c.length,Q=[{label:"Add Vehicle",icon:R,href:"/vehicles"},{label:"Add Driver",icon:M,href:"/drivers"},{label:"Create Route",icon:ee,href:"/routes"},{label:"View Reports",icon:se,href:"/analytics"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsx(ie,{}),e.jsx(re,{}),e.jsx(ce,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Dashboard"}),e.jsxs("p",{className:"text-muted-foreground",children:["Welcome back, ",(s==null?void 0:s.first_name)||"User","! Here's your fleet overview."]})]}),e.jsxs("div",{className:"flex gap-2",children:[l.length===0&&c.length===0&&d.length===0&&e.jsxs(h,{onClick:S,variant:"outline",className:"inline-flex items-center",disabled:b.isPending,children:[e.jsx(P,{className:"mr-2 h-4 w-4"}),b.isPending?"Adding...":"Add Sample Data"]}),(l.length>0||c.length>0||d.length>0)&&e.jsxs(h,{onClick:D,variant:"destructive",className:"inline-flex items-center",disabled:o.isPending,children:[e.jsx(P,{className:"mr-2 h-4 w-4"}),o.isPending?"Clearing...":"Clear All Data"]})]})]}),(s==null?void 0:s.role)==="admin"&&e.jsx(f,{className:"border-blue-200 bg-blue-50",children:e.jsx(j,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Y,{className:"h-5 w-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-blue-900",children:"Mechanic Request Management"}),e.jsx("p",{className:"text-sm text-blue-700",children:"Manage mechanic requests and working relationships for your organization."})]})]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>window.location.href="/admin/mechanic-requests",className:"border-blue-300 text-blue-700 hover:bg-blue-100",children:[e.jsx(Y,{className:"mr-2 h-4 w-4"}),"Manage Requests"]})]})})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(f,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"Total Vehicles"}),e.jsx(R,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:l.length}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[_," active"]})]})]}),e.jsxs(f,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"Active Drivers"}),e.jsx(M,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:r}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["of ",m.length," total drivers"]})]})]}),e.jsxs(f,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"Pending Maintenance"}),e.jsx(I,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:$}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"requests awaiting attention"})]})]}),e.jsxs(f,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"Recent Incidents"}),e.jsx(y,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:V}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"in the last 7 days"})]})]})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-7",children:[e.jsxs(f,{className:"col-span-4",children:[e.jsx(p,{children:e.jsxs(N,{className:"flex items-center space-x-2",children:[e.jsx(O,{className:"w-5 h-5"}),e.jsx("span",{children:"Recent Activity"})]})}),e.jsx(j,{children:e.jsxs(ae,{defaultValue:"incidents",className:"w-full",children:[e.jsxs(te,{className:"grid w-full grid-cols-2",children:[e.jsx(L,{value:"incidents",children:"Recent Incidents"}),e.jsx(L,{value:"maintenance",children:"Maintenance"})]}),e.jsx(B,{value:"incidents",className:"space-y-4",children:c.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(K,{className:"w-12 h-12 mx-auto mb-2 text-green-500"}),e.jsx("p",{children:"No recent incidents - Great job!"})]}):c.slice(0,5).map((a,t)=>{var i;return e.jsxs("div",{className:"flex items-center space-x-4 rounded-lg border p-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(y,{className:"w-5 h-5 text-orange-500"})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:a.title}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[(i=a.description)==null?void 0:i.substring(0,100),"..."]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(a.created_at).toLocaleDateString()})]}),e.jsx(v,{variant:a.severity==="high"?"destructive":a.severity==="medium"?"default":"secondary",children:a.severity})]},a.id||t)})}),e.jsx(B,{value:"maintenance",className:"space-y-4",children:d.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(K,{className:"w-12 h-12 mx-auto mb-2 text-green-500"}),e.jsx("p",{children:"No pending maintenance requests"})]}):d.slice(0,5).map((a,t)=>{var i;return e.jsxs("div",{className:"flex items-center space-x-4 rounded-lg border p-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(I,{className:"w-5 h-5 text-blue-500"})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:"Maintenance Request"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[(i=a.description)==null?void 0:i.substring(0,100),"..."]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(a.created_at).toLocaleDateString()})]}),e.jsx(v,{variant:a.status==="pending"?"default":a.status==="in_progress"?"secondary":"outline",children:a.status})]},a.id||t)})})]})})]}),e.jsxs(f,{className:"col-span-3",children:[e.jsx(p,{children:e.jsxs(N,{className:"flex items-center space-x-2",children:[e.jsx(X,{className:"w-5 h-5"}),e.jsx("span",{children:"Quick Actions"})]})}),e.jsxs(j,{className:"space-y-4",children:[e.jsx("div",{className:"grid gap-3",children:Q.map((a,t)=>{const i=a.icon;return e.jsxs(h,{variant:"outline",className:"w-full justify-start",onClick:()=>window.location.href=a.href,children:[e.jsx(i,{className:"w-4 h-4 mr-2"}),a.label]},t)})}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h4",{className:"font-medium mb-3",children:"Fleet Status"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Vehicles Active"}),e.jsxs(v,{variant:"secondary",children:[_,"/",l.length]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Drivers Available"}),e.jsxs(v,{variant:"secondary",children:[r,"/",m.length]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Maintenance Due"}),e.jsx(v,{variant:$>0?"destructive":"secondary",children:$})]})]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsxs("h4",{className:"font-medium mb-3 flex items-center space-x-2",children:[e.jsx(Z,{className:"w-4 h-4"}),e.jsx("span",{children:"Today's Summary"})]}),e.jsxs("div",{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Active Routes"}),e.jsx("span",{className:"font-medium",children:"0"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Completed Jobs"}),e.jsx("span",{className:"font-medium",children:"0"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"New Incidents"}),e.jsx("span",{className:"font-medium",children:V})]})]})]})]})]})]})]})}export{je as default};
