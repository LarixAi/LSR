import{c as oe,j as e,E as Z,a7 as pe,a8 as je,a9 as fe,aa as ye,S as we,F as ve,a1 as Ne,x as be,q as ee,C as _e,B as u,a0 as Y,ab as W,r as y,i as I,k as B,l as q,m as Ce,n as M,a as le,J as Pe,D as ce,d as de,e as Q,f as G,g as K,Y as g,I as p,A as R,w as Se,G as H,H as me,s as O,ac as te,a6 as re,z as ne,U as Ee,v as De}from"./main-piTIAPSx.js";import{u as ze}from"./useDrivers-CJ7MVxZO.js";import{P as Te}from"./progress-nJfMQ3MC.js";import{T as ke,a as Fe,b as V,c as k,d as Oe,e as S}from"./table-CV1HM_JF.js";import{C as he}from"./circle-check-big-CD0jvDn0.js";import{C as Ae}from"./circle-x-CETn4HDx.js";import{H as Ie}from"./heart-e8Bsk1RQ.js";import{P as Me}from"./phone-D7pMV1Uy.js";import{U as xe}from"./user-x-BrHPBKUE.js";import{f as $e}from"./format-VbeFDANp.js";import{U as ue}from"./user-check-CRW2UDzB.js";import{u as Ue}from"./useMutation-B8vlA97s.js";import{C as ie}from"./copy-BKc1aBN8.js";import{P as Be}from"./plus-CMGcTuiR.js";import"./useQuery-Dbdyc74j.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=oe("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=oe("MailX",[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h9",key:"1j9vog"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"m17 17 4 4",key:"1b3523"}],["path",{d:"m21 17-4 4",key:"uinynz"}]]),Re=({status:a})=>{const d={pending:"secondary",in_progress:"default",completed:"default",rejected:"destructive"},r={pending:"bg-gray-100 text-gray-800",in_progress:"bg-blue-100 text-blue-800",completed:"bg-green-100 text-green-800",rejected:"bg-red-100 text-red-800"};return e.jsx(Z,{variant:d[a]||"secondary",className:a==="completed"?r.completed:"",children:a.replace("_"," ")})},He=({status:a})=>{const d={applicant:"secondary",employee:"default",terminated:"destructive",inactive:"outline"},r={applicant:"bg-gray-100 text-gray-800",employee:"bg-green-100 text-green-800",terminated:"bg-red-100 text-red-800",inactive:"bg-gray-50 text-gray-600"};return e.jsx(Z,{variant:d[a]||"secondary",className:a==="employee"?r.employee:"",children:a})},Je=({missingDocuments:a=[],completedDocuments:d=[]})=>{const r={driver_license:{icon:qe,label:"Driver License"},medical_certificate:{icon:Ie,label:"Medical Certificate"},insurance:{icon:we,label:"Insurance Documents"},emergency_contact:{icon:Me,label:"Emergency Contact"},tax_forms:{icon:ve,label:"Tax Forms (W-4)"},direct_deposit:{icon:Ne,label:"Direct Deposit Form"},photo_id:{icon:be,label:"Photo ID Badge"}},n=Object.keys(r);return e.jsx(pe,{children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[n.map(l=>{const t=r[l],f=t.icon,c=d.includes(l),w=a.includes(l);return e.jsxs(je,{children:[e.jsx(fe,{asChild:!0,children:e.jsxs("div",{className:"relative",children:[e.jsx(f,{className:`w-4 h-4 ${c?"text-green-600":w?"text-red-500":"text-gray-400"}`}),c&&e.jsx(he,{className:"w-2 h-2 text-green-600 absolute -top-1 -right-1 bg-white rounded-full"}),w&&e.jsx(Ae,{className:"w-2 h-2 text-red-500 absolute -top-1 -right-1 bg-white rounded-full"})]})}),e.jsx(ye,{children:e.jsxs("p",{children:[t.label,": ",c?"Completed":w?"Missing":"Not Required"]})})]},l)}),a.length>0&&e.jsxs(Z,{variant:"destructive",className:"ml-2 text-xs",children:[a.length," missing"]})]})})},ge=()=>{const{profile:a}=ee(),d=(a==null?void 0:a.role)==="admin",r=(a==null?void 0:a.role)==="council",n=(a==null?void 0:a.role)==="super_admin",l=d||r||n,t=a==null?void 0:a.organization_id;return{isAdmin:d,isCouncil:r,isSuperAdmin:n,canManagePasswords:l,organizationId:t,profile:a}},Ve=({drivers:a,onViewOnboarding:d,onPasswordChange:r})=>{const{canManagePasswords:n,organizationId:l}=ge();return e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ke,{children:[e.jsx(Fe,{children:e.jsxs(V,{children:[e.jsx(k,{children:"Name"}),e.jsx(k,{children:"Email"}),e.jsx(k,{children:"Employment Status"}),e.jsx(k,{children:"Onboarding Status"}),e.jsx(k,{children:"Progress"}),e.jsx(k,{children:"Documents"}),e.jsx(k,{children:"Hire Date"}),e.jsx(k,{children:"Actions"})]})}),e.jsxs(Oe,{children:[a==null?void 0:a.map(t=>e.jsxs(V,{children:[e.jsxs(S,{className:"font-medium",children:[t.first_name," ",t.last_name]}),e.jsx(S,{children:t.email}),e.jsx(S,{children:e.jsx(He,{status:t.employment_status||"applicant"})}),e.jsx(S,{children:e.jsx(Re,{status:t.onboarding_status||"pending"})}),e.jsx(S,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Te,{value:t.onboarding_progress||0,className:"w-20"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[t.completed_tasks||0,"/",t.total_tasks||0]})]})}),e.jsx(S,{children:e.jsx(Je,{missingDocuments:t.missing_documents,completedDocuments:t.completed_documents})}),e.jsx(S,{children:t.hire_date?e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(_e,{className:"w-4 h-4"}),e.jsx("span",{children:$e(new Date(t.hire_date),"MMM dd, yyyy")})]}):e.jsx("span",{className:"text-gray-400",children:"Not hired"})}),e.jsx(S,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{variant:"outline",size:"sm",onClick:()=>d(t.id),className:"flex items-center space-x-1",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsx("span",{children:"View"})]}),r&&n&&(t.organization_id===l?e.jsxs(u,{variant:"outline",size:"sm",onClick:()=>r({id:t.id,email:t.email,first_name:t.first_name,last_name:t.last_name,organization_id:t.organization_id}),className:"flex items-center space-x-1",children:[e.jsx(W,{className:"w-4 h-4"}),e.jsx("span",{children:"Password"})]}):e.jsxs(u,{variant:"outline",size:"sm",disabled:!0,className:"flex items-center space-x-1 opacity-50 cursor-not-allowed",title:"Can only change passwords for drivers in your organization",children:[e.jsx(W,{className:"w-4 h-4"}),e.jsx("span",{children:"Password"})]}))]})})]},t.id)),(!a||a.length===0)&&e.jsx(V,{children:e.jsx(S,{colSpan:8,className:"text-center py-8",children:e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx(xe,{className:"w-8 h-8 text-gray-400"}),e.jsx("span",{className:"text-gray-500",children:"No drivers found"})]})})})]})]})})},Xe=({drivers:a,isLoading:d,onPasswordChange:r})=>{const[n,l]=y.useState(null),[t,f]=y.useState(!1),c=w=>{l(w),f(!0)};return d?e.jsx("div",{className:"flex items-center justify-center p-8",children:"Loading drivers..."}):e.jsx(e.Fragment,{children:e.jsxs(I,{children:[e.jsxs(B,{children:[e.jsxs(q,{className:"flex items-center space-x-2",children:[e.jsx(ue,{className:"w-5 h-5"}),e.jsx("span",{children:"Drivers Overview"})]}),e.jsx(Ce,{children:"Manage driver onboarding and employment status"})]}),e.jsx(M,{children:e.jsx(Ve,{drivers:a,onViewOnboarding:c,onPasswordChange:r})})]})})},Ye="https://dznbihypzmvcmradijqn.supabase.co",We=({open:a,onOpenChange:d,onDriverAdded:r})=>{const[n,l]=y.useState({first_name:"",last_name:"",email:"",phone:"",address:"",city:"",state:"",zip_code:"",hire_date:"",termination_date:"",cdl_number:"",medical_card_expiry:""}),[t,f]=y.useState(null),{toast:c}=le(),w=Pe(),N=Ue({mutationFn:async s=>{console.log("Creating driver with data:",s);const{data:{session:h},error:j}=await O.auth.getSession();if(j||!h)throw new Error("You must be logged in to create drivers. Please log in and try again.");console.log("Session found, calling create-driver function...");const{data:x,error:C}=await O.functions.invoke("create-driver",{body:{email:s.email,firstName:s.first_name,lastName:s.last_name,phone:s.phone||null,address:s.address||null,city:s.city||null,state:s.state||null,zipCode:s.zip_code||null,hireDate:s.hire_date||null,cdlNumber:s.cdl_number||null,medicalCardExpiry:s.medical_card_expiry||null}});if(console.log("Edge Function response:",{data:x,error:C}),C)if(console.error("Error creating driver:",C),C.message&&C.message.includes("non-2xx status code")){console.log("Attempting direct fetch to get detailed error...");try{const v=await fetch(`${Ye}/functions/v1/create-driver`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h.access_token}`},body:JSON.stringify({email:s.email,firstName:s.first_name,lastName:s.last_name,phone:s.phone||null,address:s.address||null,city:s.city||null,state:s.state||null,zipCode:s.zip_code||null,hireDate:s.hire_date||null,cdlNumber:s.cdl_number||null,medicalCardExpiry:s.medical_card_expiry||null})}),i=await v.text();if(console.log("Direct fetch response:",{status:v.status,statusText:v.statusText,body:i}),!v.ok)throw new Error(`Driver creation failed: ${v.status} ${v.statusText} - ${i}`)}catch(v){throw console.error("Direct fetch also failed:",v),new Error("Driver creation failed. Please check the Edge Function logs for details.")}}else throw C;if(x!=null&&x.error)throw console.error("Edge Function returned error:",x.error),new Error(x.error);return x},onSuccess:s=>{w.invalidateQueries({queryKey:["drivers"]}),f({email:n.email,temporaryPassword:s.temporaryPassword||"Contact admin for password",emailSent:s.emailSent});const h=s.emailSent?"Driver created successfully and welcome email sent!":"Driver created successfully. Email failed - please share credentials manually.";c({title:"Success",description:h}),r==null||r()},onError:s=>{var j;console.error("Driver creation error:",s);let h="Failed to create driver. Please try again.";if(s.message)h=s.message;else if((j=s.context)!=null&&j.body)try{h=(typeof s.context.body=="string"?JSON.parse(s.context.body):s.context.body).error||h}catch(x){console.error("Error parsing error body:",x)}else s.details&&(h=s.details);c({title:"Error",description:h,variant:"destructive"})}}),m=s=>{const{name:h,value:j}=s.target;l(x=>({...x,[h]:j}))},_=async s=>{if(s.preventDefault(),!n.first_name||!n.last_name||!n.email){c({title:"Validation Error",description:"Please fill in all required fields (First Name, Last Name, Email).",variant:"destructive"});return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n.email)){c({title:"Validation Error",description:"Please enter a valid email address.",variant:"destructive"});return}N.mutate(n)},P=async s=>{try{await navigator.clipboard.writeText(s),c({title:"Copied",description:"Copied to clipboard"})}catch(h){console.error("Failed to copy: ",h)}},E=()=>{f(null),l({first_name:"",last_name:"",email:"",phone:"",address:"",city:"",state:"",zip_code:"",hire_date:"",termination_date:"",cdl_number:"",medical_card_expiry:""}),d(!1)};return e.jsx(ce,{open:a,onOpenChange:E,children:e.jsx(de,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:t?e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsxs(G,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"w-5 h-5 text-green-600"}),"Driver Created Successfully"]}),e.jsx(K,{children:"The driver account has been created. Please share these login credentials with the new driver."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(R,{className:t.emailSent?"border-green-200 bg-green-50":"border-yellow-200 bg-yellow-50",children:[t.emailSent?e.jsx(Se,{className:"h-4 w-4 text-green-600"}):e.jsx(Le,{className:"h-4 w-4 text-yellow-600"}),e.jsx(H,{children:t.emailSent?e.jsxs("span",{className:"text-green-800",children:[e.jsx("strong",{children:"Email Sent:"})," Welcome email with login credentials has been sent to the driver."]}):e.jsxs("span",{className:"text-yellow-800",children:[e.jsx("strong",{children:"Email Failed:"})," Please share the credentials manually with the driver."]})})]}),e.jsxs(R,{children:[e.jsx(me,{className:"h-4 w-4"}),e.jsxs(H,{children:[e.jsx("strong",{children:"Important:"})," The driver will be required to change their password on first login for security."]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg space-y-3",children:[e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-700",children:"Email"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(p,{value:t.email,readOnly:!0,className:"bg-white"}),e.jsx(u,{variant:"outline",size:"sm",onClick:()=>P(t.email),children:e.jsx(ie,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-sm font-medium text-gray-700",children:"Temporary Password"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(p,{value:t.temporaryPassword,readOnly:!0,className:"bg-white font-mono"}),e.jsx(u,{variant:"outline",size:"sm",onClick:()=>P(t.temporaryPassword),children:e.jsx(ie,{className:"w-4 h-4"})})]})]})]}),e.jsxs("div",{className:"text-sm text-gray-600 space-y-2",children:[e.jsx("p",{children:e.jsx("strong",{children:"Next Steps:"})}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e.jsx("li",{children:"Share these credentials with the new driver"}),e.jsx("li",{children:"The driver must log in and change their password immediately"}),e.jsx("li",{children:"The temporary password will only work for the first login"})]})]}),e.jsx(u,{onClick:E,className:"w-full",children:"Close"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx(G,{children:"Add New Driver"}),e.jsx(K,{children:"Fill out the form below to add a new driver to the system. Required fields are marked with *."})]}),e.jsxs("form",{onSubmit:_,className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"first_name",children:"First Name *"}),e.jsx(p,{type:"text",id:"first_name",name:"first_name",value:n.first_name,onChange:m,required:!0,placeholder:"Enter first name"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"last_name",children:"Last Name *"}),e.jsx(p,{type:"text",id:"last_name",name:"last_name",value:n.last_name,onChange:m,required:!0,placeholder:"Enter last name"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"email",children:"Email *"}),e.jsx(p,{type:"email",id:"email",name:"email",value:n.email,onChange:m,required:!0,placeholder:"Enter email address"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"phone",children:"Phone Number"}),e.jsx(p,{type:"tel",id:"phone",name:"phone",value:n.phone,onChange:m,placeholder:"Enter phone number"})]})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"address",children:"Address"}),e.jsx(p,{type:"text",id:"address",name:"address",value:n.address,onChange:m,placeholder:"Enter street address"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"city",children:"City"}),e.jsx(p,{type:"text",id:"city",name:"city",value:n.city,onChange:m,placeholder:"Enter city"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"state",children:"State"}),e.jsx(p,{type:"text",id:"state",name:"state",value:n.state,onChange:m,placeholder:"Enter state"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"zip_code",children:"Zip Code"}),e.jsx(p,{type:"text",id:"zip_code",name:"zip_code",value:n.zip_code,onChange:m,placeholder:"Enter zip code"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"hire_date",children:"Hire Date"}),e.jsx(p,{type:"date",id:"hire_date",name:"hire_date",value:n.hire_date,onChange:m})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"termination_date",children:"Termination Date (Optional)"}),e.jsx(p,{type:"date",id:"termination_date",name:"termination_date",value:n.termination_date,onChange:m})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"cdl_number",children:"CDL Number"}),e.jsx(p,{type:"text",id:"cdl_number",name:"cdl_number",value:n.cdl_number,onChange:m,placeholder:"Enter CDL number"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"medical_card_expiry",children:"Medical Card Expiry"}),e.jsx(p,{type:"date",id:"medical_card_expiry",name:"medical_card_expiry",value:n.medical_card_expiry,onChange:m})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx(u,{type:"button",variant:"outline",onClick:E,disabled:N.isPending,children:"Cancel"}),e.jsx(u,{type:"submit",disabled:N.isPending,children:N.isPending?"Creating...":"Create Driver"})]})]})]})})})},X="https://dznbihypzmvcmradijqn.supabase.co",Qe=({isOpen:a,onClose:d,driver:r})=>{const[n,l]=y.useState(""),[t,f]=y.useState(""),[c,w]=y.useState(!1),[N,m]=y.useState(!1),[_,P]=y.useState(!1),[E,s]=y.useState(""),[h,j]=y.useState(!1),{toast:x}=le(),{canManagePasswords:C,organizationId:v}=ge(),{user:i}=ee(),b=async()=>{if(!(!r||!C)){if(r.organization_id&&r.organization_id!==v){s("You can only change passwords for drivers in your organization.");return}if(!n||!t){s("Please fill in all fields");return}if(n.length<6){s("Password must be at least 6 characters long");return}if(n!==t){s("Passwords do not match");return}j(!0)}},D=async()=>{if(!(!r||!i)){P(!0),s("");try{if(!r.id)throw new Error("Invalid driver selected. Please refresh the page and try again.");if(r.organization_id&&r.organization_id!==v)throw new Error("Access denied: You can only change passwords for drivers in your organization.");console.log("Calling Edge Function with parameters:",{targetUserId:r.id,adminUserId:i.id,hasNewPassword:!!n});const{data:{session:o}}=await O.auth.getSession();if(!o)throw new Error("No active session found. Please log in again.");const{data:z,error:A}=await O.functions.invoke("change-user-password",{body:{targetUserId:r.id,newPassword:n,adminUserId:i.id}});if(console.log("Edge Function response:",{data:z,error:A}),A)if(console.error("Edge Function error:",A),A.message&&A.message.includes("non-2xx status code")){console.log("Attempting direct fetch to get detailed error...");try{const T=await fetch(`${X}/functions/v1/change-user-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`},body:JSON.stringify({targetUserId:r.id,newPassword:n,adminUserId:i.id})}),J=await T.text();if(console.log("Direct fetch response:",{status:T.status,statusText:T.statusText,body:J}),!T.ok){const L=JSON.parse(J);if(L.error&&L.error.includes("Target user not found"))throw new Error("The selected driver no longer exists. Please refresh the page and try again.");if(L.error&&L.error.includes("User not found in authentication system")){console.log("User not found in Auth, attempting to create Auth user...");const $=await fetch(`${X}/functions/v1/create-missing-auth-user`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`},body:JSON.stringify({profileId:r.id,adminUserId:i.id})}),se=await $.text();if(console.log("Create Auth user response:",{status:$.status,body:se}),$.ok){console.log("Auth user created successfully, now trying password change again...");const U=await fetch(`${X}/functions/v1/change-user-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`},body:JSON.stringify({targetUserId:r.id,newPassword:n,adminUserId:i.id})}),ae=await U.text();if(console.log("Retry password change response:",{status:U.status,body:ae}),!U.ok)throw new Error(`Password change failed after creating Auth user: ${U.status} ${U.statusText} - ${ae}`);x({title:"Password Updated",description:`Password for ${r.email} has been successfully updated.`}),l(""),f(""),j(!1),d();return}else throw new Error(`Failed to create Auth user: ${$.status} ${$.statusText} - ${se}`)}else throw new Error(`Password change failed: ${T.status} ${T.statusText} - ${J}`)}}catch(T){throw console.error("Direct fetch also failed:",T),new Error("Password change failed. Please check the Edge Function logs for details.")}}else throw A;if(z!=null&&z.error)throw console.error("Edge Function data error:",z.error),new Error(z.error);x({title:"Password Updated",description:`Password for ${r.email} has been successfully updated.`}),l(""),f(""),j(!1),d()}catch(o){console.error("Error updating password:",o),console.error("Error details:",{message:o.message,status:o.status,statusText:o.statusText,data:o.data}),o.message&&(o.message.includes("no longer exists")||o.message.includes("Invalid driver selected")||o.message.includes("Target user not found"))?s(`${o.message} The driver list may be outdated. Please refresh the page.`):s(o.message||"Failed to update password. Please try again.")}finally{P(!1)}}},F=()=>{l(""),f(""),s(""),w(!1),m(!1),j(!1),d()};return!r||!C?null:e.jsx(ce,{open:a,onOpenChange:F,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsxs(Q,{children:[e.jsxs(G,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5"}),"Change Driver Password"]}),e.jsxs(K,{children:["Update the password for"," ",e.jsxs("span",{className:"font-medium",children:[r.first_name," ",r.last_name]})," ","(",r.email,")"]})]}),h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-4",children:e.jsxs(R,{children:[e.jsx(me,{className:"h-4 w-4"}),e.jsxs(H,{children:["Are you sure you want to change the password for"," ",e.jsxs("span",{className:"font-medium",children:[r.first_name," ",r.last_name]}),"?",e.jsx("br",{}),e.jsx("br",{}),"This action will immediately update their login credentials. They will need to use the new password to access their account."]})]})}),e.jsxs(re,{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>j(!1),disabled:_,children:"Back"}),e.jsx(u,{onClick:D,disabled:_,variant:"destructive",children:_?"Updating...":"Confirm Password Change"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4",children:[E&&e.jsx(R,{variant:"destructive",children:e.jsx(H,{children:E})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"newPassword",children:"New Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(p,{id:"newPassword",type:c?"text":"password",value:n,onChange:o=>l(o.target.value),placeholder:"Enter new password",className:"pr-10"}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>w(!c),children:c?e.jsx(te,{className:"h-4 w-4"}):e.jsx(Y,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"confirmPassword",children:"Confirm Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(p,{id:"confirmPassword",type:N?"text":"password",value:t,onChange:o=>f(o.target.value),placeholder:"Confirm new password",className:"pr-10"}),e.jsx(u,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>m(!N),children:N?e.jsx(te,{className:"h-4 w-4"}):e.jsx(Y,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsx("p",{children:"• Password must be at least 6 characters long"}),e.jsx("p",{children:"• The driver will need to use this password to log in"})]})]}),e.jsxs(re,{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",onClick:F,disabled:_,children:"Cancel"}),e.jsx(u,{onClick:b,disabled:_||!n||!t,children:"Continue"})]})]})]})})};function hs(){const{profile:a}=ee(),[d,r]=y.useState(!1),[n,l]=y.useState(!1),[t,f]=y.useState(null),{data:c=[],isLoading:w,error:N,refetch:m}=ze(),[_,P]=ne.useState("testing");ne.useEffect(()=>{(async()=>{try{console.log("Testing Supabase connection..."),P("testing");const{data:b,error:D}=await O.from("profiles").select("count").limit(1);if(D)console.error("Supabase connection test failed:",D),P("error");else if(console.log("Supabase connection test successful:",b),P("connected"),a!=null&&a.organization_id){console.log("Testing organization query for org:",a.organization_id);const{data:F,error:o}=await O.from("profiles").select("id, email, first_name, last_name, role, organization_id").eq("organization_id",a.organization_id);o?console.error("Organization query failed:",o):(console.log("Organization profiles found:",F),console.log("Drivers in organization:",F==null?void 0:F.filter(z=>z.role==="driver")))}}catch(b){console.error("Supabase connection test error:",b),P("error")}})()},[a==null?void 0:a.organization_id]);const E=()=>{r(!1),m()},s=i=>{f(i),l(!0)},h=()=>{l(!1),f(null)},j=c.length,x=c.filter(i=>i.is_active).length,C=c.filter(i=>!i.is_active).length,v=c.filter(i=>{const b=i.hire_date?new Date(i.hire_date):null,D=new Date;return D.setDate(D.getDate()-30),b&&b>D}).length;return N?e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Driver Management"}),e.jsx(I,{children:e.jsx(M,{className:"p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-destructive",children:["Error loading drivers: ",N.message]}),e.jsxs("div",{className:"mt-4 p-4 bg-gray-100 rounded text-left",children:[e.jsx("p",{children:e.jsx("strong",{children:"Debug Info:"})}),e.jsxs("p",{children:["Organization ID: ",(t==null?void 0:t.organization_id)||"Not available"]}),e.jsxs("p",{children:["Error details: ",JSON.stringify(N,null,2)]})]}),e.jsx(u,{onClick:()=>m(),className:"mt-4",children:"Try Again"})]})})})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Driver Management"}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Connection Status:"}),_==="testing"&&e.jsx("span",{className:"text-sm text-yellow-600",children:"Testing..."}),_==="connected"&&e.jsx("span",{className:"text-sm text-green-600",children:"Connected"}),_==="error"&&e.jsx("span",{className:"text-sm text-red-600",children:"Connection Error"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",onClick:async()=>{try{const{data:i,error:b}=await O.from("profiles").insert([{email:"john.driver@test.com",first_name:"John",last_name:"Driver",role:"driver",phone:"555-0123",organization_id:a==null?void 0:a.organization_id,is_active:!0,employment_status:"active",onboarding_status:"completed"},{email:"sarah.wilson@test.com",first_name:"Sarah",last_name:"Wilson",role:"driver",phone:"555-0456",organization_id:a==null?void 0:a.organization_id,is_active:!0,employment_status:"active",onboarding_status:"completed"}]).select();b?(console.error("Error adding sample drivers:",b),alert("Error adding sample drivers: "+b.message)):(console.log("Sample drivers added:",i),m(),alert("Sample drivers added successfully!"))}catch(i){console.error("Error:",i),alert("Error adding sample drivers")}},children:"Add Sample Drivers"}),e.jsxs(u,{onClick:()=>r(!0),children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Add Driver"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(I,{children:[e.jsxs(B,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(q,{className:"text-sm font-medium",children:"Total Drivers"}),e.jsx(Ee,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(M,{children:[e.jsx("div",{className:"text-2xl font-bold",children:j}),j===0&&!w&&e.jsx("div",{className:"mt-2 p-2 bg-yellow-50 rounded text-xs text-yellow-800",children:"No drivers found. Check console for debug info."})]})]}),e.jsxs(I,{children:[e.jsxs(B,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(q,{className:"text-sm font-medium",children:"Active Drivers"}),e.jsx(ue,{className:"h-4 w-4 text-green-600"})]}),e.jsx(M,{children:e.jsx("div",{className:"text-2xl font-bold",children:x})})]}),e.jsxs(I,{children:[e.jsxs(B,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(q,{className:"text-sm font-medium",children:"Inactive Drivers"}),e.jsx(xe,{className:"h-4 w-4 text-red-600"})]}),e.jsx(M,{children:e.jsx("div",{className:"text-2xl font-bold",children:C})})]}),e.jsxs(I,{children:[e.jsxs(B,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(q,{className:"text-sm font-medium",children:"New This Month"}),e.jsx(De,{className:"h-4 w-4 text-blue-600"})]}),e.jsx(M,{children:e.jsx("div",{className:"text-2xl font-bold",children:v})})]})]}),e.jsx(Xe,{drivers:c,isLoading:w,onPasswordChange:s}),e.jsx(We,{open:d,onOpenChange:r,onDriverAdded:E}),e.jsx(Qe,{isOpen:n,onClose:h,driver:t})]})}export{hs as default};
