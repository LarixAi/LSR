import{q as L,s as M,r as S,j as e,N as k,Z as z,D as re,b as ne,B as x,d as ie,e as te,f as ae,Y as m,I as u,i as j,n as g,F as A,a1 as le,H as de,O as q,k as D,l as T,a0 as ce,C as E,E as c}from"./main-piTIAPSx.js";import{u as J}from"./useQuery-Dbdyc74j.js";import{S as v,a as p,b as f,c as y,d as i}from"./select-Brm_N20Q.js";import{T as O,a as H,b as N,c as t,d as V,e as a}from"./table-CV1HM_JF.js";import{T as oe,a as he,b as F,c as I}from"./tabs-N5TLptOb.js";import{P as xe}from"./plus-CMGcTuiR.js";import{S as me}from"./search-HDsNrIL9.js";import{D as B}from"./download-C4W0Vf38.js";import"./index-Pp_niZQ8.js";const K=()=>{const{user:l,profile:d}=L();return J({queryKey:["infringements",d==null?void 0:d.organization_id],queryFn:async()=>{if(!(d!=null&&d.organization_id))throw new Error("Organization ID is required");console.log("Fetching infringements from database...");try{const{data:s,error:n}=await M.from("infringements").select(`
            *,
            driver:profiles!infringements_driver_id_fkey(id, first_name, last_name, email),
            vehicle:vehicles(id, vehicle_number, make, model),
            infringement_type_rel:infringement_types(*)
          `).eq("organization_id",d.organization_id).order("created_at",{ascending:!1});if(n){if(console.error("Error fetching infringements:",n),n.code==="42P01"||n.code==="42703")return console.warn("Infringements table or column not found, returning empty data"),[];throw n}return console.log("Fetched infringements:",s),s||[]}catch(s){return console.error("Error in useInfringements:",s),[]}},enabled:!!(d!=null&&d.organization_id)})},je=l=>{const{user:d,profile:s}=L();return J({queryKey:["driver_points_history",s==null?void 0:s.organization_id,l],queryFn:async()=>{if(!(s!=null&&s.organization_id))throw new Error("Organization ID is required");console.log("Fetching driver points history from database...");try{let n=M.from("driver_points_history").select("*").eq("organization_id",s.organization_id).order("recorded_date",{ascending:!1});const{data:h,error:o}=await n;if(o){if(console.error("Error fetching driver points history:",o),o.code==="42P01"||o.code==="42703")return console.warn("Driver points history table or column not found, returning empty data"),[];throw o}return console.log("Fetched driver points history:",h),h||[]}catch(n){return console.error("Error in useDriverPointsHistory:",n),[]}},enabled:!!(s!=null&&s.organization_id)})},ge=()=>{const{data:l=[]}=K();return je(),{total_infringements:l.length,pending_infringements:l.filter(s=>s.status==="pending").length,confirmed_infringements:l.filter(s=>s.status==="confirmed").length,resolved_infringements:l.filter(s=>s.status==="resolved").length,total_fines:l.reduce((s,n)=>s+(n.fine_amount||0),0),total_points:l.reduce((s,n)=>s+(n.penalty_points||n.points_deducted||0),0),by_severity:l.reduce((s,n)=>(s[n.severity]=(s[n.severity]||0)+1,s),{}),by_status:l.reduce((s,n)=>(s[n.status]=(s[n.status]||0)+1,s),{}),monthly_trend:l.reduce((s,n)=>{const h=new Date(n.created_at).toISOString().slice(0,7);return s[h]=(s[h]||0)+1,s},{})}},De=()=>{const{user:l,profile:d,loading:s}=L(),[n,h]=S.useState(""),[o,ue]=S.useState(""),[G,Q]=S.useState(!1),{data:b=[],isLoading:U}=K(),w=ge();if(s||U)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading infringement management..."})]})});if(!l||!d)return e.jsx(k,{to:"/auth",replace:!0});if(!["admin","council"].includes(d.role))return e.jsx(k,{to:"/unauthorized",replace:!0});b.filter(r=>{var C,P,R;const _=!n||r.description.toLowerCase().includes(n.toLowerCase())||(((C=r.driver)==null?void 0:C.first_name)||"").toLowerCase().includes(n.toLowerCase())||(((P=r.driver)==null?void 0:P.last_name)||"").toLowerCase().includes(n.toLowerCase())||(((R=r.vehicle)==null?void 0:R.vehicle_number)||"").toLowerCase().includes(n.toLowerCase()),se=!o||r.driver_id===o;return _&&se});const W=[{driverId:"1",driverName:"John Smith",totalInfringements:3,totalPoints:9,totalFines:450,riskLevel:"high"},{driverId:"2",driverName:"Sarah Johnson",totalInfringements:1,totalPoints:0,totalFines:80,riskLevel:"low"},{driverId:"3",driverName:"Mike Davis",totalInfringements:2,totalPoints:6,totalFines:380,riskLevel:"medium"}],Y=r=>{switch(r){case"pending":return e.jsx(c,{className:"bg-yellow-100 text-yellow-800 hover:bg-yellow-100",children:"Pending"});case"paid":return e.jsx(c,{className:"bg-green-100 text-green-800 hover:bg-green-100",children:"Paid"});case"disputed":return e.jsx(c,{className:"bg-blue-100 text-blue-800 hover:bg-blue-100",children:"Disputed"});case"overdue":return e.jsx(c,{className:"bg-red-100 text-red-800 hover:bg-red-100",children:"Overdue"});default:return e.jsx(c,{variant:"secondary",children:r})}},Z=r=>{switch(r){case"low":return e.jsx(c,{className:"bg-green-100 text-green-800 hover:bg-green-100",children:"Low Risk"});case"medium":return e.jsx(c,{className:"bg-yellow-100 text-yellow-800 hover:bg-yellow-100",children:"Medium Risk"});case"high":return e.jsx(c,{className:"bg-red-100 text-red-800 hover:bg-red-100",children:"High Risk"});default:return e.jsx(c,{variant:"secondary",children:r})}},X=w.total_fines,$=b.filter(r=>r.status==="pending").reduce((r,_)=>r+(_.fine_amount||0),0),ee=w.total_points;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx(z,{className:"w-8 h-8 text-red-600"}),"Infringement Management"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Track and manage driver infringements and violations"})]}),e.jsxs(re,{open:G,onOpenChange:Q,children:[e.jsx(ne,{asChild:!0,children:e.jsxs(x,{className:"bg-red-600 hover:bg-red-700",children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"Record Infringement"]})}),e.jsxs(ie,{className:"max-w-md",children:[e.jsx(te,{children:e.jsx(ae,{children:"Record New Infringement"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"driver",children:"Driver"}),e.jsxs(v,{children:[e.jsx(p,{children:e.jsx(f,{placeholder:"Select driver"})}),e.jsxs(y,{children:[e.jsx(i,{value:"john",children:"John Smith"}),e.jsx(i,{value:"sarah",children:"Sarah Johnson"}),e.jsx(i,{value:"mike",children:"Mike Davis"})]})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"vehicle",children:"Vehicle"}),e.jsxs(v,{children:[e.jsx(p,{children:e.jsx(f,{placeholder:"Select vehicle"})}),e.jsxs(y,{children:[e.jsx(i,{value:"LSR-001",children:"LSR-001"}),e.jsx(i,{value:"LSR-002",children:"LSR-002"}),e.jsx(i,{value:"LSR-003",children:"LSR-003"})]})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"type",children:"Infringement Type"}),e.jsxs(v,{children:[e.jsx(p,{children:e.jsx(f,{placeholder:"Select type"})}),e.jsxs(y,{children:[e.jsx(i,{value:"speeding",children:"Speeding"}),e.jsx(i,{value:"parking",children:"Parking Violation"}),e.jsx(i,{value:"weight",children:"Weight Violation"}),e.jsx(i,{value:"hours",children:"Driving Hours Violation"}),e.jsx(i,{value:"other",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"date",children:"Date"}),e.jsx(u,{id:"date",type:"date"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"location",children:"Location"}),e.jsx(u,{id:"location",placeholder:"Location of infringement"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"fine",children:"Fine Amount (£)"}),e.jsx(u,{id:"fine",type:"number",step:"0.01",placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"points",children:"Penalty Points"}),e.jsx(u,{id:"points",type:"number",placeholder:"0"})]}),e.jsx(x,{className:"w-full bg-red-600 hover:bg-red-700",children:"Record Infringement"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(j,{children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(A,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Infringements"}),e.jsx("p",{className:"text-2xl font-bold",children:w.total_infringements})]})]})})}),e.jsx(j,{children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(le,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Fines"}),e.jsxs("p",{className:"text-2xl font-bold",children:["£",X.toFixed(2)]})]})]})})}),e.jsx(j,{children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(de,{className:"w-8 h-8 text-yellow-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Pending Fines"}),e.jsxs("p",{className:"text-2xl font-bold text-yellow-600",children:["£",$.toFixed(2)]})]})]})})}),e.jsx(j,{children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(q,{className:"w-8 h-8 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Points"}),e.jsx("p",{className:"text-2xl font-bold",children:ee})]})]})})})]}),e.jsxs(oe,{defaultValue:"infringements",className:"space-y-6",children:[e.jsxs(he,{className:"grid w-full grid-cols-3",children:[e.jsx(F,{value:"infringements",children:"All Infringements"}),e.jsx(F,{value:"driver-summary",children:"Driver Summary"}),e.jsx(F,{value:"reports",children:"Reports & Analytics"})]}),e.jsx(I,{value:"infringements",className:"space-y-4",children:e.jsxs(j,{children:[e.jsxs(D,{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-5 h-5"}),"Infringement Records"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(me,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(u,{placeholder:"Search infringements...",value:n,onChange:r=>h(r.target.value),className:"pl-10"})]}),e.jsxs(v,{children:[e.jsx(p,{className:"w-48",children:e.jsx(f,{placeholder:"Filter by status"})}),e.jsxs(y,{children:[e.jsx(i,{value:"all",children:"All Status"}),e.jsx(i,{value:"pending",children:"Pending"}),e.jsx(i,{value:"paid",children:"Paid"}),e.jsx(i,{value:"disputed",children:"Disputed"}),e.jsx(i,{value:"overdue",children:"Overdue"})]})]})]})]}),e.jsx(g,{children:e.jsxs(O,{children:[e.jsx(H,{children:e.jsxs(N,{children:[e.jsx(t,{children:"Driver"}),e.jsx(t,{children:"Vehicle"}),e.jsx(t,{children:"Type"}),e.jsx(t,{children:"Date"}),e.jsx(t,{children:"Location"}),e.jsx(t,{children:"Fine Amount"}),e.jsx(t,{children:"Points"}),e.jsx(t,{children:"Status"}),e.jsx(t,{children:"Due Date"}),e.jsx(t,{children:"Actions"})]})}),e.jsx(V,{children:b.map(r=>e.jsxs(N,{children:[e.jsx(a,{className:"font-medium",children:r.driverName}),e.jsx(a,{children:r.vehicleNumber}),e.jsx(a,{children:r.infringementType}),e.jsx(a,{children:r.date}),e.jsx(a,{children:r.location}),e.jsxs(a,{children:["£",r.fineAmount.toFixed(2)]}),e.jsx(a,{children:r.points}),e.jsx(a,{children:Y(r.status)}),e.jsx(a,{children:r.dueDate}),e.jsx(a,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",children:e.jsx(ce,{className:"w-4 h-4"})}),e.jsx(x,{variant:"outline",size:"sm",children:e.jsx(B,{className:"w-4 h-4"})})]})})]},r.id))})]})})]})}),e.jsx(I,{value:"driver-summary",className:"space-y-4",children:e.jsxs(j,{children:[e.jsx(D,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5"}),"Driver Risk Summary"]})}),e.jsx(g,{children:e.jsxs(O,{children:[e.jsx(H,{children:e.jsxs(N,{children:[e.jsx(t,{children:"Driver Name"}),e.jsx(t,{children:"Total Infringements"}),e.jsx(t,{children:"Total Points"}),e.jsx(t,{children:"Total Fines"}),e.jsx(t,{children:"Risk Level"}),e.jsx(t,{children:"Actions"})]})}),e.jsx(V,{children:W.map(r=>e.jsxs(N,{children:[e.jsx(a,{className:"font-medium",children:r.driverName}),e.jsx(a,{children:r.totalInfringements}),e.jsx(a,{children:r.totalPoints}),e.jsxs(a,{children:["£",r.totalFines.toFixed(2)]}),e.jsx(a,{children:Z(r.riskLevel)}),e.jsx(a,{children:e.jsx(x,{variant:"outline",size:"sm",children:"View Details"})})]},r.driverId))})]})})]})}),e.jsx(I,{value:"reports",className:"space-y-4",children:e.jsxs(j,{children:[e.jsx(D,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5"}),"Reports & Analytics"]})}),e.jsx(g,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(A,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Infringement Analytics"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Generate detailed reports on driver behavior, infringement trends, and risk analysis."}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsxs(x,{className:"bg-red-600 hover:bg-red-700",children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"Monthly Report"]}),e.jsxs(x,{variant:"outline",children:[e.jsx(E,{className:"w-4 h-4 mr-2"}),"Custom Date Range"]})]})]})})]})})]})]})};export{De as default};
