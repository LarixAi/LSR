import{q,s as x,J as k,$ as p,r as P,j as e,V as M,N as O,F as T,D as K,b as R,B as D,d as A,e as U,f as G,Y as h,I as m,i as f,n as _,v as W,a1 as Y,k as $,l as X,a0 as Z,E as Q}from"./main-piTIAPSx.js";import{S as ee,a as se,b as re,c as te,d as F}from"./select-Brm_N20Q.js";import{T as ae,a as ie,b as E,c as u,d as ne,e as d}from"./table-CV1HM_JF.js";import{u as le}from"./useQuery-Dbdyc74j.js";import{u as z}from"./useMutation-B8vlA97s.js";import{u as oe}from"./useDrivers-CJ7MVxZO.js";import{b as ce}from"./useVehicles-C0CqQMfj.js";import{P as de}from"./plus-CMGcTuiR.js";import{C as he}from"./circle-check-big-CD0jvDn0.js";import{S as me}from"./search-HDsNrIL9.js";import{S as ue}from"./square-pen-DnuZJKej.js";import"./index-Pp_niZQ8.js";const V=()=>{const{user:a,profile:t}=q();return le({queryKey:["jobs",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))throw new Error("Organization ID is required");console.log("Fetching jobs from database...");try{const{data:r,error:l}=await x.from("jobs").select("*").eq("organization_id",t.organization_id).order("created_at",{ascending:!1});if(l){if(console.error("Error fetching jobs:",l),l.code==="42P01"||l.code==="PGRST200")return console.warn("jobs table not found or foreign key relationship issue, returning empty data"),[];throw l}if(!r||r.length===0)return[];const o=r.filter(n=>n.assigned_driver_id).map(n=>n.assigned_driver_id),N=r.filter(n=>n.assigned_vehicle_id).map(n=>n.assigned_vehicle_id),b=r.filter(n=>n.created_by).map(n=>n.created_by),[i,c,C]=await Promise.all([o.length>0?x.from("profiles").select("*").in("id",o):Promise.resolve({data:[],error:null}),N.length>0?x.from("vehicles").select("*").in("id",N):Promise.resolve({data:[],error:null}),b.length>0?x.from("profiles").select("*").in("id",b):Promise.resolve({data:[],error:null})]),w=r.map(n=>{var J,S,y;const g=(J=i.data)==null?void 0:J.find(s=>s.id===n.assigned_driver_id),v=(S=c.data)==null?void 0:S.find(s=>s.id===n.assigned_vehicle_id),L=(y=C.data)==null?void 0:y.find(s=>s.id===n.created_by);return{...n,assigned_driver:g||null,assigned_vehicle:v||null,creator:L||null}});return console.log("Fetched jobs with relations:",w),w||[]}catch(r){return console.error("Error in useJobs:",r),[]}},enabled:!!(t!=null&&t.organization_id)})},xe=()=>{const{profile:a}=q(),t=k();return z({mutationFn:async r=>{if(!(a!=null&&a.organization_id)||!(a!=null&&a.id))throw new Error("Organization and user information required");const{data:l,error:o}=await x.from("jobs").insert({...r,organization_id:a.organization_id,created_by:a.id}).select().single();if(o)throw o;return l},onSuccess:()=>{t.invalidateQueries({queryKey:["jobs"]}),p.success("Job created successfully")},onError:r=>{console.error("Error creating job:",r),p.error("Failed to create job: "+r.message)}})},ge=()=>{const a=k();return z({mutationFn:async({id:t,updates:r})=>{const{data:l,error:o}=await x.from("jobs").update(r).eq("id",t).select().single();if(o)throw o;return l},onSuccess:()=>{a.invalidateQueries({queryKey:["jobs"]}),p.success("Job updated successfully")},onError:t=>{console.error("Error updating job:",t),p.error("Failed to update job: "+t.message)}})},je=()=>{const a=k();return z({mutationFn:async t=>{const{error:r}=await x.from("jobs").delete().eq("id",t);if(r)throw r},onSuccess:()=>{a.invalidateQueries({queryKey:["jobs"]}),p.success("Job deleted successfully")},onError:t=>{console.error("Error deleting job:",t),p.error("Failed to delete job: "+t.message)}})},pe=()=>{const{data:a=[]}=V();return{total:a.length,pending:a.filter(r=>r.status==="pending").length,assigned:a.filter(r=>r.status==="assigned").length,in_progress:a.filter(r=>r.status==="in_progress").length,completed:a.filter(r=>r.status==="completed").length,cancelled:a.filter(r=>r.status==="cancelled").length,high_priority:a.filter(r=>r.priority==="high"||r.priority==="urgent").length}},Le=()=>{const{user:a,profile:t,loading:r}=q(),[l,o]=P.useState(""),[N,b]=P.useState(!1),[i,c]=P.useState({title:"",description:"",priority:"medium",pickup_location:"",delivery_location:"",customer_name:"",customer_contact:"",start_date:"",end_date:"",assigned_driver_id:"",assigned_vehicle_id:""}),{data:C=[],isLoading:w,error:n}=V(),g=pe();oe(),ce();const v=xe();if(ge(),je(),r||w)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx(M,{className:"h-8 w-8 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading job management..."})]})});if(!a||!t)return e.jsx(O,{to:"/auth",replace:!0});if(!["admin","council"].includes(t.role))return e.jsx(O,{to:"/unauthorized",replace:!0});const L=async()=>{try{await v.mutateAsync(i),b(!1),c({title:"",description:"",priority:"medium",pickup_location:"",delivery_location:"",customer_name:"",customer_contact:"",start_date:"",end_date:"",assigned_driver_id:"",assigned_vehicle_id:""})}catch(s){console.error("Failed to create job:",s)}},J=s=>{const j={pending:"bg-yellow-100 text-yellow-800",assigned:"bg-blue-100 text-blue-800",in_progress:"bg-purple-100 text-purple-800",completed:"bg-green-100 text-green-800",cancelled:"bg-red-100 text-red-800"};return e.jsx(Q,{className:j[s]||"bg-gray-100 text-gray-800",children:s==null?void 0:s.replace("_"," ")})},S=s=>{const j={low:"bg-gray-100 text-gray-800",medium:"bg-blue-100 text-blue-800",high:"bg-orange-100 text-orange-800",urgent:"bg-red-100 text-red-800"};return e.jsx(Q,{className:j[s]||"bg-gray-100 text-gray-800",children:s})},y=C.filter(s=>{var j,I,B,H;return((j=s.title)==null?void 0:j.toLowerCase().includes(l.toLowerCase()))||((I=s.customer_name)==null?void 0:I.toLowerCase().includes(l.toLowerCase()))||((B=s.job_number)==null?void 0:B.toLowerCase().includes(l.toLowerCase()))||((H=s.description)==null?void 0:H.toLowerCase().includes(l.toLowerCase()))});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx(T,{className:"w-8 h-8 text-blue-600"}),"Job Management"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Create, assign, and track transport jobs"})]}),e.jsxs(K,{open:N,onOpenChange:b,children:[e.jsx(R,{asChild:!0,children:e.jsxs(D,{className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"Create Job"]})}),e.jsxs(A,{className:"max-w-2xl",children:[e.jsx(U,{children:e.jsx(G,{children:"Create New Job"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"job-title",children:"Job Title *"}),e.jsx(m,{id:"job-title",placeholder:"Enter job title",value:i.title,onChange:s=>c({...i,title:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"customer",children:"Customer Name *"}),e.jsx(m,{id:"customer",placeholder:"Customer name",value:i.customer_name,onChange:s=>c({...i,customer_name:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"pickup",children:"Pickup Location"}),e.jsx(m,{id:"pickup",placeholder:"Pickup address",value:i.pickup_location,onChange:s=>c({...i,pickup_location:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"delivery",children:"Delivery Location"}),e.jsx(m,{id:"delivery",placeholder:"Delivery address",value:i.delivery_location,onChange:s=>c({...i,delivery_location:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"start-date",children:"Start Date"}),e.jsx(m,{id:"start-date",type:"date",value:i.start_date,onChange:s=>c({...i,start_date:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"priority",children:"Priority"}),e.jsxs(ee,{value:i.priority,onValueChange:s=>c({...i,priority:s}),children:[e.jsx(se,{children:e.jsx(re,{placeholder:"Select priority"})}),e.jsxs(te,{children:[e.jsx(F,{value:"low",children:"Low"}),e.jsx(F,{value:"medium",children:"Medium"}),e.jsx(F,{value:"high",children:"High"}),e.jsx(F,{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(h,{htmlFor:"description",children:"Description"}),e.jsx(m,{id:"description",placeholder:"Job description",value:i.description,onChange:s=>c({...i,description:s.target.value})})]}),e.jsx("div",{className:"col-span-2",children:e.jsx(D,{className:"w-full bg-blue-600 hover:bg-blue-700",onClick:L,disabled:v.isPending||!i.title||!i.customer_name,children:v.isPending?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"w-4 h-4 mr-2 animate-spin"}),"Creating..."]}):"Create Job"})})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(f,{children:e.jsx(_,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(T,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Jobs"}),e.jsx("p",{className:"text-2xl font-bold",children:g.total})]})]})})}),e.jsx(f,{children:e.jsx(_,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(he,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"In Progress"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:g.in_progress})]})]})})}),e.jsx(f,{children:e.jsx(_,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(W,{className:"w-8 h-8 text-yellow-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Pending"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:g.pending})]})]})})}),e.jsx(f,{children:e.jsx(_,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Completed"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:g.completed})]})]})})})]}),e.jsxs(f,{children:[e.jsxs($,{children:[e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"w-5 h-5"}),"Job List"]}),e.jsx("div",{className:"flex gap-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(me,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(m,{placeholder:"Search jobs...",value:l,onChange:s=>o(s.target.value),className:"pl-10"})]})})]}),e.jsx(_,{children:e.jsxs(ae,{children:[e.jsx(ie,{children:e.jsxs(E,{children:[e.jsx(u,{children:"Job Number"}),e.jsx(u,{children:"Title"}),e.jsx(u,{children:"Customer"}),e.jsx(u,{children:"Priority"}),e.jsx(u,{children:"Status"}),e.jsx(u,{children:"Created"}),e.jsx(u,{children:"Actions"})]})}),e.jsx(ne,{children:y.length===0?e.jsx(E,{children:e.jsx(d,{colSpan:7,className:"text-center py-8 text-gray-500",children:C.length===0?"No jobs found. Create your first job to get started.":"No jobs match your search criteria."})}):y.map(s=>e.jsxs(E,{children:[e.jsx(d,{className:"font-medium",children:s.job_number||s.id.slice(0,8)}),e.jsx(d,{children:s.title||"Untitled Job"}),e.jsx(d,{children:s.customer_name||"No customer"}),e.jsx(d,{children:S(s.priority||"medium")}),e.jsx(d,{children:J(s.status||"pending")}),e.jsx(d,{children:new Date(s.created_at).toLocaleDateString()}),e.jsx(d,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(D,{variant:"outline",size:"sm",children:e.jsx(Z,{className:"w-4 h-4"})}),e.jsx(D,{variant:"outline",size:"sm",children:e.jsx(ue,{className:"w-4 h-4"})})]})})]},s.id))})]})})]})]})};export{Le as default};
