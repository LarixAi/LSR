import{q as X,J as $,r as l,s as h,P as S,j as e,i as _,k as R,l as O,bf as c,E as N,m as K,D as G,b as U,B as i,d as Z,e as ee,f as se,g as ae,a6 as te,n as k,v as ne,X as ie,bd as re,bg as le,I as ce}from"./main-piTIAPSx.js";import{u as D}from"./useQuery-Dbdyc74j.js";import{u as P}from"./useMutation-B8vlA97s.js";import{S as T,a as Q,b as B,c as J,d as Y}from"./select-Brm_N20Q.js";import{T as de}from"./textarea-mxcr8nPj.js";import{P as y}from"./plus-CMGcTuiR.js";import{C as oe}from"./circle-check-big-CD0jvDn0.js";import{S as I}from"./search-HDsNrIL9.js";const be=({onOrganizationSelect:p,selectedOrganizationId:d})=>{const{profile:a}=X(),x=$(),[V,o]=l.useState(!1),[u,b]=l.useState(""),[E,F]=l.useState(""),[r,A]=l.useState(""),[w,H]=l.useState(!1),{data:n=[],isLoading:me,error:he}=D({queryKey:["active-mechanic-organizations",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:s,error:t}=await h.from("mechanic_organization_requests").select(`
          *,
          organization:organizations(*)
        `).eq("mechanic_id",a.id).in("status",["active","approved"]).order("created_at",{ascending:!1});return t?(console.error("Error fetching active organizations:",t),[]):(s==null?void 0:s.map(z=>z.organization))||[]},enabled:!!(a!=null&&a.id)&&a.role==="mechanic"}),{data:q=[]}=D({queryKey:["pending-mechanic-requests",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:s,error:t}=await h.from("mechanic_organization_requests").select(`
          *,
          organization:organizations(*)
        `).eq("mechanic_id",a.id).eq("status","pending").order("created_at",{ascending:!1});return t?(console.error("Error fetching pending requests:",t),[]):s||[]},enabled:!!(a!=null&&a.id)&&a.role==="mechanic"}),{data:j=[]}=D({queryKey:["available-organizations-for-requests",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:s,error:t}=await h.rpc("get_available_organizations_for_mechanic",{mechanic_uuid:a.id});return t?(console.error("Error fetching available organizations:",t),[]):s||[]},enabled:!!(a!=null&&a.id)&&a.role==="mechanic"}),f=P({mutationFn:async({organizationId:s,message:t})=>{const{data:z,error:M}=await h.from("mechanic_organization_requests").insert({mechanic_id:a==null?void 0:a.id,organization_id:s,request_type:"mechanic_to_org",requested_by:a==null?void 0:a.id,message:t.trim()||null}).select().single();if(M)throw M;return z},onSuccess:()=>{S({title:"Request Sent",description:"Your request has been sent to the organization."}),o(!1),b(""),F(""),x.invalidateQueries({queryKey:["pending-mechanic-requests"]}),x.invalidateQueries({queryKey:["available-organizations-for-requests"]})},onError:s=>{S({title:"Error",description:s.message||"Failed to send request.",variant:"destructive"})}}),L=P({mutationFn:async s=>{const{error:t}=await h.from("mechanic_organization_requests").update({status:"terminated",terminated_by:a==null?void 0:a.id,terminated_at:new Date().toISOString(),termination_reason:"Cancelled by mechanic"}).eq("id",s);if(t)throw t},onSuccess:()=>{S({title:"Request Cancelled",description:"Your request has been cancelled."}),x.invalidateQueries({queryKey:["pending-mechanic-requests"]}),x.invalidateQueries({queryKey:["available-organizations-for-requests"]})}});if(l.useEffect(()=>{var s;n&&n.length>0&&!d&&p((s=n[0])==null?void 0:s.id)},[n,d,p]),(a==null?void 0:a.role)!=="mechanic")return null;const g=n.find(s=>(s==null?void 0:s.id)===d),v=n.length,W=q.length,C=v<3,m=j.filter(s=>s.name.toLowerCase().includes(r.toLowerCase())||s.type.toLowerCase().includes(r.toLowerCase())||s.slug&&s.slug.toLowerCase().includes(r.toLowerCase()));return e.jsxs("div",{className:"mb-6 space-y-4",children:[e.jsxs(_,{children:[e.jsx(R,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(O,{className:"text-lg flex items-center space-x-2",children:[e.jsx(c,{className:"h-5 w-5"}),e.jsx("span",{children:"Working Organizations"}),e.jsxs(N,{variant:"outline",className:"ml-2",children:[v,"/3 Active"]})]}),e.jsx(K,{children:"Select which company you want to work with"})]}),C&&e.jsxs(G,{open:V,onOpenChange:o,children:[e.jsx(U,{asChild:!0,children:e.jsxs(i,{size:"sm",className:"flex items-center space-x-2",children:[e.jsx(y,{className:"h-4 w-4"}),e.jsx("span",{children:"Request to Join"})]})}),e.jsxs(Z,{children:[e.jsxs(ee,{children:[e.jsx(se,{children:"Request to Join Organization"}),e.jsx(ae,{children:"Send a request to join a new organization. You can work with up to 3 companies."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Organization"}),e.jsxs(T,{value:u,onValueChange:b,children:[e.jsx(Q,{children:e.jsx(B,{placeholder:"Choose an organization..."})}),e.jsx(J,{children:j.map(s=>e.jsx(Y,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Message (Optional)"}),e.jsx(de,{placeholder:"Tell them why you'd like to work with them...",value:E,onChange:s=>F(s.target.value),rows:3})]})]}),e.jsxs(te,{children:[e.jsx(i,{variant:"outline",onClick:()=>o(!1),children:"Cancel"}),e.jsx(i,{onClick:()=>{u&&f.mutate({organizationId:u,message:E})},disabled:!u||f.isPending,children:f.isPending?"Sending...":"Send Request"})]})]})]})]})}),e.jsx(k,{children:n.length>0?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Select Organization"}),e.jsxs(T,{value:d||"",onValueChange:p,children:[e.jsx(Q,{className:"w-full",children:e.jsx(B,{placeholder:"Choose an organization..."})}),e.jsx(J,{children:n.map(s=>e.jsx(Y,{value:s==null?void 0:s.id,children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(c,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{children:s==null?void 0:s.name}),d===(s==null?void 0:s.id)&&e.jsx(oe,{className:"h-4 w-4 text-blue-600 ml-auto"})]})},s==null?void 0:s.id))})]})]}),g&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-full",children:e.jsx(c,{className:"h-4 w-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-900",children:g==null?void 0:g.name}),e.jsxs("p",{className:"text-sm text-blue-600",children:["Currently active â€¢ ",v," organization",v>1?"s":""," available"]})]})]}),e.jsx(N,{variant:"secondary",className:"bg-blue-100 text-blue-700",children:"Active"})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(c,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Active Organizations"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"You need to request to join organizations to start working."}),C&&e.jsxs(i,{onClick:()=>o(!0),children:[e.jsx(y,{className:"h-4 w-4 mr-2"}),"Request to Join Organization"]})]})})]}),q.length>0&&e.jsxs(_,{children:[e.jsx(R,{children:e.jsxs(O,{className:"text-lg flex items-center space-x-2",children:[e.jsx(ne,{className:"h-5 w-5"}),e.jsx("span",{children:"Pending Requests"}),e.jsx(N,{variant:"outline",children:W})]})}),e.jsx(k,{children:e.jsx("div",{className:"space-y-3",children:q.map(s=>{var t;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(c,{className:"h-5 w-5 text-orange-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:(t=s.organization)==null?void 0:t.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Requested ",new Date(s.created_at).toLocaleDateString()]}),s.message&&e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:['"',s.message,'"']})]})]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>L.mutate(s.id),disabled:L.isPending,children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),"Cancel"]})]},s.id)})})})]}),j.length>0&&C&&e.jsxs(_,{children:[e.jsxs(R,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(O,{className:"text-lg flex items-center space-x-2",children:[e.jsx(y,{className:"h-5 w-5"}),e.jsx("span",{children:"Available Organizations"}),e.jsx(N,{variant:"outline",children:j.length})]}),e.jsx(i,{variant:"ghost",size:"sm",onClick:()=>H(!w),className:"p-1 h-8 w-8",children:w?e.jsx(re,{className:"h-4 w-4"}):e.jsx(le,{className:"h-4 w-4"})})]}),e.jsx(K,{children:"Organizations you can request to join"})]}),w&&e.jsxs(k,{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(I,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(ce,{placeholder:"Search organizations by name, type, or slug...",value:r,onChange:s=>A(s.target.value),className:"pl-10"})]})}),e.jsx("div",{className:"grid gap-3",children:m.length>0?m.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(c,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600",children:s.type}),s.slug&&e.jsxs("p",{className:"text-xs text-gray-500",children:["@",s.slug]})]})]}),e.jsxs(i,{size:"sm",onClick:()=>{b(s.id),o(!0)},children:[e.jsx(y,{className:"h-4 w-4 mr-1"}),"Request"]})]},s.id)):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(I,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Organizations Found"}),e.jsx("p",{className:"text-gray-600",children:r?`No organizations match "${r}"`:"No organizations available to request"}),r&&e.jsx(i,{variant:"outline",size:"sm",onClick:()=>A(""),className:"mt-2",children:"Clear Search"})]})}),m.length>5&&e.jsx("div",{className:"mt-3 text-center",children:e.jsxs("p",{className:"text-sm text-gray-500",children:["Showing ",Math.min(5,m.length)," of ",m.length," organizations"]})})]})]})]})};export{be as O};
