import{c as _e,q as be,a as we,J as Ce,r as f,s as N,j as e,i as O,k as I,l as $,x as ue,n as B,Y as m,E,B as p,a0 as De,D as ee,d as se,e as ae,f as te,F as fe,S as Me,O as Ue,I as k,N as Te}from"./main-piTIAPSx.js";import{S as A,a as q,b as R,c as V,d}from"./select-Brm_N20Q.js";import{T as Se,a as ke,b as G,c as _,d as ze,e as j}from"./table-CV1HM_JF.js";import{T as Le,a as Ee,b as ce,c as oe}from"./tabs-N5TLptOb.js";import{u as W}from"./useQuery-Dbdyc74j.js";import{u as ge}from"./useMutation-B8vlA97s.js";import{P as Pe}from"./progress-nJfMQ3MC.js";import{D as Oe}from"./download-C4W0Vf38.js";import{T as je}from"./textarea-mxcr8nPj.js";import{U as ve}from"./upload-CgVQC7ku.js";import{C as Ne}from"./circle-check-big-CD0jvDn0.js";import{S as pe}from"./search-HDsNrIL9.js";import{S as Fe}from"./square-pen-DnuZJKej.js";import{D as Ae}from"./database-BK6ac866.js";import{C as Ie}from"./circle-alert-9v4QUdZ6.js";import"./index-Pp_niZQ8.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=_e("Bluetooth",[["path",{d:"m7 7 10 10-5 5V2l5 5L7 17",key:"1q5490"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=_e("FileDown",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M12 18v-6",key:"17g6i2"}],["path",{d:"m9 15 3 3 3-3",key:"1npd3o"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=_e("Usb",[["circle",{cx:"10",cy:"7",r:"1",key:"dypaad"}],["circle",{cx:"4",cy:"20",r:"1",key:"22iqad"}],["path",{d:"M4.7 19.3 19 5",key:"1enqfc"}],["path",{d:"m21 3-3 1 2 2Z",key:"d3ov82"}],["path",{d:"M9.26 7.68 5 12l2 5",key:"1esawj"}],["path",{d:"m10 14 5 2 3.5-3.5",key:"v8oal5"}],["path",{d:"m18 12 1-1 1 1-1 1Z",key:"1bh22v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=_e("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Ke=({onDataDownloaded:r})=>{const{profile:t}=be(),{toast:P}=we(),D=Ce(),[M,z]=f.useState(!1),[ie,K]=f.useState(!1),[H,n]=f.useState(0),[S,re]=f.useState(null),[o,he]=f.useState(null),[U,c]=f.useState(""),[me,ne]=f.useState(!1),[J,w]=f.useState(!1),{data:Q=[],isLoading:ye}=W({queryKey:["card-readers",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:s,error:i}=await N.from("tachograph_card_readers").select("*").eq("organization_id",t.organization_id).eq("status","active");return i?(console.error("Error fetching card readers:",i),[]):s||[]},enabled:!!(t!=null&&t.organization_id)}),{data:T=[]}=W({queryKey:["download-sessions",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:s,error:i}=await N.from("tachograph_download_sessions").select("*").eq("organization_id",t.organization_id).order("download_start_time",{ascending:!1}).limit(10);return i?(console.error("Error fetching download sessions:",i),[]):s||[]},enabled:!!(t!=null&&t.organization_id)});W({queryKey:["vehicles",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:s,error:i}=await N.from("vehicles").select("id, vehicle_number, license_plate").eq("organization_id",t.organization_id);return i?[]:s||[]},enabled:!!(t!=null&&t.organization_id)}),W({queryKey:["drivers",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:s,error:i}=await N.from("profiles").select("id, first_name, last_name").eq("organization_id",t.organization_id).eq("role","driver");return i?[]:s||[]},enabled:!!(t!=null&&t.organization_id)});const le=async()=>{if(!U){P({title:"No Reader Selected",description:"Please select a card reader first",variant:"destructive"});return}try{z(!1),n(0),await new Promise(s=>setTimeout(s,2e3)),z(!0),P({title:"Connected",description:"Successfully connected to card reader"})}catch(s){console.error("Failed to connect to card reader:",s),P({title:"Connection Failed",description:"Failed to connect to card reader",variant:"destructive"})}},L=async()=>{if(M)try{await new Promise(i=>setTimeout(i,1e3));const s={type:"driver",info:{number:"DRIVER123456789",holder:"John Smith",expiry:"2025-12-31",type:"Driver Card"}};re(s.type),he(s.info),P({title:"Card Detected",description:`${s.info.type} detected`})}catch(s){console.error("Failed to detect card:",s),P({title:"Card Detection Failed",description:"Failed to detect card in reader",variant:"destructive"})}},Y=async()=>{if(!(!M||!S||!U)){K(!0),n(0);try{const{data:s,error:i}=await N.from("tachograph_download_sessions").insert({organization_id:t==null?void 0:t.organization_id,card_reader_id:U,card_type:S,card_number:(o==null?void 0:o.number)||"Unknown",download_status:"in_progress"}).select().single();if(i)throw i;const v=[{progress:10,message:"Initializing download..."},{progress:25,message:"Reading card data..."},{progress:50,message:"Processing records..."},{progress:75,message:"Validating data..."},{progress:90,message:"Saving to database..."},{progress:100,message:"Download complete!"}];for(const g of v)await new Promise(C=>setTimeout(C,800)),n(g.progress);const u=Z(S,o),{error:x}=await N.from("tachograph_records").insert(u.map(g=>({...g,organization_id:t==null?void 0:t.organization_id,card_type:S,card_number:o==null?void 0:o.number,card_holder_name:o==null?void 0:o.holder,download_method:"card_reader"})));if(x)throw x;await N.from("tachograph_download_sessions").update({download_status:"completed",download_end_time:new Date().toISOString(),records_downloaded:u.length}).eq("id",s.id),r({cardType:S,cardNumber:(o==null?void 0:o.number)||"",cardHolderName:(o==null?void 0:o.holder)||"",cardExpiryDate:(o==null?void 0:o.expiry)||"",downloadDate:new Date().toISOString(),recordsCount:u.length,violationsCount:u.filter(g=>g.violations&&g.violations.length>0).length,filePath:`downloads/${s.id}.ddd`}),D.invalidateQueries({queryKey:["tachograph-records"]}),D.invalidateQueries({queryKey:["download-sessions"]}),P({title:"Download Complete",description:`Successfully downloaded ${u.length} records from ${S} card`})}catch(s){console.error("Download failed:",s),P({title:"Download Failed",description:"Failed to download card data",variant:"destructive"})}finally{K(!1),n(0)}}},Z=(s,i)=>{const v=[],u=new Date;for(let x=0;x<7;x++){const g=new Date(u);g.setDate(g.getDate()-x);const C=new Date(g);C.setHours(6+Math.floor(Math.random()*4),Math.floor(Math.random()*60));const b=new Date(C);b.setHours(C.getHours()+8+Math.floor(Math.random()*4)),(b.getTime()-C.getTime())/(1e3*60*60);const h=[];if(Math.random()<.15){const X=["Driving time exceeded","Insufficient rest period","Daily driving limit exceeded","Weekly driving limit exceeded","Tachograph card not inserted"];h.push(X[Math.floor(Math.random()*X.length)])}v.push({record_date:g.toISOString().split("T")[0],start_time:C.toTimeString().split(" ")[0],end_time:b.toTimeString().split(" ")[0],activity_type:"driving",distance_km:Math.floor(Math.random()*200)+50,start_location:"Depot",end_location:"Destination",raw_data:{},violations:h,is_validated:!1})}return v},a=s=>{switch(s){case"usb_reader":return e.jsx(Re,{className:"h-4 w-4"});case"bluetooth_reader":return e.jsx($e,{className:"h-4 w-4"});case"digivu_plus":case"generation_2":return e.jsx(Be,{className:"h-4 w-4"});default:return e.jsx(ue,{className:"h-4 w-4"})}},l=s=>{const i={active:"bg-green-100 text-green-800",inactive:"bg-gray-100 text-gray-800",maintenance:"bg-yellow-100 text-yellow-800",calibration_due:"bg-red-100 text-red-800"};return e.jsx(E,{className:i[s]||"bg-gray-100 text-gray-800",children:s.replace("_"," ").toUpperCase()})},y=s=>{const i={completed:"bg-green-100 text-green-800",in_progress:"bg-blue-100 text-blue-800",failed:"bg-red-100 text-red-800",partial:"bg-yellow-100 text-yellow-800"};return e.jsx(E,{className:i[s]||"bg-gray-100 text-gray-800",children:s.replace("_"," ").toUpperCase()})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(O,{children:[e.jsx(I,{children:e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-5 w-5"}),"Card Reader"]})}),e.jsxs(B,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"card-reader",children:"Select Card Reader"}),e.jsxs(A,{value:U,onValueChange:c,children:[e.jsx(q,{children:e.jsx(R,{placeholder:"Choose a card reader"})}),e.jsx(V,{children:Q.map(s=>e.jsx(d,{value:s.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[a(s.device_type),e.jsx("span",{children:s.device_name}),l(s.status)]})},s.id))})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Reader Status"}),e.jsx(E,{variant:M?"default":"secondary",children:M?"Connected":"Disconnected"})]}),!M&&e.jsxs(p,{onClick:le,className:"w-full",disabled:!U,children:[e.jsx(Re,{className:"mr-2 h-4 w-4"}),"Connect to Card Reader"]}),M&&!S&&e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Insert a tachograph card to begin"}),e.jsxs(p,{onClick:L,variant:"outline",children:[e.jsx(ue,{className:"mr-2 h-4 w-4"}),"Detect Card"]})]}),o&&e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("h3",{className:"font-medium mb-2",children:"Card Information"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",S]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Number:"})," ",o.number]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Holder:"})," ",o.holder]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Expiry:"})," ",o.expiry]})]})]}),ie&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Downloading data..."}),e.jsxs("span",{children:[H,"%"]})]}),e.jsx(Pe,{value:H})]}),S&&!ie&&e.jsxs(p,{onClick:Y,className:"w-full",disabled:!M,children:[e.jsx(Oe,{className:"mr-2 h-4 w-4"}),"Download ",S," Card Data"]})]})]}),e.jsxs(O,{children:[e.jsx(I,{children:e.jsxs($,{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-5 w-5"}),"Recent Downloads"]}),e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>w(!0),children:[e.jsx(De,{className:"h-4 w-4"}),"View All"]})]})}),e.jsx(B,{children:e.jsxs("div",{className:"space-y-3",children:[T.slice(0,5).map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ue,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-sm",children:[s.card_type.charAt(0).toUpperCase()+s.card_type.slice(1)," Card"]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.card_number," • ",new Date(s.download_start_time).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[y(s.download_status),s.records_downloaded>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.records_downloaded," records"]})]})]},s.id)),T.length===0&&e.jsxs("div",{className:"text-center py-4 text-muted-foreground",children:[e.jsx(qe,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No recent downloads"})]})]})})]}),e.jsx(ee,{open:me,onOpenChange:ne,children:e.jsxs(se,{className:"max-w-2xl",children:[e.jsx(ae,{children:e.jsx(te,{children:"Card Reader Settings"})}),e.jsxs(Le,{defaultValue:"readers",className:"w-full",children:[e.jsxs(Ee,{className:"grid w-full grid-cols-2",children:[e.jsx(ce,{value:"readers",children:"Card Readers"}),e.jsx(ce,{value:"settings",children:"Settings"})]}),e.jsx(oe,{value:"readers",className:"space-y-4",children:e.jsx("div",{className:"space-y-4",children:Q.map(s=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[a(s.device_type),e.jsx("span",{className:"font-medium",children:s.device_name})]}),l(s.status)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{children:["Serial: ",s.serial_number]}),e.jsxs("div",{children:["Firmware: ",s.firmware_version]}),e.jsxs("div",{children:["Last Cal: ",s.last_calibration_date||"Never"]}),e.jsxs("div",{children:["Next Cal: ",s.next_calibration_due||"Not set"]})]})]},s.id))})}),e.jsx(oe,{value:"settings",className:"space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"auto-download",children:"Auto Download"}),e.jsxs(A,{defaultValue:"disabled",children:[e.jsx(q,{children:e.jsx(R,{})}),e.jsxs(V,{children:[e.jsx(d,{value:"disabled",children:"Disabled"}),e.jsx(d,{value:"daily",children:"Daily"}),e.jsx(d,{value:"weekly",children:"Weekly"})]})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"download-format",children:"Download Format"}),e.jsxs(A,{defaultValue:"ddd",children:[e.jsx(q,{children:e.jsx(R,{})}),e.jsxs(V,{children:[e.jsx(d,{value:"ddd",children:"DDD (Digital)"}),e.jsx(d,{value:"tgd",children:"TGD (Tachograph)"}),e.jsx(d,{value:"c1b",children:"C1B (Card)"})]})]})]})]})})]})]})}),e.jsx(ee,{open:J,onOpenChange:w,children:e.jsxs(se,{className:"max-w-4xl",children:[e.jsx(ae,{children:e.jsx(te,{children:"Download History"})}),e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(Se,{children:[e.jsx(ke,{children:e.jsxs(G,{children:[e.jsx(_,{children:"Date"}),e.jsx(_,{children:"Card Type"}),e.jsx(_,{children:"Card Number"}),e.jsx(_,{children:"Status"}),e.jsx(_,{children:"Records"}),e.jsx(_,{children:"Duration"})]})}),e.jsx(ze,{children:T.map(s=>e.jsxs(G,{children:[e.jsx(j,{children:new Date(s.download_start_time).toLocaleDateString()}),e.jsx(j,{children:e.jsx(E,{variant:"outline",children:s.card_type.charAt(0).toUpperCase()+s.card_type.slice(1)})}),e.jsx(j,{children:s.card_number}),e.jsx(j,{children:y(s.download_status)}),e.jsx(j,{children:s.records_downloaded}),e.jsx(j,{children:s.download_end_time?`${Math.round((new Date(s.download_end_time).getTime()-new Date(s.download_start_time).getTime())/1e3)}s`:"In Progress"})]},s.id))})]})})})]})})]})};var Ve={};const He=()=>{const{profile:r}=be(),{toast:t}=we(),P=Ce(),[D,M]=f.useState(""),[z,ie]=f.useState("all");f.useState("all");const[K,H]=f.useState(!1),[n,S]=f.useState(null),[re,o]=f.useState(!1),[he,U]=f.useState(!1),{data:c=[],isLoading:me}=W({queryKey:["analog-charts",r==null?void 0:r.organization_id],queryFn:async()=>{if(!(r!=null&&r.organization_id))return[];const{data:a,error:l}=await N.from("analog_tachograph_charts").select(`
          *,
          profiles!analog_tachograph_charts_driver_id_fkey(
            first_name,
            last_name
          ),
          vehicles!analog_tachograph_charts_vehicle_id_fkey(
            vehicle_number,
            license_plate
          )
        `).eq("organization_id",r.organization_id).order("chart_date",{ascending:!1});return l?(console.error("Error fetching analog charts:",l),t({title:"Error",description:"Failed to load analog charts",variant:"destructive"}),[]):(a==null?void 0:a.map(y=>{var s,i;return{...y,driver_name:y.profiles?`${y.profiles.first_name||""} ${y.profiles.last_name||""}`.trim():"Unknown Driver",vehicle_number:((s=y.vehicles)==null?void 0:s.vehicle_number)||"Unknown Vehicle",vehicle_license_plate:((i=y.vehicles)==null?void 0:i.license_plate)||"No Plate"}}))||[]},enabled:!!(r!=null&&r.organization_id)}),{data:ne=[]}=W({queryKey:["vehicles",r==null?void 0:r.organization_id],queryFn:async()=>{if(!(r!=null&&r.organization_id))return[];const{data:a,error:l}=await N.from("vehicles").select("id, vehicle_number, license_plate").eq("organization_id",r.organization_id);return l?[]:a||[]},enabled:!!(r!=null&&r.organization_id)}),{data:J=[]}=W({queryKey:["drivers",r==null?void 0:r.organization_id],queryFn:async()=>{if(!(r!=null&&r.organization_id))return[];const{data:a,error:l}=await N.from("profiles").select("id, first_name, last_name").eq("organization_id",r.organization_id).eq("role","driver");return l?[]:a||[]},enabled:!!(r!=null&&r.organization_id)}),w=ge({mutationFn:async a=>{const l=a.get("chart_file"),y=a.get("chart_number"),s=a.get("chart_date"),{data:i,error:v}=await N.storage.from("analog-charts").upload(`${r==null?void 0:r.organization_id}/${s}_${y}_${Date.now()}.jpg`,l);if(v)throw v;const u={organization_id:r==null?void 0:r.organization_id,driver_id:a.get("driver_id")||null,vehicle_id:a.get("vehicle_id")||null,chart_number:y,chart_date:s,start_time:a.get("start_time")||null,end_time:a.get("end_time")||null,total_distance_km:parseFloat(a.get("total_distance_km"))||null,chart_type:a.get("chart_type"),chart_format:a.get("chart_format"),chart_size:a.get("chart_size"),chart_image_url:i.path,chart_condition:a.get("chart_condition"),uploaded_by:r==null?void 0:r.id,driving_periods:[],rest_periods:[],violations:[],manual_analysis_completed:!1},{error:x}=await N.from("analog_tachograph_charts").insert(u);if(x)throw x},onSuccess:()=>{P.invalidateQueries({queryKey:["analog-charts"]}),H(!1),t({title:"Success",description:"Analog chart uploaded successfully"})},onError:a=>{console.error("Upload error:",a),t({title:"Error",description:"Failed to upload analog chart",variant:"destructive"})}}),Q=ge({mutationFn:async({chartId:a,analysisData:l})=>{const{error:y}=await N.from("analog_tachograph_charts").update({driving_periods:l.driving_periods,rest_periods:l.rest_periods,work_periods:l.work_periods,availability_periods:l.availability_periods,break_periods:l.break_periods,violations:l.violations,manual_analysis_completed:!0,analysis_notes:l.notes,analyzed_by:r==null?void 0:r.id,analyzed_at:new Date().toISOString()}).eq("id",a);if(y)throw y},onSuccess:()=>{P.invalidateQueries({queryKey:["analog-charts"]}),U(!1),t({title:"Success",description:"Chart analysis completed"})},onError:a=>{console.error("Analysis error:",a),t({title:"Error",description:"Failed to save analysis",variant:"destructive"})}}),T=(()=>{if(c.length===0)return{totalCharts:0,analyzedCharts:0,pendingAnalysis:0,chartsWithViolations:0,averageDistance:0,complianceRate:100};const a=c.length,l=c.filter(x=>x.manual_analysis_completed).length,y=a-l,s=c.filter(x=>x.violations&&Array.isArray(x.violations)&&x.violations.length>0).length,v=c.reduce((x,g)=>x+(g.total_distance_km||0),0)/a,u=a>0?(a-s)/a*100:100;return{totalCharts:a,analyzedCharts:l,pendingAnalysis:y,chartsWithViolations:s,averageDistance:Math.round(v*100)/100,complianceRate:Math.round(u*100)/100}})(),le=c.filter(a=>{var s,i,v;const l=D===""||((s=a.driver_name)==null?void 0:s.toLowerCase().includes(D.toLowerCase()))||((i=a.vehicle_number)==null?void 0:i.toLowerCase().includes(D.toLowerCase()))||((v=a.chart_number)==null?void 0:v.toLowerCase().includes(D.toLowerCase())),y=z==="all"||z==="analyzed"&&a.manual_analysis_completed||z==="pending"&&!a.manual_analysis_completed||z==="violations"&&a.violations&&Array.isArray(a.violations)&&a.violations.length>0;return l&&y}),L=a=>a.manual_analysis_completed?e.jsx(E,{variant:"default",className:"bg-green-100 text-green-800",children:"Analyzed"}):a.violations&&Array.isArray(a.violations)&&a.violations.length>0?e.jsx(E,{variant:"destructive",children:"Violations"}):e.jsx(E,{variant:"secondary",children:"Pending Analysis"}),Y=a=>{const l={"24_hour":"bg-blue-100 text-blue-800","7_day":"bg-purple-100 text-purple-800",custom:"bg-orange-100 text-orange-800"};return e.jsx(E,{className:l[a]||"bg-gray-100 text-gray-800",children:a.replace("_"," ").toUpperCase()})},Z=a=>{const l={excellent:"bg-green-100 text-green-800",good:"bg-blue-100 text-blue-800",fair:"bg-yellow-100 text-yellow-800",poor:"bg-orange-100 text-orange-800",damaged:"bg-red-100 text-red-800"};return e.jsx(E,{className:l[a]||"bg-gray-100 text-gray-800",children:a.charAt(0).toUpperCase()+a.slice(1)})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Analog Charts"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage analog tachograph charts and manual analysis"})]}),e.jsxs(p,{onClick:()=>H(!0),className:"inline-flex items-center",children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Upload Chart"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(O,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx($,{className:"text-sm font-medium",children:"Total Charts"}),e.jsx(fe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(B,{children:[e.jsx("div",{className:"text-2xl font-bold",children:T.totalCharts}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"All time analog charts"})]})]}),e.jsxs(O,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx($,{className:"text-sm font-medium",children:"Analyzed Charts"}),e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(B,{children:[e.jsx("div",{className:"text-2xl font-bold",children:T.analyzedCharts}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[T.totalCharts>0?Math.round(T.analyzedCharts/T.totalCharts*100):0,"% of total"]})]})]}),e.jsxs(O,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx($,{className:"text-sm font-medium",children:"Compliance Rate"}),e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(B,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[T.complianceRate,"%"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[T.chartsWithViolations," violations detected"]})]})]}),e.jsxs(O,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx($,{className:"text-sm font-medium",children:"Avg Distance"}),e.jsx(Ue,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(B,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[T.averageDistance," km"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Per chart"})]})]})]}),e.jsxs(O,{children:[e.jsx(I,{children:e.jsx($,{children:"Analog Charts"})}),e.jsxs(B,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(pe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(k,{placeholder:"Search by driver, vehicle, or chart number...",value:D,onChange:a=>M(a.target.value),className:"pl-10"})]})}),e.jsxs(A,{value:z,onValueChange:ie,children:[e.jsx(q,{className:"w-full sm:w-[180px]",children:e.jsx(R,{placeholder:"Filter by status"})}),e.jsxs(V,{children:[e.jsx(d,{value:"all",children:"All Status"}),e.jsx(d,{value:"analyzed",children:"Analyzed"}),e.jsx(d,{value:"pending",children:"Pending Analysis"}),e.jsx(d,{value:"violations",children:"With Violations"})]})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(Se,{children:[e.jsx(ke,{children:e.jsxs(G,{children:[e.jsx(_,{children:"Date"}),e.jsx(_,{children:"Chart Number"}),e.jsx(_,{children:"Driver"}),e.jsx(_,{children:"Vehicle"}),e.jsx(_,{children:"Type"}),e.jsx(_,{children:"Distance"}),e.jsx(_,{children:"Condition"}),e.jsx(_,{children:"Status"}),e.jsx(_,{children:"Actions"})]})}),e.jsx(ze,{children:le.length===0?e.jsx(G,{children:e.jsx(j,{colSpan:9,className:"text-center py-8",children:e.jsx("div",{className:"text-muted-foreground",children:c.length===0?e.jsxs("div",{children:[e.jsx(fe,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No analog charts found"}),e.jsx("p",{className:"text-sm",children:"Upload your first analog chart to get started"}),e.jsxs(p,{onClick:()=>H(!0),className:"mt-4",variant:"outline",children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Upload First Chart"]})]}):e.jsxs("div",{children:[e.jsx(pe,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No charts match your filters"}),e.jsx("p",{className:"text-sm",children:"Try adjusting your search criteria"})]})})})}):le.map(a=>e.jsxs(G,{children:[e.jsx(j,{children:e.jsx("div",{className:"font-medium",children:new Date(a.chart_date).toLocaleDateString()})}),e.jsx(j,{children:e.jsx("div",{className:"font-medium",children:a.chart_number})}),e.jsx(j,{children:e.jsx("div",{className:"font-medium",children:a.driver_name})}),e.jsx(j,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.vehicle_number}),e.jsx("div",{className:"text-sm text-muted-foreground",children:a.vehicle_license_plate})]})}),e.jsx(j,{children:Y(a.chart_type)}),e.jsx(j,{children:a.total_distance_km?`${a.total_distance_km} km`:"-"}),e.jsx(j,{children:Z(a.chart_condition)}),e.jsx(j,{children:L(a)}),e.jsx(j,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>{S(a),o(!0)},children:e.jsx(De,{className:"h-4 w-4"})}),!a.manual_analysis_completed&&e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>{S(a),U(!0)},children:e.jsx(Fe,{className:"h-4 w-4"})})]})})]},a.id))})]})})]})]}),e.jsx(ee,{open:K,onOpenChange:H,children:e.jsxs(se,{className:"max-w-2xl",children:[e.jsx(ae,{children:e.jsx(te,{children:"Upload Analog Chart"})}),e.jsxs("form",{onSubmit:a=>{a.preventDefault();const l=new FormData(a.currentTarget);w.mutate(l)},children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"chart_number",children:"Chart Number"}),e.jsx(k,{name:"chart_number",required:!0,placeholder:"e.g., CHART-2024-001"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"chart_date",children:"Chart Date"}),e.jsx(k,{type:"date",name:"chart_date",required:!0})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"driver_id",children:"Driver"}),e.jsxs(A,{name:"driver_id",required:!0,children:[e.jsx(q,{children:e.jsx(R,{placeholder:"Select driver"})}),e.jsx(V,{children:J.map(a=>e.jsxs(d,{value:a.id,children:[a.first_name," ",a.last_name]},a.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"vehicle_id",children:"Vehicle"}),e.jsxs(A,{name:"vehicle_id",required:!0,children:[e.jsx(q,{children:e.jsx(R,{placeholder:"Select vehicle"})}),e.jsx(V,{children:ne.map(a=>e.jsxs(d,{value:a.id,children:[a.vehicle_number," (",a.license_plate,")"]},a.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"chart_type",children:"Chart Type"}),e.jsxs(A,{name:"chart_type",required:!0,children:[e.jsx(q,{children:e.jsx(R,{placeholder:"Select chart type"})}),e.jsxs(V,{children:[e.jsx(d,{value:"24_hour",children:"24 Hour"}),e.jsx(d,{value:"7_day",children:"7 Day"}),e.jsx(d,{value:"custom",children:"Custom"})]})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"chart_format",children:"Chart Format"}),e.jsxs(A,{name:"chart_format",required:!0,children:[e.jsx(q,{children:e.jsx(R,{placeholder:"Select format"})}),e.jsxs(V,{children:[e.jsx(d,{value:"circular",children:"Circular"}),e.jsx(d,{value:"strip",children:"Strip"})]})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"start_time",children:"Start Time"}),e.jsx(k,{type:"time",name:"start_time"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"end_time",children:"End Time"}),e.jsx(k,{type:"time",name:"end_time"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"total_distance_km",children:"Total Distance (km)"}),e.jsx(k,{type:"number",name:"total_distance_km",step:"0.1"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"chart_condition",children:"Chart Condition"}),e.jsxs(A,{name:"chart_condition",required:!0,children:[e.jsx(q,{children:e.jsx(R,{placeholder:"Select condition"})}),e.jsxs(V,{children:[e.jsx(d,{value:"excellent",children:"Excellent"}),e.jsx(d,{value:"good",children:"Good"}),e.jsx(d,{value:"fair",children:"Fair"}),e.jsx(d,{value:"poor",children:"Poor"}),e.jsx(d,{value:"damaged",children:"Damaged"})]})]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(m,{htmlFor:"chart_file",children:"Chart Image"}),e.jsx(k,{type:"file",name:"chart_file",accept:"image/*,.pdf",required:!0,className:"mt-1"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Upload a clear image or PDF of the analog chart"})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-6",children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>H(!1),children:"Cancel"}),e.jsx(p,{type:"submit",disabled:w.isPending,children:w.isPending?"Uploading...":"Upload Chart"})]})]})]})}),e.jsx(ee,{open:re,onOpenChange:o,children:e.jsxs(se,{className:"max-w-4xl",children:[e.jsx(ae,{children:e.jsx(te,{children:"Analog Chart Details"})}),n&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Chart Number:"})," ",n.chart_number]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(n.chart_date).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Driver:"})," ",n.driver_name]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle:"})," ",n.vehicle_number," (",n.vehicle_license_plate,")"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",Y(n.chart_type)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Format:"})," ",n.chart_format]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Distance:"})," ",n.total_distance_km?`${n.total_distance_km} km`:"Not recorded"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Analysis Status"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",L(n)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Condition:"})," ",Z(n.chart_condition)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Uploaded:"})," ",new Date(n.uploaded_at).toLocaleString()]}),n.analysis_notes&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Notes:"})," ",n.analysis_notes]})]})]})]}),n.chart_image_url&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Image"}),e.jsx("div",{className:"border rounded-lg p-4",children:e.jsx("img",{src:`${Ve.REACT_APP_SUPABASE_URL}/storage/v1/object/public/analog-charts/${n.chart_image_url}`,alt:"Analog Chart",className:"max-w-full h-auto rounded"})})]}),n.violations&&Array.isArray(n.violations)&&n.violations.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Violations Detected"}),e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-red-800",children:n.violations.map((a,l)=>e.jsx("li",{children:a},l))})})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(p,{variant:"outline",onClick:()=>o(!1),children:"Close"}),!n.manual_analysis_completed&&e.jsxs(p,{onClick:()=>{o(!1),U(!0)},children:[e.jsx(Fe,{className:"mr-2 h-4 w-4"}),"Analyze Chart"]})]})]})]})}),e.jsx(ee,{open:he,onOpenChange:U,children:e.jsxs(se,{className:"max-w-4xl",children:[e.jsx(ae,{children:e.jsx(te,{children:"Analyze Analog Chart"})}),n&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Chart:"})," ",n.chart_number]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(n.chart_date).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Driver:"})," ",n.driver_name]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle:"})," ",n.vehicle_number]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Chart Image"}),n.chart_image_url&&e.jsx("img",{src:`${Ve.REACT_APP_SUPABASE_URL}/storage/v1/object/public/analog-charts/${n.chart_image_url}`,alt:"Analog Chart",className:"max-w-full h-auto rounded border"})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Manual Analysis"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Analyze the chart and record the periods of activity, rest, and any violations detected."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"analysis_notes",children:"Analysis Notes"}),e.jsx(je,{id:"analysis_notes",placeholder:"Record your analysis findings, violations detected, and any notes...",className:"mt-1"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"driving_periods",children:"Driving Periods"}),e.jsx(je,{id:"driving_periods",placeholder:"e.g., 06:00-12:00, 14:00-18:00",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"rest_periods",children:"Rest Periods"}),e.jsx(je,{id:"rest_periods",placeholder:"e.g., 12:00-14:00, 18:00-06:00",className:"mt-1"})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"violations",children:"Violations Detected"}),e.jsx(je,{id:"violations",placeholder:"List any violations found during analysis...",className:"mt-1"})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(p,{variant:"outline",onClick:()=>U(!1),children:"Cancel"}),e.jsx(p,{onClick:()=>{var l;const a={driving_periods:[],rest_periods:[],work_periods:[],availability_periods:[],break_periods:[],violations:[],notes:((l=document.getElementById("analysis_notes"))==null?void 0:l.value)||""};Q.mutate({chartId:n.id,analysisData:a})},disabled:Q.isPending,children:Q.isPending?"Saving...":"Save Analysis"})]})]})]})})]})},cs=()=>{const{user:r,profile:t,loading:P}=be(),{toast:D}=we(),M=Ce(),[z,ie]=f.useState(""),[K,H]=f.useState("all"),[n,S]=f.useState("all"),[re,o]=f.useState(!1),[he,U]=f.useState(!1),[c,me]=f.useState(null),[ne,J]=f.useState(!1),{data:w=[],isLoading:Q}=W({queryKey:["tachograph-records",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:s,error:i}=await N.from("tachograph_records").select("*").eq("organization_id",t.organization_id).order("record_date",{ascending:!1}).order("start_time",{ascending:!1});if(i)return console.error("Error fetching tachograph records:",i),D({title:"Error",description:"Failed to load tachograph records",variant:"destructive"}),[];const v=[...new Set((s==null?void 0:s.filter(h=>h.driver_id).map(h=>h.driver_id))||[])],u=[...new Set((s==null?void 0:s.filter(h=>h.vehicle_id).map(h=>h.vehicle_id))||[])];let x=[],g=[];if(v.length>0){const{data:h}=await N.from("profiles").select("id, first_name, last_name").in("id",v);x=h||[]}if(u.length>0){const{data:h}=await N.from("vehicles").select("id, vehicle_number, license_plate").in("id",u);g=h||[]}const C=new Map(x.map(h=>[h.id,h])),b=new Map(g.map(h=>[h.id,h]));return(s==null?void 0:s.map(h=>{var de,X,F,xe;return{...h,driver_name:h.driver_id&&C.has(h.driver_id)?`${((de=C.get(h.driver_id))==null?void 0:de.first_name)||""} ${((X=C.get(h.driver_id))==null?void 0:X.last_name)||""}`.trim():"Unknown Driver",vehicle_number:h.vehicle_id&&b.has(h.vehicle_id)&&((F=b.get(h.vehicle_id))==null?void 0:F.vehicle_number)||"Unknown Vehicle",vehicle_license_plate:h.vehicle_id&&b.has(h.vehicle_id)&&((xe=b.get(h.vehicle_id))==null?void 0:xe.license_plate)||"No Plate"}}))||[]},enabled:!!(t!=null&&t.organization_id)}),{data:ye=[]}=W({queryKey:["vehicles",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:s,error:i}=await N.from("vehicles").select("id, vehicle_number, license_plate").eq("organization_id",t.organization_id);return i?(console.error("Error fetching vehicles:",i),[]):s||[]},enabled:!!(t!=null&&t.organization_id)}),{data:T=[]}=W({queryKey:["drivers",t==null?void 0:t.organization_id],queryFn:async()=>{if(!(t!=null&&t.organization_id))return[];const{data:s,error:i}=await N.from("profiles").select("id, first_name, last_name").eq("organization_id",t.organization_id).eq("role","driver");return i?(console.error("Error fetching drivers:",i),[]):s||[]},enabled:!!(t!=null&&t.organization_id)}),L=(()=>{if(w.length===0)return{totalRecords:0,validatedRecords:0,pendingValidation:0,recordsWithViolations:0,averageDistance:0,complianceRate:100,totalDrivingTime:0,totalRestTime:0};const s=w.length,i=w.filter(F=>F.is_validated).length,v=s-i,u=w.filter(F=>F.violations&&Array.isArray(F.violations)&&F.violations.length>0).length,g=w.reduce((F,xe)=>F+(xe.distance_km||0),0)/s,C=w.filter(F=>F.activity_type==="driving"),b=w.filter(F=>F.activity_type==="rest"),h=C.length,de=b.length,X=s>0?(s-u)/s*100:100;return{totalRecords:s,validatedRecords:i,pendingValidation:v,recordsWithViolations:u,averageDistance:Math.round(g*100)/100,complianceRate:Math.round(X*100)/100,totalDrivingTime:h,totalRestTime:de}})(),Y=w.filter(s=>{var x,g,C;const i=z===""||((x=s.driver_name)==null?void 0:x.toLowerCase().includes(z.toLowerCase()))||((g=s.vehicle_number)==null?void 0:g.toLowerCase().includes(z.toLowerCase()))||((C=s.activity_type)==null?void 0:C.toLowerCase().includes(z.toLowerCase())),v=K==="all"||K==="validated"&&s.is_validated||K==="pending"&&!s.is_validated||K==="violations"&&s.violations&&Array.isArray(s.violations)&&s.violations.length>0,u=n==="all"||n==="today"&&s.record_date===new Date().toISOString().split("T")[0]||n==="week"&&(()=>{const b=new Date;return b.setDate(b.getDate()-7),new Date(s.record_date)>=b})()||n==="month"&&(()=>{const b=new Date;return b.setMonth(b.getMonth()-1),new Date(s.record_date)>=b})();return i&&v&&u}),Z=ge({mutationFn:async s=>{const i=s.get("file"),{data:v,error:u}=await N.storage.from("tachograph-files").upload(`${t==null?void 0:t.organization_id}/${Date.now()}_${i.name}`,i);if(u)throw u;const x={organization_id:t==null?void 0:t.organization_id,driver_id:s.get("driver_id")||null,vehicle_id:s.get("vehicle_id")||null,record_date:s.get("record_date"),start_time:s.get("start_time"),end_time:s.get("end_time")||null,activity_type:s.get("activity_type"),distance_km:parseFloat(s.get("distance_km"))||null,start_location:s.get("start_location")||null,end_location:s.get("end_location")||null,file_path:v.path,raw_data:{},violations:[],is_validated:!1},{error:g}=await N.from("tachograph_records").insert(x);if(g)throw g},onSuccess:()=>{M.invalidateQueries({queryKey:["tachograph-records"]}),o(!1),D({title:"Success",description:"Tachograph record uploaded successfully"})},onError:s=>{console.error("Upload error:",s),D({title:"Error",description:"Failed to upload tachograph record",variant:"destructive"})}}),a=ge({mutationFn:async({recordId:s,isValidated:i,notes:v})=>{const{error:u}=await N.from("tachograph_records").update({is_validated:i,validation_notes:v||null}).eq("id",s);if(u)throw u},onSuccess:()=>{M.invalidateQueries({queryKey:["tachograph-records"]}),D({title:"Success",description:"Record validation updated"})},onError:s=>{console.error("Validation error:",s),D({title:"Error",description:"Failed to update validation",variant:"destructive"})}});if(P||Q)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-lg",children:"Loading tachograph manager..."})]})});if(!r||!t)return e.jsx(Te,{to:"/auth",replace:!0});if(!["admin","council"].includes(t.role))return e.jsx(Te,{to:"/unauthorized",replace:!0});const l=s=>s.is_validated?e.jsx(E,{variant:"default",className:"bg-green-100 text-green-800",children:"Validated"}):s.violations&&Array.isArray(s.violations)&&s.violations.length>0?e.jsx(E,{variant:"destructive",children:"Violations"}):e.jsx(E,{variant:"secondary",children:"Pending"}),y=s=>{const i={driving:"bg-blue-100 text-blue-800",rest:"bg-green-100 text-green-800",work:"bg-yellow-100 text-yellow-800",availability:"bg-purple-100 text-purple-800",break:"bg-orange-100 text-orange-800"};return e.jsx(E,{className:i[s]||"bg-gray-100 text-gray-800",children:s.charAt(0).toUpperCase()+s.slice(1)})};return e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Tachograph Manager"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage digital and analog tachograph records"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(p,{onClick:()=>o(!0),variant:"outline",children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Upload Digital"]}),e.jsxs(p,{onClick:()=>U(!0),children:[e.jsx(fe,{className:"mr-2 h-4 w-4"}),"Upload Analog"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(O,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx($,{className:"text-sm font-medium",children:"Total Records"}),e.jsx(Ae,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(B,{children:[e.jsx("div",{className:"text-2xl font-bold",children:L.totalRecords}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"All time tachograph records"})]})]}),e.jsxs(O,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx($,{className:"text-sm font-medium",children:"Validated Records"}),e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(B,{children:[e.jsx("div",{className:"text-2xl font-bold",children:L.validatedRecords}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[L.totalRecords>0?Math.round(L.validatedRecords/L.totalRecords*100):0,"% of total"]})]})]}),e.jsxs(O,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx($,{className:"text-sm font-medium",children:"Compliance Rate"}),e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(B,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[L.complianceRate,"%"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[L.recordsWithViolations," violations detected"]})]})]}),e.jsxs(O,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx($,{className:"text-sm font-medium",children:"Avg Distance"}),e.jsx(Ue,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(B,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[L.averageDistance," km"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Per tachograph record"})]})]})]}),e.jsxs(Le,{defaultValue:"digital",className:"space-y-6",children:[e.jsxs(Ee,{className:"grid w-full grid-cols-3",children:[e.jsx(ce,{value:"digital",children:"Digital Records"}),e.jsx(ce,{value:"card-reader",children:"Card Reader"}),e.jsx(ce,{value:"analog",children:"Analog Charts"})]}),e.jsxs(oe,{value:"digital",className:"space-y-6",children:[e.jsxs(O,{children:[e.jsx(I,{children:e.jsx($,{children:"Records"})}),e.jsxs(B,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(pe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(k,{placeholder:"Search by driver, vehicle, or activity...",value:z,onChange:s=>ie(s.target.value),className:"pl-10"})]})}),e.jsxs(A,{value:K,onValueChange:H,children:[e.jsx(q,{className:"w-full sm:w-[180px]",children:e.jsx(R,{placeholder:"Filter by status"})}),e.jsxs(V,{children:[e.jsx(d,{value:"all",children:"All Status"}),e.jsx(d,{value:"validated",children:"Validated"}),e.jsx(d,{value:"pending",children:"Pending"}),e.jsx(d,{value:"violations",children:"With Violations"})]})]}),e.jsxs(A,{value:n,onValueChange:S,children:[e.jsx(q,{className:"w-full sm:w-[180px]",children:e.jsx(R,{placeholder:"Filter by date"})}),e.jsxs(V,{children:[e.jsx(d,{value:"all",children:"All Time"}),e.jsx(d,{value:"today",children:"Today"}),e.jsx(d,{value:"week",children:"Last 7 Days"}),e.jsx(d,{value:"month",children:"Last 30 Days"})]})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(Se,{children:[e.jsx(ke,{children:e.jsxs(G,{children:[e.jsx(_,{children:"Date"}),e.jsx(_,{children:"Driver"}),e.jsx(_,{children:"Vehicle"}),e.jsx(_,{children:"Activity"}),e.jsx(_,{children:"Time"}),e.jsx(_,{children:"Distance"}),e.jsx(_,{children:"Status"}),e.jsx(_,{children:"Actions"})]})}),e.jsx(ze,{children:Y.length===0?e.jsx(G,{children:e.jsx(j,{colSpan:8,className:"text-center py-8",children:e.jsx("div",{className:"text-muted-foreground",children:w.length===0?e.jsxs("div",{children:[e.jsx(Ae,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No tachograph records found"}),e.jsx("p",{className:"text-sm",children:"Upload your first tachograph record to get started"}),e.jsxs(p,{onClick:()=>o(!0),className:"mt-4",variant:"outline",children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Upload First Record"]})]}):e.jsxs("div",{children:[e.jsx(pe,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"No records match your filters"}),e.jsx("p",{className:"text-sm",children:"Try adjusting your search criteria"})]})})})}):Y.map(s=>e.jsxs(G,{children:[e.jsx(j,{children:e.jsx("div",{className:"font-medium",children:new Date(s.record_date).toLocaleDateString()})}),e.jsx(j,{children:e.jsx("div",{className:"font-medium",children:s.driver_name})}),e.jsx(j,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.vehicle_number}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.vehicle_license_plate})]})}),e.jsx(j,{children:y(s.activity_type)}),e.jsx(j,{children:e.jsx("div",{children:e.jsxs("div",{className:"font-medium",children:[s.start_time," - ",s.end_time||"Ongoing"]})})}),e.jsx(j,{children:s.distance_km?`${s.distance_km} km`:"-"}),e.jsx(j,{children:l(s)}),e.jsx(j,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>{me(s),J(!0)},children:e.jsx(De,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>{a.mutate({recordId:s.id,isValidated:!s.is_validated,notes:s.validation_notes||void 0})},disabled:a.isPending,children:s.is_validated?e.jsx(Ie,{className:"h-4 w-4"}):e.jsx(Ne,{className:"h-4 w-4"})})]})})]},s.id))})]})})]})]}),e.jsx(ee,{open:re,onOpenChange:o,children:e.jsxs(se,{className:"max-w-2xl",children:[e.jsx(ae,{children:e.jsx(te,{children:"Upload Tachograph Record"})}),e.jsxs("form",{onSubmit:s=>{s.preventDefault();const i=new FormData(s.currentTarget);Z.mutate(i)},children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"driver_id",children:"Driver"}),e.jsxs(A,{name:"driver_id",required:!0,children:[e.jsx(q,{children:e.jsx(R,{placeholder:"Select driver"})}),e.jsx(V,{children:T.map(s=>e.jsxs(d,{value:s.id,children:[s.first_name," ",s.last_name]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"vehicle_id",children:"Vehicle"}),e.jsxs(A,{name:"vehicle_id",required:!0,children:[e.jsx(q,{children:e.jsx(R,{placeholder:"Select vehicle"})}),e.jsx(V,{children:ye.map(s=>e.jsxs(d,{value:s.id,children:[s.vehicle_number," (",s.license_plate,")"]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"record_date",children:"Record Date"}),e.jsx(k,{type:"date",name:"record_date",required:!0,defaultValue:new Date().toISOString().split("T")[0]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"activity_type",children:"Activity Type"}),e.jsxs(A,{name:"activity_type",required:!0,children:[e.jsx(q,{children:e.jsx(R,{placeholder:"Select activity"})}),e.jsxs(V,{children:[e.jsx(d,{value:"driving",children:"Driving"}),e.jsx(d,{value:"rest",children:"Rest"}),e.jsx(d,{value:"work",children:"Work"}),e.jsx(d,{value:"availability",children:"Availability"}),e.jsx(d,{value:"break",children:"Break"})]})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"start_time",children:"Start Time"}),e.jsx(k,{type:"time",name:"start_time",required:!0})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"end_time",children:"End Time"}),e.jsx(k,{type:"time",name:"end_time"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"distance_km",children:"Distance (km)"}),e.jsx(k,{type:"number",name:"distance_km",step:"0.1"})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"file",children:"Tachograph File"}),e.jsx(k,{type:"file",name:"file",accept:".ddd,.tgd,.c1b,.v1b,.v2b,.esm",required:!0})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(m,{htmlFor:"start_location",children:"Start Location"}),e.jsx(k,{name:"start_location",placeholder:"Enter start location"})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx(m,{htmlFor:"end_location",children:"End Location"}),e.jsx(k,{name:"end_location",placeholder:"Enter end location"})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-6",children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>o(!1),children:"Cancel"}),e.jsx(p,{type:"submit",disabled:Z.isPending,children:Z.isPending?"Uploading...":"Upload Record"})]})]})]})}),e.jsx(ee,{open:ne,onOpenChange:J,children:e.jsxs(se,{className:"max-w-4xl",children:[e.jsx(ae,{children:e.jsx(te,{children:"Tachograph Record Details"})}),c&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Basic Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(c.record_date).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Driver:"})," ",c.driver_name]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle:"})," ",c.vehicle_number," (",c.vehicle_license_plate,")"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Activity:"})," ",y(c.activity_type)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Time:"})," ",c.start_time," - ",c.end_time||"Ongoing"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Distance:"})," ",c.distance_km?`${c.distance_km} km`:"Not recorded"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Location & Validation"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Start Location:"})," ",c.start_location||"Not specified"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"End Location:"})," ",c.end_location||"Not specified"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Card Number:"})," ",c.card_number||"Not recorded"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Downloaded:"})," ",c.downloaded_at?new Date(c.downloaded_at).toLocaleString():"Not downloaded"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",l(c)]})]})]})]}),c.violations&&Array.isArray(c.violations)&&c.violations.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Violations Detected"}),e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-red-800",children:c.violations.map((s,i)=>e.jsx("li",{children:s},i))})})]}),c.validation_notes&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Validation Notes"}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4",children:e.jsx("p",{className:"text-sm text-blue-800",children:c.validation_notes})})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(p,{variant:"outline",onClick:()=>J(!1),children:"Close"}),e.jsx(p,{onClick:()=>{a.mutate({recordId:c.id,isValidated:!c.is_validated,notes:c.validation_notes||void 0})},disabled:a.isPending,children:c.is_validated?"Mark as Pending":"Mark as Validated"})]})]})]})})]}),e.jsx(oe,{value:"card-reader",className:"space-y-6",children:e.jsx(Ke,{onDataDownloaded:s=>{D({title:"Card Data Downloaded",description:`Successfully downloaded ${s.recordsCount} records from ${s.cardType} card`}),M.invalidateQueries({queryKey:["tachograph-records"]})}})}),e.jsx(oe,{value:"analog",className:"space-y-6",children:e.jsx(He,{})})]})]})};export{cs as default};
