import{q as xe,s as U,J as us,a as we,r as o,j as e,E as b,v as $e,a2 as hs,B as h,ax as ms,D as xs,d as gs,e as ps,f as fs,H as ve,g as ys,i as w,k as q,l as C,m as $,n as k,Y as j,F as _s,I as je,S as Fe,a0 as vs}from"./main-piTIAPSx.js";import{T as js,a as bs,b as Le,c as ze}from"./tabs-N5TLptOb.js";import{S as Ge,a as Ue,b as Qe,c as He,d as X}from"./select-Brm_N20Q.js";import{T as Ns,a as ws,b as he,c as Y,d as ks,e as O}from"./table-CV1HM_JF.js";import{T as Ae}from"./textarea-mxcr8nPj.js";import{P as qs}from"./progress-nJfMQ3MC.js";import{u as Cs}from"./useQuery-Dbdyc74j.js";import{u as Ss}from"./useMutation-B8vlA97s.js";import{b as Be}from"./useVehicles-C0CqQMfj.js";import{A as Es}from"./arrow-left-D5FvV0kk.js";import{S as Ps}from"./save-4i_nN9Q9.js";import{A as Ts}from"./arrow-right-D4j6qhn0.js";import{I as Me}from"./info-IsFyPzEb.js";import{C as ae}from"./circle-check-big-CD0jvDn0.js";import{D as be}from"./download-C4W0Vf38.js";import{C as Ne}from"./car-B9KPzxYH.js";import{C as We}from"./circle-x-CETn4HDx.js";import{N as Ds}from"./navigation-D0f2KySn.js";import{C as me}from"./camera-DB1Hu7y8.js";import{R as Vs}from"./refresh-cw-BS9rbMP7.js";import{P as Is}from"./plus-CMGcTuiR.js";import{S as Rs}from"./search-HDsNrIL9.js";import{S as Fs}from"./square-pen-DnuZJKej.js";import{f as ie}from"./format-VbeFDANp.js";import"./index-Pp_niZQ8.js";const Ls=r=>{const{profile:c}=xe();return Cs({queryKey:["vehicle-checks",r,c==null?void 0:c.organization_id],queryFn:async()=>{if(!(c!=null&&c.organization_id))return[];try{let _=U.from("vehicle_checks").select("*").eq("organization_id",c.organization_id).order("check_date",{ascending:!1});const{data:x,error:P}=await _;if(P)return console.warn("Vehicle checks query failed:",P.message),[];if(!x||x.length===0)return[];const l=[...new Set(x.map(u=>u.vehicle_id).filter(Boolean))],m=[...new Set(x.map(u=>u.driver_id).filter(Boolean))],[g,V]=await Promise.all([l.length>0?U.from("vehicles").select("id, vehicle_number, license_plate, make, model, organization_id").in("id",l).eq("organization_id",c.organization_id):Promise.resolve({data:[],error:null}),m.length>0?U.from("profiles").select("id, first_name, last_name, employee_id, organization_id").in("id",m).eq("organization_id",c.organization_id):Promise.resolve({data:[],error:null})]),f=new Map((g.data||[]).map(u=>[u.id,u])),v=new Map((V.data||[]).map(u=>[u.id,u]));return x.map(u=>({...u,vehicles:u.vehicle_id?f.get(u.vehicle_id):void 0,driver_profile:u.driver_id?v.get(u.driver_id):void 0})).filter(u=>!u.vehicles||u.vehicles.organization_id===c.organization_id)}catch(_){return console.warn("Vehicle checks fetch failed:",_ instanceof Error?_.message:"Unknown error"),[]}},enabled:!!(c!=null&&c.organization_id),retry:1,staleTime:5*60*1e3,gcTime:10*60*1e3})},zs=()=>{const r=us(),{toast:c}=we(),{profile:_}=xe();return Ss({mutationFn:async x=>{if(!(_!=null&&_.organization_id))throw new Error("Organization ID is required to create vehicle check");const{data:P,error:l}=await U.from("vehicles").select("organization_id").eq("id",x.vehicle_id).single();if(l||!P||P.organization_id!==_.organization_id)throw new Error("Vehicle not found or access denied");const{data:m,error:g}=await U.from("profiles").select("organization_id").eq("id",x.driver_id).single();if(g||!m||m.organization_id!==_.organization_id)throw new Error("Driver not found or access denied");const{data:V,error:f}=await U.from("vehicle_checks").insert([x]).select().single();if(f)throw new Error(`Failed to create vehicle check: ${f.message}`);return V},onSuccess:()=>{r.invalidateQueries({queryKey:["vehicle-checks"]}),c({title:"Success",description:"Vehicle check submitted successfully"})},onError:x=>{c({title:"Error",description:"Failed to submit vehicle check: "+x.message,variant:"destructive"})}})},Oe=async(r,c,_,x,P)=>{try{const l=r.name.split(".").pop(),m=`${Date.now()}_${Math.random().toString(36).substring(2)}.${l}`,g=`${_}/${x}/${P}/${m}`;console.log("Uploading file:",{bucket:c,storagePath:g,fileSize:r.size});const{data:V,error:f}=await U.storage.from(c).upload(g,r,{cacheControl:"3600",upsert:!1});if(f)return console.error("Upload error:",f),{success:!1,error:f.message};const{data:{publicUrl:v}}=U.storage.from(c).getPublicUrl(g);return console.log("File uploaded successfully:",{storagePath:g,publicUrl:v}),{success:!0,fileUrl:v,storagePath:g}}catch(l){return console.error("File upload failed:",l),{success:!1,error:l instanceof Error?l.message:"Unknown error occurred"}}},As=()=>{var Ve,Ie,Re;const{profile:r}=xe(),{toast:c}=we(),_=zs(),{data:x=[],isLoading:P}=Be(),[l,m]=o.useState("vehicle-selection"),[g,V]=o.useState(""),[f,v]=o.useState(""),[L,u]=o.useState(""),[T,J]=o.useState(0),[p,K]=o.useState({}),[Q,ne]=o.useState([]),[ee,se]=o.useState(!1),[z,i]=o.useState(""),[d,I]=o.useState(""),[H,Ye]=o.useState(""),[B,ke]=o.useState(null),[le,ge]=o.useState(!1),[pe,te]=o.useState(!1),[qe,Ce]=o.useState(!1),[Xe,Se]=o.useState(!1),[Je,Ke]=o.useState(""),A=o.useRef(null),ce=o.useRef(null),re=o.useRef(null),Z=x.filter(s=>s.is_active),Ee=s=>({exterior:"ðŸ”¹ Exterior Check",interior:"ðŸ”¹ Interior Check",safety:"ðŸ”¹ Safety Equipment",load:"ðŸ”¹ Load & Trailer",general:"ðŸ”¹ General Equipment",final:"ðŸ”¹ Final Check",documentation:"ðŸ”¹ Documentation",driver:"ðŸ”¹ Driver Check"})[s]||s,Pe=s=>({exterior:"Checking vehicle exterior, lights, tires, and body condition",interior:"Checking cab interior, controls, and dashboard systems",safety:"Checking safety equipment, emergency exits, and accessibility features",load:"Checking load security, trailer connections, and height limits",general:"Checking general equipment, AdBlue, and emergency devices",final:"Final verification and defect reporting confirmation",documentation:"Recording mileage and documentation checks",driver:"Driver fitness and readiness assessment"})[s]||"Vehicle inspection category",Ze=s=>({1:"Check for any visible leaks under the vehicle. Look for oil, fuel, coolant, or other fluid stains on the ground. Pay attention to the engine area, transmission, and fuel tank.",2:"Inspect the windscreen for cracks, chips, or damage. Ensure it's clean and provides clear visibility. Check for any delamination or distortion.",3:"Test the wipers by turning them on. Check that they clear the windscreen effectively. Test the washer fluid spray and ensure it reaches the windscreen.",4:"Turn on the headlights and check both main beam and dipped beam. Ensure lenses are clean and not cracked. Check that both lights are working.",5:"Test all front indicators including side repeaters. Ensure they flash at the correct rate and are visible from all angles.",6:"Test the horn by pressing it. Ensure it produces a clear, audible sound that can be heard from outside the vehicle.",7:"Check all mirrors are securely fitted and properly adjusted. Ensure they're not cracked or damaged. Test that they provide adequate rearward visibility.",8:"Verify the front registration plate is present, clean, and securely attached. Check that all numbers and letters are clearly visible and not obscured.",9:"Inspect all tyres on the passenger side. Check tread depth (minimum 1.6mm), look for cuts, bulges, or damage. Check tyre pressure and ensure valve caps are present.",10:"Check all wheel nuts are present and properly tightened. Look for any signs of rust, cracks, or missing nuts. Ensure wheel covers are secure.",11:"Inspect mudguards and spray suppression devices. Ensure they're properly fitted and not damaged. Check they're positioned correctly to prevent spray.",12:"Check bodywork for any damage, sharp edges, or corrosion. Look for dents, scratches, or areas that could cause injury or further damage.",13:"Inspect all reflectors on the passenger side. Ensure they're clean, secure, and properly positioned. Check they're not cracked or damaged.",14:"Test all rear lights including brake lights, indicators, and tail lights. Ensure they're working correctly and visible from behind the vehicle.",15:"Check the number plate light is working and illuminates the registration plate clearly. Ensure it's not cracked or damaged.",16:"Inspect the rear registration plate. Ensure it's clean, secure, and all numbers/letters are clearly visible.",17:"Check rear reflectors are clean, secure, and properly positioned. Ensure they're not damaged or missing.",18:"If fitted, test the tail lift operation. Check it raises and lowers smoothly, and locks securely in both positions.",19:"Inspect under-run protection bars if fitted. Ensure they're securely attached and not damaged or bent.",20:"Test rear doors or tailgate operation. Check hinges, locks, and latches work correctly. Ensure doors close and seal properly.",21:"Inspect all tyres on the driver's side. Check tread depth, condition, pressure, and look for any damage or wear.",22:"Check the exhaust system is secure and not leaking. Look for excessive smoke or unusual noises. Ensure the exhaust pipe is not damaged.",23:"Test side marker lamps are working correctly. Ensure they're visible and not damaged.",24:"Check the fuel filler cap is secure and not leaking. Ensure the cap fits properly and the seal is intact.",25:"Check the driver's seat is secure and properly adjusted. Test seat belts buckle and unbuckle correctly. Ensure belts retract properly.",26:"Check steering wheel for excessive play or looseness. Ensure it turns smoothly and returns to center properly.",27:"Test brake pedal feel and travel. Check for any brake warning lights. Ensure brakes feel firm and responsive.",28:"Check all dashboard warning lights are functioning. Ensure no warning lights remain illuminated when they shouldn't be.",29:"Verify tachograph is working and calibrated. Check paper roll is available and properly fitted. Ensure time is set correctly.",30:"Check odometer is functioning and recording mileage correctly. Test speed limiter if fitted.",31:"Test handbrake/parking brake operation. Ensure it holds the vehicle securely on a slope.",32:"Test heating and ventilation systems. Ensure air flows correctly and temperature controls work.",33:"Check saloon lighting and flooring are safe and secure. Look for any loose or damaged floor panels.",34:"Verify fire extinguisher is present, secure, and in date. Check it's easily accessible and properly mounted.",35:"Check first aid kit is present, stocked, and in date. Ensure it's easily accessible and properly stored.",36:"Test all passenger doors open and close properly. Check emergency exits are clearly marked and functional.",37:"If fitted, check emergency hammers are present and secure. Ensure they're easily accessible in an emergency.",38:"If fitted, test wheelchair ramp/lift operation. Ensure it works smoothly and safely.",39:"Check all passenger seat belts are working correctly. Ensure they buckle and retract properly.",40:"Verify accessibility signage is fitted and visible. Check it meets required standards.",41:"If fitted, check camera systems are working and clean. Ensure displays are clear and functional.",42:"If fitted, check fresnel lens is properly positioned and visible. Ensure it provides adequate blind spot coverage.",43:"Check load is properly secured with appropriate restraints. Ensure curtains or straps are tight and secure.",44:"Verify load height is within legal limits. Check it doesn't exceed maximum permitted height.",45:"If towing, check trailer brake lines are secure and not leaking. Test brake operation.",46:"If towing, check trailer coupling is secure and clip is in place. Ensure electrical connections are safe.",47:"If towing, check trailer landing legs are up and secure. Ensure they're not dragging or loose.",48:"Check AdBlue level if fitted. Ensure cap is secure and system is functioning.",49:"Verify warning triangles or other warning devices are on board and accessible.",50:"Check emergency contact numbers are carried in the cab and easily accessible.",51:"If fitted, test fire suppression system operation. Ensure it's properly maintained.",52:"Check cab is clean and free from loose items that could cause hazards during operation.",53:"Confirm no defects were found during the inspection. If defects were found, ensure they're properly documented.",54:"Verify all defects have been reported to the transport manager immediately. Ensure proper reporting procedures were followed.",55:"Record the current mileage reading from the vehicle odometer. Ensure it's accurate and legible.",56:"Confirm you are fit to drive. Check you're not tired, under the influence, or suffering from any condition that could affect driving ability."})[s]||"Please inspect this item thoroughly and ensure it meets safety standards.",R=[{id:"1",question_text:"Fuel / Oil / Fluid Leaks under the vehicle?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:1,category:"exterior"},{id:"2",question_text:"Windscreen â€“ clean, free from cracks/damage?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:2,category:"exterior"},{id:"3",question_text:"Windscreen wipers & washers working correctly?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:3,category:"exterior"},{id:"4",question_text:"Headlights (main/dip) working & lenses clean?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:4,category:"exterior"},{id:"5",question_text:"Front indicators including side repeaters working?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:5,category:"exterior"},{id:"6",question_text:"Horn working clearly?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:6,category:"exterior"},{id:"7",question_text:"Mirrors fitted, secure, adjusted, and not cracked?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:7,category:"exterior"},{id:"8",question_text:"Front registration plate present, clean, & secure?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:8,category:"exterior"},{id:"9",question_text:"Tyres (condition, tread depth, inflation, cuts, bulges)?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:9,category:"exterior"},{id:"10",question_text:"Wheel nuts secure (no cracks, rust marks, missing nuts)?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:10,category:"exterior"},{id:"11",question_text:"Spray suppression/mudguards fitted & secure?",question_type:"yes_no",is_required:!0,is_critical:!1,order_index:11,category:"exterior"},{id:"12",question_text:"Bodywork free from damage/sharp edges?",question_type:"yes_no",is_required:!0,is_critical:!1,order_index:12,category:"exterior"},{id:"13",question_text:"Reflectors clean & secure?",question_type:"yes_no",is_required:!0,is_critical:!1,order_index:13,category:"exterior"},{id:"14",question_text:"Rear lights, brake lights & indicators working?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:14,category:"exterior"},{id:"15",question_text:"Number plate light working?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:15,category:"exterior"},{id:"16",question_text:"Rear registration plate clean & secure?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:16,category:"exterior"},{id:"17",question_text:"Rear reflectors clean & secure?",question_type:"yes_no",is_required:!0,is_critical:!1,order_index:17,category:"exterior"},{id:"18",question_text:"Tail lift fitted? If yes, does it operate safely & securely?",question_type:"yes_no",is_required:!1,is_critical:!0,order_index:18,category:"exterior"},{id:"19",question_text:"Side & rear under-run protection bars secure (if fitted)?",question_type:"yes_no",is_required:!1,is_critical:!0,order_index:19,category:"exterior"},{id:"20",question_text:"Rear doors or tailgate secure, hinges & locks working?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:20,category:"exterior"},{id:"21",question_text:"Tyres & wheels condition (as per nearside)?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:21,category:"exterior"},{id:"22",question_text:"Exhaust system secure, no leaks, no excessive smoke?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:22,category:"exterior"},{id:"23",question_text:"Side marker lamps working?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:23,category:"exterior"},{id:"24",question_text:"Fuel filler cap secure, no leaks?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:24,category:"exterior"},{id:"25",question_text:"Driver's seat secure, belts working properly?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:25,category:"interior"},{id:"26",question_text:"Steering wheel â€“ no excessive play?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:26,category:"interior"},{id:"27",question_text:"Brakes â€“ firm pedal, no leaks, warning lights off?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:27,category:"interior"},{id:"28",question_text:"Dashboard warning lights â€“ all checked, no unresolved warnings?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:28,category:"interior"},{id:"29",question_text:"Tachograph working, calibrated, and paper roll available?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:29,category:"interior"},{id:"30",question_text:"Odometer/speed limiter functioning?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:30,category:"interior"},{id:"31",question_text:"Handbrake/parking brake working?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:31,category:"interior"},{id:"32",question_text:"Heating & ventilation working?",question_type:"yes_no",is_required:!1,is_critical:!1,order_index:32,category:"interior"},{id:"33",question_text:"Saloon lighting/flooring safe (PSV)?",question_type:"yes_no",is_required:!1,is_critical:!1,order_index:33,category:"interior"},{id:"34",question_text:"Fire extinguisher present, secure, in date?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:34,category:"safety"},{id:"35",question_text:"First aid kit present, stocked, in date?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:35,category:"safety"},{id:"36",question_text:"Passenger doors open/close properly, emergency exits working?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:36,category:"safety"},{id:"37",question_text:"Emergency hammer(s) present and secure (PSV)?",question_type:"yes_no",is_required:!1,is_critical:!0,order_index:37,category:"safety"},{id:"38",question_text:"Wheelchair ramp/lift works correctly (PSV)?",question_type:"yes_no",is_required:!1,is_critical:!0,order_index:38,category:"safety"},{id:"39",question_text:"Seat belts for passengers working where fitted?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:39,category:"safety"},{id:"40",question_text:"Accessibility signage fitted and visible (PSV/FORS)?",question_type:"yes_no",is_required:!1,is_critical:!1,order_index:40,category:"safety"},{id:"41",question_text:"Camera or detection systems clean & working (FORS)?",question_type:"yes_no",is_required:!1,is_critical:!1,order_index:41,category:"safety"},{id:"42",question_text:"Fresnel lens (blind spot lens) fitted & visible (FORS)?",question_type:"yes_no",is_required:!1,is_critical:!1,order_index:42,category:"safety"},{id:"43",question_text:"Load properly secured, curtains/straps tight?",question_type:"yes_no",is_required:!1,is_critical:!0,order_index:43,category:"load"},{id:"44",question_text:"Load height correct & not exceeding legal limits?",question_type:"yes_no",is_required:!1,is_critical:!0,order_index:44,category:"load"},{id:"45",question_text:"Trailer brake lines secure, no leaks?",question_type:"yes_no",is_required:!1,is_critical:!0,order_index:45,category:"load"},{id:"46",question_text:"Trailer coupling secure, clip in place, electrical lines safe?",question_type:"yes_no",is_required:!1,is_critical:!0,order_index:46,category:"load"},{id:"47",question_text:"Trailer landing legs up & secure?",question_type:"yes_no",is_required:!1,is_critical:!0,order_index:47,category:"load"},{id:"48",question_text:"AdBlue level checked & cap secure?",question_type:"yes_no",is_required:!1,is_critical:!1,order_index:48,category:"general"},{id:"49",question_text:"Reflective triangles / warning devices on board?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:49,category:"safety"},{id:"50",question_text:"Emergency contact numbers carried in cab?",question_type:"yes_no",is_required:!0,is_critical:!1,order_index:50,category:"general"},{id:"51",question_text:"Fire suppression system (if fitted) operational?",question_type:"yes_no",is_required:!1,is_critical:!0,order_index:51,category:"safety"},{id:"52",question_text:"Vehicle cleanliness â€“ cab free from loose items causing hazard?",question_type:"yes_no",is_required:!0,is_critical:!1,order_index:52,category:"general"},{id:"53",question_text:"Nil Defects (tick if no issues found)",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:53,category:"final"},{id:"54",question_text:"All defects reported to transport manager immediately?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:54,category:"final"},{id:"55",question_text:"What is the current mileage?",question_type:"number",is_required:!0,is_critical:!1,order_index:55,category:"documentation"},{id:"56",question_text:"Are you fit to drive?",question_type:"yes_no",is_required:!0,is_critical:!0,order_index:56,category:"driver"}];o.useEffect(()=>{Ye((()=>{const t="DF",a=new Date,n=a.getFullYear().toString().slice(-2),N=(a.getMonth()+1).toString().padStart(2,"0"),F=a.getDate().toString().padStart(2,"0"),M=`vehicle_check_counter_${n}${N}${F}`,G=parseInt(localStorage.getItem(M)||"0")+1;localStorage.setItem(M,G.toString());const S=G.toString().padStart(4,"0");return`${t}${n}${N}${F}${S}`})())},[]),o.useEffect(()=>{const s=A.current;if(s){const t=()=>{console.log("Video is ready to play")},a=n=>{console.error("Video error:",n),te(!1)};return s.addEventListener("canplay",t),s.addEventListener("error",a),()=>{s.removeEventListener("canplay",t),s.removeEventListener("error",a),s.srcObject&&s.srcObject.getTracks().forEach(N=>N.stop())}}},[]),o.useEffect(()=>{let s=null;if(ee&&navigator.geolocation)try{s=navigator.geolocation.watchPosition(t=>{const a={latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy,timestamp:new Date().toISOString()};ne(n=>[...n,a])},t=>{console.error("GPS Error:",t),console.log("GPS tracking failed, continuing without GPS")},{enableHighAccuracy:!1,timeout:5e3,maximumAge:6e4})}catch(t){console.error("GPS initialization error:",t)}return()=>{s!==null&&navigator.geolocation.clearWatch(s)}},[ee]);const es=()=>{se(!0),console.log("GPS tracking started")},ss=()=>{se(!1),console.log("GPS tracking stopped")},ts=async()=>{Ce(!0);try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}}});A.current&&(A.current.srcObject=s,await A.current.play(),te(!0),console.log("Camera started successfully"))}catch(s){console.error("Camera error:",s),te(!1);let t="Please allow camera access to continue with the vehicle check.";s instanceof Error&&(s.name==="NotAllowedError"?t="Camera access was denied. Please allow camera permissions in your browser settings.":s.name==="NotFoundError"?t="No camera found on this device.":s.name==="NotSupportedError"&&(t="Camera is not supported on this device or browser.")),c({title:"Camera Access",description:t,variant:"destructive"})}finally{Ce(!1)}},rs=()=>{if(A.current&&ce.current&&pe){const s=ce.current.getContext("2d");if(s){const t=A.current,a=ce.current;if(t.videoWidth===0||t.videoHeight===0){c({title:"Camera Not Ready",description:"Please wait for the camera to initialize before capturing.",variant:"destructive"});return}a.width=t.videoWidth,a.height=t.videoHeight,s.drawImage(t,0,0);const n=a.toDataURL("image/jpeg",.8);v(n);const N=t.srcObject;N&&N.getTracks().forEach(F=>F.stop()),te(!1),c({title:"Photo Captured",description:"Registration plate photo has been captured successfully."})}}else c({title:"Camera Not Available",description:"Please start the camera first before capturing a photo.",variant:"destructive"})},is=()=>{if(console.log("Starting signature capture"),re.current){const s=re.current,t=s.getContext("2d");if(t){t.clearRect(0,0,s.width,s.height),t.strokeStyle="#000",t.lineWidth=3,t.lineCap="round",t.lineJoin="round";let a=!1,n=0,N=0;const F=y=>{const E=s.getBoundingClientRect(),ue="touches"in y?y.touches[0].clientX:y.clientX,fe="touches"in y?y.touches[0].clientY:y.clientY;return{x:ue-E.left,y:fe-E.top}},M=y=>{y.preventDefault(),a=!0;const E=F(y);n=E.x,N=E.y},G=y=>{if(y.preventDefault(),!a)return;const E=F(y);t.beginPath(),t.moveTo(n,N),t.lineTo(E.x,E.y),t.stroke(),n=E.x,N=E.y},S=()=>{a=!1;const y=s.toDataURL("image/png");i(y),console.log("Signature captured")};s.removeEventListener("mousedown",M),s.removeEventListener("mousemove",G),s.removeEventListener("mouseup",S),s.removeEventListener("mouseleave",S),s.removeEventListener("touchstart",M),s.removeEventListener("touchmove",G),s.removeEventListener("touchend",S),s.addEventListener("mousedown",M),s.addEventListener("mousemove",G),s.addEventListener("mouseup",S),s.addEventListener("mouseleave",S),s.addEventListener("touchstart",M,{passive:!1}),s.addEventListener("touchmove",G,{passive:!1}),s.addEventListener("touchend",S),console.log("Signature listeners added")}}},as=()=>{if(re.current){const s=re.current,t=s.getContext("2d");t&&(t.clearRect(0,0,s.width,s.height),i(""))}},oe=(s,t)=>{K(a=>({...a,[s]:t}))},ns=()=>{console.log("Current step:",l,"Question index:",T),l==="vehicle-selection"?g?(m("registration-photo"),console.log("Moving to registration-photo")):c({title:"Vehicle Required",description:"Please select a vehicle to continue.",variant:"destructive"}):l==="registration-photo"?f?(m("mileage"),console.log("Moving to mileage")):c({title:"Photo Required",description:"Please capture a photo of the registration plate.",variant:"destructive"}):l==="mileage"?L&&L.trim()!==""?(m("questions"),es(),console.log("Moving to questions, GPS tracking started")):c({title:"Mileage Required",description:"Please enter the current mileage.",variant:"destructive"}):l==="questions"?T<R.length-1?(J(s=>s+1),console.log("Moving to next question:",T+1)):(ss(),m("signature"),setTimeout(()=>{is()},100),console.log("Moving to signature")):l==="signature"&&(z?(m("review"),console.log("Moving to review")):c({title:"Signature Required",description:"Please provide your signature to continue.",variant:"destructive"}))},ls=()=>{console.log("Going back from step:",l),l==="registration-photo"?m("vehicle-selection"):l==="mileage"?m("registration-photo"):l==="questions"?T>0?J(s=>s-1):m("mileage"):l==="signature"?(m("questions"),J(R.length-1)):l==="review"&&m("signature")},Te=async()=>{var s,t;if(!(r!=null&&r.organization_id)||!(r!=null&&r.id)){c({title:"Authentication Error",description:"Please log in again to continue.",variant:"destructive"});return}ge(!0);try{console.log("Submitting vehicle check...");let a="";if(f){const D=await fetch(f).then(_e=>_e.blob()),ye=new File([D],"registration-photo.jpg",{type:"image/jpeg"}),W=await Oe(ye,"vehicle-photos","registration-photos",r.organization_id,r.id);W.success?a=W.fileUrl||"":console.warn("Failed to upload registration photo:",W.error)}let n="";if(z){const D=await fetch(z).then(_e=>_e.blob()),ye=new File([D],"signature.png",{type:"image/png"}),W=await Oe(ye,"vehicle-photos","signatures",r.organization_id,r.id);W.success?n=W.fileUrl||"":console.warn("Failed to upload signature:",W.error)}const N=R.length,F=Object.keys(p).length,M=N>0?Math.round(F/N*100):0,S=R.filter(D=>D.is_critical).filter(D=>p[D.id]===!1).length,y=S===0,E={organization_id:r.organization_id,vehicle_id:g,driver_id:r.id,check_type:"daily",status:"completed",started_at:new Date().toISOString(),completed_at:new Date().toISOString(),odometer_reading:parseInt(L)||0,overall_condition:y?"good":"poor",defects_found:S,critical_issues:S,score:M,pass_fail:y,compliance_status:y?"compliant":"non_compliant",notes:d,attachments:JSON.stringify({registration_photo_url:a,signature_url:n,gps_track:Q,answers:p,reference_number:H}),metadata:JSON.stringify({reference_number:H,gps_points_count:Q.length,questions_answered:F,total_questions:N})},ue=await _.mutateAsync(E),fe={id:ue.id,reference_number:H,vehicle_id:g,vehicle_number:((s=Z.find(D=>D.id===g))==null?void 0:s.vehicle_number)||"",license_plate:((t=Z.find(D=>D.id===g))==null?void 0:t.license_plate)||"",driver_id:r.id,driver_name:r!=null&&r.first_name&&(r!=null&&r.last_name)?`${r.first_name} ${r.last_name}`:(r==null?void 0:r.email)||"",template_id:"1",template_name:"Standard Vehicle Check",start_time:new Date().toISOString(),end_time:new Date().toISOString(),status:"completed",mileage:parseInt(L)||0,registration_photo_url:a,gps_track:Q,answers:p,signature_url:n,notes:d};ke(fe),console.log("Vehicle check submitted successfully:",ue)}catch(a){console.error("Error submitting vehicle check:",a),c({title:"Error",description:"Failed to complete vehicle check. Please try again.",variant:"destructive"})}finally{ge(!1)}},cs=()=>{var s;m("vehicle-selection"),V(""),v(""),u(""),J(0),K({}),ne([]),se(!1),i(""),I(""),ke(null),ge(!1),(s=A.current)!=null&&s.srcObject&&A.current.srcObject.getTracks().forEach(a=>a.stop()),console.log("Vehicle check reset")},De=()=>{const s=["vehicle-selection","registration-photo","mileage","questions","signature","review"];return(s.indexOf(l)+1)/s.length*100},de=()=>R[T],os=s=>{Ke(Ze(s)),Se(!0)},ds=()=>{var s,t;switch(l){case"vehicle-selection":return e.jsxs(w,{className:"w-full shadow-sm border-0",children:[e.jsxs(q,{className:"pb-4",children:[e.jsx(C,{className:"text-lg sm:text-xl text-gray-900",children:"Select Vehicle"}),e.jsx($,{className:"text-sm sm:text-base text-gray-600",children:"Choose the vehicle you will be checking today"})]}),e.jsxs(k,{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(j,{htmlFor:"vehicle",className:"text-base font-medium text-gray-700",children:"Vehicle"}),e.jsxs(Ge,{value:g,onValueChange:V,children:[e.jsx(Ue,{className:"h-14 sm:h-12 text-base",children:e.jsx(Qe,{placeholder:"Choose your vehicle"})}),e.jsx(He,{children:P?e.jsx(X,{value:"loading",disabled:!0,children:"Loading vehicles..."}):Z.length===0?e.jsx(X,{value:"no-vehicles",disabled:!0,children:"No vehicles available"}):Z.map(n=>e.jsxs(X,{value:n.id,className:"text-base",children:[n.vehicle_number," - ",n.license_plate]},n.id))})]})]}),e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4 sm:p-6 border border-blue-200",children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2 sm:mb-3 text-base sm:text-lg",children:"Reference Number"}),e.jsx("p",{className:"text-blue-700 font-mono text-xl sm:text-2xl font-bold mb-2",children:H}),e.jsx("p",{className:"text-blue-600 text-xs sm:text-sm",children:"This unique reference will appear on all documents"})]})]})]});case"registration-photo":return e.jsxs(w,{className:"w-full shadow-sm border-0",children:[e.jsxs(q,{className:"pb-4",children:[e.jsx(C,{className:"text-lg sm:text-xl text-gray-900",children:"Vehicle Registration Photo"}),e.jsx($,{className:"text-sm sm:text-base text-gray-600",children:"Take a clear photo of the vehicle registration plate"})]}),e.jsx(k,{className:"space-y-4 sm:space-y-6",children:f?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:f,alt:"Registration Plate",className:"w-full h-80 object-cover rounded-lg border-2 border-gray-200"}),e.jsx("div",{className:"absolute top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium",children:"âœ“ Photo Captured"})]}),e.jsxs("div",{className:"flex flex-col space-y-3 sm:flex-row sm:space-y-0 sm:space-x-3",children:[e.jsxs(h,{onClick:()=>{v(""),te(!1)},variant:"outline",className:"flex-1 h-14 sm:h-12 text-base font-medium",children:[e.jsx(me,{className:"w-5 h-5 mr-2"}),"Retake Photo"]}),e.jsxs(h,{onClick:()=>m("mileage"),variant:"default",className:"flex-1 h-14 sm:h-12 text-base font-medium",children:[e.jsx(ae,{className:"w-5 h-5 mr-2"}),"Photo OK"]})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx("video",{ref:A,autoPlay:!0,playsInline:!0,className:"w-full h-48 sm:h-64 lg:h-80 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300"}),e.jsx("canvas",{ref:ce,className:"hidden"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsxs("div",{className:"relative w-64 h-32",children:[e.jsx("div",{className:"absolute inset-0 border-2 border-white border-dashed rounded-lg bg-black bg-opacity-20"}),e.jsx("div",{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 w-32 h-8 border-2 border-yellow-400 bg-yellow-400 bg-opacity-20 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-yellow-400 text-xs font-bold",children:"REG PLATE"})}),e.jsx("div",{className:"absolute -top-8 left-1/2 transform -translate-x-1/2 text-white text-sm font-medium bg-black bg-opacity-50 px-3 py-1 rounded",children:"Position vehicle here"})]})}),e.jsxs("div",{className:"absolute bottom-4 left-4 right-4 bg-black bg-opacity-50 text-white p-3 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(me,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Camera Instructions"})]}),e.jsxs("ul",{className:"text-sm space-y-1",children:[e.jsx("li",{children:"â€¢ Position the vehicle within the white outline"}),e.jsx("li",{children:"â€¢ Ensure the registration plate is clearly visible in the yellow area"}),e.jsx("li",{children:"â€¢ Hold the camera steady and well-lit"}),e.jsx("li",{children:"â€¢ Make sure the plate text is readable"})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx(h,{onClick:ts,variant:"outline",disabled:qe,className:"flex-1 h-12 text-base",children:qe?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-gray-400 border-t-transparent rounded-full animate-spin mr-2"}),"Starting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-5 h-5 mr-2"}),"Start Camera"]})}),e.jsxs(h,{onClick:rs,disabled:!pe,className:"flex-1 h-12 text-base",children:[e.jsx(me,{className:"w-5 h-5 mr-2"}),"Capture Photo"]})]}),pe&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("span",{className:"text-green-800 font-medium",children:"Camera Active"})]}),e.jsx("p",{className:"text-green-700 text-sm mt-1",children:'Camera is ready. Position the vehicle and tap "Capture Photo".'})]})]})})]});case"mileage":return e.jsxs(w,{className:"w-full shadow-sm border-0",children:[e.jsxs(q,{className:"pb-4",children:[e.jsx(C,{className:"text-lg sm:text-xl text-gray-900",children:"Current Mileage"}),e.jsx($,{className:"text-sm sm:text-base text-gray-600",children:"Enter the current mileage reading from the vehicle"})]}),e.jsx(k,{className:"space-y-4 sm:space-y-6",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(j,{htmlFor:"mileage",className:"text-base font-medium text-gray-700",children:"Mileage (miles)"}),e.jsx(je,{id:"mileage",type:"number",value:L,onChange:n=>u(n.target.value),placeholder:"Enter current mileage",className:"h-14 sm:h-12 text-base"})]})})]});case"questions":const a=de();return e.jsxs(w,{className:"w-full shadow-sm border-0",children:[e.jsxs(q,{className:"pb-3 sm:pb-4",children:[e.jsx(C,{className:"text-lg sm:text-xl text-gray-900",children:"Vehicle Check Questions"}),e.jsxs($,{className:"text-sm sm:text-base text-gray-600",children:["Question ",T+1," of ",R.length]})]}),e.jsxs(k,{className:"space-y-3 sm:space-y-4",children:[e.jsxs("div",{className:"space-y-3 sm:space-y-4",children:[e.jsxs("div",{className:"bg-blue-50 rounded-lg p-2 sm:p-3 border border-blue-200",children:[e.jsxs("div",{className:"flex flex-col space-y-1 sm:flex-row sm:items-center sm:justify-between sm:space-y-0",children:[e.jsxs("div",{className:"flex flex-col space-y-2 sm:flex-row sm:items-center sm:space-y-0 sm:space-x-2",children:[e.jsx(b,{variant:"outline",className:"text-xs sm:text-sm font-semibold bg-blue-100 text-blue-800 border-blue-300 w-fit",children:Ee(a.category)}),a.is_critical&&e.jsxs(b,{variant:"destructive",className:"text-xs sm:text-sm w-fit",children:[e.jsx(ve,{className:"w-3 h-3 mr-1"}),"Critical"]})]}),e.jsxs("div",{className:"text-xs sm:text-sm text-blue-600 font-medium",children:["Step ",T+1," of ",R.length]})]}),e.jsx("div",{className:"mt-2 text-xs sm:text-sm text-blue-700 leading-relaxed",children:Pe(a.category)})]}),e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("h3",{className:"text-lg sm:text-xl font-semibold leading-relaxed text-gray-900 flex-1",children:a.question_text}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>os(a.id),className:`flex-shrink-0 p-2 h-auto rounded-full transition-colors duration-200 ${a.is_critical?"text-red-600 hover:text-red-800 hover:bg-red-50":"text-blue-600 hover:text-blue-800 hover:bg-blue-50"}`,title:"Get inspection guidance",children:e.jsx(Me,{className:`w-5 h-5 ${a.is_critical?"animate-pulse":""}`})})]}),a.category==="exterior"&&e.jsxs("div",{className:"bg-blue-50 rounded-lg p-2 sm:p-3 border border-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(Ne,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Inspection Flow"})]}),e.jsxs("div",{className:"text-xs text-blue-700 space-y-2",children:[e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("span",{className:"w-5 h-5 bg-blue-200 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5",children:"1"}),e.jsx("span",{className:"leading-relaxed",children:"Front of Vehicle (Left to Right)"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("span",{className:"w-5 h-5 bg-blue-200 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5",children:"2"}),e.jsx("span",{className:"leading-relaxed",children:"Nearside (Passenger Side)"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("span",{className:"w-5 h-5 bg-blue-200 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5",children:"3"}),e.jsx("span",{className:"leading-relaxed",children:"Rear of Vehicle"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("span",{className:"w-5 h-5 bg-blue-200 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5",children:"4"}),e.jsx("span",{className:"leading-relaxed",children:"Offside (Driver's Side)"})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("span",{className:"w-5 h-5 bg-blue-200 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5",children:"5"}),e.jsx("span",{className:"leading-relaxed",children:"Inside Cab & Safety Equipment"})]})]})]}),a.question_type==="yes_no"&&e.jsxs("div",{className:"flex flex-col space-y-2 sm:flex-row sm:space-y-0 sm:space-x-4",children:[e.jsxs(h,{variant:p[a.id]===!0?"default":"outline",onClick:()=>oe(a.id,!0),className:"flex-1 h-12 text-base font-medium",children:[e.jsx(ae,{className:"w-5 h-5 mr-2"}),"Yes"]}),e.jsxs(h,{variant:p[a.id]===!1?"default":"outline",onClick:()=>oe(a.id,!1),className:"flex-1 h-12 text-base font-medium",children:[e.jsx(We,{className:"w-5 h-5 mr-2"}),"No"]})]}),a.question_type==="number"&&e.jsx(je,{type:"number",value:p[a.id]||"",onChange:n=>oe(a.id,n.target.value),placeholder:"Enter value",className:"h-12 text-base"}),a.question_type==="text"&&e.jsx(Ae,{value:p[a.id]||"",onChange:n=>oe(a.id,n.target.value),placeholder:"Enter your answer",rows:3,className:"text-base resize-none"})]}),ee&&e.jsxs("div",{className:"bg-green-50 rounded-lg p-2 sm:p-3 border border-green-200",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ds,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-green-800 font-medium text-sm sm:text-base",children:"GPS Tracking Active"})]}),e.jsxs("p",{className:"text-green-700 text-xs sm:text-sm mt-1",children:["Location is being tracked: ",Q.length," points recorded"]})]})]})]});case"signature":return e.jsxs(w,{className:"w-full shadow-sm border-0",children:[e.jsxs(q,{className:"pb-4",children:[e.jsx(C,{className:"text-lg sm:text-xl text-gray-900",children:"Driver Signature"}),e.jsx($,{className:"text-sm sm:text-base text-gray-600",children:"Sign to confirm the vehicle check is complete and accurate"})]}),e.jsxs(k,{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(j,{className:"text-base font-medium",children:"Signature"}),e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-3 sm:p-4",children:e.jsx("canvas",{ref:re,width:400,height:200,className:"w-full h-32 sm:h-40 lg:h-48 border rounded-lg cursor-crosshair bg-white touch-none",style:{border:"1px solid #e5e7eb"}})}),e.jsxs("div",{className:"flex flex-col space-y-2 sm:flex-row sm:items-center sm:space-y-0 sm:space-x-2",children:[e.jsx(h,{onClick:as,variant:"outline",size:"sm",className:"text-sm w-fit",children:"Clear Signature"}),e.jsx("span",{className:"text-xs sm:text-sm text-muted-foreground",children:"Click and drag to sign, or use your finger on mobile"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(j,{htmlFor:"notes",className:"text-base font-medium text-gray-700",children:"Additional Notes (Optional)"}),e.jsx(Ae,{id:"notes",value:d,onChange:n=>I(n.target.value),placeholder:"Any additional observations or notes...",rows:3,className:"text-base resize-none"})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx(h,{onClick:Te,disabled:le||!z,className:"w-full h-12 text-base",children:le?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-5 h-5 mr-2"}),"Complete Vehicle Check"]})}),!z&&e.jsx("p",{className:"text-sm text-muted-foreground mt-2 text-center",children:"Please provide your signature to complete the check"})]})]})]});case"review":return e.jsxs(w,{className:"w-full shadow-sm border-0",children:[e.jsxs(q,{className:"pb-4",children:[e.jsx(C,{className:"text-lg sm:text-xl text-gray-900",children:"Review Vehicle Check"}),e.jsx($,{className:"text-sm sm:text-base text-gray-600",children:"Review all information before submitting"})]}),e.jsxs(k,{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"grid gap-4 sm:gap-6 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{className:"text-base font-medium",children:"Reference Number"}),e.jsx("p",{className:"font-mono text-lg font-bold",children:H})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{className:"text-base font-medium",children:"Vehicle"}),e.jsxs("p",{className:"text-base",children:[(s=Z.find(n=>n.id===g))==null?void 0:s.vehicle_number," - ",(t=Z.find(n=>n.id===g))==null?void 0:t.license_plate]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{className:"text-base font-medium",children:"Mileage"}),e.jsxs("p",{className:"text-base",children:[L," miles"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{className:"text-base font-medium",children:"GPS Points"}),e.jsxs("p",{className:"text-base",children:[Q.length," locations tracked"]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(j,{className:"text-base font-medium",children:"Registration Photo"}),f&&e.jsx("div",{className:"border rounded-lg p-2",children:e.jsx("img",{src:f,alt:"Registration Plate",className:"w-48 h-36 object-cover rounded border"})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(j,{className:"text-base font-medium",children:"Answers Summary"}),e.jsx("div",{className:"space-y-2 max-h-80 overflow-y-auto",children:R.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded border",children:[e.jsx("span",{className:"text-sm flex-1 mr-4",children:n.question_text}),e.jsx(b,{variant:p[n.id]?"default":"secondary",className:"text-xs",children:p[n.id]?"Answered":"Not Answered"})]},n.id))})]}),z&&e.jsxs("div",{className:"space-y-3",children:[e.jsx(j,{className:"text-base font-medium",children:"Signature"}),e.jsx("div",{className:"border rounded-lg p-2",children:e.jsx("img",{src:z,alt:"Driver Signature",className:"w-48 h-24 object-contain border rounded"})})]})]})]});default:return null}};return e.jsxs("div",{className:"h-screen bg-gray-50 relative",children:[e.jsx("div",{className:"h-full overflow-y-auto pb-24",children:e.jsxs("div",{className:"space-y-3 p-3 sm:space-y-4 sm:p-4 lg:space-y-6 lg:p-6 max-w-4xl mx-auto",children:[e.jsx("div",{className:"bg-white rounded-lg p-3 sm:p-4 shadow-sm border",children:e.jsxs("div",{className:"flex flex-col space-y-3 sm:flex-row sm:items-center sm:justify-between sm:space-y-0",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-xl sm:text-2xl lg:text-3xl font-bold tracking-tight text-gray-900",children:"Enhanced Vehicle Check"}),e.jsx("p",{className:"text-muted-foreground text-sm sm:text-base mt-1",children:"Complete vehicle inspection with GPS tracking and photo capture"})]}),e.jsxs("div",{className:"flex flex-col space-y-2 sm:flex-row sm:items-center sm:space-y-0 sm:space-x-2",children:[e.jsxs(b,{variant:"outline",className:"text-xs w-fit",children:[e.jsx($e,{className:"w-3 h-3 mr-1"}),new Date().toLocaleTimeString()]}),e.jsxs(b,{variant:"outline",className:"text-xs w-fit",children:[e.jsx(hs,{className:"w-3 h-3 mr-1"}),r!=null&&r.first_name&&(r!=null&&r.last_name)?`${r.first_name} ${r.last_name}`:r==null?void 0:r.email]})]})]})}),e.jsxs("div",{className:"bg-white rounded-lg p-3 sm:p-4 shadow-sm border space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"Progress"}),e.jsxs("span",{className:"text-muted-foreground font-semibold",children:[Math.round(De()),"%"]})]}),e.jsx(qs,{value:De(),className:"w-full h-3"}),l==="questions"&&e.jsxs("div",{className:"bg-blue-50 rounded-lg p-3 border border-blue-200",children:[e.jsxs("div",{className:"flex flex-col space-y-2 sm:flex-row sm:items-center sm:justify-between sm:space-y-0",children:[e.jsxs("div",{className:"flex flex-col space-y-1 sm:flex-row sm:items-center sm:space-y-0 sm:space-x-2",children:[e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:"Current Section:"}),e.jsx(b,{variant:"outline",className:"text-xs w-fit",children:Ee(((Ve=de())==null?void 0:Ve.category)||"")})]}),e.jsxs("div",{className:"text-xs text-gray-500 font-medium",children:["Question ",T+1," of ",R.length]})]}),e.jsx("div",{className:"mt-2 text-xs text-blue-700 leading-relaxed",children:Pe(((Ie=de())==null?void 0:Ie.category)||"")})]})]}),e.jsx("div",{children:ds()})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg p-3 sm:p-4 z-10",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs("div",{className:"flex flex-col space-y-3 sm:flex-row sm:items-center sm:justify-between sm:space-y-0",children:[e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[e.jsxs(h,{variant:"outline",onClick:ls,disabled:l==="vehicle-selection",className:"flex-1 sm:flex-none h-12 text-base",children:[e.jsx(Es,{className:"w-4 h-4 mr-2"}),"Previous"]}),e.jsxs(h,{variant:"outline",onClick:cs,className:"flex-1 sm:flex-none h-12 text-base",children:[e.jsx(ms,{className:"w-4 h-4 mr-2"}),"Reset"]})]}),e.jsx("div",{className:"flex items-center space-x-2 w-full sm:w-auto",children:l==="review"?e.jsxs(h,{onClick:Te,disabled:le,className:"w-full sm:w-auto h-12 text-base",children:[e.jsx(Ps,{className:"w-4 h-4 mr-2"}),le?"Submitting...":"Complete Check"]}):l==="signature"?e.jsx("div",{className:"w-full sm:w-auto"}):e.jsxs(h,{onClick:ns,className:"w-full sm:w-auto h-12 text-base",children:[e.jsx(Ts,{className:"w-4 h-4 mr-2"}),"Next"]})})]})})}),e.jsx(xs,{open:Xe,onOpenChange:Se,children:e.jsxs(gs,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(ps,{children:[e.jsxs(fs,{className:"flex items-center space-x-2",children:[e.jsx(Me,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{children:"Inspection Guidance"}),((Re=de())==null?void 0:Re.is_critical)&&e.jsxs(b,{variant:"destructive",className:"ml-2",children:[e.jsx(ve,{className:"w-3 h-3 mr-1"}),"Critical"]})]}),e.jsx(ys,{className:"text-base",children:"Detailed instructions for this inspection item"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4 border border-blue-200",children:[e.jsx("h4",{className:"font-semibold text-blue-900 mb-2",children:"What to Check:"}),e.jsx("p",{className:"text-blue-800 leading-relaxed whitespace-pre-line",children:Je})]}),e.jsxs("div",{className:"bg-yellow-50 rounded-lg p-4 border border-yellow-200",children:[e.jsx("h4",{className:"font-semibold text-yellow-900 mb-2",children:"ðŸ’¡ Tips:"}),e.jsxs("ul",{className:"text-yellow-800 space-y-1 text-sm",children:[e.jsx("li",{children:"â€¢ Take your time to inspect thoroughly"}),e.jsx("li",{children:'â€¢ If in doubt, mark as "No" and report the issue'}),e.jsx("li",{children:"â€¢ Use a flashlight if needed for better visibility"}),e.jsx("li",{children:"â€¢ Check from multiple angles when possible"}),e.jsx("li",{children:"â€¢ Don't skip any items - each is important for safety"})]})]})]})]})}),B&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs(w,{className:"w-full max-w-2xl mx-4",children:[e.jsxs(q,{children:[e.jsxs(C,{className:"flex items-center space-x-2",children:[e.jsx(ae,{className:"w-6 h-6 text-green-600"}),e.jsx("span",{children:"Vehicle Check Completed!"})]}),e.jsx($,{children:"Your vehicle check has been successfully submitted"})]}),e.jsxs(k,{className:"space-y-4",children:[e.jsxs("div",{className:"bg-green-50 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-green-900 mb-2",children:"Reference Number"}),e.jsx("p",{className:"font-mono text-lg text-green-700",children:B.reference_number})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(j,{children:"Vehicle"}),e.jsxs("p",{children:[B.vehicle_number," - ",B.license_plate]})]}),e.jsxs("div",{children:[e.jsx(j,{children:"Mileage"}),e.jsxs("p",{children:[B.mileage," miles"]})]}),e.jsxs("div",{children:[e.jsx(j,{children:"GPS Points"}),e.jsxs("p",{children:[B.gps_track.length," locations"]})]}),e.jsxs("div",{children:[e.jsx(j,{children:"Questions Answered"}),e.jsxs("p",{children:[Object.keys(B.answers).length," of ",R.length]})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(h,{className:"flex-1",children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"Download Report"]}),e.jsxs(h,{variant:"outline",className:"flex-1",children:[e.jsx(_s,{className:"w-4 h-4 mr-2"}),"View Details"]})]})]})]})})]})},ut=()=>{xe();const{toast:r}=we(),[c,_]=o.useState("new-check"),[x,P]=o.useState(""),[l,m]=o.useState("all"),[g,V]=o.useState(!1),{data:f=[],isLoading:v,refetch:L}=Ls(),{data:u=[],isLoading:T,refetch:J}=Be(),p=f.map(i=>{const d=u.find(H=>H.id===i.vehicle_id),I=i.driver_profile;return{id:i.id,vehicle_id:i.vehicle_id||"",vehicle_number:(d==null?void 0:d.vehicle_number)||"Unknown",license_plate:(d==null?void 0:d.license_plate)||"Unknown",check_date:i.created_at?ie(new Date(i.created_at),"yyyy-MM-dd"):"",status:i.status||"pending",issues_found:i.defects_found?Array(i.defects_found).fill("Issue found"):[],notes:i.notes||"",created_at:i.created_at||"",driver_name:I?`${I.first_name} ${I.last_name}`:"Unknown Driver",check_type:i.check_type||"daily"}}),K=p.filter(i=>{const d=i.vehicle_number.toLowerCase().includes(x.toLowerCase())||i.license_plate.toLowerCase().includes(x.toLowerCase())||i.driver_name.toLowerCase().includes(x.toLowerCase()),I=l==="all"||i.status===l;return d&&I}),Q=i=>{switch(i){case"completed":return e.jsx(b,{variant:"default",className:"bg-green-100 text-green-800",children:"Completed"});case"pending":return e.jsx(b,{variant:"secondary",children:"Pending"});case"failed":return e.jsx(b,{variant:"destructive",children:"Failed"});default:return e.jsx(b,{variant:"outline",children:i})}},ne=i=>{switch(i){case"daily":return e.jsx(b,{variant:"outline",className:"text-blue-600",children:"Daily"});case"weekly":return e.jsx(b,{variant:"outline",className:"text-purple-600",children:"Weekly"});case"comprehensive":return e.jsx(b,{variant:"outline",className:"text-orange-600",children:"Comprehensive"});default:return e.jsx(b,{variant:"outline",children:i})}},ee=()=>{_("new-check"),r({title:"New Vehicle Check",description:"Starting new vehicle inspection..."})},se=()=>{const i=K.map(d=>({"Vehicle Number":d.vehicle_number,"License Plate":d.license_plate,Date:d.check_date,Status:d.status,Type:d.check_type,Driver:d.driver_name,Issues:d.issues_found.join(", "),Notes:d.notes}));console.log("Exporting data:",i),r({title:"Export Successful",description:"Vehicle check data exported to CSV"})},z=async()=>{try{await Promise.all([L(),J()]),r({title:"Data Refreshed",description:"Vehicle checks and vehicles data updated"})}catch{r({title:"Refresh Failed",description:"Failed to refresh data. Please try again.",variant:"destructive"})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Vehicle Checks"}),e.jsx("p",{className:"text-muted-foreground",children:"Daily vehicle inspections and safety checks"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(h,{onClick:z,variant:"outline",size:"sm",disabled:v||T,children:[e.jsx(Vs,{className:`w-4 h-4 mr-2 ${v||T?"animate-spin":""}`}),"Refresh"]}),e.jsxs(h,{onClick:se,variant:"outline",size:"sm",children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"Export"]}),e.jsxs(h,{onClick:ee,children:[e.jsx(Is,{className:"w-4 h-4 mr-2"}),"New Check"]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(w,{children:[e.jsxs(q,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Total Checks"}),e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(k,{children:[v?e.jsx("div",{className:"text-2xl font-bold text-muted-foreground",children:"..."}):e.jsx("div",{className:"text-2xl font-bold",children:p.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"This month"})]})]}),e.jsxs(w,{children:[e.jsxs(q,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Completed"}),e.jsx(ae,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(k,{children:[v?e.jsx("div",{className:"text-2xl font-bold text-muted-foreground",children:"..."}):e.jsx("div",{className:"text-2xl font-bold text-green-600",children:p.filter(i=>i.status==="completed").length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Passed inspections"})]})]}),e.jsxs(w,{children:[e.jsxs(q,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Issues Found"}),e.jsx(ve,{className:"h-4 w-4 text-orange-600"})]}),e.jsxs(k,{children:[v?e.jsx("div",{className:"text-2xl font-bold text-muted-foreground",children:"..."}):e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:p.reduce((i,d)=>i+d.issues_found.length,0)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total issues reported"})]})]}),e.jsxs(w,{children:[e.jsxs(q,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Last Check"}),e.jsx($e,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(k,{children:[v?e.jsx("div",{className:"text-2xl font-bold text-muted-foreground",children:"..."}):e.jsx("div",{className:"text-2xl font-bold",children:p.length>0?ie(new Date(p[0].created_at),"MMM dd"):"N/A"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:v?"":p.length>0?ie(new Date(p[0].created_at),"HH:mm"):""})]})]})]}),e.jsxs(js,{value:c,onValueChange:_,className:"space-y-4",children:[e.jsxs(bs,{className:"grid w-full grid-cols-2",children:[e.jsx(Le,{value:"new-check",children:"New Vehicle Check"}),e.jsx(Le,{value:"history",children:"Check History"})]}),e.jsx(ze,{value:"new-check",className:"space-y-4",children:e.jsxs(w,{children:[e.jsxs(q,{children:[e.jsxs(C,{className:"flex items-center space-x-2",children:[e.jsx(Fe,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{children:"Enhanced Vehicle Check"})]}),e.jsx($,{children:"Complete vehicle inspection with GPS tracking, photo capture, and unique reference numbers"})]}),e.jsxs(k,{className:"space-y-4",children:[e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"Enhanced Features"}),e.jsxs("ul",{className:"text-blue-700 space-y-1 text-sm",children:[e.jsx("li",{children:"â€¢ GPS tracking during inspection"}),e.jsx("li",{children:"â€¢ Photo capture of registration plate"}),e.jsx("li",{children:"â€¢ Unique reference numbers for each check"}),e.jsx("li",{children:"â€¢ Digital signature capture"}),e.jsx("li",{children:"â€¢ Comprehensive reporting"}),e.jsx("li",{children:"â€¢ Admin-managed question templates"})]})]}),e.jsxs(h,{className:"w-full",onClick:()=>V(!0),size:"lg",children:[e.jsx(Fe,{className:"w-5 h-5 mr-2"}),"Start Enhanced Vehicle Check"]})]})]})}),e.jsxs(ze,{value:"history",className:"space-y-4",children:[e.jsxs(w,{children:[e.jsxs(q,{children:[e.jsx(C,{children:"Check History"}),e.jsx($,{children:"View and manage your vehicle inspection history"})]}),e.jsx(k,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(j,{htmlFor:"search",children:"Search"}),e.jsxs("div",{className:"relative",children:[e.jsx(Rs,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(je,{id:"search",placeholder:"Search by vehicle number or license plate...",value:x,onChange:i=>P(i.target.value),className:"pl-8"})]})]}),e.jsxs("div",{className:"sm:w-48",children:[e.jsx(j,{htmlFor:"status",children:"Status"}),e.jsxs(Ge,{value:l,onValueChange:m,children:[e.jsx(Ue,{children:e.jsx(Qe,{})}),e.jsxs(He,{children:[e.jsx(X,{value:"all",children:"All Status"}),e.jsx(X,{value:"completed",children:"Completed"}),e.jsx(X,{value:"pending",children:"Pending"}),e.jsx(X,{value:"failed",children:"Failed"})]})]})]})]})})]}),e.jsx(w,{children:e.jsx(k,{className:"p-0",children:e.jsxs(Ns,{children:[e.jsx(ws,{children:e.jsxs(he,{children:[e.jsx(Y,{children:"Vehicle"}),e.jsx(Y,{children:"Date"}),e.jsx(Y,{children:"Type"}),e.jsx(Y,{children:"Status"}),e.jsx(Y,{children:"Issues"}),e.jsx(Y,{children:"Notes"}),e.jsx(Y,{className:"text-right",children:"Actions"})]})}),e.jsx(ks,{children:v?e.jsx(he,{children:e.jsx(O,{colSpan:7,className:"text-center py-8",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-muted-foreground",children:"Loading vehicle checks..."})]})})}):K.length===0?e.jsx(he,{children:e.jsx(O,{colSpan:7,className:"text-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ne,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium",children:"No vehicle checks found"}),e.jsx("p",{className:"text-muted-foreground",children:x||l!=="all"?"Try adjusting your search or filter criteria":"Start your first vehicle inspection to see it here"})]})})}):K.map(i=>e.jsxs(he,{children:[e.jsx(O,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.vehicle_number}),e.jsx("div",{className:"text-sm text-muted-foreground",children:i.license_plate})]})}),e.jsx(O,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:ie(new Date(i.check_date),"MMM dd, yyyy")}),e.jsx("div",{className:"text-sm text-muted-foreground",children:ie(new Date(i.created_at),"HH:mm")})]})}),e.jsx(O,{children:ne(i.check_type)}),e.jsx(O,{children:Q(i.status)}),e.jsx(O,{children:i.issues_found.length>0?e.jsxs("div",{className:"space-y-1",children:[i.issues_found.slice(0,2).map((d,I)=>e.jsx(b,{variant:"outline",className:"text-xs",children:d},I)),i.issues_found.length>2&&e.jsxs(b,{variant:"outline",className:"text-xs",children:["+",i.issues_found.length-2," more"]})]}):e.jsx("span",{className:"text-green-600 text-sm",children:"No issues"})}),e.jsx(O,{children:e.jsx("div",{className:"max-w-xs truncate",children:i.notes||"No notes"})}),e.jsx(O,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(h,{variant:"ghost",size:"sm",children:e.jsx(vs,{className:"w-4 h-4"})}),e.jsx(h,{variant:"ghost",size:"sm",children:e.jsx(Fs,{className:"w-4 h-4"})}),e.jsx(h,{variant:"ghost",size:"sm",children:e.jsx(be,{className:"w-4 h-4"})})]})})]},i.id))})]})})})]})]}),g&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"w-full max-w-6xl h-[90vh] bg-white rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Enhanced Vehicle Check"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>V(!1),children:e.jsx(We,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"h-full overflow-y-auto",children:e.jsx(As,{})})]})})]})};export{ut as default};
